FFFFFFFFFFFF.FF.FFFFFFFFFF.........                                      [100%]
=================================== FAILURES ===================================
_________________ test_admin_read_requires_read_or_admin_scope _________________

client = <starlette.testclient.TestClient object at 0x128b17bd0>

    def test_admin_read_requires_read_or_admin_scope(client):
        """Test that admin read endpoints require admin:read or admin scope"""
        # Test with admin:read scope - should succeed
        token_read = _tok(["admin:read"])
        response = client.get("/v1/admin/config", headers={"Authorization": f"Bearer {token_read}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:38: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "046ed0ef-88d5-4ddb-a9c3-1c4e99f56572", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "046ed0ef-88d5-4ddb-a9c3-1c4e99f56572", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "046ed0ef-88d5-4ddb-a9c3-1c4e99f56572", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "046ed0ef-88d5-4ddb-a9c3-1c4e99f56572", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "046ed0ef-88d5-4ddb-a9c3-1c4e99f56572", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.012s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 12.005805969238281, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.012s)
________________ test_admin_write_requires_write_or_admin_scope ________________

client = <starlette.testclient.TestClient object at 0x122707990>

    def test_admin_write_requires_write_or_admin_scope(client):
        """Test that admin write endpoints require admin:write or admin scope"""
        test_data = {"test": "data"}

        # Test with admin:write scope - should succeed
        token_write = _tok(["admin:write"])
        response = client.post("/v1/admin/config", json=test_data, headers={"Authorization": f"Bearer {token_write}"})
>       assert response.status_code == 200
E       assert 405 == 200
E        +  where 405 = <Response [405 Method Not Allowed]>.status_code

tests/test_admin_scope_granular.py:62: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "415228bc-6bc3-4d35-9b2f-163f3d52d00d", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "415228bc-6bc3-4d35-9b2f-163f3d52d00d", "status_code": 405, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:write", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: POST /v1/admin/config -> 405 (0.010s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "b2d50b37f217fca2f07052f7ca136e33", "status_code": 405, "duration_ms": 9.618997573852539, "error_code": "CLIENT_METHOD_NOT_ALLOWED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: POST /v1/admin/config -> 405 (0.010s)
______________________ test_admin_metrics_endpoint_scope _______________________

client = <starlette.testclient.TestClient object at 0x122704190>

    def test_admin_metrics_endpoint_scope(client):
        """Test that /v1/admin/metrics requires admin:read or admin scope"""
        # Test with admin:read scope - should succeed
        token_read = _tok(["admin:read"])
        response = client.get("/v1/admin/metrics", headers={"Authorization": f"Bearer {token_read}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:84: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8b844343-a0b5-4e78-b4ea-ec27c383744f", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8b844343-a0b5-4e78-b4ea-ec27c383744f", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8b844343-a0b5-4e78-b4ea-ec27c383744f", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "8b844343-a0b5-4e78-b4ea-ec27c383744f", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/metrics", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/metrics -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 7.631063461303711, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/metrics -> 401 (0.008s)
___________________ test_admin_system_status_endpoint_scope ____________________

client = <starlette.testclient.TestClient object at 0x11f425690>

    def test_admin_system_status_endpoint_scope(client):
        """Test that system status endpoints require admin:read or admin scope"""
        # Test with admin:read scope - should succeed
        token_read = _tok(["admin:read"])
        response = client.get("/v1/admin/system/status", headers={"Authorization": f"Bearer {token_read}"})
        assert response.status_code == 200

        # Test with admin scope - should succeed
        token_admin = _tok(["admin"])
        response = client.get("/v1/admin/system/status", headers={"Authorization": f"Bearer {token_admin}"})
>       assert response.status_code == 200
E       assert 403 == 200
E        +  where 403 = <Response [403 Forbidden]>.status_code

tests/test_admin_scope_granular.py:107: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "9b2086b8-fe64-4c4c-8d6c-1795f29ae020", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "9b2086b8-fe64-4c4c-8d6c-1795f29ae020", "status_code": 200, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/system/status", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/system/status -> 200 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 200, "duration_ms": 6.981849670410156}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "cef7cc27-a28d-4791-bde7-3a7127d3d538", "level": "WARNING", "component": "app.deps.scopes", "msg": "deny: missing_scope scope=<admin:read> available=<admin>", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "cef7cc27-a28d-4791-bde7-3a7127d3d538", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "cef7cc27-a28d-4791-bde7-3a7127d3d538", "status_code": 403, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin", "user_id": "test-user-123", "route": "/v1/admin/system/status", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/system/status -> 403 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "fd10a783c2576b17ccbbe7aa0f33e3d6", "status_code": 403, "duration_ms": 7.065057754516602, "error_code": "CLIENT_FORBIDDEN"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/system/status -> 200 (0.007s)
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
WARNING  app.deps.scopes:scopes.py:406 deny: missing_scope scope=<admin:read> available=<admin>
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/system/status -> 403 (0.007s)
_______________________ test_admin_flags_endpoint_scope ________________________

client = <starlette.testclient.TestClient object at 0x11f427150>

    def test_admin_flags_endpoint_scope(client):
        """Test that flags endpoint requires admin:read or admin scope"""
        # Test with admin:read scope - should succeed
        token_read = _tok(["admin:read"])
        response = client.get("/v1/admin/flags", headers={"Authorization": f"Bearer {token_read}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:120: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "4c80ff9c-5f09-482b-908f-809caf02968d", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "4c80ff9c-5f09-482b-908f-809caf02968d", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "4c80ff9c-5f09-482b-908f-809caf02968d", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "4c80ff9c-5f09-482b-908f-809caf02968d", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/flags", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/flags -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 7.9250335693359375, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/flags -> 401 (0.008s)
_______________________ test_admin_errors_endpoint_scope _______________________

client = <starlette.testclient.TestClient object at 0x11f5ebcd0>

    def test_admin_errors_endpoint_scope(client):
        """Test that errors endpoint requires admin:read or admin scope"""
        # Test with admin:read scope - should succeed
        token_read = _tok(["admin:read"])
        response = client.get("/v1/admin/errors", headers={"Authorization": f"Bearer {token_read}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:138: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "5c8c1201-e282-4bac-974b-aa5db47ca269", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "5c8c1201-e282-4bac-974b-aa5db47ca269", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "5c8c1201-e282-4bac-974b-aa5db47ca269", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "5c8c1201-e282-4bac-974b-aa5db47ca269", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/errors", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/errors -> 401 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 7.439851760864258, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/errors -> 401 (0.007s)
________________________ test_admin_tv_config_put_scope ________________________

client = <starlette.testclient.TestClient object at 0x11f242490>

    def test_admin_tv_config_put_scope(client):
        """Test that TV config PUT endpoint requires admin:write or admin scope"""
        test_data = {"config": {"theme": "dark"}}

        # Test with admin:write scope - should succeed
        token_write = _tok(["admin:write"])
        response = client.put("/v1/admin/tv/config", json=test_data, headers={"Authorization": f"Bearer {token_write}"})
>       assert response.status_code == 200
E       assert 405 == 200
E        +  where 405 = <Response [405 Method Not Allowed]>.status_code

tests/test_admin_scope_granular.py:158: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "2c69fb1d-1284-4281-ab1a-8dc81812dde5", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "2c69fb1d-1284-4281-ab1a-8dc81812dde5", "status_code": 405, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:write", "user_id": "test-user-123", "route": "/v1/admin/tv/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: PUT /v1/admin/tv/config -> 405 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "b2d50b37f217fca2f07052f7ca136e33", "status_code": 405, "duration_ms": 7.2040557861328125, "error_code": "CLIENT_METHOD_NOT_ALLOWED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: PUT /v1/admin/tv/config -> 405 (0.007s)
___________________ test_admin_vector_store_bootstrap_scope ____________________

client = <starlette.testclient.TestClient object at 0x11f72c7d0>

    def test_admin_vector_store_bootstrap_scope(client):
        """Test that vector store bootstrap requires admin:write or admin scope"""
        # Test with admin:write scope - should succeed
        token_write = _tok(["admin:write"])
        response = client.post("/v1/admin/vector_store/bootstrap", headers={"Authorization": f"Bearer {token_write}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:176: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8064cb3a-ec71-420c-9d6c-f194314f9e9d", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8064cb3a-ec71-420c-9d6c-f194314f9e9d", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8064cb3a-ec71-420c-9d6c-f194314f9e9d", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "8064cb3a-ec71-420c-9d6c-f194314f9e9d", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:write", "user_id": "test-user-123", "route": "/v1/admin/vector_store/bootstrap", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: POST /v1/admin/vector_store/bootstrap -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "b2d50b37f217fca2f07052f7ca136e33", "status_code": 401, "duration_ms": 7.747888565063477, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: POST /v1/admin/vector_store/bootstrap -> 401 (0.008s)
_______________________ test_user_profile_endpoint_scope _______________________

client = <starlette.testclient.TestClient object at 0x11f7a0fd0>

    def test_user_profile_endpoint_scope(client):
        """Test that user profile endpoint requires user:profile scope"""
        # Test with user:profile scope - should succeed
        token_profile = _tok(["user:profile"])
        response = client.get("/v1/admin/users/me", headers={"Authorization": f"Bearer {token_profile}"})
        assert response.status_code == 200

        # Test with admin scope - should succeed (admin can access user profile)
        token_admin = _tok(["admin"])
        response = client.get("/v1/admin/users/me", headers={"Authorization": f"Bearer {token_admin}"})
>       assert response.status_code == 200
E       assert 403 == 200
E        +  where 403 = <Response [403 Forbidden]>.status_code

tests/test_admin_scope_granular.py:199: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "3d966215-6b4b-43ac-954e-861e18b16ff4", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "3d966215-6b4b-43ac-954e-861e18b16ff4", "status_code": 200, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "user:profile", "user_id": "test-user-123", "route": "/v1/admin/users/me", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/users/me -> 200 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "40b91b618569de8ecb7489420ace030f", "status_code": 200, "duration_ms": 8.327960968017578}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8a6b0d4f-73b4-4e67-93c3-6d1f40f6b59f", "level": "WARNING", "component": "app.deps.scopes", "msg": "deny: missing_scope scope=<user:profile> available=<admin>", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "8a6b0d4f-73b4-4e67-93c3-6d1f40f6b59f", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "8a6b0d4f-73b4-4e67-93c3-6d1f40f6b59f", "status_code": 403, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin", "user_id": "test-user-123", "route": "/v1/admin/users/me", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/users/me -> 403 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "fd10a783c2576b17ccbbe7aa0f33e3d6", "status_code": 403, "duration_ms": 7.214069366455078, "error_code": "CLIENT_FORBIDDEN"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/users/me -> 200 (0.008s)
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
WARNING  app.deps.scopes:scopes.py:406 deny: missing_scope scope=<user:profile> available=<admin>
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/users/me -> 403 (0.007s)
_______________________ test_scope_combination_scenarios _______________________

client = <starlette.testclient.TestClient object at 0x11f73cd90>

    def test_scope_combination_scenarios(client):
        """Test various scope combination scenarios"""
        # Test multiple scopes including required one
        token_multi = _tok(["admin:read", "user:profile"])
        response = client.get("/v1/admin/config", headers={"Authorization": f"Bearer {token_multi}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:212: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "16cfe68c-b15f-47b1-9fd4-c3a43881f846", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "16cfe68c-b15f-47b1-9fd4-c3a43881f846", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "16cfe68c-b15f-47b1-9fd4-c3a43881f846", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "16cfe68c-b15f-47b1-9fd4-c3a43881f846", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "16cfe68c-b15f-47b1-9fd4-c3a43881f846", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read user:profile", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "d2e2aadd413ac786270546048a6960a8", "status_code": 401, "duration_ms": 8.271217346191406, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.008s)
___________________ test_scope_inheritance_admin_full_access ___________________

client = <starlette.testclient.TestClient object at 0x11f7b31d0>

    def test_scope_inheritance_admin_full_access(client):
        """Test that admin scope provides access to all admin endpoints"""
        token_admin = _tok(["admin"])

        # Test all admin endpoints with admin scope
        endpoints = [
            "/v1/admin/config",
            "/v1/admin/metrics",
            "/v1/admin/system/status",
            "/v1/admin/flags",
            "/v1/admin/errors"
        ]

        for endpoint in endpoints:
            response = client.get(endpoint, headers={"Authorization": f"Bearer {token_admin}"})
>           assert response.status_code == 200, f"Admin should access {endpoint}"
E           AssertionError: Admin should access /v1/admin/config
E           assert 401 == 200
E            +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:240: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "2302e4f8-064a-4681-bc71-c28c75f9f647", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "2302e4f8-064a-4681-bc71-c28c75f9f647", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "2302e4f8-064a-4681-bc71-c28c75f9f647", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "2302e4f8-064a-4681-bc71-c28c75f9f647", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "2302e4f8-064a-4681-bc71-c28c75f9f647", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "fd10a783c2576b17ccbbe7aa0f33e3d6", "status_code": 401, "duration_ms": 8.047819137573242, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.008s)
_____________________ test_scope_separation_read_vs_write ______________________

client = <starlette.testclient.TestClient object at 0x11ea44290>

    def test_scope_separation_read_vs_write(client):
        """Test that read and write scopes are properly separated"""
        # Test that admin:read allows reads but not writes
        token_read = _tok(["admin:read"])

        # Read operations should work
        read_endpoints = [
            "/v1/admin/config",
            "/v1/admin/metrics",
            "/v1/admin/system/status"
        ]

        for endpoint in read_endpoints:
            response = client.get(endpoint, headers={"Authorization": f"Bearer {token_read}"})
>           assert response.status_code == 200, f"admin:read should allow GET {endpoint}"
E           AssertionError: admin:read should allow GET /v1/admin/config
E           assert 401 == 200
E            +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:257: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "9b826542-5793-498b-8ba8-335edacae5b2", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "9b826542-5793-498b-8ba8-335edacae5b2", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "9b826542-5793-498b-8ba8-335edacae5b2", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "9b826542-5793-498b-8ba8-335edacae5b2", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "9b826542-5793-498b-8ba8-335edacae5b2", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 7.4748992919921875, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.007s)
________________________ test_malformed_token_handling _________________________

client = <starlette.testclient.TestClient object at 0x11f797e90>

    def test_malformed_token_handling(client):
        """Test that malformed tokens are properly rejected"""
        response = client.get("/v1/admin/config", headers={"Authorization": "Bearer malformed-token"})
        assert response.status_code == 401

        response = client.get("/v1/admin/config", headers={"Authorization": "NotBearer token"})
>       assert response.status_code == 401
E       assert 500 == 401
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/test_admin_scope_granular.py:297: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_auth_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "f910c381-6abf-42da-964f-e850563be29b", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "f910c381-6abf-42da-964f-e850563be29b", "level": "INFO", "component": "app.auth_monitoring", "msg": "Authentication event", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "f910c381-6abf-42da-964f-e850563be29b", "level": "WARNING", "component": "app.security", "msg": "deny: invalid_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "f910c381-6abf-42da-964f-e850563be29b", "level": "WARNING", "component": "app.security", "msg": "auth.unauthorized", "env": "", "build_sha": "", "version": "", "meta": {"reason": "unauthorized"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "f910c381-6abf-42da-964f-e850563be29b", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "f910c381-6abf-42da-964f-e850563be29b", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "258f0bff1dd3f1fdcafae527365787a4", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "84ae974e086a7c5acfae7914253b8b40", "status_code": 401, "duration_ms": 7.693052291870117, "error_code": "CLIENT_UNAUTHORIZED"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "3971c5d8-a89d-472d-bad1-95d810cfc5f1", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "ERROR", "component": "app.middleware.custom", "msg": "Request failed: GET /v1/admin/config -> NameError: name '_admin_token' is not defined", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "94a08da1fecbb6e8b46990538c7b50b2", "duration_ms": 6.0939788818359375, "error_type": "NameError", "error_message": "name '_admin_token' is not defined", "error_code": "SERVER_INTERNAL_ERROR_UNKNOWN"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:250 auth.invalid_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.auth_monitoring:auth_monitoring.py:95 Authentication event
WARNING  app.security:security.py:848 deny: invalid_token
WARNING  app.security:security.py:853 auth.unauthorized
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.008s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
ERROR    app.middleware.custom:custom.py:143 Request failed: GET /v1/admin/config -> NameError: name '_admin_token' is not defined
Traceback (most recent call last):
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 157, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/anyio/streams/memory.py", line 126, in receive
    raise EndOfStream from None
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/app/middleware/custom.py", line 113, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/custom.py", line 173, in dispatch
    return await _silent_refresh_fn(request, call_next)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 656, in silent_refresh_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/custom.py", line 181, in dispatch
    return await _reload_env_fn(request, call_next)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 789, in reload_env_middleware
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 56, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/session_attach.py", line 67, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/rate_limit.py", line 111, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/metrics_mw.py", line 41, in dispatch
    resp: Response = await call_next(request)
                     ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 158, in dispatch
    resp = await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/audit_mw.py", line 14, in dispatch
    resp = await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 341, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 186, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 231, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/middleware/middleware_core.py", line 100, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/api/admin.py", line 441, in admin_config
    _check_admin(token, request)
  File "/Users/kingal/2025/GesahniV2/app/api/admin.py", line 232, in _check_admin
    _tok = _admin_token()
           ^^^^^^^^^^^^
NameError: name '_admin_token' is not defined
_________________________ test_scope_case_sensitivity __________________________

client = <starlette.testclient.TestClient object at 0x128811f90>

    def test_scope_case_sensitivity(client):
        """Test that scope matching is case sensitive"""
        # Test with lowercase scopes (assuming our system is case-sensitive)
        token_lowercase = _tok(["admin:read"])
        response = client.get("/v1/admin/config", headers={"Authorization": f"Bearer {token_lowercase}"})
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_admin_scope_granular.py:305: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "274084c5-75d3-4932-bcd7-3761d1396239", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "274084c5-75d3-4932-bcd7-3761d1396239", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "274084c5-75d3-4932-bcd7-3761d1396239", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_clerk_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_clerk_token"}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "274084c5-75d3-4932-bcd7-3761d1396239", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "274084c5-75d3-4932-bcd7-3761d1396239", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": "admin:read", "user_id": "test-user-123", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:35Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.008s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "839482c54453bed87051b1f90f0d1f16", "status_code": 401, "duration_ms": 7.545948028564453, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:288 auth.invalid_clerk_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.008s)
______________________ test_audit_append_basic_structure _______________________

client = <starlette.testclient.TestClient object at 0x11f685390>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_basic_struct0/audit')

    def test_audit_append_basic_structure(client, tmp_audit_dir):
        """Test basic structure of audit events"""
        # Make a request
        response = client.get("/healthz")
        assert response.status_code == 200

        # Read audit file
        audit_file = get_audit_file_path()
        assert audit_file.exists()

        content = audit_file.read_text().strip()
        assert content, "Audit file should not be empty"

        lines = content.split('\n')
        assert len(lines) >= 1, "Should have at least one audit event"

        # Parse the last event
        last_event = json.loads(lines[-1])

        # Verify required fields
>       assert "ts" in last_event
E       AssertionError: assert 'ts' in {'action': 'http_request', 'data': {'method': 'GET', 'path': '/v1/google/auth/callback', 'route': 'google_callback', '...35', 'metadata': {'audit_version': '2.0', 'ip_address': 'testclient', 'request_id': '-', 'session_id': None, ...}, ...}

tests/test_audit_trail.py:65: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:38Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:38Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:38Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:38Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.86700439453125}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
______________________ test_audit_append_multiple_events _______________________

client = <starlette.testclient.TestClient object at 0x128ee7090>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_multiple_eve0/audit')

    def test_audit_append_multiple_events(client, tmp_audit_dir):
        """Test that multiple requests create multiple audit events"""
        # Make multiple requests
        client.get("/healthz")
        client.get("/v1/admin/metrics")
        client.post("/v1/admin/config", json={"test": "data"})

        # Read audit file
        audit_file = tmp_audit_dir / "events.ndjson"
>       content = audit_file.read_text().strip()
                  ^^^^^^^^^^^^^^^^^^^^^^

tests/test_audit_trail.py:86:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1058: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_multiple_eve0/audit/events.ndjson')
mode = 'r', buffering = -1, encoding = 'locale', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_multiple_eve0/audit/events.ndjson'

../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1044: FileNotFoundError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 6.026029586791992}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "ae9f8f3f-b19f-44c5-865e-18a7699cab10", "level": "WARNING", "component": "app.deps.scopes", "msg": "deny: missing_scope scope=<admin:read> reason=no_payload", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "ae9f8f3f-b19f-44c5-865e-18a7699cab10", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "ae9f8f3f-b19f-44c5-865e-18a7699cab10", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "anon", "route": "/v1/admin/metrics", "error_code": null}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/metrics -> 401 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 401, "duration_ms": 6.049871444702148, "error_code": "CLIENT_UNAUTHORIZED"}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d8b97f91-b45b-44f5-81b8-d6f74a5f0301", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "d8b97f91-b45b-44f5-81b8-d6f74a5f0301", "status_code": 405, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "anon", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: POST /v1/admin/config -> 405 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 405, "duration_ms": 5.728006362915039, "error_code": "CLIENT_METHOD_NOT_ALLOWED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
WARNING  app.deps.scopes:scopes.py:400 deny: missing_scope scope=<admin:read> reason=no_payload
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/metrics -> 401 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: POST /v1/admin/config -> 405 (0.006s)
_____________________ test_audit_append_with_error_status ______________________

client = <starlette.testclient.TestClient object at 0x128a91290>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_with_error_s0/audit')

    def test_audit_append_with_error_status(client, tmp_audit_dir):
        """Test audit logging for error responses"""
        # Make a request that will result in an error
        response = client.get("/nonexistent-endpoint")
>       assert response.status_code == 404
E       assert 405 == 404
E        +  where 405 = <Response [405 Method Not Allowed]>.status_code

tests/test_audit_trail.py:105: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "e46ecbb1-9369-4c38-a45b-cb3e466c1958", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "e46ecbb1-9369-4c38-a45b-cb3e466c1958", "status_code": 405, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "anon", "route": "/nonexistent-endpoint", "error_code": null}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /nonexistent-endpoint -> 405 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 405, "duration_ms": 6.3991546630859375, "error_code": "CLIENT_METHOD_NOT_ALLOWED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /nonexistent-endpoint -> 405 (0.006s)
_____________________ test_audit_append_preserves_history ______________________

client = <starlette.testclient.TestClient object at 0x128bd7350>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_preserves_hi0/audit')

    def test_audit_append_preserves_history(client, tmp_audit_dir):
        """Test that audit file preserves history across requests"""
        # Make first request
        client.get("/healthz")
        audit_file = tmp_audit_dir / "events.ndjson"
>       content1 = audit_file.read_text().strip()
                   ^^^^^^^^^^^^^^^^^^^^^^

tests/test_audit_trail.py:128:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1058: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_preserves_hi0/audit/events.ndjson')
mode = 'r', buffering = -1, encoding = 'locale', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_preserves_hi0/audit/events.ndjson'

../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1044: FileNotFoundError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.342245101928711}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
______________________ test_audit_append_timestamp_format ______________________

client = <starlette.testclient.TestClient object at 0x128f17650>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_timestamp_fo0/audit')

    def test_audit_append_timestamp_format(client, tmp_audit_dir):
        """Test that timestamps are in proper ISO format"""
        import re

        client.get("/healthz")

        audit_file = tmp_audit_dir / "events.ndjson"
>       content = audit_file.read_text().strip()
                  ^^^^^^^^^^^^^^^^^^^^^^

tests/test_audit_trail.py:147:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1058: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_timestamp_fo0/audit/events.ndjson')
mode = 'r', buffering = -1, encoding = 'locale', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_timestamp_fo0/audit/events.ndjson'

../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1044: FileNotFoundError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.898786544799805}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
__________________ test_audit_append_includes_request_details __________________

client = <starlette.testclient.TestClient object at 0x128dd2750>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_includes_req0/audit')

    def test_audit_append_includes_request_details(client, tmp_audit_dir):
        """Test that audit events include detailed request information"""
        # Make a request with specific characteristics
        response = client.get("/v1/admin/metrics?param=test")
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_audit_trail.py:161: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "37747c8b-a4a3-4bfa-8616-a599981a2dfe", "level": "WARNING", "component": "app.deps.scopes", "msg": "deny: missing_scope scope=<admin:read> reason=no_payload", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "37747c8b-a4a3-4bfa-8616-a599981a2dfe", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "37747c8b-a4a3-4bfa-8616-a599981a2dfe", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "anon", "route": "/v1/admin/metrics", "error_code": null}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/metrics -> 401 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 401, "duration_ms": 6.430149078369141, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
WARNING  app.deps.scopes:scopes.py:400 deny: missing_scope scope=<admin:read> reason=no_payload
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/metrics -> 401 (0.006s)
____________________ test_audit_append_with_authentication _____________________

client = <starlette.testclient.TestClient object at 0x128f0bd50>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_with_authent0/audit')

    def test_audit_append_with_authentication(client, tmp_audit_dir):
        """Test audit logging with authentication context"""
        # This would need a valid token in a real scenario
        # For now, test with invalid token to see auth-related fields
        response = client.get("/v1/admin/config", headers={"Authorization": "Bearer invalid-token"})

        audit_file = tmp_audit_dir / "events.ndjson"
>       content = audit_file.read_text().strip()
                  ^^^^^^^^^^^^^^^^^^^^^^

tests/test_audit_trail.py:181:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1058: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_with_authent0/audit/events.ndjson')
mode = 'r', buffering = -1, encoding = 'locale', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_with_authent0/audit/events.ndjson'

../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1044: FileNotFoundError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.deps.user", "msg": "auth.invalid_token", "env": "", "build_sha": "", "version": "", "meta": {"reason": "invalid_auth_token"}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "level": "INFO", "component": "app.security", "msg": "auth.token_source", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "level": "INFO", "component": "app.auth_monitoring", "msg": "Authentication event", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "level": "WARNING", "component": "app.security", "msg": "deny: invalid_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "level": "WARNING", "component": "app.security", "msg": "auth.unauthorized", "env": "", "build_sha": "", "version": "", "meta": {"reason": "unauthorized"}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "level": "INFO", "component": "app.middleware.middleware_core", "msg": "request_summary", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "d07ae000-c897-42a1-b9ef-3406c4be87e3", "status_code": 401, "latency_ms": null, "router_decision": null, "model_used": null, "reason": null, "rule": null, "tokens_in": null, "tokens_out": null, "retrieved_tokens": null, "self_check": null, "escalated": null, "cache_hit": null, "limit_bucket": {"long_limit": 60, "long_remaining": 60, "burst_limit": 10, "burst_remaining": 10}, "requests_remaining": 60, "enforced_scope": null, "user_id": "1e91b84fbd4d3db0804ba6dfac672d48", "route": "/v1/admin/config", "error_code": null}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /v1/admin/config -> 401 (0.007s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "43568fa3f8f2c90181bfd1364f49b164", "status_code": 401, "duration_ms": 6.842851638793945, "error_code": "CLIENT_UNAUTHORIZED"}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:128 auth.token_source
WARNING  app.deps.user:user.py:250 auth.invalid_token
INFO     app.security:security.py:741 auth.token_source
INFO     app.auth_monitoring:auth_monitoring.py:95 Authentication event
WARNING  app.security:security.py:848 deny: invalid_token
WARNING  app.security:security.py:853 auth.unauthorized
INFO     app.middleware.middleware_core:middleware_core.py:463 request_summary
INFO     app.middleware.custom:custom.py:131 Request completed: GET /v1/admin/config -> 401 (0.007s)
______________________ test_audit_append_file_permissions ______________________

client = <starlette.testclient.TestClient object at 0x128f69310>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_file_permiss0/audit')

    def test_audit_append_file_permissions(client, tmp_audit_dir):
        """Test that audit file has appropriate permissions"""
        client.get("/healthz")

        audit_file = tmp_audit_dir / "events.ndjson"
>       assert audit_file.exists()
E       AssertionError: assert False
E        +  where False = exists()
E        +    where exists = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_file_permiss0/audit/events.ndjson').exists

tests/test_audit_trail.py:196: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.899024963378906}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
_____________________ test_audit_append_concurrent_access ______________________

client = <starlette.testclient.TestClient object at 0x128f55810>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_concurrent_a0/audit')

    def test_audit_append_concurrent_access(client, tmp_audit_dir):
        """Test audit file handling under concurrent access"""
        import threading
        import concurrent.futures

        def make_request():
            return client.get("/healthz")

        # Make concurrent requests
        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            futures = [executor.submit(make_request) for _ in range(10)]
            responses = [f.result() for f in concurrent.futures.as_completed(futures)]

        # All should succeed
        assert all(r.status_code == 200 for r in responses)

        # Check audit file
        audit_file = get_audit_file_path()
        content = audit_file.read_text().strip()
        lines = content.split('\n')

        # Should have all events
        assert len(lines) >= 10, f"Expected at least 10 audit events, got {len(lines)}"

        # All should be valid JSON
        events = [json.loads(line) for line in lines]
>       assert all(event["action"] == "http_request" for event in events)
E       assert False
E        +  where False = all(<generator object test_audit_append_concurrent_access.<locals>.<genexpr> at 0x129175be0>)

tests/test_audit_trail.py:232: AssertionError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.019s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 18.949031829833984}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.020s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 19.90199089050293}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.022s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 22.11785316467285}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.020s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 20.102739334106445}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.021s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 21.39592170715332}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.017s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 17.370223999023438}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.014s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 14.462947845458984}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.019s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 19.324302673339844}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.020s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 19.593000411987305}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.018s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 17.5931453704834}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.019s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.020s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.022s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.020s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.021s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.017s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.014s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.019s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.020s)
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.018s)
___________________ test_audit_append_file_rotation_scenario ___________________

client = <starlette.testclient.TestClient object at 0x128f54650>
tmp_audit_dir = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_file_rotatio0/audit')

    def test_audit_append_file_rotation_scenario(client, tmp_audit_dir):
        """Test audit file behavior (in a real system, this would test log rotation)"""
        # Make many requests to simulate file growth
        for i in range(100):
            client.get("/healthz")

        audit_file = tmp_audit_dir / "events.ndjson"
>       content = audit_file.read_text().strip()
                  ^^^^^^^^^^^^^^^^^^^^^^

tests/test_audit_trail.py:242:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1058: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_file_rotatio0/audit/events.ndjson')
mode = 'r', buffering = -1, encoding = 'locale', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-3/test_audit_append_file_rotatio0/audit/events.ndjson'

../../.pyenv/versions/3.11.9/lib/python3.11/pathlib.py:1044: FileNotFoundError
---------------------------- Captured stderr setup -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "WARNING", "component": "app.memory.unified_store", "msg": "VECTOR_STORE is deprecated, use VECTOR_DSN instead", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.memory.unified_store", "msg": "Using MemoryVectorStore", "env": "", "build_sha": "", "version": ""}
------------------------------ Captured log setup ------------------------------
WARNING  app.memory.unified_store:unified_store.py:89 VECTOR_STORE is deprecated, use VECTOR_DSN instead
INFO     app.memory.unified_store:unified_store.py:131 Using MemoryVectorStore
----------------------------- Captured stderr call -----------------------------
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.223274230957031}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.826068878173828}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.391908645629883}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.7817230224609375}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.344701766967773}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.415273666381836}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.463911056518555}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.513978958129883}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.613161087036133}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.689931869506836}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.41288948059082}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.585981369018555}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.784107208251953}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.506826400756836}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.422187805175781}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.665851593017578}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.6062469482421875}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.427194595336914}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.450082778930664}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.699945449829102}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.846096038818359}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.91786003112793}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.5928955078125}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.550933837890625}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.756927490234375}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.732847213745117}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.559993743896484}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.554033279418945}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.689216613769531}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.513025283813477}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.442930221557617}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.18798828125}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.256891250610352}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.848884582519531}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 6.073951721191406}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.637884140014648}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.013942718505859}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.761934280395508}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.1746368408203125}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.036830902099609}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.670143127441406}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.584312438964844}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.624128341674805}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.537820816040039}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.622220993041992}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.804134368896484}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.102872848510742}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.524158477783203}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 6.006956100463867}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.8727264404296875}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 6.063699722290039}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.084037780761719}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.8198699951171875}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.616975784301758}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.741191864013672}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.750967025756836}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.66609001159668}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.678964614868164}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.472017288208008}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.004s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.462957382202148}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.626750946044922}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.953145980834961}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.621028900146484}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.94694709777832}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.565954208374023}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.626750946044922}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.60505485534668}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.607915878295898}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.5490264892578125}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.000829696655273}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.517793655395508}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.016803741455078}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.80198860168457}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.637956619262695}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.927873611450195}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.325794219970703}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.787921905517578}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.707813262939453}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.243062973022461}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.533052444458008}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.775047302246094}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.902839660644531}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.460023880004883}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.84466552734375}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.093812942504883}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.672050476074219}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.523992538452148}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.614830017089844}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.959821701049805}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.952907562255859}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.733085632324219}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.179882049560547}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.399942398071289}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.44285774230957}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.863977432250977}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.784822463989258}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.823207855224609}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.006s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.814075469970703}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 5.047082901000977}}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.deps.user", "msg": "auth.no_token", "env": "", "build_sha": "", "version": ""}
{"timestamp": "2025-08-22T08:06:39Z", "req_id": "-", "level": "INFO", "component": "app.middleware.custom", "msg": "Request completed: GET /healthz -> 200 (0.005s)", "env": "", "build_sha": "", "version": "", "meta": {"req_id": "-", "route": null, "user_anon": "local", "status_code": 200, "duration_ms": 4.899024963378906}}
------------------------------ Captured log call -------------------------------
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.004s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.006s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
INFO     app.deps.user:user.py:135 auth.no_token
INFO     app.middleware.custom:custom.py:131 Request completed: GET /healthz -> 200 (0.005s)
=============================== warnings summary ===============================
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/chromadb/api/collection_configuration.py:347
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/chromadb/api/collection_configuration.py:347
  /Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/chromadb/api/collection_configuration.py:347: DeprecationWarning: legacy embedding function config: '_LengthEmbedder' object has no attribute 'is_legacy'
    return json.dumps(create_collection_configuration_to_json(config))

../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323
  /Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_generate_schema.py:298
  /Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/pydantic/_internal/_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/passlib/utils/__init__.py:854
  /Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

app/transcribe.py:7
  /Users/kingal/2025/GesahniV2/app/transcribe.py:7: DeprecationWarning: 'audioop' is deprecated and slated for removal in Python 3.13
    import audioop  # type: ignore

app/main.py:1206
  /Users/kingal/2025/GesahniV2/app/main.py:1206: DeprecationWarning: `example` has been deprecated, please use `examples` instead
    from .api.care import router as care_router

../../.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/testclient.py:454
  /Users/kingal/.pyenv/versions/3.11.9/lib/python3.11/site-packages/starlette/testclient.py:454: DeprecationWarning: The `allow_redirects` argument is deprecated. Use `follow_redirects` instead.
    warnings.warn(message, DeprecationWarning)

tests/integration/test_refresh_concurrent.py:8
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_concurrent.py:8: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:26
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:26: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:52
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:52: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:77
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:77: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:103
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:103: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:132
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:132: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:158
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:158: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:192
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:192: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_race_condition_fix.py:220
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_race_condition_fix.py:220: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

tests/integration/test_refresh_replay.py:13
  /Users/kingal/2025/GesahniV2/tests/integration/test_refresh_replay.py:13: PytestUnknownMarkWarning: Unknown pytest.mark.contract - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.contract

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_admin_scope_granular.py::test_admin_read_requires_read_or_admin_scope
FAILED tests/test_admin_scope_granular.py::test_admin_write_requires_write_or_admin_scope
FAILED tests/test_admin_scope_granular.py::test_admin_metrics_endpoint_scope
FAILED tests/test_admin_scope_granular.py::test_admin_system_status_endpoint_scope
FAILED tests/test_admin_scope_granular.py::test_admin_flags_endpoint_scope - ...
FAILED tests/test_admin_scope_granular.py::test_admin_errors_endpoint_scope
FAILED tests/test_admin_scope_granular.py::test_admin_tv_config_put_scope - a...
FAILED tests/test_admin_scope_granular.py::test_admin_vector_store_bootstrap_scope
FAILED tests/test_admin_scope_granular.py::test_user_profile_endpoint_scope
FAILED tests/test_admin_scope_granular.py::test_scope_combination_scenarios
FAILED tests/test_admin_scope_granular.py::test_scope_inheritance_admin_full_access
FAILED tests/test_admin_scope_granular.py::test_scope_separation_read_vs_write
FAILED tests/test_admin_scope_granular.py::test_malformed_token_handling - as...
FAILED tests/test_admin_scope_granular.py::test_scope_case_sensitivity - asse...
FAILED tests/test_audit_trail.py::test_audit_append_basic_structure - Asserti...
FAILED tests/test_audit_trail.py::test_audit_append_multiple_events - FileNot...
FAILED tests/test_audit_trail.py::test_audit_append_with_error_status - asser...
FAILED tests/test_audit_trail.py::test_audit_append_preserves_history - FileN...
FAILED tests/test_audit_trail.py::test_audit_append_timestamp_format - FileNo...
FAILED tests/test_audit_trail.py::test_audit_append_includes_request_details
FAILED tests/test_audit_trail.py::test_audit_append_with_authentication - Fil...
FAILED tests/test_audit_trail.py::test_audit_append_file_permissions - Assert...
FAILED tests/test_audit_trail.py::test_audit_append_concurrent_access - asser...
FAILED tests/test_audit_trail.py::test_audit_append_file_rotation_scenario - ...
