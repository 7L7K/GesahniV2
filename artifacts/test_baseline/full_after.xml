<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="90" failures="1033" skipped="6" tests="2335" time="158.289" timestamp="2025-09-02T21:13:10.619539-04:00" hostname="MacBook-Pro-2.local"><testcase classname="frontend.final_google_test" name="test_complete_google_flow" time="0.016" /><testcase classname="test_asyncio_mode" name="test_async_function_without_decorator" time="0.104" /><testcase classname="test_asyncio_mode" name="test_with_async_fixture" time="0.103" /><testcase classname="test_complete_oauth_flow" name="test_oauth_flow" time="0.012" /><testcase classname="test_complete_oauth_flow" name="test_manual_oauth_callback" time="0.001" /><testcase classname="test_credentials_simulation" name="test_scenarios" time="0.004" /><testcase classname="test_credentials_simulation" name="test_real_world_scenario" time="0.002" /><testcase classname="test_csrf_cors_fix" name="test_csrf_cross_site_validation" time="0.001" /><testcase classname="test_csrf_cors_fix" name="test_cors_middleware" time="0.003" /><testcase classname="test_csrf_cors_fix" name="test_csrf_enforcement" time="0.002" /><testcase classname="test_enhanced_logging" name="test_successful_token_exchange_logging" time="0.005" /><testcase classname="test_enhanced_logging" name="test_error_token_exchange_logging" time="0.003" /><testcase classname="test_frontend_backend_oauth" name="test_backend_oauth_endpoints" time="0.004" /><testcase classname="test_frontend_backend_oauth" name="test_frontend_api_integration" time="0.003" /><testcase classname="test_frontend_backend_oauth" name="test_oauth_callback_simulation" time="0.004" /><testcase classname="test_frontend_backend_oauth" name="test_integration_endpoints" time="0.003" /><testcase classname="test_frontend_backend_oauth" name="test_frontend_health_endpoints" time="0.003" /><testcase classname="test_google_oauth_setup" name="test_google_oauth_config" time="0.004" /><testcase classname="test_google_oauth_simple" name="test_endpoints" time="0.004" /><testcase classname="test_google_oauth_simple" name="test_oauth_flow" time="0.003" /><testcase classname="test_missing_iss_simulation" name="test_scenarios" time="0.002" /><testcase classname="test_missing_iss_simulation" name="test_edge_cases" time="0.001" /><testcase classname="test_oauth_fix" name="test_exchange_code_preserves_id_token" time="0.004" /><testcase classname="test_oauth_fix" name="test_callback_id_token_extraction" time="0.001" /><testcase classname="test_oauth_scopes" name="test_google_scopes" time="0.002" /><testcase classname="test_oauth_scopes" name="test_oauth_flow_simulation" time="0.001" /><testcase classname="test_rate_limit_disabled" name="test_rate_limit_disabled" time="0.227" /><testcase classname="test_spotify_callback" name="test_spotify_callback" time="0.006" /><testcase classname="test_spotify_integrations_status" name="test_spotify_integrations_status_no_token" time="0.037" /><testcase classname="test_spotify_integrations_status" name="test_spotify_integrations_status_with_token" time="0.037" /><testcase classname="test_spotify_integrations_status" name="test_spotify_integrations_status_expired_token" time="0.033" /><testcase classname="test_spotify_integrations_status" name="test_spotify_integrations_status_recently_refreshed" time="0.036" /><testcase classname="test_spotify_internal" name="test_callback_internal" time="0.711" /><testcase classname="test_token_refresh_manual" name="test_manual_token_refresh" time="0.041" /><testcase classname="test_user_data_saving" name="test_user_data_extraction" time="0.002" /><testcase classname="test_user_data_saving" name="test_user_data_saving" time="0.002" /><testcase classname="test_user_data_saving" name="test_user_authentication_simulation" time="0.002" /><testcase classname="test_user_data_saving" name="test_complete_user_journey" time="0.001" /><testcase classname="tests.google.test_callback_and_status" name="test_callback_redirects_303_and_clears_cookies[303]" time="0.015"><failure message="assert 404 in (302, 303)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/google/test_callback_and_status.py:31: in test_callback_redirects_303_and_clears_cookies
    assert resp.status_code in (302, 303)
E   assert 404 in (302, 303)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.google.test_callback_and_status" name="test_status_refreshed_flag" time="0.004"><failure message="assert 404 in (200, 401)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/google/test_callback_and_status.py:56: in test_status_refreshed_flag
    assert resp.status_code in (200, 401)
E   assert 404 in (200, 401)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.google.test_http_exchange" name="test_exchange_success" time="0.002" /><testcase classname="tests.google.test_http_exchange" name="test_exchange_invalid_grant" time="0.002" /><testcase classname="tests.google.test_http_exchange" name="test_exchange_timeout" time="0.002" /><testcase classname="tests.google.test_refresh_dedup" name="test_refresh_dedup_concurrency" time="0.013" /><testcase classname="tests.integration.test_ask_router_contract" name="test_ask_returns_503_when_router_missing" time="3.197"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: in pytest_fixture_setup
    hook_result = yield
                  ^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.integration.test_ask_router_contract" name="test_ask_returns_503_when_router_raises" time="0.000"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.integration.test_ask_router_contract" name="test_ask_returns_200_when_router_works" time="0.000"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.integration.test_auth_cookie_parity" name="test_classic_login_sets_cookies_on_final_response" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_auth_cookie_parity.py:44: in test_classic_login_sets_cookies_on_final_response
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_auth_cookie_parity" name="test_oauth_callback_sets_cookies_on_callback_response_single_hop" time="0.005"><failure message="assert 404 in (&lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.TEMPORARY_REDIRECT: 307&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_auth_cookie_parity.py:95: in test_oauth_callback_sets_cookies_on_callback_response_single_hop
    assert r.status_code in (HTTPStatus.FOUND, HTTPStatus.TEMPORARY_REDIRECT)
E   assert 404 in (&lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.TEMPORARY_REDIRECT: 307&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_auth_cookie_parity" name="test_oauth_cross_site_uses_finisher_then_redirects" time="0.005"><failure message="assert 404 == &lt;HTTPStatus.FOUND: 302&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.FOUND: 302&gt; = HTTPStatus.FOUND">tests/integration/test_auth_cookie_parity.py:127: in test_oauth_cross_site_uses_finisher_then_redirects
    assert r1.status_code == HTTPStatus.FOUND
E   assert 404 == &lt;HTTPStatus.FOUND: 302&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.FOUND: 302&gt; = HTTPStatus.FOUND</failure></testcase><testcase classname="tests.integration.test_auth_integration" name="test_csrf_enforcement_on_login" time="0.096"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_auth_integration.py:33: in test_csrf_enforcement_on_login
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_auth_integration" name="test_backoff_sleep_in_login" time="0.004"><failure message="assert 404 in (200, 409)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_auth_integration.py:54: in test_backoff_sleep_in_login
    assert register_resp.status_code in (200, 409)
E   assert 404 in (200, 409)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_whoami_with_bearer_token" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_bearer_auth_end_to_end.py:31: in test_whoami_with_bearer_token
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_protected_endpoint_with_bearer_token" time="0.004" /><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_cors_preflight_with_authorization_header" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_bearer_auth_end_to_end.py:60: in test_cors_preflight_with_authorization_header
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_csrf_bypass_for_api_endpoints" time="0.004" /><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_scope_enforcement_integration" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_bearer_auth_end_to_end.py:109: in test_scope_enforcement_integration
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_invalid_token_handling" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_bearer_auth_end_to_end.py:126: in test_invalid_token_handling
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_missing_token_anonymous_access" time="0.004"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_bearer_auth_end_to_end.py:140: in test_missing_token_anonymous_access
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_bearer_auth_end_to_end.TestBearerAuthEndToEnd" name="test_websocket_with_bearer_token" time="0.002" /><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_login_cookies_consistency" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:51: in test_login_cookies_consistency
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_refresh_cookies_consistency" time="0.006" /><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_logout_cookies_consistency" time="0.006"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:147: in test_logout_cookies_consistency
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_google_oauth_cookies_consistency" time="0.008"><failure message="assert 404 in [302, 200]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:188: in test_google_oauth_cookies_consistency
    assert response.status_code in [302, 200]
E   assert 404 in [302, 200]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_device_trust_cookies_consistency" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:220: in test_device_trust_cookies_consistency
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_no_redirects_before_cookies" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:252: in test_no_redirects_before_cookies
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_cookie_ttl_consistency" time="0.006" /><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_dev_mode_cookie_secure" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:332: in test_dev_mode_cookie_secure
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_production_cookie_secure" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:358: in test_production_cookie_secure
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_consistency.TestCookieConsistency" name="test_centralized_cookie_configuration" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_consistency.py:384: in test_centralized_cookie_configuration
    assert login_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_eviction_stress" name="test_cookie_eviction_stress" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_eviction_stress.py:16: in test_cookie_eviction_stress
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND, HTTPStatus.UNAUTHORIZED)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_priority_fallback" name="test_cookie_priority_fallback" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_priority_fallback.py:21: in test_cookie_priority_fallback
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_priority_flags" name="test_cookie_priority_flags_after_login" time="0.006"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_priority_flags.py:14: in test_cookie_priority_flags_after_login
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cookie_priority_pressure" name="test_cookie_pressure_priority" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cookie_priority_pressure.py:13: in test_cookie_pressure_priority
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCORSConfiguration" name="test_cors_headers_present" time="0.007"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_csrf_fetch_integration.py:23: in test_cors_headers_present
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCORSConfiguration" name="test_cors_credentials_allowed" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_csrf_fetch_integration.py:42: in test_cors_credentials_allowed
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCORSConfiguration" name="test_cors_origin_validation" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_csrf_fetch_integration.py:57: in test_cors_origin_validation
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCSRFProtection" name="test_csrf_disabled_by_default" time="0.006" /><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCSRFProtection" name="test_csrf_enabled_blocks_missing_token" time="0.005"><failure message="assert 404 in [400, 403]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cors_csrf_fetch_integration.py:97: in test_csrf_enabled_blocks_missing_token
    assert response.status_code in [400, 403]
E   assert 404 in [400, 403]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCSRFProtection" name="test_csrf_oauth_callback_bypass" time="0.006" /><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCSRFProtection" name="test_csrf_double_submit_pattern" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cors_csrf_fetch_integration.py:112: in test_csrf_double_submit_pattern
    assert csrf_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestFetchCredentials" name="test_fetch_credentials_documented" time="0.001" /><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCORSHeadersExposure" name="test_sensitive_headers_not_exposed" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_csrf_fetch_integration.py:151: in test_sensitive_headers_not_exposed
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestCORSHeadersExposure" name="test_only_necessary_headers_exposed" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_csrf_fetch_integration.py:168: in test_only_necessary_headers_exposed
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestEnvironmentConfiguration" name="test_cors_environment_variables" time="0.002" /><testcase classname="tests.integration.test_cors_csrf_fetch_integration.TestEnvironmentConfiguration" name="test_csrf_environment_variables" time="0.001" /><testcase classname="tests.integration.test_cors_preflight" name="test_global_preflight_headers" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_preflight.py:20: in test_global_preflight_headers
    r = _preflight(client, p)
        ^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_cors_preflight.py:7: in _preflight
    return client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_preflight" name="test_preflight_no_rate_limit_headers" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_preflight.py:38: in test_preflight_no_rate_limit_headers
    r = _preflight(client, p)
        ^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_cors_preflight.py:7: in _preflight
    return client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_preflight" name="test_preflight_no_auth_headers" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_preflight.py:53: in test_preflight_no_auth_headers
    r = _preflight(client, p)
        ^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_cors_preflight.py:7: in _preflight
    return client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_preflight" name="test_preflight_cors_headers_present" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/integration/test_cors_preflight.py:68: in test_preflight_cors_headers_present
    r = _preflight(client, p)
        ^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_cors_preflight.py:7: in _preflight
    return client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.integration.test_cors_preflight" name="test_regular_request_cors_headers" time="0.004"><failure message="AssertionError: assert None == 'http://localhost:3000'&#10; +  where None = &lt;built-in method get of dict object at 0x11f1819c0&gt;('access-control-allow-origin')&#10; +    where &lt;built-in method get of dict object at 0x11f1819c0&gt; = {'content-length': '227', 'content-type': 'application/json', 'x-error-code': 'not_found'}.get">tests/integration/test_cors_preflight.py:98: in test_regular_request_cors_headers
    assert h.get("access-control-allow-origin") == "http://localhost:3000"
E   AssertionError: assert None == 'http://localhost:3000'
E    +  where None = &lt;built-in method get of dict object at 0x11f1819c0&gt;('access-control-allow-origin')
E    +    where &lt;built-in method get of dict object at 0x11f1819c0&gt; = {'content-length': '227', 'content-type': 'application/json', 'x-error-code': 'not_found'}.get</failure></testcase><testcase classname="tests.integration.test_cross_site_secure_flags" name="test_cross_site_secure_flags" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_cross_site_secure_flags.py:14: in test_cross_site_secure_flags
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_same_origin_validation" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_cross_site_scenarios.py:23: in test_csrf_same_origin_validation
    assert csrf_resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_cross_site_validation" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_cross_site_scenarios.py:48: in test_csrf_cross_site_validation
    assert csrf_resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_cross_site_missing_token" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_cross_site_scenarios.py:75: in test_csrf_cross_site_missing_token
    assert refresh_resp.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_cross_site_missing_intent" time="0.003"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:88: in test_csrf_cross_site_missing_intent
    csrf_token = csrf_resp.json()["csrf_token"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_cross_site_invalid_token_format" time="0.005"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_cross_site_scenarios.py:110: in test_csrf_cross_site_invalid_token_format
    assert refresh_resp.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_same_origin_missing_cookie" time="0.004"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:123: in test_csrf_same_origin_missing_cookie
    csrf_token = csrf_resp.json()["csrf_token"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_same_origin_mismatch" time="0.003"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:143: in test_csrf_same_origin_mismatch
    csrf_token = csrf_resp.json()["csrf_token"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_disabled_behavior" time="0.004"><failure message="assert 404 in [401, 403]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_cross_site_scenarios.py:166: in test_csrf_disabled_behavior
    assert refresh_resp.status_code in [401, 403]  # Auth error, not CSRF error
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in [401, 403]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_middleware_cross_site_validation" time="0.003"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:178: in test_csrf_middleware_cross_site_validation
    csrf_token = csrf_resp.json()["csrf_token"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_middleware_same_origin_validation" time="0.005"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:203: in test_csrf_middleware_same_origin_validation
    csrf_token = csrf_resp.json()["csrf_token"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_cross_site_scenarios" name="test_csrf_cross_site_server_side_validation" time="0.004"><failure message="KeyError: 'csrf_token'">tests/integration/test_csrf_cross_site_scenarios.py:230: in test_csrf_cross_site_server_side_validation
    valid_token = csrf_resp.json()["csrf_token"]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'csrf_token'</failure></testcase><testcase classname="tests.integration.test_csrf_enabled_globally" name="test_csrf_enabled_globally" time="0.003"><failure message="assert 404 in {&lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.FORBIDDEN: 403&gt;}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_csrf_enabled_globally.py:14: in test_csrf_enabled_globally
    assert r.status_code in {HTTPStatus.FORBIDDEN, HTTPStatus.BAD_REQUEST}
E   assert 404 in {&lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.FORBIDDEN: 403&gt;}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_csrf_grace_period_warns" name="test_csrf_grace_period_warns" time="0.005"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_csrf_grace_period_warns.py:14: in test_csrf_grace_period_warns
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_csrf_missing_cookie" name="test_csrf_missing_cookie" time="0.004"><failure message="assert 404 == &lt;HTTPStatus.FORBIDDEN: 403&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.FORBIDDEN: 403&gt; = HTTPStatus.FORBIDDEN">tests/integration/test_csrf_missing_cookie.py:14: in test_csrf_missing_cookie
    assert r.status_code == HTTPStatus.FORBIDDEN
E   assert 404 == &lt;HTTPStatus.FORBIDDEN: 403&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.FORBIDDEN: 403&gt; = HTTPStatus.FORBIDDEN</failure></testcase><testcase classname="tests.integration.test_csrf_profile" name="test_profile_mutation_requires_csrf" time="0.004"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_csrf_profile.py:16: in test_profile_mutation_requires_csrf
    assert cr.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_csrf_standard_header" name="test_csrf_standard_header" time="0.004"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_csrf_standard_header.py:16: in test_csrf_standard_header
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_csrf_standard_header" name="test_csrf_legacy_header_blocked" time="0.005"><failure message="assert 404 == &lt;HTTPStatus.BAD_REQUEST: 400&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.BAD_REQUEST: 400&gt; = HTTPStatus.BAD_REQUEST">tests/integration/test_csrf_standard_header.py:25: in test_csrf_legacy_header_blocked
    assert r.status_code == HTTPStatus.BAD_REQUEST
E   assert 404 == &lt;HTTPStatus.BAD_REQUEST: 400&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.BAD_REQUEST: 400&gt; = HTTPStatus.BAD_REQUEST</failure></testcase><testcase classname="tests.integration.test_logout_cookie_clear" name="test_logout_clears_and_blocks_refresh" time="0.005"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_logout_cookie_clear.py:13: in test_logout_clears_and_blocks_refresh
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_oauth_finisher_refresh" name="test_oauth_finisher_refresh_requires_intent_in_none_mode" time="0.005"><failure message="assert 404 in {&lt;HTTPStatus.NO_CONTENT: 204&gt;, &lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_oauth_finisher_refresh.py:16: in test_oauth_finisher_refresh_requires_intent_in_none_mode
    assert r1.status_code in {
E   assert 404 in {&lt;HTTPStatus.NO_CONTENT: 204&gt;, &lt;HTTPStatus.FOUND: 302&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_oauth_logging_integration.TestOAuthLoggingIntegration" name="test_oauth_login_url_logging_integration" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_oauth_logging_integration.py:43: in test_oauth_login_url_logging_integration
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_oauth_logging_integration.TestOAuthLoggingIntegration" name="test_whoami_logging_integration" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_oauth_logging_integration.py:87: in test_whoami_logging_integration
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_oauth_logging_integration.TestOAuthLoggingIntegration" name="test_oauth_callback_failure_logging_integration" time="0.002"><failure message="AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'">tests/integration/test_oauth_logging_integration.py:125: in test_oauth_callback_failure_logging_integration
    with patch("app.api.google_oauth._verify_signed_state", return_value=True):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_text_vs_messages_normalization[none]" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:40: in test_text_vs_messages_normalization
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_text_vs_messages_normalization[hybrid]" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:40: in test_text_vs_messages_normalization
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_text_vs_messages_normalization[strict_bearer]" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:40: in test_text_vs_messages_normalization
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_sse_flow_with_heartbeat" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:135: in test_sse_flow_with_heartbeat
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_error_mapping_auth_rate_5xx" time="0.004"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_phase5_docs_and_tests.py:188: in test_error_mapping_auth_rate_5xx
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_model_override_routing" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:237: in test_model_override_routing
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_auth_gate_behavior_strict_vs_hybrid" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_phase5_docs_and_tests.py:269: in test_auth_gate_behavior_strict_vs_hybrid
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_request_id_and_trace_id_headers" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:314: in test_request_id_and_trace_id_headers
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_phase5_docs_and_tests.TestPhase5DocsAndTests" name="test_log_redaction_verbose_mode" time="0.001"><failure message="AttributeError: 'module' object at app.main has no attribute 'route_prompt'">.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:90: in annotated_getattr
    obj = getattr(obj, name)
          ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.main' has no attribute 'route_prompt'

The above exception was the direct cause of the following exception:
tests/integration/test_phase5_docs_and_tests.py:353: in test_log_redaction_verbose_mode
    monkeypatch.setattr("app.main.route_prompt", mock_route_prompt)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:104: in derive_importpath
    annotated_getattr(target, attr, ann=module)
.venv/lib/python3.12/site-packages/_pytest/monkeypatch.py:92: in annotated_getattr
    raise AttributeError(
E   AttributeError: 'module' object at app.main has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.integration.test_qdrant_dual_fallback_integration" name="test_vector_store_selection_env" time="0.007" /><testcase classname="tests.integration.test_qdrant_dual_fallback_integration" name="test_dual_mode_logs" time="0.007" /><testcase classname="tests.integration.test_refresh_concurrent" name="test_refresh_concurrent_two_calls" time="3.167"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_concurrent.py:18: in test_refresh_concurrent_two_calls
    assert ref, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_header_case" name="test_refresh_header_case" time="0.004"><failure message="assert 404 in {&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_header_case.py:14: in test_refresh_header_case
    assert r.status_code in {
E   assert 404 in {&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_basic_concurrent" time="3.176"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:33: in test_race_condition_fix_basic_concurrent
    refresh_token = _setup_user(client, "race_basic_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_multiple_concurrent" time="3.170"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:63: in test_race_condition_fix_multiple_concurrent
    refresh_token = _setup_user(client, "race_multi_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_rapid_sequential" time="3.171"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:94: in test_race_condition_fix_rapid_sequential
    refresh_token = _setup_user(client, "race_seq_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_cookie_mode" time="3.167"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:121: in test_race_condition_fix_cookie_mode
    _setup_user(client, "race_cookie_user")
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_retry_mechanism" time="3.175"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:153: in test_race_condition_fix_retry_mechanism
    refresh_token = _setup_user(client, "race_retry_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_error_handling" time="3.172"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:185: in test_race_condition_fix_error_handling
    refresh_token = _setup_user(client, "race_error_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_metrics_tracking" time="3.173"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:225: in test_race_condition_fix_metrics_tracking
    refresh_token = _setup_user(client, "race_metrics_user")
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_race_condition_fix" name="test_race_condition_fix_different_sessions" time="6.454"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_race_condition_fix.py:260: in test_race_condition_fix_different_sessions
    refresh_token1 = _setup_user(client1, "race_session1_user")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_race_condition_fix.py:22: in _setup_user
    assert refresh_token, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_replay" name="test_refresh_replay_header_mode" time="3.178"><failure message="AssertionError: missing refresh_token cookie after login&#10;assert None">tests/integration/test_refresh_replay.py:23: in test_refresh_replay_header_mode
    assert ref, "missing refresh_token cookie after login"
E   AssertionError: missing refresh_token cookie after login
E   assert None</failure></testcase><testcase classname="tests.integration.test_refresh_replay" name="test_refresh_replay_sequential" time="0.008"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_replay.py:46: in test_refresh_replay_sequential
    _bootstrap(client)
tests/integration/test_refresh_replay.py:39: in _bootstrap
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_replay" name="test_refresh_race_two_inflight" time="0.010"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_replay.py:63: in test_refresh_race_two_inflight
    _bootstrap(client)
tests/integration/test_refresh_replay.py:39: in _bootstrap
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_requires_intent" name="test_refresh_requires_intent_when_none" time="0.008"><failure message="assert 404 == &lt;HTTPStatus.BAD_REQUEST: 400&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.BAD_REQUEST: 400&gt; = HTTPStatus.BAD_REQUEST">tests/integration/test_refresh_requires_intent.py:14: in test_refresh_requires_intent_when_none
    assert r1.status_code == HTTPStatus.BAD_REQUEST
E   assert 404 == &lt;HTTPStatus.BAD_REQUEST: 400&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.BAD_REQUEST: 400&gt; = HTTPStatus.BAD_REQUEST</failure></testcase><testcase classname="tests.integration.test_refresh_requires_intent" name="test_refresh_allowed_first_party" time="0.005"><failure message="assert 404 in {&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_requires_intent.py:31: in test_refresh_allowed_first_party
    assert r.status_code in {
E   assert 404 in {&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.BAD_REQUEST: 400&gt;, &lt;HTTPStatus.UNAUTHORIZED: 401&gt;}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_rotation" name="test_refresh_rotates_and_spends_prior_jti" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_rotation.py:24: in test_refresh_rotates_and_spends_prior_jti
    _login(client)
tests/integration/test_refresh_rotation.py:17: in _login
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_rotation" name="test_access_proactive_rotation_threshold_respected" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_rotation.py:47: in test_access_proactive_rotation_threshold_respected
    _login(client)
tests/integration/test_refresh_rotation.py:17: in _login
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_workers" name="test_concurrent_refresh_simulated_workers" time="0.008"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_workers.py:19: in test_concurrent_refresh_simulated_workers
    c = _setup(monkeypatch)
        ^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_workers.py:14: in _setup
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_refresh_workers" name="test_csrf_intent_required_in_none" time="0.007"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_refresh_workers.py:38: in test_csrf_intent_required_in_none
    c = _setup(monkeypatch)
        ^^^^^^^^^^^^^^^^^^^
tests/integration/test_refresh_workers.py:14: in _setup
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_resilience_metrics" name="test_metrics_exist_after_forced_errors" time="0.017"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_resilience_metrics.py:34: in test_metrics_exist_after_forced_errors
    metrics = _get_metrics_text(client)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_resilience_metrics.py:13: in _get_metrics_text
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_samesite_modes" name="test_samesite_lax" time="0.008"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_samesite_modes.py:19: in test_samesite_lax
    _login(client)
tests/integration/test_samesite_modes.py:11: in _login
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_samesite_modes" name="test_samesite_none" time="0.008"><failure message="assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_samesite_modes.py:29: in test_samesite_none
    _login(client)
tests/integration/test_samesite_modes.py:11: in _login
    assert r.status_code in (HTTPStatus.OK, HTTPStatus.FOUND)
E   assert 404 in (&lt;HTTPStatus.OK: 200&gt;, &lt;HTTPStatus.FOUND: 302&gt;)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase1_map_and_cookie_persistence" time="0.005"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:98: in test_phase1_map_and_cookie_persistence
    out = _register_and_login(client)  # Use generated unique username
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase2_sessions_listing_and_revoke_cross_device" time="0.005"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:119: in test_phase2_sessions_listing_and_revoke_cross_device
    _register_and_login(client, "user2")
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase2_missing_and_expired_tokens_and_rate_limits" time="0.005"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:181: in test_phase2_missing_and_expired_tokens_and_rate_limits
    _register_and_login(client, "user3")
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase2_boundary_listing_shapes_and_pages" time="0.005"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:228: in test_phase2_boundary_listing_shapes_and_pages
    _register_and_login(client, "user4")
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase3_restart_sessions_store_and_retry_on_fail" time="0.007"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:240: in test_phase3_restart_sessions_store_and_retry_on_fail
    _register_and_login(client, "user5")
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_bucket" name="test_phase4_emit_records_and_summary" time="0.007"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_sessions_bucket.py:263: in test_phase4_emit_records_and_summary
    _register_and_login(client, "user6")
tests/integration/test_sessions_bucket.py:43: in _register_and_login
    assert r1.status_code in (200, 400)  # 400 when user already exists
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_sessions_fallback_compat" name="test_sessions_legacy_wrapper" time="0.006"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_sessions_fallback_compat.py:18: in test_sessions_legacy_wrapper
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_sessions_paginated" name="test_sessions_paginated" time="0.324"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_sessions_paginated.py:29: in test_sessions_paginated
    assert r1.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_sessions_shape" name="test_sessions_returns_array" time="0.008"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_sessions_shape.py:18: in test_sessions_returns_array
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_sessions_type_conform" name="test_sessions_type_conforms" time="0.008"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_sessions_type_conform.py:18: in test_sessions_type_conforms
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_http_handler_crisp_errors" time="0.007"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_websocket_integration.py:64: in test_websocket_http_handler_crisp_errors
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_cors_origins_restricted_to_localhost" time="0.004"><failure message="AssertionError: CORS middleware should be configured&#10;assert None is not None">tests/integration/test_websocket_integration.py:88: in test_cors_origins_restricted_to_localhost
    assert cors_middleware is not None, "CORS middleware should be configured"
E   AssertionError: CORS middleware should be configured
E   assert None is not None</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_origin_validation_integration" time="0.006"><failure message="assert True is False&#10; +  where True = &lt;function validate_websocket_origin at 0x112f89940&gt;(&lt;test_websocket_integration.MockWebSocket object at 0x11f0fa4e0&gt;)">tests/integration/test_websocket_integration.py:115: in test_websocket_origin_validation_integration
    assert validate_websocket_origin(invalid_ws) is False
E   assert True is False
E    +  where True = &lt;function validate_websocket_origin at 0x112f89940&gt;(&lt;test_websocket_integration.MockWebSocket object at 0x11f0fa4e0&gt;)</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_url_building_consistency" time="0.004" /><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_error_handling_headers" time="0.008"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_websocket_integration.py:142: in test_websocket_error_handling_headers
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_cors_configuration_validation" time="0.005"><failure message="AssertionError: CORS middleware should be configured&#10;assert None is not None">tests/integration/test_websocket_integration.py:165: in test_cors_configuration_validation
    assert cors_middleware is not None, "CORS middleware should be configured"
E   AssertionError: CORS middleware should be configured
E   assert None is not None</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_requirement_documentation" time="0.005"><failure message="assert 'WebSocket requirement' in 'from app.env_utils import load_env\n\nload_env()\nimport asyncio\nimport hashlib\nimport logging\nimport os\nimport t... os.getenv(&quot;HOST&quot;, &quot;0.0.0.0&quot;)\n    port = int(os.getenv(&quot;PORT&quot;, 8000))\n\n    uvicorn.run(app, host=host, port=port)\n'">tests/integration/test_websocket_integration.py:177: in test_websocket_requirement_documentation
    assert "WebSocket requirement" in main_content
E   assert 'WebSocket requirement' in 'from app.env_utils import load_env\n\nload_env()\nimport asyncio\nimport hashlib\nimport logging\nimport os\nimport t... os.getenv("HOST", "0.0.0.0")\n    port = int(os.getenv("PORT", 8000))\n\n    uvicorn.run(app, host=host, port=port)\n'</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_auth_successful_connection" time="0.011"><failure message="TypeError: object Mock can't be used in 'await' expression">tests/integration/test_websocket_integration.py:224: in test_websocket_auth_successful_connection
    await verify_ws(mock_ws)
app/security_ws.py:118: in verify_ws
    await ws.close(code=4401, reason="missing_token")
E   TypeError: object Mock can't be used in 'await' expression</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_auth_missing_token" time="0.011"><failure message="fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M201XKEV0G501DZST8Y', 'env': 'test'}}">tests/integration/test_websocket_integration.py:253: in test_websocket_auth_missing_token
    await verify_ws(mock_ws)
app/security_ws.py:120: in verify_ws
    raise unauthorized(message="authentication required", hint="include token in Authorization header, query param, or cookie")
E   fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M201XKEV0G501DZST8Y', 'env': 'test'}}</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_auth_invalid_origin" time="0.007"><failure message="fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M36ETJXPE90EEZ2BPP0', 'env': 'test'}}">tests/integration/test_websocket_integration.py:279: in test_websocket_auth_invalid_origin
    await verify_ws(mock_ws)
app/security_ws.py:120: in verify_ws
    raise unauthorized(message="authentication required", hint="include token in Authorization header, query param, or cookie")
E   fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M36ETJXPE90EEZ2BPP0', 'env': 'test'}}</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_auth_expired_token" time="0.009"><failure message="fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M48CP9ZEBN3S055C9HC', 'env': 'test'}}">tests/integration/test_websocket_integration.py:308: in test_websocket_auth_expired_token
    await verify_ws(mock_ws)
app/security_ws.py:120: in verify_ws
    raise unauthorized(message="authentication required", hint="include token in Authorization header, query param, or cookie")
E   fastapi.exceptions.HTTPException: 401: {'code': 'unauthorized', 'message': 'authentication required', 'detail': 'authentication required', 'hint': 'include token in Authorization header, query param, or cookie', 'details': {'status_code': 401, 'req_id': '-', 'timestamp': '2025-09-03T01:14:02Z', 'error_id': '01K46J6M48CP9ZEBN3S055C9HC', 'env': 'test'}}</failure></testcase><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_connection_state_management" time="0.012" /><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_broadcasting_with_dead_connections" time="0.007" /><testcase classname="tests.integration.test_websocket_integration.TestWebSocketIntegration" name="test_websocket_http_handler_comprehensive_errors" time="0.009"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/integration/test_websocket_integration.py:398: in test_websocket_http_handler_comprehensive_errors
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.integration.test_whoami_cookie_vs_header" name="test_cookie_only_session_ready" time="0.008"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_whoami_cookie_vs_header.py:24: in test_cookie_only_session_ready
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_whoami_cookie_vs_header" name="test_header_only_session_ready" time="0.007"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_whoami_cookie_vs_header.py:39: in test_header_only_session_ready
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_whoami_cookie_vs_header" name="test_neither_token" time="0.006"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_whoami_cookie_vs_header.py:54: in test_neither_token
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_whoami_cookie_vs_header" name="test_expired_access_token" time="0.007"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_whoami_cookie_vs_header.py:74: in test_expired_access_token
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.integration.test_whoami_duplicate_definitions" name="test_single_whoami_definition" time="0.490" /><testcase classname="tests.integration.test_whoami_token_source_priority" name="test_cookie_preferred_over_header_when_both_valid" time="0.008"><failure message="assert 404 == &lt;HTTPStatus.OK: 200&gt;&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code&#10; +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK">tests/integration/test_whoami_token_source_priority.py:23: in test_cookie_preferred_over_header_when_both_valid
    assert r.status_code == HTTPStatus.OK
E   assert 404 == &lt;HTTPStatus.OK: 200&gt;
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code
E    +  and   &lt;HTTPStatus.OK: 200&gt; = HTTPStatus.OK</failure></testcase><testcase classname="tests.smoke.test_golden_flows" name="test_health_and_headers" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_golden_flows.py:24: in test_health_and_headers
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_golden_flows" name="test_rate_limit_status" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_golden_flows.py:36: in test_rate_limit_status
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_music_orchestrator" name="test_device_selection_prefers_active" time="0.005" /><testcase classname="tests.smoke.test_music_orchestrator" name="test_basic_commands_route_to_provider" time="0.003" /><testcase classname="tests.smoke.test_rate_limit_headers" name="test_rate_limit_headers_present" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_rate_limit_headers.py:14: in test_rate_limit_headers_present
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_rate_limit_slo" name="test_basic_route_latency_budget" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_rate_limit_slo.py:20: in test_basic_route_latency_budget
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_memory_backend" time="0.010"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:54: in test_vector_store_memory_backend
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_chroma_backend" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:74: in test_vector_store_chroma_backend
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_qdrant_backend" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:105: in test_vector_store_qdrant_backend
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_legacy_compatibility" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:156: in test_vector_store_legacy_compatibility
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_default_fallback" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:198: in test_vector_store_default_fallback
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_error_handling" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/smoke/test_vector_store_unified.py:215: in test_vector_store_error_handling
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.smoke.test_vector_store_unified" name="test_vector_store_strict_mode" time="0.004"><failure message="Failed: DID NOT RAISE &lt;class 'ValueError'&gt;">tests/smoke/test_vector_store_unified.py:230: in test_vector_store_strict_mode
    with pytest.raises(ValueError, match="Unsupported vector store scheme: invalid"):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE &lt;class 'ValueError'&gt;</failure></testcase><testcase classname="tests.test_ablation_harness" name="test_ablation_modes" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ablation_harness.py:32: in test_ablation_modes
    base = _run_trace(client, "base prompt")
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_ablation_harness.py:12: in _run_trace
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_api_endpoints" name="test_metrics_requires_token_and_returns_shape" time="0.160" /><testcase classname="tests.test_admin_api_endpoints" name="test_router_decisions_requires_token_and_returns_list" time="0.064" /><testcase classname="tests.test_admin_api_endpoints" name="test_retrieval_last_filters_by_trace_event" time="0.216" /><testcase classname="tests.test_admin_api_endpoints" name="test_decision_explain_404_and_ok" time="0.057" /><testcase classname="tests.test_admin_api_endpoints" name="test_admin_config_includes_store_overrides" time="0.049" /><testcase classname="tests.test_admin_api_endpoints" name="test_errors_and_self_review_guarded_and_shapes" time="0.057" /><testcase classname="tests.test_admin_config_visibility" name="test_admin_config_guard_and_shape" time="0.056"><failure message="AssertionError: assert 200 == 403&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code&#10; +    where &lt;Response [200 OK]&gt; = get('/v1/admin/config?token=x')&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x11f256300&gt;.get">tests/test_admin_config_visibility.py:15: in test_admin_config_guard_and_shape
    assert client.get("/v1/admin/config?token=x").status_code == 403
E   AssertionError: assert 200 == 403
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code
E    +    where &lt;Response [200 OK]&gt; = get('/v1/admin/config?token=x')
E    +      where get = &lt;starlette.testclient.TestClient object at 0x11f256300&gt;.get</failure></testcase><testcase classname="tests.test_admin_config_visibility" name="test_admin_config_flags_reflected" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_config_visibility.py:46: in test_admin_config_flags_reflected
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_decisions_shape" name="test_admin_decisions_shape" time="0.061" /><testcase classname="tests.test_admin_errors_self_review" name="test_admin_errors_and_self_review" time="0.055" /><testcase classname="tests.test_admin_metrics_shape" name="test_admin_metrics_shape" time="0.053" /><testcase classname="tests.test_admin_rbac" name="test_admin_unauth" time="0.128"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:36: in test_admin_unauth
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_forbidden" time="0.099"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:44: in test_admin_forbidden
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_ok" time="0.092"><failure message="assert (404 == 200)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:52: in test_admin_ok
    assert r.status_code == 200 and r.json()["status"] == "ok"
E   assert (404 == 200)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_rbac_info_unauth" time="0.091"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:58: in test_admin_rbac_info_unauth
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_rbac_info_forbidden" time="0.091"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:66: in test_admin_rbac_info_forbidden
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_rbac_info_ok" time="0.089"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:75: in test_admin_rbac_info_ok
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_users_me_unauth" time="0.091"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:84: in test_admin_users_me_unauth
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_users_me_ok" time="0.091"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:93: in test_admin_users_me_ok
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_system_status_unauth" time="0.090"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:102: in test_admin_system_status_unauth
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_system_status_forbidden" time="0.091"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:110: in test_admin_system_status_forbidden
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac" name="test_admin_system_status_ok" time="0.094"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac.py:119: in test_admin_system_status_ok
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac_and_pin" name="test_admin_routes_denied_without_scope" time="0.004"><failure message="assert 404 in {401, 403}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac_and_pin.py:15: in test_admin_routes_denied_without_scope
    assert r.status_code in {401, 403}
E   assert 404 in {401, 403}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_rbac_and_pin" name="test_pin_requires_scope_when_enforced" time="0.006"><failure message="assert 404 in {401, 403}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_rbac_and_pin.py:28: in test_pin_requires_scope_when_enforced
    assert r.status_code in {401, 403}
E   assert 404 in {401, 403}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_requires_jwt_and_scope" name="test_admin_denies_without_jwt" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_requires_jwt_and_scope.py:28: in test_admin_denies_without_jwt
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_requires_jwt_and_scope" name="test_admin_requires_scope_with_jwt" time="0.005"><failure message="assert 404 in {401, 403}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_requires_jwt_and_scope.py:42: in test_admin_requires_scope_with_jwt
    assert r.status_code in {401, 403}
E   assert 404 in {401, 403}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_retrieval_last" name="test_admin_retrieval_last" time="0.055" /><testcase classname="tests.test_admin_router_filters" name="test_router_filters_and_pagination" time="0.072" /><testcase classname="tests.test_admin_scope_granular" name="test_admin_read_requires_read_or_admin_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:51: in test_admin_read_requires_read_or_admin_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_write_requires_write_or_admin_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:83: in test_admin_write_requires_write_or_admin_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_metrics_endpoint_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:115: in test_admin_metrics_endpoint_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_system_status_endpoint_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:139: in test_admin_system_status_endpoint_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_flags_endpoint_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:164: in test_admin_flags_endpoint_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_errors_endpoint_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:188: in test_admin_errors_endpoint_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_tv_config_put_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:216: in test_admin_tv_config_put_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_admin_vector_store_bootstrap_scope" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:245: in test_admin_vector_store_bootstrap_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_user_profile_endpoint_scope" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:271: in test_user_profile_endpoint_scope
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_scope_combination_scenarios" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:295: in test_scope_combination_scenarios
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_scope_inheritance_admin_full_access" time="0.006"><failure message="AssertionError: Admin should access /v1/admin/config&#10;assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:329: in test_scope_inheritance_admin_full_access
    assert response.status_code == 200, f"Admin should access {endpoint}"
E   AssertionError: Admin should access /v1/admin/config
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_scope_separation_read_vs_write" time="0.004"><failure message="AssertionError: admin:read should allow GET /v1/admin/config&#10;assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:348: in test_scope_separation_read_vs_write
    assert response.status_code == 200, f"admin:read should allow GET {endpoint}"
E   AssertionError: admin:read should allow GET /v1/admin/config
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_expired_token_handling" time="0.004"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:387: in test_expired_token_handling
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_malformed_token_handling" time="0.004"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:395: in test_malformed_token_handling
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_scope_granular" name="test_scope_case_sensitivity" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_admin_scope_granular.py:410: in test_scope_case_sensitivity
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_admin_suite_extended" name="test_metrics_allows_without_token_in_tests" time="0.042" /><testcase classname="tests.test_admin_suite_extended" name="test_metrics_cache_rate_is_float_under_pytest" time="0.045" /><testcase classname="tests.test_admin_suite_extended" name="test_router_decisions_limit_bounds" time="0.048" /><testcase classname="tests.test_admin_suite_extended" name="test_retrieval_last_limit_bounds" time="0.045" /><testcase classname="tests.test_admin_suite_extended" name="test_router_decisions_order_and_fields" time="0.049" /><testcase classname="tests.test_admin_suite_extended" name="test_retrieval_last_filters_trace_event" time="0.040" /><testcase classname="tests.test_admin_suite_extended" name="test_decisions_explain_ok" time="0.041" /><testcase classname="tests.test_admin_suite_extended" name="test_errors_limit_and_shape" time="0.042"><failure message="AssertionError: assert (50 == 50 and '49' == '59'&#10; +  where 50 = len([{'component': 'x', 'level': 'ERROR', 'msg': '0', 'timestamp': 't'}, {'component': 'x', 'level': 'ERROR', 'msg': '1', ...evel': 'ERROR', 'msg': '4', 'timestamp': 't'}, {'component': 'x', 'level': 'ERROR', 'msg': '5', 'timestamp': 't'}, ...])&#10;  &#10;  - 59&#10;  + 49)">tests/test_admin_suite_extended.py:128: in test_errors_limit_and_shape
    assert len(errs) == 50 and errs[-1]["msg"] == "59"
E   AssertionError: assert (50 == 50 and '49' == '59'
E    +  where 50 = len([{'component': 'x', 'level': 'ERROR', 'msg': '0', 'timestamp': 't'}, {'component': 'x', 'level': 'ERROR', 'msg': '1', ...evel': 'ERROR', 'msg': '4', 'timestamp': 't'}, {'component': 'x', 'level': 'ERROR', 'msg': '5', 'timestamp': 't'}, ...])
E     
E     - 59
E     + 49)</failure></testcase><testcase classname="tests.test_admin_suite_extended" name="test_self_review_unavailable_shape" time="0.040" /><testcase classname="tests.test_admin_suite_extended" name="test_flags_endpoint_sets_env_and_guard" time="0.040"><failure message="AssertionError: assert 405 == 403&#10; +  where 405 = &lt;Response [405 Method Not Allowed]&gt;.status_code&#10; +    where &lt;Response [405 Method Not Allowed]&gt; = post('/v1/admin/flags?key=FOO&amp;value=BAR&amp;token=x')&#10; +      where post = &lt;starlette.testclient.TestClient object at 0x11f5958b0&gt;.post">tests/test_admin_suite_extended.py:140: in test_flags_endpoint_sets_env_and_guard
    assert client.post("/v1/admin/flags?key=FOO&amp;value=BAR&amp;token=x").status_code == 403
E   AssertionError: assert 405 == 403
E    +  where 405 = &lt;Response [405 Method Not Allowed]&gt;.status_code
E    +    where &lt;Response [405 Method Not Allowed]&gt; = post('/v1/admin/flags?key=FOO&amp;value=BAR&amp;token=x')
E    +      where post = &lt;starlette.testclient.TestClient object at 0x11f5958b0&gt;.post</failure></testcase><testcase classname="tests.test_admin_suite_extended" name="test_admin_config_403_without_token_when_not_test_mode" time="0.042"><failure message="AssertionError: assert 200 == 403&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code&#10; +    where &lt;Response [200 OK]&gt; = get('/v1/admin/config')&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x11f5387d0&gt;.get">tests/test_admin_suite_extended.py:151: in test_admin_config_403_without_token_when_not_test_mode
    assert client.get("/v1/admin/config").status_code == 403
E   AssertionError: assert 200 == 403
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code
E    +    where &lt;Response [200 OK]&gt; = get('/v1/admin/config')
E    +      where get = &lt;starlette.testclient.TestClient object at 0x11f5387d0&gt;.get</failure></testcase><testcase classname="tests.test_admin_suite_extended" name="test_admin_config_ok_with_token_and_overrides" time="0.042" /><testcase classname="tests.test_admin_suite_extended" name="test_admin_metrics_top_skills_sorted" time="0.046" /><testcase classname="tests.test_admin_suite_extended" name="test_admin_router_decisions_clip_limit" time="0.043" /><testcase classname="tests.test_admin_suite_extended" name="test_admin_retrieval_last_clip_limit" time="0.043" /><testcase classname="tests.test_admin_suite_extended" name="test_admin_decisions_explain_404_for_missing" time="0.046" /><testcase classname="tests.test_aookie_consistency" name="test_login_sets_all_three_cookies_consistently" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:32: in test_login_sets_all_three_cookies_consistently
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_aookie_consistency" name="test_refresh_rotates_all_three_cookies_consistently" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:51: in test_refresh_rotates_all_three_cookies_consistently
    assert login_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_aookie_consistency" name="test_logout_clears_all_three_cookies_consistently" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:78: in test_logout_clears_all_three_cookies_consistently
    assert login_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_aookie_consistency" name="test_oauth_callback_sets_all_three_cookies_consistently" time="0.001"><skipped type="pytest.skip" message="OAuth test needs to be updated for new cookie system">/Users/kingal/2025/GesahniV2/tests/test_aookie_consistency.py:98: OAuth test needs to be updated for new cookie system</skipped></testcase><testcase classname="tests.test_aookie_consistency" name="test_finish_clerk_login_sets_all_three_cookies_consistently" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:109: in test_finish_clerk_login_sets_all_three_cookies_consistently
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_aookie_consistency" name="test_cookie_attributes_consistency_across_endpoints" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:122: in test_cookie_attributes_consistency_across_endpoints
    assert login_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_aookie_consistency" name="test_session_cookie_is_opaque_and_consistent" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_aookie_consistency.py:150: in test_session_cookie_is_opaque_and_consistent
    assert login_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_auth.TestWhoami" name="test_whoami_valid_cookie_happy_path" time="0.157" /><testcase classname="tests.test_api_auth.TestWhoami" name="test_whoami_valid_header_happy_path" time="0.132" /><testcase classname="tests.test_api_auth.TestWhoami" name="test_whoami_no_token_error" time="0.130" /><testcase classname="tests.test_api_auth.TestWhoami" name="test_whoami_expired_token_error" time="0.134" /><testcase classname="tests.test_api_auth.TestRefresh" name="test_refresh_valid_token_happy_path" time="0.134"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/test_api_auth.py:200: in test_refresh_valid_token_happy_path
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_auth.TestRefresh" name="test_refresh_no_token_error" time="0.128" /><testcase classname="tests.test_api_auth.TestRefresh" name="test_refresh_invalid_token_error" time="0.130" /><testcase classname="tests.test_api_auth.TestLogout" name="test_logout_happy_path" time="0.128" /><testcase classname="tests.test_api_auth.TestLogout" name="test_logout_no_cookies_still_works" time="0.135" /><testcase classname="tests.test_api_auth.TestPats" name="test_list_pats_happy_path" time="0.139" /><testcase classname="tests.test_api_auth.TestPats" name="test_create_pat_happy_path" time="0.131" /><testcase classname="tests.test_api_auth.TestPats" name="test_create_pat_unauthorized_error" time="0.128"><failure message="AssertionError: assert 'Unauthorized' in {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}&#10; +  where {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...} = &lt;built-in method get of dict object at 0x11f796780&gt;('detail', '')&#10; +    where &lt;built-in method get of dict object at 0x11f796780&gt; = {'detail': {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}}.get&#10; +      where {'detail': {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}} = json()&#10; +        where json = &lt;Response [401 Unauthorized]&gt;.json">tests/test_api_auth.py:365: in test_create_pat_unauthorized_error
    assert "Unauthorized" in response.json().get("detail", "")
E   AssertionError: assert 'Unauthorized' in {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}
E    +  where {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...} = &lt;built-in method get of dict object at 0x11f796780&gt;('detail', '')
E    +    where &lt;built-in method get of dict object at 0x11f796780&gt; = {'detail': {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}}.get
E    +      where {'detail': {'code': 'unauthorized', 'detail': 'authentication required', 'details': {'env': 'dev', 'error_id': '01K46J6SK45JMA6NYZS1QJKRP8', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'login or include Authorization header', ...}} = json()
E    +        where json = &lt;Response [401 Unauthorized]&gt;.json</failure></testcase><testcase classname="tests.test_api_auth.TestLogin" name="test_login_happy_path" time="0.136" /><testcase classname="tests.test_api_auth.TestLogin" name="test_login_missing_username_error" time="0.132" /><testcase classname="tests.test_api_auth.TestLogin" name="test_login_rate_limit_error" time="0.127" /><testcase classname="tests.test_api_auth.TestFinish" name="test_finish_happy_path" time="0.134" /><testcase classname="tests.test_api_auth.TestFinish" name="test_finish_get_redirect_happy_path" time="0.134" /><testcase classname="tests.test_api_auth.TestWhoamiAdvanced" name="test_whoami_priority_order" time="0.131" /><testcase classname="tests.test_api_auth.TestWhoamiAdvanced" name="test_whoami_invalid_jwt_secret_error" time="0.131" /><testcase classname="tests.test_api_auth.TestWhoamiAdvanced" name="test_whoami_malformed_token_error" time="0.130" /><testcase classname="tests.test_api_contracts" name="test_whoami_contract" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_contracts.py:21: in test_whoami_contract
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_contracts" name="test_sessions_contract" time="0.008"><failure message="AssertionError: assert False&#10; +  where False = isinstance({'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J6TNHVX49T6WY2MTGF8KX', 'method': 'GET', 'path': '/v1/sessions', ...}, 'message': 'Not Found'}, list)">tests/test_api_contracts.py:49: in test_sessions_contract
    assert isinstance(arr, list)
E   AssertionError: assert False
E    +  where False = isinstance({'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J6TNHVX49T6WY2MTGF8KX', 'method': 'GET', 'path': '/v1/sessions', ...}, 'message': 'Not Found'}, list)</failure></testcase><testcase classname="tests.test_api_contracts" name="test_revoke_session_contract" time="0.003" /><testcase classname="tests.test_api_contracts" name="test_pats_get_empty" time="0.003" /><testcase classname="tests.test_api_contracts" name="test_pats_post_contract" time="0.004" /><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_health_ready_endpoint" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_health_ready_components_structure" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_login_dev_path" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_login_missing_username" time="0.006"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_logout_endpoint" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_whoami_unauthenticated" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_whoami_with_cookies" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_whoami_with_bearer_token" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_refresh_endpoint" time="0.201"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_refresh_without_token" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_models_list_endpoint" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_models_list_includes_expected_engines" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_ask_endpoint_with_mock_router" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_ask_endpoint_unauthenticated" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_ask_endpoint_empty_prompt" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_ask_endpoint_with_chat_format" time="0.007"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_ask_endpoint_analytics_tracking" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_cors_headers_present" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_json_content_type_enforced" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_rate_limiting_headers" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_error_response_format" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_cache_headers_on_health" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_vary_header_present" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_request_id_header_echoed" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_comprehensive_auth_flow" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_concurrent_request_handling" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_large_payload_handling" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_malformed_json_handling" time="0.006"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_sql_injection_attempt_handling" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_xss_attempt_handling" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_path_traversal_attempt" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_unauthorized_access_patterns" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_health_endpoint_under_load" time="0.007"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_memory_leak_prevention" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_timeout_handling" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_graceful_error_recovery" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_request_response_consistency" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_api_version_consistency" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_security_headers" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_content_length_validation" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_http_methods_validation" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_query_parameter_validation" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_response_format_consistency" time="0.004"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_api_contract_compliance" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_auth_token_format_validation" time="0.006"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_endpoints_comprehensive.TestAPIEndpointsComprehensive" name="test_concurrent_auth_handling" time="0.005"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'&quot;">tests/test_api_endpoints_comprehensive.py:36: in client
    return create_test_client()
           ^^^^^^^^^^^^^^^^^^^^
tests/test_minimal_fastapi_app.py:199: in create_test_client
    p.start()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; does not have the attribute 'route_prompt'</error></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleLoginUrl" name="test_login_url_missing_config_error" time="0.004"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:57: in test_login_url_missing_config_error
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleLoginUrl" name="test_login_url_happy_path" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:77: in test_login_url_happy_path
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleLoginUrl" name="test_login_url_with_optional_params" time="0.004"><failure message="KeyError: 'auth_url'">tests/test_api_google_oauth.py:111: in test_login_url_with_optional_params
    auth_url = data["auth_url"]
               ^^^^^^^^^^^^^^^^
E   KeyError: 'auth_url'</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_missing_code_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:132: in test_callback_missing_code_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_missing_state_error" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:147: in test_callback_missing_state_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_bad_state_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:167: in test_callback_bad_state_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_expired_state_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:197: in test_callback_expired_state_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_token_exchange_failure" time="0.005"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:228: in test_callback_token_exchange_failure
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallback" name="test_callback_happy_path" time="0.003"><failure message="TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'">tests/test_api_google_oauth.py:265: in test_callback_happy_path
    response = client.get(
E   TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallbackErrors" name="test_callback_missing_code_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:295: in test_callback_missing_code_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallbackErrors" name="test_callback_bad_state_mismatch_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:315: in test_callback_bad_state_mismatch_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallbackErrors" name="test_callback_missing_state_cookie_error" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:334: in test_callback_missing_state_cookie_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleCallbackErrors" name="test_callback_expired_state_error" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:364: in test_callback_expired_state_error
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleRedirectValidation" name="test_login_url_invalid_redirect_blocked" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:390: in test_login_url_invalid_redirect_blocked
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleRedirectValidation" name="test_login_url_allowed_redirect_passthrough" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:414: in test_login_url_allowed_redirect_passthrough
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleRedirectValidation" name="test_login_url_no_allowlist_allows_all" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:437: in test_login_url_no_allowlist_allows_all
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleConfiguration" name="test_login_url_missing_client_id_error" time="0.005"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:461: in test_login_url_missing_client_id_error
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_google_oauth.TestGoogleConfiguration" name="test_login_url_missing_redirect_uri_error" time="0.005"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_api_google_oauth.py:478: in test_login_url_missing_redirect_uri_error
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_api_history_rag_skills" name="test_history_recent_reads_jsonl" time="0.014" /><testcase classname="tests.test_api_history_rag_skills" name="test_rag_search_works_without_store" time="0.018" /><testcase classname="tests.test_api_history_rag_skills" name="test_skills_list_shape" time="0.007" /><testcase classname="tests.test_api_key" name="test_get_client_missing_key" time="0.001" /><testcase classname="tests.test_api_key" name="test_close_client_double" time="0.004" /><testcase classname="tests.test_ask_auth" name="test_ask_requires_auth" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_auth.py:34: in test_ask_requires_auth
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_auth" name="test_ask_requires_scope" time="0.002"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_ask_auth.py:42: in test_ask_requires_scope
    token = mint_token(scopes=["care:resident"])  # no chat:write
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_ask_auth.py:20: in mint_token
    return make_access(claims)
           ^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_ask_auth" name="test_ask_with_cookie_and_csrf" time="0.002"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_ask_auth.py:58: in test_ask_with_cookie_and_csrf
    token = mint_token()  # defaults include chat:write
            ^^^^^^^^^^^^
tests/test_ask_auth.py:20: in mint_token
    return make_access(claims)
           ^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_ask_auth" name="test_ask_with_bearer_and_csrf" time="0.002"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_ask_auth.py:76: in test_ask_with_bearer_and_csrf
    token = mint_token()  # defaults include chat:write
            ^^^^^^^^^^^^
tests/test_ask_auth.py:20: in mint_token
    return make_access(claims)
           ^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_ask_auth_before_rate_limit" name="test_ask_unauth_is_401_without_rl_headers" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_auth_before_rate_limit.py:26: in test_ask_unauth_is_401_without_rl_headers
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_auth_before_rate_limit" name="test_ask_authed_over_limit_returns_429_with_retry_after" time="0.275"><failure message="assert False">tests/test_ask_auth_before_rate_limit.py:44: in test_ask_authed_over_limit_returns_429_with_retry_after
    assert got_429
E   assert False</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[ ]" time="0.007"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[?]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[hi]" time="0.006"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[a]" time="0.006"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[\n]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[   ]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[x]" time="0.006"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[ok]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[yes]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_empty_or_minimal_prompts_rejected[no]" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:62: in test_empty_or_minimal_prompts_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_whitespace_only_prompt_rejected" time="0.006"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:76: in test_whitespace_only_prompt_rejected
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_single_character_prompt_rejected" time="0.005"><failure message="AssertionError: Single char 'a' should be rejected&#10;assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:91: in test_single_character_prompt_rejected
    assert response.status_code == 422, f"Single char '{char}' should be rejected"
E   AssertionError: Single char 'a' should be rejected
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_very_short_words_rejected" time="0.005"><failure message="AssertionError: Very short word 'a' should be rejected&#10;assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:108: in test_very_short_words_rejected
    assert response.status_code == 422, f"Very short word '{word}' should be rejected"
E   AssertionError: Very short word 'a' should be rejected
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_prompt_with_only_punctuation_rejected" time="0.005"><failure message="AssertionError: Punctuation only prompt '?' should be rejected&#10;assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:125: in test_prompt_with_only_punctuation_rejected
    assert response.status_code == 422, f"Punctuation only prompt '{prompt}' should be rejected"
E   AssertionError: Punctuation only prompt '?' should be rejected
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_req_id_consistency_in_error_responses" time="0.005"><failure message="AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '240', 'content-type': 'application/json'})&#10; +  where Headers({'x-error-code': 'not_found', 'content-length': '240', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers">tests/test_ask_short_prompt_failures.py:140: in test_req_id_consistency_in_error_responses
    assert "X-Request-ID" in response.headers
E   AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '240', 'content-type': 'application/json'})
E    +  where Headers({'x-error-code': 'not_found', 'content-length': '240', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_json_error_body_on_validation_error" time="0.005"><failure message="assert 404 == 422&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:155: in test_json_error_body_on_validation_error
    assert response.status_code == 422
E   assert 404 == 422
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_unbound_local_error_prevention" time="0.005"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ask_short_prompt_failures.py:184: in test_unbound_local_error_prevention
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_req_id_available_in_error_cases" time="0.005" /><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_req_id_generation_at_function_top" time="0.003" /><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_response_payload_predeclared" time="0.005" /><testcase classname="tests.test_ask_short_prompt_failures.TestShortPromptFailures" name="test_unsafe_locals_usage_fixed" time="0.008" /><testcase classname="tests.test_audit_trail" name="test_audit_file_created_on_request" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_audit_trail.py:60: in test_audit_file_created_on_request
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_basic_structure" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_audit_trail.py:71: in test_audit_append_basic_structure
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_multiple_events" time="0.010"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_multiple_eve0/audit/events.ndjson'">tests/test_audit_trail.py:129: in test_audit_append_multiple_events
    content = audit_file.read_text().strip()
              ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_multiple_eve0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_with_error_status" time="0.007"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_with_error_s0/audit/events.ndjson'">tests/test_audit_trail.py:152: in test_audit_append_with_error_status
    content = audit_file.read_text().strip()
              ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_with_error_s0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_preserves_history" time="0.006"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_preserves_hi0/audit/events.ndjson'">tests/test_audit_trail.py:171: in test_audit_append_preserves_history
    content1 = audit_file.read_text().strip()
               ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_preserves_hi0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_timestamp_format" time="0.006"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_timestamp_fo0/audit/events.ndjson'">tests/test_audit_trail.py:190: in test_audit_append_timestamp_format
    content = audit_file.read_text().strip()
              ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_timestamp_fo0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_includes_request_details" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_audit_trail.py:209: in test_audit_append_includes_request_details
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_with_authentication" time="0.006"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_with_authent0/audit/events.ndjson'">tests/test_audit_trail.py:231: in test_audit_append_with_authentication
    content = audit_file.read_text().strip()
              ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_with_authent0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_file_permissions" time="0.005"><failure message="AssertionError: assert False&#10; +  where False = exists()&#10; +    where exists = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_file_permiss0/audit/events.ndjson').exists">tests/test_audit_trail.py:246: in test_audit_append_file_permissions
    assert audit_file.exists()
E   AssertionError: assert False
E    +  where False = exists()
E    +    where exists = PosixPath('/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_file_permiss0/audit/events.ndjson').exists</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_concurrent_access" time="0.026"><failure message="assert False&#10; +  where False = all(&lt;generator object test_audit_append_concurrent_access.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f461970&gt;)">tests/test_audit_trail.py:269: in test_audit_append_concurrent_access
    assert all(r.status_code == 200 for r in responses)
E   assert False
E    +  where False = all(&lt;generator object test_audit_append_concurrent_access.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f461970&gt;)</failure></testcase><testcase classname="tests.test_audit_trail" name="test_audit_append_file_rotation_scenario" time="0.216"><failure message="FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_file_rotatio0/audit/events.ndjson'">tests/test_audit_trail.py:291: in test_audit_append_file_rotation_scenario
    content = audit_file.read_text().strip()
              ^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1027: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pathlib.py:1013: in open
    return io.open(self, mode, buffering, encoding, errors, newline)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   FileNotFoundError: [Errno 2] No such file or directory: '/private/var/folders/9b/yw1q_r5s4r7bqgy0lnm__9q80000gn/T/pytest-of-kingal/pytest-51/test_audit_append_file_rotatio0/audit/events.ndjson'</failure></testcase><testcase classname="tests.test_auth" name="test_login_success" time="0.037"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/test_auth.py:46: in test_login_success
    assert resp.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth" name="test_login_bad_credentials" time="0.034" /><testcase classname="tests.test_auth" name="test_login_is_public_endpoint" time="0.033"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/test_auth.py:73: in test_login_is_public_endpoint
    assert resp.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth" name="test_refresh_and_logout" time="0.033"><failure message="KeyError: 'refresh_token'">tests/test_auth.py:96: in test_refresh_and_logout
    refresh = tokens["refresh_token"]
              ^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'refresh_token'</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_boot_logged_out_to_logged_in" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_behavior.py:283: in test_boot_logged_out_to_logged_in
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_refresh_while_logged_in" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_behavior.py:331: in test_refresh_while_logged_in
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_logout_behavior" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_behavior.py:363: in test_logout_behavior
    assert logout_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_websocket_behavior" time="0.002"><failure message="AssertionError: Should attempt connection when authenticated&#10;assert 0 == 1&#10; +  where 0 = &lt;tests.test_auth_behavior.MockWebSocketHub object at 0x11f84a360&gt;.connection_attempts">tests/test_auth_behavior.py:395: in test_websocket_behavior
    assert (
E   AssertionError: Should attempt connection when authenticated
E   assert 0 == 1
E    +  where 0 = &lt;tests.test_auth_behavior.MockWebSocketHub object at 0x11f84a360&gt;.connection_attempts</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_health_check_behavior" time="0.002" /><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_csp_service_worker_sanity" time="0.004"><failure message="assert 404 in [200, 401]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_behavior.py:452: in test_csp_service_worker_sanity
    assert response.status_code in [200, 401]  # May be 401 if not authenticated
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in [200, 401]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_auth_orchestrator_singleton_behavior" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_auth_behavior.py:481: in test_auth_orchestrator_singleton_behavior
    mock_auth_orchestrator.checkAuth()
tests/test_auth_behavior.py:103: in checkAuth
    return asyncio.Future()
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_websocket_auth_coordination" time="0.001" /><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_network_panel_401_tracking" time="0.002" /><testcase classname="tests.test_auth_behavior.TestAuthenticationBehavior" name="test_auth_state_transitions" time="0.002" /><testcase classname="tests.test_auth_behavior.TestAuthenticationIntegration" name="test_complete_auth_flow" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_behavior.py:572: in test_complete_auth_flow
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_core_unit" name="test_extract_token_precedence_header_over_cookie" time="0.002" /><testcase classname="tests.test_auth_core_unit" name="test_extract_token_access_cookie_when_no_header" time="0.003"><failure message="AssertionError: assert 'none' == 'access_cookie'&#10;  &#10;  - access_cookie&#10;  + none">tests/test_auth_core_unit.py:29: in test_extract_token_access_cookie_when_no_header
    assert src == "access_cookie"
E   AssertionError: assert 'none' == 'access_cookie'
E     
E     - access_cookie
E     + none</failure></testcase><testcase classname="tests.test_auth_core_unit" name="test_extract_token_session_when_no_header_or_access" time="0.002"><failure message="AssertionError: assert 'none' == 'session'&#10;  &#10;  - session&#10;  + none">tests/test_auth_core_unit.py:36: in test_extract_token_session_when_no_header_or_access
    assert src == "session"
E   AssertionError: assert 'none' == 'session'
E     
E     - session
E     + none</failure></testcase><testcase classname="tests.test_auth_core_unit" name="test_decode_any_hs256_roundtrip" time="0.002"><failure message="jwt.exceptions.InvalidTokenError: invalid_token">tests/test_auth_core_unit.py:43: in test_decode_any_hs256_roundtrip
    payload = decode_any(token)
              ^^^^^^^^^^^^^^^^^
app/auth_core.py:110: in decode_any
    raise jwt.InvalidTokenError("invalid_token")
E   jwt.exceptions.InvalidTokenError: invalid_token</failure></testcase><testcase classname="tests.test_auth_core_unit" name="test_resolve_auth_sets_state_for_access_cookie" time="0.002"><failure message="AssertionError: assert None == 'alice'">tests/test_auth_core_unit.py:52: in test_resolve_auth_sets_state_for_access_cookie
    assert out["user_id"] == "alice"
E   AssertionError: assert None == 'alice'</failure></testcase><testcase classname="tests.test_auth_core_unit" name="test_has_scope_and_require_scope" time="0.002" /><testcase classname="tests.test_auth_extras" name="test_register_invalid_username" time="0.044" /><testcase classname="tests.test_auth_extras" name="test_register_duplicate_username" time="0.036"><failure message="assert 409 == 200&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/test_auth_extras.py:48: in test_register_duplicate_username
    assert r1.status_code == 200
E   assert 409 == 200
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_extras" name="test_password_strength_policy" time="0.041"><failure message="assert 409 == 200&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/test_auth_extras.py:65: in test_password_strength_policy
    assert r.status_code == 200
E   assert 409 == 200
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_extras" name="test_login_throttling_lockout" time="0.050" /><testcase classname="tests.test_auth_extras" name="test_refresh_with_access_token_rejected" time="0.066"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_auth_extras.py:102: in test_refresh_with_access_token_rejected
    login = client.post(
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/auth.py:873: in login
    access_token = make_access({"user_id": req.username})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_auth_extras" name="test_refresh_issuer_mismatch" time="0.065"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_auth_extras.py:123: in test_refresh_issuer_mismatch
    login = client.post(
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/auth.py:873: in login
    access_token = make_access({"user_id": req.username})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_auth_extras" name="test_forgot_and_reset_password_flow" time="0.109"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_auth_extras.py:168: in test_forgot_and_reset_password_flow
    r = client.post("/login", json={"username": "sam", "password": "newpass"})
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/auth.py:873: in login
    access_token = make_access({"user_id": req.username})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_auth_flow" name="test_whoami_endpoint" time="0.005" /><testcase classname="tests.test_auth_flow" name="test_refresh_endpoint" time="0.008" /><testcase classname="tests.test_auth_flow" name="test_401_handling" time="0.004" /><testcase classname="tests.test_auth_flow" name="test_cors_handling" time="0.004" /><testcase classname="tests.test_auth_flow" name="test_refresh_cookie_only" time="0.005" /><testcase classname="tests.test_auth_flow" name="test_login_flow" time="0.004" /><testcase classname="tests.test_auth_flow" name="test_no_html_redirects" time="0.011" /><testcase classname="tests.test_auth_frontend_like" name="test_ws_allows_query_param_token" time="0.006"><failure message="starlette.websockets.WebSocketDisconnect">tests/test_auth_frontend_like.py:25: in test_ws_allows_query_param_token
    with client.websocket_connect(f"/v1/transcribe?access_token={token}") as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.test_auth_hardening" name="test_dynamic_attempt_max_runtime" time="0.001" /><testcase classname="tests.test_auth_hardening" name="test_rbac_ladder_admin_helpers" time="0.002"><skipped type="pytest.skip" message="Legacy auth router not mounted; skipping RBAC ladder test">/Users/kingal/2025/GesahniV2/tests/test_auth_hardening.py:34: Legacy auth router not mounted; skipping RBAC ladder test</skipped></testcase><testcase classname="tests.test_auth_hardening" name="test_rate_limit_throttle_and_window_reset" time="0.002" /><testcase classname="tests.test_auth_hardening" name="test_backoff_threshold_logic" time="0.001" /><testcase classname="tests.test_auth_hardening" name="test_session_binding_and_verify" time="0.002" /><testcase classname="tests.test_auth_hardening" name="test_csrf_enforcement_on_login" time="0.000"><skipped type="pytest.skip" message="Requires full server CSRF + cookie setup; run in integration suite">/Users/kingal/2025/GesahniV2/tests/test_auth_hardening.py:131: Requires full server CSRF + cookie setup; run in integration suite</skipped></testcase><testcase classname="tests.test_auth_hardening" name="test_backoff_sleep_in_login" time="0.000"><skipped type="pytest.skip" message="Integration test: exercise login endpoint backoff sleep">/Users/kingal/2025/GesahniV2/tests/test_auth_hardening.py:136: Integration test: exercise login endpoint backoff sleep</skipped></testcase><testcase classname="tests.test_auth_legacy_names_off" name="test_legacy_cookies_do_not_authenticate_http" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_legacy_names_off.py:29: in test_legacy_cookies_do_not_authenticate_http
    cookies = _login(client)
              ^^^^^^^^^^^^^^
tests/test_auth_legacy_names_off.py:17: in _login
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_legacy_names_off" name="test_legacy_cookies_do_not_authenticate_ws" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_legacy_names_off.py:42: in test_legacy_cookies_do_not_authenticate_ws
    cookies = _login(client)
              ^^^^^^^^^^^^^^
tests/test_auth_legacy_names_off.py:17: in _login
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_logs" name="test_auth_logs" time="9.326" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_log_auth_event" time="0.004" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_track_auth_event_context_manager" time="0.014" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_whoami_call" time="0.004" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_finish_call" time="0.004" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_privileged_call_blocked" time="0.004" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_ws_reconnect_attempt" time="0.003" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_auth_lock_event" time="0.002" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_record_auth_state_change" time="0.003" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_boot_phase_detection" time="0.002"><failure message="assert False is True&#10; +  where False = _is_boot_phase()">tests/test_auth_monitoring.py:159: in test_boot_phase_detection
    assert _is_boot_phase() is True
E   assert False is True
E    +  where False = _is_boot_phase()</failure></testcase><testcase classname="tests.test_auth_monitoring.TestAuthMonitoring" name="test_error_handling" time="0.002" /><testcase classname="tests.test_auth_monitoring.TestAuthMonitoringIntegration" name="test_whoami_endpoint_monitoring" time="0.008"><failure message="TypeError: object Response can't be used in 'await' expression">tests/test_auth_monitoring.py:192: in test_whoami_endpoint_monitoring
    response = await client.get("/v1/whoami")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object Response can't be used in 'await' expression</failure></testcase><testcase classname="tests.test_auth_monitoring.TestAuthMonitoringIntegration" name="test_finish_endpoint_monitoring" time="0.006"><failure message="TypeError: object Response can't be used in 'await' expression">tests/test_auth_monitoring.py:207: in test_finish_endpoint_monitoring
    response = await client.post("/v1/auth/finish")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object Response can't be used in 'await' expression</failure></testcase><testcase classname="tests.test_auth_monitoring.TestAuthMonitoringIntegration" name="test_privileged_call_blocking_monitoring" time="0.005"><failure message="TypeError: object Response can't be used in 'await' expression">tests/test_auth_monitoring.py:217: in test_privileged_call_blocking_monitoring
    response = await client.get("/v1/me")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object Response can't be used in 'await' expression</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_session_only_http_auth_via_store_identity" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_phase1.py:36: in test_session_only_http_auth_via_store_identity
    cookies = _login_and_get_cookies(client)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_auth_phase1.py:22: in _login_and_get_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_options_never_401_with_require_user" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/test_auth_phase1.py:52: in test_options_never_401_with_require_user
    r = client.options("/v1/auth/clerk/protected")
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_ws_auth_with_canonical_session_cookie" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_phase1.py:58: in test_ws_auth_with_canonical_session_cookie
    cookies = _login_and_get_cookies(client)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_auth_phase1.py:22: in _login_and_get_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_ws_auth_with_legacy_session_cookie" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_phase1.py:68: in test_ws_auth_with_legacy_session_cookie
    cookies = _login_and_get_cookies(client)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_auth_phase1.py:22: in _login_and_get_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_store_outage_session_only_503_but_header_passes" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_phase1.py:78: in test_store_outage_session_only_503_but_header_passes
    cookies = _login_and_get_cookies(client, username="bob")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_auth_phase1.py:22: in _login_and_get_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_phase1" name="test_lazy_refresh_sets_new_access_token_cookie" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_phase1.py:109: in test_lazy_refresh_sets_new_access_token_cookie
    cookies = _login_and_get_cookies(client, username="carol")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_auth_phase1.py:22: in _login_and_get_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_spotify" name="test_happy_path_whoami_and_spotify_status" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_spotify.py:16: in test_happy_path_whoami_and_spotify_status
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_spotify" name="test_spotify_devices_requires_auth" time="0.004"><failure message="assert 404 in (401, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_spotify.py:31: in test_spotify_devices_requires_auth
    assert r.status_code in (401, 403)
E   assert 404 in (401, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_spotify" name="test_header_mode_sees_authorization" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_spotify.py:40: in test_header_mode_sees_authorization
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_spotify" name="test_spotify_callback_shape" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_auth_spotify.py:46: in test_spotify_callback_shape
    assert r.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_auth_store" name="test_auth_store_crud" time="0.042" /><testcase classname="tests.test_browser_auth" name="test_boot_sequence" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f4c15e0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f4c15e0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f4c15e0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_browser_auth.py:37: in test_boot_sequence
    whoami_response = session.get(f"{BASE_URL}/v1/whoami", timeout=5)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:602: in get
    return self.request("GET", url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f4c15e0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_browser_auth" name="test_401_handling" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f439cd0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f439cd0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f439cd0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_browser_auth.py:108: in test_401_handling
    state_response = session.get(f"{BASE_URL}/v1/state", timeout=5)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:602: in get
    return self.request("GET", url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f439cd0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_browser_auth" name="test_refresh_cookie_only" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f52bb30&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f52bb30&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f52bb30&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_browser_auth.py:161: in test_refresh_cookie_only
    response = session.post(f"{BASE_URL}/v1/auth/refresh", headers=headers, timeout=5)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f52bb30&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_browser_auth" name="test_login_and_refresh_flow" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x117ef7020&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x117ef7020&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x117ef7020&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_browser_auth.py:191: in test_login_and_refresh_flow
    login_response = session.post(f"{BASE_URL}/login", json=login_data, timeout=5)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x117ef7020&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_browser_auth" name="test_no_html_redirects" time="0.009" /><testcase classname="tests.test_budget_caps" name="test_quota_breach_disables_escalation" time="0.005" /><testcase classname="tests.test_budget_caps" name="test_reply_len_target_reduced_under_budget" time="0.002" /><testcase classname="tests.test_budget_property" name="test_budget_property_caps_random" time="0.002" /><testcase classname="tests.test_builder_defaults_top_k" name="test_builder_defaults_top_k" time="0.008" /><testcase classname="tests.test_cache_none_feedback" name="test_cache_allows_none_feedback" time="0.002" /><testcase classname="tests.test_cache_segregation" name="test_cache_segregation_by_model" time="0.002" /><testcase classname="tests.test_cache_segregation" name="test_cache_segregation_different_models_same_prompt" time="0.002" /><testcase classname="tests.test_calendar_api" name="test_calendar_next_returns_three_sorted" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_calendar_api.py:38: in test_calendar_next_returns_three_sorted
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_list_returns_all_sorted" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_calendar_api.py:49: in test_calendar_list_returns_all_sorted
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_today_filters_today_only" time="0.011"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_calendar_api.py:73: in test_calendar_today_filters_today_only
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_calendar_api" name="test_openapi_calendar_models_present_with_examples" time="0.005"><failure message="AssertionError: assert ('Event' in {})">tests/test_calendar_api.py:83: in test_openapi_calendar_models_present_with_examples
    assert "Event" in schemas and "EventsResponse" in schemas
E   AssertionError: assert ('Event' in {})</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_endpoints_tagged_calendar[/v1/calendar/next]" time="0.004"><failure message="assert (None)">tests/test_calendar_api.py:99: in test_calendar_endpoints_tagged_calendar
    assert op and "Calendar" in (op.get("tags") or [])
E   assert (None)</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_endpoints_tagged_calendar[/v1/calendar/today]" time="0.003"><failure message="assert (None)">tests/test_calendar_api.py:99: in test_calendar_endpoints_tagged_calendar
    assert op and "Calendar" in (op.get("tags") or [])
E   assert (None)</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_endpoints_tagged_calendar[/v1/calendar/list]" time="0.005"><failure message="assert (None)">tests/test_calendar_api.py:99: in test_calendar_endpoints_tagged_calendar
    assert op and "Calendar" in (op.get("tags") or [])
E   assert (None)</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_response_shapes" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_calendar_api.py:106: in test_calendar_response_shapes
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_calendar_api" name="test_calendar_openapi_status_code_200_has_model" time="0.003"><failure message="AssertionError: assert False&#10; +  where False = &lt;built-in method endswith of str object at 0x11060a538&gt;('/EventsResponse')&#10; +    where &lt;built-in method endswith of str object at 0x11060a538&gt; = ''.endswith&#10; +      where '' = &lt;built-in method get of dict object at 0x1203087c0&gt;('$ref', '')&#10; +        where &lt;built-in method get of dict object at 0x1203087c0&gt; = {}.get">tests/test_calendar_api.py:120: in test_calendar_openapi_status_code_200_has_model
    assert schema.get("$ref", "").endswith("/EventsResponse")
E   AssertionError: assert False
E    +  where False = &lt;built-in method endswith of str object at 0x11060a538&gt;('/EventsResponse')
E    +    where &lt;built-in method endswith of str object at 0x11060a538&gt; = ''.endswith
E    +      where '' = &lt;built-in method get of dict object at 0x1203087c0&gt;('$ref', '')
E    +        where &lt;built-in method get of dict object at 0x1203087c0&gt; = {}.get</failure></testcase><testcase classname="tests.test_camera_plan" name="test_camera_plan_low_risk" time="0.002" /><testcase classname="tests.test_camera_plan" name="test_camera_plan_high_risk_safety_retry" time="0.003" /><testcase classname="tests.test_capture" name="test_record_creates_file" time="0.011" /><testcase classname="tests.test_capture_auth" name="test_capture_start_sets_user_id_from_token" time="0.013" /><testcase classname="tests.test_capture_auth" name="test_capture_start_invalid_token" time="0.008" /><testcase classname="tests.test_care_api" name="test_alert_create_ack_flow" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_api.py:31: in test_alert_create_ack_flow
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_care_api" name="test_device_heartbeat_status" time="0.005"><failure message="assert (404 == 200)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_api.py:42: in test_device_heartbeat_status
    assert s0.status_code == 200 and s0.json()["online"] is False
E   assert (404 == 200)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_validation_invalid_kind" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_extras.py:30: in test_alert_validation_invalid_kind
    assert r.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_validation_invalid_severity" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_extras.py:39: in test_alert_validation_invalid_severity
    assert r.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_ack_idempotent" time="0.004"><failure message="KeyError: 'id'">tests/test_care_extras.py:48: in test_alert_ack_idempotent
    aid = r.json()["id"]
          ^^^^^^^^^^^^^^
E   KeyError: 'id'</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_resolve_flow" time="0.005"><failure message="KeyError: 'id'">tests/test_care_extras.py:61: in test_alert_resolve_flow
    aid = r.json()["id"]
          ^^^^^^^^^^^^^^
E   KeyError: 'id'</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_list_filter_by_resident" time="0.010" /><testcase classname="tests.test_care_extras" name="test_alert_sms_enqueued" time="0.002"><failure message="ModuleNotFoundError: No module named 'app.queue'">tests/test_care_extras.py:90: in test_alert_sms_enqueued
    import app.queue as aq
E   ModuleNotFoundError: No module named 'app.queue'</failure></testcase><testcase classname="tests.test_care_extras" name="test_ws_broadcast_created_and_ack" time="0.005"><failure message="starlette.websockets.WebSocketDisconnect">tests/test_care_extras.py:104: in test_ws_broadcast_created_and_ack
    with c.websocket_connect("/v1/ws/care") as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.test_care_extras" name="test_heartbeat_online_and_offline_by_time" time="0.028"><failure message="KeyError: 'online'">tests/test_care_extras.py:132: in test_heartbeat_online_and_offline_by_time
    assert s1.json()["online"] is True
           ^^^^^^^^^^^^^^^^^^^
E   KeyError: 'online'</failure></testcase><testcase classname="tests.test_care_extras" name="test_device_battery_in_status" time="0.007"><failure message="AssertionError: assert None == 11&#10; +  where None = &lt;built-in method get of dict object at 0x11f6cd680&gt;('battery')&#10; +    where &lt;built-in method get of dict object at 0x11f6cd680&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J7EQK1EJ41AW4VYVYDNWA', 'method': 'GET', 'path': '/v1/care/device_status', ...}, 'message': 'Not Found'}.get&#10; +      where {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J7EQK1EJ41AW4VYVYDNWA', 'method': 'GET', 'path': '/v1/care/device_status', ...}, 'message': 'Not Found'} = json()&#10; +        where json = &lt;Response [404 Not Found]&gt;.json">tests/test_care_extras.py:147: in test_device_battery_in_status
    assert s.json().get("battery") == 11
E   AssertionError: assert None == 11
E    +  where None = &lt;built-in method get of dict object at 0x11f6cd680&gt;('battery')
E    +    where &lt;built-in method get of dict object at 0x11f6cd680&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J7EQK1EJ41AW4VYVYDNWA', 'method': 'GET', 'path': '/v1/care/device_status', ...}, 'message': 'Not Found'}.get
E    +      where {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J7EQK1EJ41AW4VYVYDNWA', 'method': 'GET', 'path': '/v1/care/device_status', ...}, 'message': 'Not Found'} = json()
E    +        where json = &lt;Response [404 Not Found]&gt;.json</failure></testcase><testcase classname="tests.test_care_extras" name="test_sessions_filter_by_resident" time="0.009" /><testcase classname="tests.test_care_extras" name="test_contacts_crud_create_list_update_delete" time="0.004"><failure message="KeyError: 'id'">tests/test_care_extras.py:171: in test_contacts_crud_create_list_update_delete
    cid = r.json()["id"]
          ^^^^^^^^^^^^^^
E   KeyError: 'id'</failure></testcase><testcase classname="tests.test_care_extras" name="test_ack_via_link_token_flow" time="0.004"><failure message="KeyError: 'id'">tests/test_care_extras.py:192: in test_ack_via_link_token_flow
    aid = r.json()["id"]
          ^^^^^^^^^^^^^^
E   KeyError: 'id'</failure></testcase><testcase classname="tests.test_care_extras" name="test_contacts_quiet_hours_json_handling" time="0.005"><failure message="KeyError: 'id'">tests/test_care_extras.py:206: in test_contacts_quiet_hours_json_handling
    cid = r.json()["id"]
          ^^^^^^^^^^^^^^
E   KeyError: 'id'</failure></testcase><testcase classname="tests.test_care_extras" name="test_alert_resolve_nonexistent" time="0.004" /><testcase classname="tests.test_care_extras" name="test_ack_invalid_token" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_extras.py:223: in test_ack_invalid_token
    assert a.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_care_sessions_contacts" name="test_sessions_crud" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_care_sessions_contacts.py:10: in test_sessions_crud
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_chroma_query_user_memories" name="test_query_user_memories_recomputes_and_sorts" time="0.002" /><testcase classname="tests.test_chroma_store_extra" name="test_chroma_length_metric_does_not_over_filter" time="0.003" /><testcase classname="tests.test_coerce_k" name="test_coerce_k[None-3]" time="0.002" /><testcase classname="tests.test_coerce_k" name="test_coerce_k[-3]" time="0.001" /><testcase classname="tests.test_coerce_k" name="test_coerce_k[3-3]" time="0.003" /><testcase classname="tests.test_coerce_k" name="test_coerce_k[0-3]" time="0.002" /><testcase classname="tests.test_coerce_k" name="test_build_sanitizes_top_k" time="0.008" /><testcase classname="tests.test_complete_auth_flow" name="test_boot_sequence_analysis" time="0.006"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f503d40&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f503d40&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f503d40&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_complete_auth_flow.py:39: in test_boot_sequence_analysis
    whoami_response = session.get(f"{BASE_URL}/v1/whoami", timeout=5)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:602: in get
    return self.request("GET", url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f503d40&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_complete_auth_flow" name="test_401_handling_sequence" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f3c6ba0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f3c6ba0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f3c6ba0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_complete_auth_flow.py:105: in test_401_handling_sequence
    state_response = session.get(f"{BASE_URL}/v1/state", timeout=5)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:602: in get
    return self.request("GET", url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f3c6ba0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_complete_auth_flow" name="test_cors_vs_auth" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x112c6ca70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x112c6ca70&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x112c6ca70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_complete_auth_flow.py:167: in test_cors_vs_auth
    response = session.get(f"{BASE_URL}/v1/state", headers=headers, timeout=5)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:602: in get
    return self.request("GET", url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x112c6ca70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_complete_auth_flow" name="test_refresh_cookie_only" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f835ee0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f835ee0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f835ee0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_complete_auth_flow.py:219: in test_refresh_cookie_only
    response = session.post(f"{BASE_URL}/v1/auth/refresh", headers=headers, timeout=5)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/auth/refresh (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f835ee0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_complete_auth_flow" name="test_no_html_redirects" time="0.010" /><testcase classname="tests.test_complete_auth_flow" name="test_authenticated_flow" time="0.006"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f1f7e00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f1f7e00&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f1f7e00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_complete_auth_flow.py:334: in test_authenticated_flow
    login_response = session.post(f"{BASE_URL}/login", json=login_data, timeout=5)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /login (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f1f7e00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_auth_token_creation_edge_cases" time="0.003" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_concurrent_token_creation" time="0.017" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_memory_store_large_content" time="0.003" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_memory_store_empty_content" time="0.002" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_memory_store_none_content" time="0.002" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_llama_integration_failures" time="0.005"><failure message="assert True is False">tests/test_comprehensive_errors.py:225: in test_llama_integration_failures
    assert LLAMA_HEALTHY is False  # Should mark as unhealthy
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert True is False</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_gpt_client_failures" time="0.004"><failure message="RuntimeError: GPT backend unavailable (test stub)">tests/test_comprehensive_errors.py:231: in test_gpt_client_failures
    result = event_loop.run_until_complete(
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tasks.py:520: in wait_for
    return await fut
           ^^^^^^^^^
app/gpt_client.py:189: in ask_gpt
    raise RuntimeError("GPT backend unavailable (test stub)")
E   RuntimeError: GPT backend unavailable (test stub)</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_request_id_collisions" time="2.181"><failure message="assert 0 == 1000&#10; +  where 0 = len(set())">tests/test_comprehensive_errors.py:265: in test_request_id_collisions
    assert len(request_ids) == 1000
E   assert 0 == 1000
E    +  where 0 = len(set())</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_concurrent_request_success" time="0.245"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:280: in test_concurrent_request_success
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_concurrent_request_unique_ids" time="0.297" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_test_isolation" time="0.009"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:316: in test_test_isolation
    assert response1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_large_payload_handling" time="0.005"><failure message="assert 404 in [200, 400, 413, 500]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:327: in test_large_payload_handling
    assert response.status_code in [200, 400, 413, 500]
E   assert 404 in [200, 400, 413, 500]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_malformed_json_request" time="0.006"><failure message="assert 404 in [400, 422]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:337: in test_malformed_json_request
    assert response.status_code in [400, 422]
E   assert 404 in [400, 422]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_missing_required_fields" time="0.006"><failure message="assert 404 in [400, 422]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:342: in test_missing_required_fields
    assert response.status_code in [400, 422]
E   assert 404 in [400, 422]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_wrong_content_type" time="0.005"><failure message="assert 404 in [400, 415, 422]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:349: in test_wrong_content_type
    assert response.status_code in [400, 415, 422]
E   assert 404 in [400, 415, 422]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_resource_cleanup" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:366: in test_resource_cleanup
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_error_logging_completeness" time="0.004" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_startup_failure_recovery" time="0.006"><failure message="assert 404 in [200, 503]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:398: in test_startup_failure_recovery
    assert response.status_code in [200, 503]  # Should handle degraded state
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in [200, 503]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_performance_degradation" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:407: in test_performance_degradation
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_file_system_errors" time="0.002" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_network_timeout_scenarios" time="0.004"><failure message="Failed: DID NOT RAISE &lt;class 'TimeoutError'&gt;">tests/test_comprehensive_errors.py:436: in test_network_timeout_scenarios
    with pytest.raises(TimeoutError, match="Network timeout"):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE &lt;class 'TimeoutError'&gt;</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_memory_exhaustion" time="0.006" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_concurrent_database_access" time="0.124"><failure message="assert 404 in [200, 201, 400, 401, 422, 500]">tests/test_comprehensive_errors.py:475: in test_concurrent_database_access
    assert result in [200, 201, 400, 401, 422, 500]  # Expected status codes
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in [200, 201, 400, 401, 422, 500]</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_error_propagation" time="0.005"><failure message="assert 404 in [200, 503]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:486: in test_error_propagation
    assert response.status_code in [200, 503]
E   assert 404 in [200, 503]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_logging_under_load" time="0.154" /><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_component_isolation" time="0.004"><failure message="assert 404 in [200, 503]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:515: in test_component_isolation
    assert response.status_code in [200, 503]
E   assert 404 in [200, 503]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestComprehensiveErrors" name="test_error_recovery" time="3.173"><failure message="Failed: DID NOT RAISE &lt;class 'Exception'&gt;">tests/test_comprehensive_errors.py:525: in test_error_recovery
    with pytest.raises(Exception, match="Temporary failure"):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE &lt;class 'Exception'&gt;</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestIntegrationFailures" name="test_external_service_failures" time="0.006"><failure message="assert 404 in [500, 503]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:560: in test_external_service_failures
    assert response.status_code in [500, 503]
E   assert 404 in [500, 503]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestIntegrationFailures" name="test_configuration_errors" time="0.004"><failure message="Failed: DID NOT RAISE any of (&lt;class 'KeyError'&gt;, &lt;class 'ValueError'&gt;, &lt;class 'ImportError'&gt;)">tests/test_comprehensive_errors.py:578: in test_configuration_errors
    with pytest.raises((KeyError, ValueError, ImportError)):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE any of (&lt;class 'KeyError'&gt;, &lt;class 'ValueError'&gt;, &lt;class 'ImportError'&gt;)</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestIntegrationFailures" name="test_data_corruption_scenarios" time="0.005"><failure message="assert 404 in [200, 401, 403]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_comprehensive_errors.py:591: in test_data_corruption_scenarios
    assert response.status_code in [200, 401, 403]
E   assert 404 in [200, 401, 403]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_comprehensive_errors.TestIntegrationFailures" name="test_rate_limiting_edge_cases" time="0.213"><failure message="AssertionError: All requests were blocked&#10;assert 0 &gt; 0">tests/test_comprehensive_errors.py:606: in test_rate_limiting_edge_cases
    assert success_count &gt; 0, "All requests were blocked"
E   AssertionError: All requests were blocked
E   assert 0 &gt; 0</failure></testcase><testcase classname="tests.test_comprehensive_routing" name="test_allowlist_validation" time="0.002"><failure message="ImportError: cannot import name '_validate_model_allowlist' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)">tests/test_comprehensive_routing.py:16: in test_allowlist_validation
    from app.router import _validate_model_allowlist
E   ImportError: cannot import name '_validate_model_allowlist' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)</failure></testcase><testcase classname="tests.test_comprehensive_routing" name="test_fallback_logic" time="0.002"><failure message="ImportError: cannot import name '_get_fallback_model' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)">tests/test_comprehensive_routing.py:50: in test_fallback_logic
    from app.router import _get_fallback_model, _get_fallback_vendor
E   ImportError: cannot import name '_get_fallback_model' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)</failure></testcase><testcase classname="tests.test_comprehensive_routing" name="test_keyword_detection" time="0.003" /><testcase classname="tests.test_comprehensive_routing" name="test_golden_trace_structure" time="0.002"><failure message="ImportError: cannot import name '_log_golden_trace' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)">tests/test_comprehensive_routing.py:97: in test_golden_trace_structure
    from app.router import _log_golden_trace
E   ImportError: cannot import name '_log_golden_trace' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)</failure></testcase><testcase classname="tests.test_comprehensive_routing" name="test_environment_configuration" time="0.002" /><testcase classname="tests.test_comprehensive_routing" name="test_endpoints" time="0.002" /><testcase classname="tests.test_comprehensive_routing" name="test_metrics_structure" time="0.002" /><testcase classname="tests.test_comprehensive_routing" name="test_fallback_metrics_labeling" time="0.002"><failure message="ImportError: cannot import name '_get_fallback_vendor' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)">tests/test_comprehensive_routing.py:195: in test_fallback_metrics_labeling
    from app.router import _get_fallback_vendor
E   ImportError: cannot import name '_get_fallback_vendor' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)</failure></testcase><testcase classname="tests.test_comprehensive_routing" name="test_user_circuit_breaker_thread_safety" time="0.002"><failure message="ImportError: cannot import name '_user_cb_record_failure' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)">tests/test_comprehensive_routing.py:238: in test_user_circuit_breaker_thread_safety
    from app.router import _user_cb_record_failure, _user_cb_reset, _user_circuit_open
E   ImportError: cannot import name '_user_cb_record_failure' from 'app.router' (/Users/kingal/2025/GesahniV2/app/router/__init__.py)</failure></testcase><testcase classname="tests.test_comprehensive_skills" name="test_skills_comprehensive" time="0.008" /><testcase classname="tests.test_config" name="test_key" time="0.002"><failure message="AssertionError: OPENAI_API_KEY should be set in test environment&#10;assert ''">tests/test_config.py:42: in test_key
    assert key, "OPENAI_API_KEY should be set in test environment"
E   AssertionError: OPENAI_API_KEY should be set in test environment
E   assert ''</failure></testcase><testcase classname="tests.test_config" name="test_config_forbidden" time="0.108"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_config.py:65: in test_config_forbidden
    assert resp.status_code == 401  # Should be 401 for unauthenticated, not 403
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_config" name="test_config_allowed" time="0.113"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_config.py:91: in test_config_allowed
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_config" name="test_config_env_reload" time="0.115"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_config.py:126: in test_config_env_reload
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_cookie_centralization" name="test_cookie_facade_functions" time="0.004" /><testcase classname="tests.test_cookie_consistency" name="test_login_sets_cookies_once" time="0.548"><failure message="AssertionError: Expected 1 access_token cookie, got 0&#10;assert 0 == 1&#10; +  where 0 = len([])">tests/test_cookie_consistency.py:79: in test_login_sets_cookies_once
    assert (
E   AssertionError: Expected 1 access_token cookie, got 0
E   assert 0 == 1
E    +  where 0 = len([])</failure></testcase><testcase classname="tests.test_cookie_consistency" name="test_refresh_sets_cookies_once" time="0.526"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/test_cookie_consistency.py:131: in test_refresh_sets_cookies_once
    assert refresh_resp.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.test_cookie_consistency" name="test_logout_clears_cookies_properly" time="0.558"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/test_cookie_consistency.py:198: in test_logout_clears_cookies_properly
    assert refresh_resp.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.test_cookie_consistency" name="test_cookie_attributes_consistency" time="0.523"><failure message="IndexError: list index out of range">tests/test_cookie_consistency.py:264: in test_cookie_attributes_consistency
    login_access = [h for h in login_cookies if "access_token=" in h][0]
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   IndexError: list index out of range</failure></testcase><testcase classname="tests.test_cookie_policy" name="test_set_named_cookie_enforces_samesite_none_secure" time="0.002" /><testcase classname="tests.test_cookies_https" name="test_auth_cookies_secure_in_https_context" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_cookies_https.py:14: in test_auth_cookies_secure_in_https_context
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_cors_credentials" name="test_cors_with_credentials" time="0.049"><failure message="httpx.ConnectError: All connection attempts failed">.venv/lib/python3.12/site-packages/httpx/_transports/default.py:101: in map_httpcore_exceptions
    yield
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:394: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
.venv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:101: in handle_async_request
    raise exc
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:78: in handle_async_request
    stream = await self._connect(request)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:124: in _connect
    stream = await self._network_backend.connect_tcp(**kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_backends/auto.py:31: in connect_tcp
    return await self._backend.connect_tcp(
.venv/lib/python3.12/site-packages/httpcore/_backends/anyio.py:113: in connect_tcp
    with map_exceptions(exc_map):
         ^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/httpcore/_exceptions.py:14: in map_exceptions
    raise to_exc(exc) from exc
E   httpcore.ConnectError: All connection attempts failed

The above exception was the direct cause of the following exception:
tests/test_cors_credentials.py:12: in test_cors_with_credentials
    response = await client.get(
.venv/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:393: in handle_async_request
    with map_httpcore_exceptions():
         ^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:118: in map_httpcore_exceptions
    raise mapped_exc(message) from exc
E   httpx.ConnectError: All connection attempts failed</failure></testcase><testcase classname="tests.test_cors_middleware" name="test_cors" time="0.054"><failure message="httpx.ConnectError: All connection attempts failed">.venv/lib/python3.12/site-packages/httpx/_transports/default.py:101: in map_httpcore_exceptions
    yield
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:394: in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py:256: in handle_async_request
    raise exc from None
.venv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py:236: in handle_async_request
    response = await connection.handle_async_request(
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:101: in handle_async_request
    raise exc
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:78: in handle_async_request
    stream = await self._connect(request)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_async/connection.py:124: in _connect
    stream = await self._network_backend.connect_tcp(**kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpcore/_backends/auto.py:31: in connect_tcp
    return await self._backend.connect_tcp(
.venv/lib/python3.12/site-packages/httpcore/_backends/anyio.py:113: in connect_tcp
    with map_exceptions(exc_map):
         ^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/httpcore/_exceptions.py:14: in map_exceptions
    raise to_exc(exc) from exc
E   httpcore.ConnectError: All connection attempts failed

The above exception was the direct cause of the following exception:
tests/test_cors_middleware.py:12: in test_cors
    response = await client.get(
.venv/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
.venv/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:393: in handle_async_request
    with map_httpcore_exceptions():
         ^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/httpx/_transports/default.py:118: in map_httpcore_exceptions
    raise mapped_exc(message) from exc
E   httpx.ConnectError: All connection attempts failed</failure></testcase><testcase classname="tests.test_cors_on_error" name="test_cors_on_error_has_headers" time="0.097"><failure message="AssertionError: assert 'access-control-allow-origin' in {'content-length': '255', 'content-type': 'application/json', 'x-error-code': 'not_found'}">tests/test_cors_on_error.py:21: in test_cors_on_error_has_headers
    assert "access-control-allow-origin" in {
E   AssertionError: assert 'access-control-allow-origin' in {'content-length': '255', 'content-type': 'application/json', 'x-error-code': 'not_found'}</failure></testcase><testcase classname="tests.test_csrf_cookie_flags" name="test_csrf_cookie_flags" time="0.101"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_csrf_cookie_flags.py:13: in test_csrf_cookie_flags
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_csrf_cors_integration" name="test_csrf_cookie_and_cors" time="3.190"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_csrf_cors_integration.py:13: in test_csrf_cookie_and_cors
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_debug_model_routing" name="test_dry_run_llama_path" time="0.002"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_debug_model_routing.py:38: in test_dry_run_llama_path
    _common_patches(monkeypatch, router)
tests/test_debug_model_routing.py:21: in _common_patches
    monkeypatch.setattr(router, "handle_command", _handle)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_debug_model_routing" name="test_dry_run_gpt_fallback" time="0.002"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_debug_model_routing.py:54: in test_dry_run_gpt_fallback
    _common_patches(monkeypatch, router)
tests/test_debug_model_routing.py:21: in _common_patches
    monkeypatch.setattr(router, "handle_command", _handle)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_dedup" name="test_dedup_middleware" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_dedup.py:22: in test_dedup_middleware
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_dedupe_ledger" name="test_dedupe_idempotency" time="0.019" /><testcase classname="tests.test_embeddings" name="test_embed_openai" time="0.005" /><testcase classname="tests.test_embeddings" name="test_embed_model_env" time="0.002" /><testcase classname="tests.test_embeddings" name="test_embed_llama" time="0.008" /><testcase classname="tests.test_embeddings" name="test_benchmark" time="0.004" /><testcase classname="tests.test_embeddings" name="test_embedding_backend_logged[openai]" time="0.004" /><testcase classname="tests.test_embeddings" name="test_embedding_backend_logged[llama]" time="0.004" /><testcase classname="tests.test_embeddings" name="test_embedding_backend_logged[stub]" time="0.002" /><testcase classname="tests.test_embeddings" name="test_force_stub_pytest[embed_sync]" time="0.003" /><testcase classname="tests.test_embeddings" name="test_force_stub_pytest[embed]" time="0.002" /><testcase classname="tests.test_embeddings" name="test_force_stub_memory[embed_sync]" time="0.002" /><testcase classname="tests.test_embeddings" name="test_force_stub_memory[embed]" time="0.002" /><testcase classname="tests.test_embeddings" name="test_openai_cache_ttl" time="0.008" /><testcase classname="tests.test_embeddings" name="test_llama_missing_dependency" time="0.002" /><testcase classname="tests.test_embeddings" name="test_llama_missing_model" time="0.001" /><testcase classname="tests.test_embeddings" name="test_stub_deterministic" time="0.002" /><testcase classname="tests.test_end_to_end_spotify_flow" name="test_complete_e2e_spotify_flow" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1200beff0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x1200beff0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1200beff0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_end_to_end_spotify_flow.py:21: in test_complete_e2e_spotify_flow
    login_response = requests.get(login_url, cookies=cookies)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1200beff0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_env_parsing_fuzz" name="test_env_parsing_fuzz" time="0.004" /><testcase classname="tests.test_error_envelope" name="test_build_error_contains_ids" time="0.001" /><testcase classname="tests.test_error_envelope" name="test_raise_enveloped_raises_http_exception" time="0.001" /><testcase classname="tests.test_follow_up" name="test_schedule_and_persist" time="0.017" /><testcase classname="tests.test_follow_up" name="test_cancel_follow_up" time="0.009" /><testcase classname="tests.test_footer_ribbon_ui_stub" name="test_footer_ribbon_truncation_logic" time="0.001" /><testcase classname="tests.test_google_connect_flow" name="test_google_connect_flow" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=3000): Max retries exceeded with url: /settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12006d640&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x12006d640&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=3000): Max retries exceeded with url: /settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12006d640&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_google_connect_flow.py:14: in test_google_connect_flow
    response = requests.get(f"{FRONTEND_URL}/settings")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=3000): Max retries exceeded with url: /settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12006d640&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_google_flow" name="test_google_oauth_flow" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/google/auth/login_url?next=/settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1202a4590&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x1202a4590&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/google/auth/login_url?next=/settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1202a4590&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_google_flow.py:12: in test_google_oauth_flow
    response = requests.get(f"{BASE_URL}/v1/google/auth/login_url?next=/settings")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/google/auth/login_url?next=/settings (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x1202a4590&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_google_mismatch" name="test_enable_service_account_mismatch" time="0.019"><failure message="assert 0 == 2&#10; +  where 0 = len([])">tests/test_google_mismatch.py:50: in test_enable_service_account_mismatch
    assert len(all_tokens) == 2
E   assert 0 == 2
E    +  where 0 = len([])</failure></testcase><testcase classname="tests.test_google_mismatch_brand" name="test_brand_account_same_email_different_sub" time="0.018"><failure message="AttributeError: &lt;module 'app.api.google_services' from '/Users/kingal/2025/GesahniV2/app/api/google_services.py'&gt; has no attribute 'get_all_user_tokens'">tests/test_google_mismatch_brand.py:44: in test_brand_account_same_email_different_sub
    monkeypatch.setattr(google_services, "get_all_user_tokens", lambda user: dao.get_all_user_tokens(user))
E   AttributeError: &lt;module 'app.api.google_services' from '/Users/kingal/2025/GesahniV2/app/api/google_services.py'&gt; has no attribute 'get_all_user_tokens'</failure></testcase><testcase classname="tests.test_google_oauth_login" name="test_google_login_flow" time="0.028"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_google_oauth_login.py:80: in test_google_login_flow
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_gpt_client_cost" name="test_cost_breakdown" time="0.004" /><testcase classname="tests.test_header_auth" name="test_whoami_with_header" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fd01a00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11fd01a00&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fd01a00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_header_auth.py:26: in test_whoami_with_header
    response = requests.get(f"{BASE_URL}/v1/whoami")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/whoami (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fd01a00&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_header_auth" name="test_csrf_bypass" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f714b90&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11f714b90&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f714b90&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_header_auth.py:51: in test_csrf_bypass
    response = requests.post(f"{BASE_URL}/v1/state", json=data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:115: in post
    return request("post", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11f714b90&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_header_auth" name="test_state_endpoint" time="0.005"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fdeba70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x11fdeba70&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fdeba70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_header_auth.py:72: in test_state_endpoint
    response = requests.get(f"{BASE_URL}/v1/state")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/state (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x11fdeba70&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_health" name="test_health_never_500" time="0.003"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health.py:24: in test_health_never_500
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_exponential_backoff_before_success" time="0.008"><failure message="assert 0 == 1">tests/test_health_check_improvements.py:56: in test_exponential_backoff_before_success
    assert llama_health_check_state["consecutive_failures"] == 1
E   assert 0 == 1</failure></testcase><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_success_resets_backoff" time="0.005"><failure message="assert 5.0 == 10.0">tests/test_health_check_improvements.py:85: in test_success_resets_backoff
    assert llama_health_check_state["next_check_delay"] == 10.0
E   assert 5.0 == 10.0</failure></testcase><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_throttling_after_success" time="0.004" /><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_max_delay_cap" time="0.005"><failure message="assert 200.0 == 300.0">tests/test_health_check_improvements.py:138: in test_max_delay_cap
    assert llama_health_check_state["next_check_delay"] == 300.0
E   assert 200.0 == 300.0</failure></testcase><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_schedule_next_health_check" time="0.006"><failure message="assert &lt;function _check_and_set_flag at 0x11f74c9a0&gt; == _check_and_set_flag">tests/test_health_check_improvements.py:156: in test_schedule_next_health_check
    assert call_args[0][0] == _check_and_set_flag  # function
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert &lt;function _check_and_set_flag at 0x11f74c9a0&gt; == _check_and_set_flag</failure></testcase><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_startup_check_schedules_health_check" time="0.006" /><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_skip_health_check_due_to_throttling" time="0.005" /><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_skip_health_check_due_to_backoff" time="0.005" /><testcase classname="tests.test_health_check_improvements.TestHealthCheckImprovements" name="test_health_check_proceeds_when_not_throttled" time="0.005"><failure message="AssertionError: assert 0 == 1&#10; +  where 0 = &lt;AsyncMock name='json_request' id='4829178832'&gt;.call_count">tests/test_health_check_improvements.py:243: in test_health_check_proceeds_when_not_throttled
    assert mock_json_request.call_count == 1
E   AssertionError: assert 0 == 1
E    +  where 0 = &lt;AsyncMock name='json_request' id='4829178832'&gt;.call_count</failure></testcase><testcase classname="tests.test_health_checks" name="test_health_qdrant_endpoint_present" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_checks.py:11: in test_health_qdrant_endpoint_present
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_checks" name="test_health_chroma_endpoint_present" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_checks.py:18: in test_health_chroma_endpoint_present
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_contract" name="test_ready_contract_shape" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_contract.py:22: in test_ready_contract_shape
    assert r.status_code == 200  # Never 5xx for readiness probes
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_degradation" name="test_healthz_degrades_when_deps_missing" time="0.014" /><testcase classname="tests.test_health_deps" name="test_health_deps_degraded_llama" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_deps.py:24: in test_health_deps_degraded_llama
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_deps" name="test_health_deps_skipped_when_env_missing" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_deps.py:43: in test_health_deps_skipped_when_env_missing
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_deps" name="test_llama_skipped_when_disabled_env" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_deps.py:64: in test_llama_skipped_when_disabled_env
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_deps" name="test_optional_hang_times_out" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_deps.py:80: in test_optional_hang_times_out
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_live" name="test_health_live_basic_ok" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_live.py:12: in test_health_live_basic_ok
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_live" name="test_health_live_no_auth_required" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_live.py:21: in test_health_live_no_auth_required
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_live" name="test_health_live_cache_headers_and_no_cookies" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_live.py:28: in test_health_live_cache_headers_and_no_cookies
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_live" name="test_health_live_not_rate_limited_under_hammer" time="0.046"><failure message="assert False&#10; +  where False = all(&lt;generator object test_health_live_not_rate_limited_under_hammer.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f880450&gt;)">tests/test_health_live.py:39: in test_health_live_not_rate_limited_under_hammer
    assert all(code == 200 for code in codes)
E   assert False
E    +  where False = all(&lt;generator object test_health_live_not_rate_limited_under_hammer.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f880450&gt;)</failure></testcase><testcase classname="tests.test_health_ready" name="test_health_ready_ok" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_ready.py:19: in test_health_ready_ok
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_ready" name="test_health_ready_db_fail" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_ready.py:37: in test_health_ready_db_fail
    assert r.status_code == 200  # Readiness probes never return 5xx
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_ready" name="test_health_ready_timeout_enforced" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_ready.py:56: in test_health_ready_timeout_enforced
    assert r.status_code == 200  # Readiness probes never return 5xx
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_health_ready_degraded" name="test_health_ready_degraded" time="3.177"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_health_ready_degraded.py:56: in test_health_ready_degraded
    assert r.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_healthz" name="test_healthz" time="0.016" /><testcase classname="tests.test_history" name="test_history_appends_entry" time="0.006" /><testcase classname="tests.test_home_assistant" name="test_handle_command_entity_not_found" time="0.004" /><testcase classname="tests.test_home_assistant" name="test_resolve_entity_unreachable" time="0.002" /><testcase classname="tests.test_home_assistant" name="test_request_picks_up_token" time="0.004" /><testcase classname="tests.test_home_assistant_downgrade" name="test_ha_service_human_readable" time="0.005"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_home_assistant_downgrade.py:31: in test_ha_service_human_readable
    assert res.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_home_assistant_errors" name="test_ha_error_taxonomy" time="0.002" /><testcase classname="tests.test_imports" name="test_import_all_modules" time="0.035" /><testcase classname="tests.test_intent_detector" name="test_detect_intent_cases[yo-expected0]" time="0.003" /><testcase classname="tests.test_intent_detector" name="test_detect_intent_cases[hello there-expected1]" time="0.003" /><testcase classname="tests.test_intent_detector" name="test_detect_intent_cases[turn on the lights-expected2]" time="0.002" /><testcase classname="tests.test_intent_detector" name="test_detect_intent_cases[tell me a fun fact-expected3]" time="0.002" /><testcase classname="tests.test_intent_detector" name="test_detect_intent_cases[asdasdasd-expected4]" time="0.001" /><testcase classname="tests.test_jwt_enforcement" name="test_jwt_enforcement[prod-0-True]" time="0.107" /><testcase classname="tests.test_jwt_enforcement" name="test_jwt_enforcement[production-0-True]" time="0.099" /><testcase classname="tests.test_jwt_enforcement" name="test_jwt_enforcement[dev-0-False]" time="3.281" /><testcase classname="tests.test_jwt_enforcement" name="test_jwt_enforcement[prod-1-False]" time="3.269" /><testcase classname="tests.test_jwt_enforcement" name="test_dev_warns" time="3.275"><failure message="assert False&#10; +  where False = any(&lt;generator object test_dev_warns.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f880040&gt;)">tests/test_jwt_enforcement.py:52: in test_dev_warns
    assert any("WEAK" in rec.message for rec in caplog.records)
E   assert False
E    +  where False = any(&lt;generator object test_dev_warns.&lt;locals&gt;.&lt;genexpr&gt; at 0x11f880040&gt;)</failure></testcase><testcase classname="tests.test_jwt_leeway" name="test_decode_allows_clock_skew" time="0.002" /><testcase classname="tests.test_jwt_policy" name="test_dev_weak_secret_allows" time="3.277" /><testcase classname="tests.test_jwt_policy" name="test_prod_weak_secret_rejects" time="0.090" /><testcase classname="tests.test_llama" name="test_llama_status_returns_healthy" time="0.004" /><testcase classname="tests.test_llama_tags" name="test_missing_model_warns" time="0.005"><failure message="AssertionError: assert 'missing on Ollama' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x11fdaff50&gt;.text">tests/test_llama_tags.py:21: in test_missing_model_warns
    assert "missing on Ollama" in caplog.text
E   AssertionError: assert 'missing on Ollama' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x11fdaff50&gt;.text</failure></testcase><testcase classname="tests.test_logging" name="test_request_id_header" time="0.006"><failure message="AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'})&#10; +  where Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers">tests/test_logging.py:26: in test_request_id_header
    assert "X-Request-ID" in resp.headers
E   AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'})
E    +  where Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers</failure></testcase><testcase classname="tests.test_logging" name="test_http_logging_initialized_once" time="0.004" /><testcase classname="tests.test_markitdown_ingest" name="test_ingest_markdown_text" time="0.004" /><testcase classname="tests.test_math_eval" name="test_basic_arithmetic" time="0.004"><failure message="app.skills.math_eval.EvalError: parse_error">app/skills/math_eval.py:170: in evaluate_expr
    node = ast.parse(expr, mode="eval")
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/ast.py:52: in parse
    return compile(source, filename, mode, flags,
E     File "&lt;unknown&gt;", line 1
E       ((50)/100.0) of 40
E                    ^^
E   SyntaxError: invalid syntax

The above exception was the direct cause of the following exception:
tests/test_math_eval.py:9: in test_basic_arithmetic
    v, e = evaluate_expr("50% of 40")
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
app/skills/math_eval.py:172: in evaluate_expr
    raise EvalError("parse_error") from e
E   app.skills.math_eval.EvalError: parse_error</failure></testcase><testcase classname="tests.test_math_eval" name="test_sqrt_and_pow_and_approx" time="0.002" /><testcase classname="tests.test_math_skill" name="test_pure_add" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:12: in test_pure_add
    out = run_handle("9+9")
          ^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_equals_true" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:17: in test_equals_true
    out = run_handle("9=9")
          ^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_equals_false" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:22: in test_equals_false
    out = run_handle("3*3 = 8")
          ^^^^^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_approx" time="0.001"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:27: in test_approx
    out = run_handle("1/3 ≈ 0.3333333")
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_power_caret" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:32: in test_power_caret
    out = run_handle("2^3")
          ^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_percent_of" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:37: in test_percent_of
    out = run_handle("20% * 50")
          ^^^^^^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_math_skill" name="test_funcs" time="0.001"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_math_skill.py:42: in test_funcs
    out = run_handle("sqrt(16)")
          ^^^^^^^^^^^^^^^^^^^^^^
tests/test_math_skill.py:8: in run_handle
    return asyncio.get_event_loop().run_until_complete(ms.MathSkill().handle(prompt))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_memgpt_policy_budget" name="test_policy_blocks_low_confidence" time="0.001" /><testcase classname="tests.test_memory_api_selection_extra" name="test_default_to_memory_under_pytest" time="0.004"><failure message="AssertionError: assert 'NoneType' == 'MemoryVectorStore'&#10;  &#10;  - MemoryVectorStore&#10;  + NoneType">tests/test_memory_api_selection_extra.py:13: in test_default_to_memory_under_pytest
    assert type(mem_api._store).__name__ == "MemoryVectorStore"
E   AssertionError: assert 'NoneType' == 'MemoryVectorStore'
E     
E     - MemoryVectorStore
E     + NoneType</failure></testcase><testcase classname="tests.test_memory_api_selection_extra" name="test_unknown_kind_records_fallback" time="0.004"><failure message="AssertionError: assert 'NoneType' in {'ChromaVectorStore', 'MemoryVectorStore'}&#10; +  where 'NoneType' = &lt;class 'NoneType'&gt;.__name__&#10; +    where &lt;class 'NoneType'&gt; = type(None)&#10; +      where None = &lt;module 'app.memory.api' from '/Users/kingal/2025/GesahniV2/app/memory/api.py'&gt;._store">tests/test_memory_api_selection_extra.py:22: in test_unknown_kind_records_fallback
    assert type(mem_api._store).__name__ in {"ChromaVectorStore", "MemoryVectorStore"}
E   AssertionError: assert 'NoneType' in {'ChromaVectorStore', 'MemoryVectorStore'}
E    +  where 'NoneType' = &lt;class 'NoneType'&gt;.__name__
E    +    where &lt;class 'NoneType'&gt; = type(None)
E    +      where None = &lt;module 'app.memory.api' from '/Users/kingal/2025/GesahniV2/app/memory/api.py'&gt;._store</failure></testcase><testcase classname="tests.test_memory_api_selection_extra" name="test_dual_unavailable_falls_back" time="0.004"><failure message="AssertionError: assert 'NoneType' == 'MemoryVectorStore'&#10;  &#10;  - MemoryVectorStore&#10;  + NoneType">tests/test_memory_api_selection_extra.py:35: in test_dual_unavailable_falls_back
    assert type(mem_api._store).__name__ == "MemoryVectorStore"
E   AssertionError: assert 'NoneType' == 'MemoryVectorStore'
E     
E     - MemoryVectorStore
E     + NoneType</failure></testcase><testcase classname="tests.test_metrics" name="test_metrics_exposes_prometheus_and_increments_counter" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_metrics.py:11: in test_metrics_exposes_prometheus_and_increments_counter
    assert r0.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_metrics" name="test_metrics_health_requests_count_and_latency" time="0.011"><failure message="assert 'gesahni_requests_total' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:02Z&quot;,&quot;error_id&quot;:&quot;01K46J8F9KH1A9GEKQ41XMYYZX&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics.py:29: in test_metrics_health_requests_count_and_latency
    assert "gesahni_requests_total" in body
E   assert 'gesahni_requests_total' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:02Z","error_id":"01K46J8F9KH1A9GEKQ41XMYYZX","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_endpoint" name="test_metrics_endpoint" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_metrics_endpoint.py:33: in test_metrics_endpoint
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_endpoint_exists" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_metrics_exposed.py:21: in test_metrics_endpoint_exists
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_expose_http_requests_total" time="0.013"><failure message="assert 'http_requests_total' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:02Z&quot;,&quot;error_id&quot;:&quot;01K46J8FAT6WJ07WRE98PZ2YHT&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics_exposed.py:38: in test_metrics_expose_http_requests_total
    assert "http_requests_total" in body
E   assert 'http_requests_total' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:02Z","error_id":"01K46J8FAT6WJ07WRE98PZ2YHT","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_expose_auth_fail_total" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_metrics_exposed.py:51: in test_metrics_expose_auth_fail_total
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_expose_rbac_deny_total" time="0.004"><failure message="assert 404 in [401, 403]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_metrics_exposed.py:67: in test_metrics_expose_rbac_deny_total
    assert response.status_code in [401, 403]
E   assert 404 in [401, 403]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_expose_rate_limited_total" time="0.251"><failure message="assert 'rate_limited_total' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:03Z&quot;,&quot;error_id&quot;:&quot;01K46J8FKDCMG1VW8HC1G68HTS&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics_exposed.py:89: in test_metrics_expose_rate_limited_total
    assert "rate_limited_total" in body
E   assert 'rate_limited_total' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:03Z","error_id":"01K46J8FKDCMG1VW8HC1G68HTS","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_expose_latency_histogram" time="0.008"><failure message="assert 'http_request_latency_seconds' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:03Z&quot;,&quot;error_id&quot;:&quot;01K46J8FKVGEVBNSEJAF1S3BNW&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics_exposed.py:102: in test_metrics_expose_latency_histogram
    assert "http_request_latency_seconds" in body
E   assert 'http_request_latency_seconds' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:03Z","error_id":"01K46J8FKVGEVBNSEJAF1S3BNW","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_format_is_prometheus_compliant" time="0.005"><failure message="Failed: Invalid metric value:">tests/test_metrics_exposed.py:141: in test_metrics_format_is_prometheus_compliant
    float(value_part)
E   ValueError: could not convert string to float: ''

During handling of the above exception, another exception occurred:
tests/test_metrics_exposed.py:143: in test_metrics_format_is_prometheus_compliant
    pytest.fail(f"Invalid metric value: {value_part}")
E   Failed: Invalid metric value:</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_include_help_comments" time="0.006"><failure message="assert '# HELP http_requests_total Total HTTP requests' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:03Z&quot;,&quot;error_id&quot;:&quot;01K46J8FMHKT45Y6ZN1PWVWDJA&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics_exposed.py:152: in test_metrics_include_help_comments
    assert "# HELP http_requests_total Total HTTP requests" in body
E   assert '# HELP http_requests_total Total HTTP requests' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:03Z","error_id":"01K46J8FMHKT45Y6ZN1PWVWDJA","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_exposed" name="test_metrics_include_type_comments" time="0.004"><failure message="assert '# TYPE http_requests_total counter' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/me...&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:03Z&quot;,&quot;error_id&quot;:&quot;01K46J8FMT4T8R6E4ASM4HQPN0&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/test_metrics_exposed.py:165: in test_metrics_include_type_comments
    assert "# TYPE http_requests_total counter" in body
E   assert '# TYPE http_requests_total counter' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/me...","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:03Z","error_id":"01K46J8FMT4T8R6E4ASM4HQPN0","env":"dev"}}'</failure></testcase><testcase classname="tests.test_metrics_vector" name="test_metric_objects_exist" time="0.001" /><testcase classname="tests.test_middleware_dedup" name="test_dedup_middleware_basic" time="0.008" /><testcase classname="tests.test_middleware_dedup" name="test_dedup_ttl_expiry" time="1.214" /><testcase classname="tests.test_middleware_logging" name="test_logrecord_has_observability_fields" time="0.002"><failure message="AssertionError: assert False&#10; +  where False = hasattr(LogRecord(req_id='1', prompt=None, engine_used=None, response=None, timestamp=None, session_id=None, user_id=None, cha...acts_block=None, route_trace=None, tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None), 'prompt_hash')">tests/test_middleware_logging.py:14: in test_logrecord_has_observability_fields
    assert hasattr(rec, f)
E   AssertionError: assert False
E    +  where False = hasattr(LogRecord(req_id='1', prompt=None, engine_used=None, response=None, timestamp=None, session_id=None, user_id=None, cha...acts_block=None, route_trace=None, tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None), 'prompt_hash')</failure></testcase><testcase classname="tests.test_middleware_logging" name="test_request_headers_set" time="0.008"><failure message="AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'})&#10; +  where Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers">tests/test_middleware_logging.py:32: in test_request_headers_set
    assert "X-Request-ID" in r.headers
E   AssertionError: assert 'X-Request-ID' in Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'})
E    +  where Headers({'x-error-code': 'not_found', 'content-length': '239', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers</failure></testcase><testcase classname="tests.test_middleware_order" name="test_middleware_order_dev" time="0.142"><failure message="IndexError: list index out of range">tests/test_middleware_order.py:15: in test_middleware_order_dev
    assert names[-1] == "RequestIDMiddleware"
           ^^^^^^^^^
E   IndexError: list index out of range</failure></testcase><testcase classname="tests.test_middleware_order_contract" name="test_middleware_order_contract" time="0.155"><failure message="AssertionError: assert [] == ['CORSMiddlew...dleware', ...]&#10;  &#10;  Right contains 14 more items, first extra item: 'CORSMiddleware'&#10;  Use -v to get more diff">tests/test_middleware_order_contract.py:18: in test_middleware_order_contract
    assert names == [
E   AssertionError: assert [] == ['CORSMiddlew...dleware', ...]
E     
E     Right contains 14 more items, first extra item: 'CORSMiddleware'
E     Use -v to get more diff</failure></testcase><testcase classname="tests.test_middleware_stack_valid" name="test_user_middleware_are_classes" time="0.002"><failure message="AssertionError: No middleware found in app.user_middleware&#10;assert []&#10; +  where [] = &lt;fastapi.applications.FastAPI object at 0x11fd11790&gt;.user_middleware">tests/test_middleware_stack_valid.py:22: in test_user_middleware_are_classes
    assert app.user_middleware, "No middleware found in app.user_middleware"
E   AssertionError: No middleware found in app.user_middleware
E   assert []
E    +  where [] = &lt;fastapi.applications.FastAPI object at 0x11fd11790&gt;.user_middleware</failure></testcase><testcase classname="tests.test_middleware_stack_valid" name="test_middleware_names_are_unique" time="0.001" /><testcase classname="tests.test_middleware_stack_valid" name="test_middleware_stack_integrity" time="0.002"><failure message="AssertionError: Middleware stack is empty&#10;assert 0 &gt; 0&#10; +  where 0 = len([])">tests/test_middleware_stack_valid.py:77: in test_middleware_stack_integrity
    assert len(middleware_list) &gt; 0, "Middleware stack is empty"
E   AssertionError: Middleware stack is empty
E   assert 0 &gt; 0
E    +  where 0 = len([])</failure></testcase><testcase classname="tests.test_middleware_stack_valid" name="test_no_function_in_middleware_attrs" time="0.002" /><testcase classname="tests.test_model_picker" name="test_pick_model_llama" time="0.002"><failure message="ValueError: too many values to unpack (expected 2)">tests/test_model_picker.py:12: in test_pick_model_llama
    engine, model = pick_model("hello", "chat", 5)
    ^^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)</failure></testcase><testcase classname="tests.test_model_picker" name="test_pick_model_complex_long" time="0.002"><failure message="ValueError: too many values to unpack (expected 2)">tests/test_model_picker.py:19: in test_pick_model_complex_long
    engine, model = pick_model(prompt, "chat", 0)
    ^^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)</failure></testcase><testcase classname="tests.test_model_picker" name="test_pick_model_keyword" time="0.002"><failure message="ValueError: too many values to unpack (expected 2)">tests/test_model_picker.py:25: in test_pick_model_keyword
    engine, model = pick_model("please analyze this", "chat", 0)
    ^^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)</failure></testcase><testcase classname="tests.test_model_picker" name="test_pick_model_llama_unhealthy" time="0.003"><failure message="ValueError: too many values to unpack (expected 2)">tests/test_model_picker.py:32: in test_pick_model_llama_unhealthy
    engine, model = pick_model("hello", "chat", 5)
    ^^^^^^^^^^^^^
E   ValueError: too many values to unpack (expected 2)</failure></testcase><testcase classname="tests.test_model_router" name="test_compose_cache_id_stable" time="0.002" /><testcase classname="tests.test_model_router" name="test_route_text_defaults_to_nano" time="0.002" /><testcase classname="tests.test_model_router" name="test_route_text_long_prompt_escalates" time="0.001" /><testcase classname="tests.test_model_router" name="test_run_with_self_check_escalates_then_passes" time="0.003" /><testcase classname="tests.test_model_router" name="test_vision_triage" time="0.002" /><testcase classname="tests.test_model_router" name="test_route_text_attachments_branch" time="0.001" /><testcase classname="tests.test_model_router" name="test_route_text_ops_branches" time="0.003" /><testcase classname="tests.test_model_router" name="test_route_text_keyword_escalates" time="0.002"><failure message="AssertionError: assert 'gpt-5-nano' == 'gpt-4.1-nano'&#10;  &#10;  - gpt-4.1-nano&#10;  ?     ^^^&#10;  + gpt-5-nano&#10;  ?     ^">tests/test_model_router.py:96: in test_route_text_keyword_escalates
    assert d.model == "gpt-4.1-nano"
E   AssertionError: assert 'gpt-5-nano' == 'gpt-4.1-nano'
E     
E     - gpt-4.1-nano
E     ?     ^^^
E     + gpt-5-nano
E     ?     ^</failure></testcase><testcase classname="tests.test_model_router" name="test_route_text_heavy_intent_escalates" time="0.001" /><testcase classname="tests.test_model_router" name="test_route_vision_cap" time="0.004" /><testcase classname="tests.test_model_router" name="test_budget_caps_disable_escalations" time="0.002" /><testcase classname="tests.test_model_router" name="test_self_check_single_retry_to_mid_tier" time="0.002" /><testcase classname="tests.test_model_router_rules_reload" name="test_compose_cache_id_is_stable" time="0.002" /><testcase classname="tests.test_model_router_rules_reload" name="test_route_text_short_default" time="0.002" /><testcase classname="tests.test_model_router_rules_reload" name="test_route_text_long_prompt" time="0.002" /><testcase classname="tests.test_model_router_rules_reload" name="test_route_text_long_rag" time="0.001" /><testcase classname="tests.test_model_router_rules_reload" name="test_route_text_ops_simple_vs_complex" time="0.001" /><testcase classname="tests.test_model_router_rules_reload" name="test_run_with_self_check_escalates_once" time="0.002" /><testcase classname="tests.test_model_router_rules_reload" name="test_load_rules_hot_reload" time="0.009" /><testcase classname="tests.test_music_api" name="test_state_default" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_api.py:28: in test_state_default
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_api" name="test_set_vibe_and_caps" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_api.py:41: in test_set_vibe_and_caps
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_extra" name="test_state_spotify_provider_and_track_mapping" time="0.047"><failure message="KeyError: 'is_playing'">tests/test_music_extra.py:58: in test_state_spotify_provider_and_track_mapping
    assert body["is_playing"] is True
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'is_playing'</failure></testcase><testcase classname="tests.test_music_extra" name="test_queue_mapping_spotify" time="0.006"><failure message="KeyError: 'current'">tests/test_music_extra.py:98: in test_queue_mapping_spotify
    assert body["current"]["id"] == "cur1"
           ^^^^^^^^^^^^^^^
E   KeyError: 'current'</failure></testcase><testcase classname="tests.test_music_extra" name="test_recommendations_filtering_explicit" time="0.008"><failure message="KeyError: 'recommendations'">tests/test_music_extra.py:135: in test_recommendations_filtering_explicit
    ids = [r["id"] for r in out["recommendations"]]
                            ^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'recommendations'</failure></testcase><testcase classname="tests.test_music_extra" name="test_recommendations_limit_clamp" time="0.007"><failure message="KeyError: 'recommendations'">tests/test_music_extra.py:165: in test_recommendations_limit_clamp
    assert len(out["recommendations"]) == 10
               ^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'recommendations'</failure></testcase><testcase classname="tests.test_music_extra" name="test_set_device_calls_transfer_when_spotify" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_extra.py:182: in test_set_device_calls_transfer_when_spotify
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_extra" name="test_volume_without_value_returns_400" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_extra.py:189: in test_volume_without_value_returns_400
    assert r.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_extra" name="test_unknown_command_returns_400" time="0.005"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_extra.py:195: in test_unknown_command_returns_400
    assert r.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_extra" name="test_restore_clamps_to_quiet_cap" time="0.011"><failure message="KeyError: 'volume'">tests/test_music_extra.py:209: in test_restore_clamps_to_quiet_cap
    after = c.get("/v1/state", headers=_auth()).json()["volume"]
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'volume'</failure></testcase><testcase classname="tests.test_music_extra" name="test_temporary_volume_twice_restores_first" time="0.020"><failure message="KeyError: 'volume'">tests/test_music_extra.py:231: in test_temporary_volume_twice_restores_first
    after = c.get("/v1/state", headers=_auth()).json()["volume"]
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'volume'</failure></testcase><testcase classname="tests.test_music_extra" name="test_state_radio_fields_present_when_fallback" time="0.005"><failure message="AssertionError: assert None == 'radio'&#10; +  where None = &lt;built-in method get of dict object at 0x12003ca40&gt;('provider')&#10; +    where &lt;built-in method get of dict object at 0x12003ca40&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8HHETKAPJYQB9PPQBEF1', 'method': 'GET', 'path': '/v1/state', ...}, 'message': 'Not Found'}.get">tests/test_music_extra.py:243: in test_state_radio_fields_present_when_fallback
    assert body.get("provider") == "radio"
E   AssertionError: assert None == 'radio'
E    +  where None = &lt;built-in method get of dict object at 0x12003ca40&gt;('provider')
E    +    where &lt;built-in method get of dict object at 0x12003ca40&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8HHETKAPJYQB9PPQBEF1', 'method': 'GET', 'path': '/v1/state', ...}, 'message': 'Not Found'}.get</failure></testcase><testcase classname="tests.test_music_extra" name="test_queue_empty_and_count_zero_when_provider_off" time="0.004"><failure message="KeyError: 'up_next'">tests/test_music_extra.py:250: in test_queue_empty_and_count_zero_when_provider_off
    assert body["up_next"] == [] and body["skip_count"] &gt;= 0
           ^^^^^^^^^^^^^^^
E   KeyError: 'up_next'</failure></testcase><testcase classname="tests.test_music_extra" name="test_music_ws_ping_pong" time="0.005"><failure message="starlette.websockets.WebSocketDisconnect">tests/test_music_extra.py:254: in test_music_ws_ping_pong
    with _client().websocket_connect("/v1/ws/music") as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.test_music_extra" name="test_vibe_defaults_turn_up_and_uplift" time="0.006"><failure message="KeyError: 'vibe'">tests/test_music_extra.py:264: in test_vibe_defaults_turn_up_and_uplift
    assert abs(st["vibe"]["energy"] - 0.9) &lt; 1e-6
               ^^^^^^^^^^
E   KeyError: 'vibe'</failure></testcase><testcase classname="tests.test_music_extra" name="test_explicit_allowed_respects_global_disable" time="0.007"><failure message="KeyError: 'explicit_allowed'">tests/test_music_extra.py:277: in test_explicit_allowed_respects_global_disable
    assert st["explicit_allowed"] is False
           ^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'explicit_allowed'</failure></testcase><testcase classname="tests.test_music_extra" name="test_state_includes_device_id_after_set" time="0.007"><failure message="KeyError: 'device_id'">tests/test_music_extra.py:284: in test_state_includes_device_id_after_set
    assert st["device_id"] == "dev-9"
           ^^^^^^^^^^^^^^^
E   KeyError: 'device_id'</failure></testcase><testcase classname="tests.test_music_features" name="test_volume_cap_in_quiet_hours" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_features.py:35: in test_volume_cap_in_quiet_hours
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_features" name="test_duck_and_restore" time="0.010"><failure message="KeyError: 'volume'">tests/test_music_features.py:56: in test_duck_and_restore
    base = client.get("/v1/state").json()["volume"]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'volume'</failure></testcase><testcase classname="tests.test_music_features" name="test_recommendations_cache" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_features.py:87: in test_recommendations_cache
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_features" name="test_queue_skip_count" time="0.013"><failure message="KeyError: 'skip_count'">tests/test_music_features.py:106: in test_queue_skip_count
    assert q["skip_count"] &gt;= 3
           ^^^^^^^^^^^^^^^
E   KeyError: 'skip_count'</failure></testcase><testcase classname="tests.test_music_features" name="test_device_set_and_state_reflects" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_features.py:113: in test_device_set_and_state_reflects
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_more" name="test_provider_none_when_both_off" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_music_more.py:36: in test_provider_none_when_both_off
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_music_more" name="test_provider_radio_when_fallback_on" time="0.007"><failure message="AssertionError: assert None == 'radio'&#10; +  where None = &lt;built-in method get of dict object at 0x1180b1b00&gt;('provider')&#10; +    where &lt;built-in method get of dict object at 0x1180b1b00&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8HRE0NXYRAAJ04EPN0G7', 'method': 'GET', 'path': '/v1/state', ...}, 'message': 'Not Found'}.get">tests/test_music_more.py:49: in test_provider_radio_when_fallback_on
    assert body.get("provider") == "radio"
E   AssertionError: assert None == 'radio'
E    +  where None = &lt;built-in method get of dict object at 0x1180b1b00&gt;('provider')
E    +    where &lt;built-in method get of dict object at 0x1180b1b00&gt; = {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8HRE0NXYRAAJ04EPN0G7', 'method': 'GET', 'path': '/v1/state', ...}, 'message': 'Not Found'}.get</failure></testcase><testcase classname="tests.test_music_more" name="test_radio_play_pause_toggle" time="0.010"><failure message="KeyError: 'is_playing'">tests/test_music_more.py:60: in test_radio_play_pause_toggle
    assert c.get("/v1/state").json()["is_playing"] is True
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'is_playing'</failure></testcase><testcase classname="tests.test_music_more" name="test_vibe_name_defaults_calm_night" time="0.010"><failure message="KeyError: 'vibe'">tests/test_music_more.py:70: in test_vibe_name_defaults_calm_night
    assert abs(st["vibe"]["energy"] - 0.25) &lt; 1e-6
               ^^^^^^^^^^
E   KeyError: 'vibe'</failure></testcase><testcase classname="tests.test_music_more" name="test_vibe_name_defaults_turn_up" time="0.009"><failure message="KeyError: 'vibe'">tests/test_music_more.py:78: in test_vibe_name_defaults_turn_up
    assert abs(st["vibe"]["energy"] - 0.9) &lt; 1e-6
               ^^^^^^^^^^
E   KeyError: 'vibe'</failure></testcase><testcase classname="tests.test_music_more" name="test_partial_vibe_merge_energy_only" time="0.007"><failure message="KeyError: 'vibe'">tests/test_music_more.py:84: in test_partial_vibe_merge_energy_only
    before = c.get("/v1/state").json()["vibe"]["name"]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'vibe'</failure></testcase><testcase classname="tests.test_music_more" name="test_explicit_allowed_true_when_vibe_explicit_true" time="0.010"><failure message="KeyError: 'explicit_allowed'">tests/test_music_more.py:96: in test_explicit_allowed_true_when_vibe_explicit_true
    assert st["explicit_allowed"] is True
           ^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'explicit_allowed'</failure></testcase><testcase classname="tests.test_music_more" name="test_explicit_allowed_false_when_vibe_explicit_false" time="0.009"><failure message="KeyError: 'explicit_allowed'">tests/test_music_more.py:104: in test_explicit_allowed_false_when_vibe_explicit_false
    assert st["explicit_allowed"] is False
           ^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'explicit_allowed'</failure></testcase><testcase classname="tests.test_music_more" name="test_vibe_change_caps_volume_downward" time="0.012"><failure message="KeyError: 'volume'">tests/test_music_more.py:119: in test_vibe_change_caps_volume_downward
    assert st["volume"] &lt;= 40
           ^^^^^^^^^^^^
E   KeyError: 'volume'</failure></testcase><testcase classname="tests.test_music_more" name="test_restore_noop_when_no_duck" time="0.005"><failure message="KeyError: 'volume'">tests/test_music_more.py:125: in test_restore_noop_when_no_duck
    before = c.get("/v1/state").json()["volume"]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'volume'</failure></testcase><testcase classname="tests.test_music_more" name="test_album_art_cached_path_returned_when_file_exists" time="0.004" /><testcase classname="tests.test_music_more" name="test_in_quiet_hours_across_midnight_true" time="0.001" /><testcase classname="tests.test_music_more" name="test_in_quiet_hours_outside_daytime" time="0.002" /><testcase classname="tests.test_music_more" name="test_queue_skip_count_persistence" time="0.012"><failure message="KeyError: 'skip_count'">tests/test_music_more.py:166: in test_queue_skip_count_persistence
    q1 = c.get("/v1/queue").json()["skip_count"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'skip_count'</failure></testcase><testcase classname="tests.test_music_more" name="test_devices_empty_when_provider_off" time="0.006"><failure message="KeyError: 'devices'">tests/test_music_more.py:175: in test_devices_empty_when_provider_off
    assert devs["devices"] == []
           ^^^^^^^^^^^^^^^
E   KeyError: 'devices'</failure></testcase><testcase classname="tests.test_music_more" name="test_set_device_overwrites_previous" time="0.012"><failure message="KeyError: 'device_id'">tests/test_music_more.py:184: in test_set_device_overwrites_previous
    assert st["device_id"] == "dev-2"
           ^^^^^^^^^^^^^^^
E   KeyError: 'device_id'</failure></testcase><testcase classname="tests.test_no_basicconfig" name="test_no_basicConfig" time="0.099"><failure message="AssertionError: Found logging.basicConfig in app/integrations/logging_config.py&#10;assert 'logging.basicConfig(' not in 'import os\n...ut,\n    )\n'&#10;  &#10;  'logging.basicConfig(' is contained here:&#10;    gging&#10;        logging.basicConfig(&#10;            level=getattr(logging, os.getenv(&quot;LOG_LEVEL&quot;, &quot;INFO&quot;).upper()),&#10;            format=&quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;,&#10;            stream=sys.stdout,&#10;        )">tests/test_no_basicconfig.py:11: in test_no_basicConfig
    assert (
E   AssertionError: Found logging.basicConfig in app/integrations/logging_config.py
E   assert 'logging.basicConfig(' not in 'import os\n...ut,\n    )\n'
E     
E     'logging.basicConfig(' is contained here:
E       gging
E           logging.basicConfig(
E               level=getattr(logging, os.getenv("LOG_LEVEL", "INFO").upper()),
E               format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
E               stream=sys.stdout,
E           )</failure></testcase><testcase classname="tests.test_no_function_middleware" name="test_no_decorator_middlewares" time="0.164" /><testcase classname="tests.test_no_function_middleware" name="test_no_asgi_middleware_patterns" time="0.065" /><testcase classname="tests.test_no_raw_jwt_decode" name="test_no_raw_jwt_decode_outside_helper" time="0.122"><failure message="AssertionError: raw jwt.decode found in: ['/Users/kingal/2025/GesahniV2/app/auth_core.py', '/Users/kingal/2025/GesahniV2/app/api/auth.py']&#10;assert not ['/Users/kingal/2025/GesahniV2/app/auth_core.py', '/Users/kingal/2025/GesahniV2/app/api/auth.py']">tests/test_no_raw_jwt_decode.py:16: in test_no_raw_jwt_decode_outside_helper
    assert not bad, f"raw jwt.decode found in: {bad}"
E   AssertionError: raw jwt.decode found in: ['/Users/kingal/2025/GesahniV2/app/auth_core.py', '/Users/kingal/2025/GesahniV2/app/api/auth.py']
E   assert not ['/Users/kingal/2025/GesahniV2/app/auth_core.py', '/Users/kingal/2025/GesahniV2/app/api/auth.py']</failure></testcase><testcase classname="tests.test_oauth_apple_redirect_cookies" name="test_apple_callback_sets_cookies_on_returned_302" time="0.008"><failure message="assert 400 in (302, 307)&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/test_oauth_apple_redirect_cookies.py:58: in test_apple_callback_sets_cookies_on_returned_302
    assert r.status_code in (302, 307)
E   assert 400 in (302, 307)
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_google_oauth_state_cookie_shape" time="0.111"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_oauth_state_cookie.py:29: in test_google_oauth_state_cookie_shape
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_google_oauth_state_cookie_lax_samesite" time="0.111"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_oauth_state_cookie.py:52: in test_google_oauth_state_cookie_lax_samesite
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_google_oauth_state_verification" time="0.184"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_oauth_state_cookie.py:64: in test_google_oauth_state_verification
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_google_oauth_state_mismatch" time="0.184"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_oauth_state_cookie.py:91: in test_google_oauth_state_mismatch
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_apple_oauth_state_cookie_shape" time="0.122" /><testcase classname="tests.test_oauth_state_cookie" name="test_apple_oauth_state_verification" time="0.098"><failure message="TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'">tests/test_oauth_state_cookie.py:145: in test_apple_oauth_state_verification
    r1 = c.get("/v1/auth/apple/start", allow_redirects=False)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_apple_oauth_state_mismatch" time="0.100"><failure message="TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'">tests/test_oauth_state_cookie.py:186: in test_apple_oauth_state_mismatch
    r1 = c.get("/v1/auth/apple/start", allow_redirects=False)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'</failure></testcase><testcase classname="tests.test_oauth_state_cookie" name="test_oauth_state_cookie_clearing" time="0.094"><failure message="TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'">tests/test_oauth_state_cookie.py:218: in test_oauth_state_cookie_clearing
    r1 = c.get("/v1/auth/apple/start", allow_redirects=False)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TestClient.get() got an unexpected keyword argument 'allow_redirects'</failure></testcase><testcase classname="tests.test_openai_params" name="test_openai_omits_max_tokens_by_default" time="0.001" /><testcase classname="tests.test_openai_params" name="test_openai_passes_max_completion_tokens" time="0.001" /><testcase classname="tests.test_openapi_contract" name="test_openapi_contract_models_examples_present" time="0.009" /><testcase classname="tests.test_openapi_contract" name="test_openapi_contract_hits_examples" time="0.004" /><testcase classname="tests.test_openapi_tags_and_grouping" name="test_openapi_has_exactly_six_tag_groups_in_order" time="0.001" /><testcase classname="tests.test_openapi_tags_and_grouping" name="test_no_extra_operation_tags" time="0.002"><failure message="AssertionError: group missing: TV&#10;assert 'TV' in set()">tests/test_openapi_tags_and_grouping.py:51: in test_no_extra_operation_tags
    assert g in seen, f"group missing: {g}"
E   AssertionError: group missing: TV
E   assert 'TV' in set()</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/admin/metrics-get-Admin]" time="0.002"><failure message="AssertionError: operation not found: get /v1/admin/metrics&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: get /v1/admin/metrics
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/music-post-Music]" time="0.002"><failure message="AssertionError: operation not found: post /v1/music&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/music
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/tts/speak-post-Music]" time="0.001"><failure message="AssertionError: operation not found: post /v1/tts/speak&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/tts/speak
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/calendar/next-get-Calendar]" time="0.002"><failure message="AssertionError: operation not found: get /v1/calendar/next&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: get /v1/calendar/next
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/tv/photos-get-TV]" time="0.002"><failure message="AssertionError: operation not found: get /v1/tv/photos&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: get /v1/tv/photos
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/care/contacts-get-Care]" time="0.001"><failure message="AssertionError: operation not found: get /v1/care/contacts&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: get /v1/care/contacts
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_specific_endpoints_are_grouped_by_expected_tag[/v1/login-post-Auth]" time="0.001"><failure message="AssertionError: operation not found: post /v1/login&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:70: in test_specific_endpoints_are_grouped_by_expected_tag
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/login
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_healthz_is_admin_tag" time="0.001"><failure message="AssertionError: operation not found: get /healthz&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:78: in test_healthz_is_admin_tag
    op = _find_op(o, "/healthz", "get")
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: get /healthz
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/tts/speak-post-TTSRequest-TTSAck]" time="0.003"><failure message="AssertionError: operation not found: post /v1/tts/speak&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/tts/speak
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/music-post-MusicCommand-OkResponse]" time="0.002"><failure message="AssertionError: operation not found: post /v1/music&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/music
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/vibe-post-VibeBody-VibeResponse]" time="0.001"><failure message="AssertionError: operation not found: post /v1/vibe&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/vibe
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/profile-post-UserProfile-ProfileOk]" time="0.001"><failure message="AssertionError: operation not found: post /v1/profile&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/profile
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/reminders-post-ReminderCreate-OkResponse]" time="0.002"><failure message="AssertionError: operation not found: post /v1/reminders&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/reminders
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/care/contacts-post-ContactBody-ContactCreateResponse]" time="0.003"><failure message="AssertionError: operation not found: post /v1/care/contacts&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/care/contacts
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_examples_present_on_request_and_response_models[/v1/care/alerts-post-AlertCreate-AlertRecord]" time="0.039"><failure message="AssertionError: operation not found: post /v1/care/alerts&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:98: in test_examples_present_on_request_and_response_models
    op = _find_op(o, path, method)
         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/care/alerts
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_openapi_tags_and_grouping" name="test_auth_token_endpoint_present_and_tagged_auth" time="0.044"><failure message="AssertionError: operation not found: post /v1/auth/token&#10;assert False&#10; +  where False = isinstance(None, dict)">tests/test_openapi_tags_and_grouping.py:124: in test_auth_token_endpoint_present_and_tagged_auth
    op = _find_op(o, "/v1/auth/token", "post")
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_openapi_tags_and_grouping.py:14: in _find_op
    assert isinstance(op, dict), f"operation not found: {method} {path}"
E   AssertionError: operation not found: post /v1/auth/token
E   assert False
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsMiddleware" name="test_metrics_middleware_basic" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_phase6_1_metrics.py:31: in test_metrics_middleware_basic
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsMiddleware" name="test_metrics_endpoint_exposed" time="0.003"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_phase6_1_metrics.py:39: in test_metrics_endpoint_exposed
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsMiddleware" name="test_route_name_extraction" time="0.005" /><testcase classname="tests.test_phase6_1_metrics.TestAuthMetrics" name="test_auth_fail_metrics_import" time="0.001" /><testcase classname="tests.test_phase6_1_metrics.TestAuthMetrics" name="test_rbac_deny_metrics_import" time="0.001" /><testcase classname="tests.test_phase6_1_metrics.TestAuthMetrics" name="test_rate_limited_metrics_import" time="0.001" /><testcase classname="tests.test_phase6_1_metrics.TestMetricsStructure" name="test_requests_metric_structure" time="0.001"><failure message="AssertionError: assert False&#10; +  where False = hasattr(prometheus_client.metrics.Counter(http_requests), 'labelnames')">tests/test_phase6_1_metrics.py:90: in test_requests_metric_structure
    assert hasattr(REQUESTS, "labelnames")
E   AssertionError: assert False
E    +  where False = hasattr(prometheus_client.metrics.Counter(http_requests), 'labelnames')</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsStructure" name="test_latency_metric_structure" time="0.001"><failure message="AssertionError: assert False&#10; +  where False = hasattr(prometheus_client.metrics.Histogram(http_request_latency_seconds), 'labelnames')">tests/test_phase6_1_metrics.py:96: in test_latency_metric_structure
    assert hasattr(LATENCY, "labelnames")
E   AssertionError: assert False
E    +  where False = hasattr(prometheus_client.metrics.Histogram(http_request_latency_seconds), 'labelnames')</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsStructure" name="test_auth_fail_metric_structure" time="0.001"><failure message="AssertionError: assert False&#10; +  where False = hasattr(prometheus_client.metrics.Counter(auth_fail), 'labelnames')">tests/test_phase6_1_metrics.py:106: in test_auth_fail_metric_structure
    assert hasattr(AUTH_FAIL, "labelnames")
E   AssertionError: assert False
E    +  where False = hasattr(prometheus_client.metrics.Counter(auth_fail), 'labelnames')</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsStructure" name="test_rbac_deny_metric_structure" time="0.001"><failure message="AssertionError: assert False&#10; +  where False = hasattr(prometheus_client.metrics.Counter(rbac_deny), 'labelnames')">tests/test_phase6_1_metrics.py:112: in test_rbac_deny_metric_structure
    assert hasattr(RBAC_DENY, "labelnames")
E   AssertionError: assert False
E    +  where False = hasattr(prometheus_client.metrics.Counter(rbac_deny), 'labelnames')</failure></testcase><testcase classname="tests.test_phase6_1_metrics.TestMetricsStructure" name="test_rate_limited_metric_structure" time="0.001"><failure message="AssertionError: assert False&#10; +  where False = hasattr(prometheus_client.metrics.Counter(rate_limited), 'labelnames')">tests/test_phase6_1_metrics.py:118: in test_rate_limited_metric_structure
    assert hasattr(RATE_LIMITED, "labelnames")
E   AssertionError: assert False
E    +  where False = hasattr(prometheus_client.metrics.Counter(rate_limited), 'labelnames')</failure></testcase><testcase classname="tests.test_phase6_2_audit.TestAuditModels" name="test_audit_event_creation" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestAuditModels" name="test_audit_event_defaults" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestAuditModels" name="test_audit_event_json_serialization" time="0.004" /><testcase classname="tests.test_phase6_2_audit.TestAuditStore" name="test_single_audit_append" time="0.002" /><testcase classname="tests.test_phase6_2_audit.TestAuditStore" name="test_bulk_audit_append" time="0.002" /><testcase classname="tests.test_phase6_2_audit.TestAuditStore" name="test_append_only_behavior" time="0.002" /><testcase classname="tests.test_phase6_2_audit.TestAuditStore" name="test_audit_file_permissions" time="0.002" /><testcase classname="tests.test_phase6_2_audit.TestAuditMiddleware" name="test_audit_middleware_import" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestAuditMiddleware" name="test_audit_models_import" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestAuditMiddleware" name="test_audit_store_import" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestWebSocketAudit" name="test_websocket_connect_event" time="0.001" /><testcase classname="tests.test_phase6_2_audit.TestWebSocketAudit" name="test_websocket_disconnect_event" time="0.001" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_availability_slo_health_check" time="0.217"><failure message="AssertionError: .3%&#10;assert 0.0 &gt;= 0.999">tests/test_phase6_4_slos.py:119: in test_availability_slo_health_check
    assert success_rate &gt;= 0.999, ".3%"
E   AssertionError: .3%
E   assert 0.0 &gt;= 0.999</failure></testcase><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_read_latency_slo" time="0.097" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_write_latency_slo" time="0.001" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_4xx_error_budget_slo" time="0.003" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_5xx_error_budget_slo" time="0.002"><failure message="AssertionError: .4%&#10;assert 0.0025 &lt;= 0.001">tests/test_phase6_4_slos.py:187: in test_5xx_error_budget_slo
    assert error_rate_5xx &lt;= 0.001, ".4%"
E   AssertionError: .4%
E   assert 0.0025 &lt;= 0.001</failure></testcase><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_rate_limit_budget_slo" time="0.002" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_slo_violation_detection" time="0.002" /><testcase classname="tests.test_phase6_4_slos.TestSLOCompliance" name="test_slo_compliance_reporting" time="0.002" /><testcase classname="tests.test_phase6_4_slos" name="test_slo_compliance_for_deployment" time="0.225"><failure message="Failed: .3f">tests/test_phase6_4_slos.py:327: in test_slo_compliance_for_deployment
    pytest.fail(".3f")
E   Failed: .3f</failure></testcase><testcase classname="tests.test_phase6_4_slos" name="test_performance_regression_detection" time="0.070" /><testcase classname="tests.test_phase6_slos.TestSLOMonitoring" name="test_api_availability_slo" time="0.005"><failure message="assert (False or 0.9803921568627451 &gt;= 98.0)">tests/test_phase6_slos.py:42: in test_api_availability_slo
    assert api_slo["achieved"] or api_slo["value"] &gt;= 98.0
E   assert (False or 0.9803921568627451 &gt;= 98.0)</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOMonitoring" name="test_auth_success_rate_slo" time="0.004"><failure message="assert 0.0 &gt;= 95.0">tests/test_phase6_slos.py:59: in test_auth_success_rate_slo
    assert auth_slo["value"] &gt;= 95.0
E   assert 0.0 &gt;= 95.0</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOMonitoring" name="test_api_latency_slo" time="0.006" /><testcase classname="tests.test_phase6_slos.TestSLOMonitoring" name="test_error_rate_slos" time="0.183" /><testcase classname="tests.test_phase6_slos.TestSLOMonitoring" name="test_insufficient_sample_size" time="0.003" /><testcase classname="tests.test_phase6_slos.TestSLOCIIntegration" name="test_successful_slo_ci_test" time="0.166"><failure message="Failed: SLO CI test failed when it should have passed">tests/test_phase6_slos.py:133: in test_successful_slo_ci_test
    assert_slos_in_ci(min_success_rate=0.8)
app/slos.py:492: in assert_slos_in_ci
    raise AssertionError(failure_msg)
E   AssertionError: SLO tests failed. Failed SLOs: auth_success_rate, auth_latency, api_availability, api_latency, authz_success_rate, ws_connection_success, ws_message_latency, ai_response_success, ai_response_latency, security_incident_rate, audit_integrity, memory_search_latency, error_rate_4xx, error_rate_5xx Critical failures: auth_success_rate, auth_latency, api_availability, api_latency, authz_success_rate, ws_connection_success, ws_message_latency, ai_response_success, ai_response_latency, security_incident_rate, audit_integrity, memory_search_latency, error_rate_4xx, error_rate_5xx

During handling of the above exception, another exception occurred:
tests/test_phase6_slos.py:135: in test_successful_slo_ci_test
    pytest.fail("SLO CI test failed when it should have passed")
E   Failed: SLO CI test failed when it should have passed</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOCIIntegration" name="test_failed_slo_ci_test" time="0.007" /><testcase classname="tests.test_phase6_slos.TestSLOCIIntegration" name="test_partial_slo_failure_ci_test" time="0.005" /><testcase classname="tests.test_phase6_slos.TestSLOCIIntegration" name="test_ai_response_slo" time="0.004"><failure message="assert 0.8 == 80.0">tests/test_phase6_slos.py:172: in test_ai_response_slo
    assert ai_success_slo["value"] == 80.0
E   assert 0.8 == 80.0</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOCIIntegration" name="test_security_incident_slo" time="0.002" /><testcase classname="tests.test_phase6_slos.TestSLOAlertingThresholds" name="test_warning_threshold_detection" time="0.004"><failure message="assert not True">tests/test_phase6_slos.py:204: in test_warning_threshold_detection
    assert not latency_slo["achieved"]  # Above 2s target
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert not True</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOAlertingThresholds" name="test_critical_threshold_detection" time="0.006"><failure message="assert not True">tests/test_phase6_slos.py:217: in test_critical_threshold_detection
    assert not latency_slo["achieved"]
E   assert not True</failure></testcase><testcase classname="tests.test_phase6_slos.TestSLOAlertingThresholds" name="test_system_health_check" time="0.151"><failure message="assert False">tests/test_phase6_slos.py:227: in test_system_health_check
    assert is_healthy
E   assert False</failure></testcase><testcase classname="tests.test_phase6_slos" name="test_production_deployment_gates" time="0.002"><failure message="AssertionError: Critical SLO failures: ['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', 'ws_message_latency', 'ai_response_success', 'ai_response_latency', 'security_incident_rate', 'audit_integrity', 'memory_search_latency', 'error_rate_4xx', 'error_rate_5xx']&#10;assert 14 == 0&#10; +  where 14 = len(['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', ...])">tests/test_phase6_slos.py:251: in test_production_deployment_gates
    assert len(critical_failures) == 0, f"Critical SLO failures: {critical_failures}"
E   AssertionError: Critical SLO failures: ['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', 'ws_message_latency', 'ai_response_success', 'ai_response_latency', 'security_incident_rate', 'audit_integrity', 'memory_search_latency', 'error_rate_4xx', 'error_rate_5xx']
E   assert 14 == 0
E    +  where 14 = len(['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', ...])</failure></testcase><testcase classname="tests.test_phase6_slos" name="test_canary_deployment_gates" time="0.002"><failure message="AssertionError: Critical SLO failures in canary: ['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', 'ws_message_latency', 'ai_response_success', 'ai_response_latency', 'security_incident_rate', 'audit_integrity', 'memory_search_latency', 'error_rate_4xx', 'error_rate_5xx']&#10;assert 14 == 0&#10; +  where 14 = len(['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', ...])">tests/test_phase6_slos.py:263: in test_canary_deployment_gates
    assert (
E   AssertionError: Critical SLO failures in canary: ['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', 'ws_message_latency', 'ai_response_success', 'ai_response_latency', 'security_incident_rate', 'audit_integrity', 'memory_search_latency', 'error_rate_4xx', 'error_rate_5xx']
E   assert 14 == 0
E    +  where 14 = len(['auth_success_rate', 'auth_latency', 'api_availability', 'api_latency', 'authz_success_rate', 'ws_connection_success', ...])</failure></testcase><testcase classname="tests.test_planning_pass" name="test_planning_pass_carries_into_action" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_planning_pass.py:10: in test_planning_pass_carries_into_action
    monkeypatch.setattr(r, "handle_command", lambda p: None)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_profile_kv_router" name="test_profile_kv_short_ask_flow" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_profile_kv_router.py:24: in test_profile_kv_short_ask_flow
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_profile_kv_store" name="test_upsert_semantics_newest_wins" time="0.018" /><testcase classname="tests.test_profile_kv_store" name="test_get_values_and_snapshot" time="0.003" /><testcase classname="tests.test_prompt_builder" name="test_prompt_builder_respects_token_limit" time="0.014" /><testcase classname="tests.test_prompt_builder" name="test_prompt_builder_includes_user_prompt" time="0.006" /><testcase classname="tests.test_prompt_builder" name="test_prompt_builder_fills_all_fields" time="0.007" /><testcase classname="tests.test_prompt_builder" name="test_prompt_builder_drops_summary_before_memories" time="0.010" /><testcase classname="tests.test_prompt_builder_rag" name="test_prompt_builder_appends_rag_sources" time="0.008" /><testcase classname="tests.test_prompt_small_ask_diet" name="test_small_ask_prompt_is_thin" time="0.006" /><testcase classname="tests.test_prompt_snapshots" name="test_prompt_snapshot_stable" time="0.006" /><testcase classname="tests.test_qdrant_adapter_extra" name="test_qdrant_disabled_in_pytest_by_default" time="0.002" /><testcase classname="tests.test_qdrant_threshold_policy" name="test_threshold_constant_documented" time="0.001" /><testcase classname="tests.test_quiet_hours" name="test_status_reports_quiet_hours" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_quiet_hours.py:16: in test_status_reports_quiet_hours
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_rate_limit" name="test_rate_limit_prunes_empty" time="0.002" /><testcase classname="tests.test_rate_limit" name="test_bucket_counters_reset" time="0.056" /><testcase classname="tests.test_rate_limit" name="test_http_limit_does_not_block_ws" time="0.010"><failure message="AssertionError: assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code&#10; +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'X-Forwarded-For': '1.2.3.4'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x11f84a7e0&gt;.get">tests/test_rate_limit.py:63: in test_http_limit_does_not_block_ws
    assert client.get("/ping", headers=headers).status_code == 429
E   AssertionError: assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code
E    +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'X-Forwarded-For': '1.2.3.4'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x11f84a7e0&gt;.get</failure></testcase><testcase classname="tests.test_rate_limit" name="test_ws_limit_does_not_block_http" time="0.012" /><testcase classname="tests.test_rate_limit" name="test_x_forwarded_for_splits" time="0.006"><failure message="AssertionError: assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code&#10; +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'X-Forwarded-For': '1.1.1.1, 3.3.3.3'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x112c6cbf0&gt;.get">tests/test_rate_limit.py:97: in test_x_forwarded_for_splits
    assert client.get("/ping", headers=h2).status_code == 429
E   AssertionError: assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code
E    +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'X-Forwarded-For': '1.1.1.1, 3.3.3.3'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x112c6cbf0&gt;.get</failure></testcase><testcase classname="tests.test_rate_limit_fix" name="test_whoami_rate_limiting" time="1.031" /><testcase classname="tests.test_rate_limit_fix" name="test_health_endpoint" time="0.006" /><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_basic" time="0.097"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_rate_limit_mw.py:37: in test_rate_limit_basic
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_options_exempt" time="0.093"><failure message="AssertionError: TestClient did not receive any response.">tests/test_rate_limit_mw.py:66: in test_rate_limit_options_exempt
    r = c.options("/v1/csrf")
        ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_window_reset" time="0.108"><failure message="assert 404 == 429&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_rate_limit_mw.py:78: in test_rate_limit_window_reset
    assert r3.status_code == 429
E   assert 404 == 429
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_headers" time="0.103"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_rate_limit_mw.py:93: in test_rate_limit_headers
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_user_isolation" time="0.103"><failure message="assert 429 in [404, 404, 404, 404]">tests/test_rate_limit_mw.py:116: in test_rate_limit_user_isolation
    assert 429 in responses
E   assert 429 in [404, 404, 404, 404]</failure></testcase><testcase classname="tests.test_rate_limit_mw" name="test_rate_limit_middleware_import" time="0.001" /><testcase classname="tests.test_rate_limit_mw" name="test_csrf_middleware_enhancements" time="0.001" /><testcase classname="tests.test_rate_limit_mw" name="test_secret_verification" time="0.001" /><testcase classname="tests.test_rate_limit_simple" name="test_rate_limit_configuration" time="0.002" /><testcase classname="tests.test_rate_limit_simple" name="test_bypass_logic" time="0.002" /><testcase classname="tests.test_rate_limit_simple" name="test_auth_orchestrator_improvements" time="0.001" /><testcase classname="tests.test_rate_limit_simple" name="test_environment_configuration" time="0.001" /><testcase classname="tests.test_rate_limit_smoke" name="test_rate_limit_smoke_csrf_endpoint" time="0.107"><failure message="AssertionError: Expected 429, got 404&#10;assert 404 == 429&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_rate_limit_smoke.py:59: in test_rate_limit_smoke_csrf_endpoint
    assert (
E   AssertionError: Expected 429, got 404
E   assert 404 == 429
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_rate_limit_smoke" name="test_rate_limit_metrics_endpoint" time="0.001" /><testcase classname="tests.test_record_session" name="test_record_session_cli" time="0.208" /><testcase classname="tests.test_redaction_whitelist" name="test_redaction_skips_whitelisted_numbers" time="0.004" /><testcase classname="tests.test_register" name="test_register_and_duplicate" time="0.032"><failure message="assert 409 == 200&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/test_register.py:24: in test_register_and_duplicate
    assert resp.status_code == 200
E   assert 409 == 200
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.test_register" name="test_register_is_public_endpoint" time="0.026"><failure message="assert 409 == 200&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/test_register.py:56: in test_register_is_public_endpoint
    assert resp.status_code == 200
E   assert 409 == 200
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.test_remaining_budget_fix" name="test_get_remaining_budget" time="0.609" /><testcase classname="tests.test_resolve_entity" name="test_exact_match_preferred" time="0.003" /><testcase classname="tests.test_resolve_entity" name="test_substring_fallback" time="0.002" /><testcase classname="tests.test_resolve_entity" name="test_get_states_cache_and_invalidate" time="0.002" /><testcase classname="tests.test_retention" name="test_archive_old_sessions" time="0.010" /><testcase classname="tests.test_retrieval_logging" name="test_pipeline_trace_contains_threshold_and_scores" time="0.107" /><testcase classname="tests.test_retrieval_strategies_eval" name="test_rrf_merges_lists_reasonably" time="0.001" /><testcase classname="tests.test_retrieval_strategies_eval" name="test_time_decay_monotonic" time="0.002" /><testcase classname="tests.test_retrieval_strategies_eval" name="test_temporal_boost_changes_order" time="0.001" /><testcase classname="tests.test_retriever_budget" name="test_retriever_budget" time="0.010" /><testcase classname="tests.test_route_prompt_changes" name="test_route_prompt_changes" time="0.006" /><testcase classname="tests.test_router" name="test_router_fallback_metrics_updated" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'detect_intent'">tests/test_router.py:123: in test_router_fallback_metrics_updated
    monkeypatch.setattr(router, "detect_intent", lambda p: ("chat", "high"))
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'detect_intent'</failure></testcase><testcase classname="tests.test_router" name="test_gpt_override" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router.py:157: in test_gpt_override
    monkeypatch.setattr(router, "ask_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router" name="test_gpt_override_invalid" time="0.002"><failure message="RuntimeError: Router has not been configured. Call set_router() first.">tests/test_router.py:172: in test_gpt_override_invalid
    asyncio.run(router.route_prompt("hello world", user_id="u", model_override="gpt-3"))
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/router/entrypoint.py:23: in route_prompt
    router = get_router()
             ^^^^^^^^^^^^
app/router/registry.py:29: in get_router
    raise RuntimeError("Router has not been configured. Call set_router() first.")
E   RuntimeError: Router has not been configured. Call set_router() first.</failure></testcase><testcase classname="tests.test_router" name="test_gpt_override_http_error_falls_back" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router.py:190: in test_gpt_override_http_error_falls_back
    monkeypatch.setattr(router, "ask_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router" name="test_gpt_override_runtime_error_detail" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router.py:210: in test_gpt_override_runtime_error_detail
    monkeypatch.setattr(router, "ask_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router" name="test_complexity_checks" time="0.002"><failure message="RuntimeError: Router has not been configured. Call set_router() first.">tests/test_router.py:240: in test_complexity_checks
    assert asyncio.run(router.route_prompt(long_prompt, user_id="u")) == "gpt"
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/router/entrypoint.py:23: in route_prompt
    router = get_router()
             ^^^^^^^^^^^^
app/router/registry.py:29: in get_router
    raise RuntimeError("Router has not been configured. Call set_router() first.")
E   RuntimeError: Router has not been configured. Call set_router() first.</failure></testcase><testcase classname="tests.test_router" name="test_skill_metrics" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'CATALOG'">tests/test_router.py:259: in test_skill_metrics
    monkeypatch.setattr(router, "CATALOG", [(["dummy"], DummySkill)])
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'CATALOG'</failure></testcase><testcase classname="tests.test_router" name="test_debug_env_toggle" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router.py:288: in test_debug_env_toggle
    monkeypatch.setattr(router, "ask_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router" name="test_llama_circuit_open" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_router.py:327: in test_llama_circuit_open
    monkeypatch.setattr(router, "handle_command", lambda p: None)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_router" name="test_generation_options_passthrough" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_router.py:353: in test_generation_options_passthrough
    monkeypatch.setattr(router, "handle_command", _hc)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_router" name="test_undefined_var_guard_debug_model_routing_disabled" time="0.001" /><testcase classname="tests.test_router" name="test_override_happy_path_openai_healthy" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'">tests/test_router.py:426: in test_override_happy_path_openai_healthy
    monkeypatch.setattr(router, "_check_vendor_health", lambda vendor: vendor == "openai")
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'</failure></testcase><testcase classname="tests.test_router" name="test_budget_enforcement_timeout" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'">tests/test_router.py:450: in test_budget_enforcement_timeout
    monkeypatch.setattr(router, "_check_vendor_health", lambda vendor: vendor == "ollama")
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'</failure></testcase><testcase classname="tests.test_router" name="test_req_id_propagation_both_vendors" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'PostCallData'">tests/test_router.py:484: in test_req_id_propagation_both_vendors
    monkeypatch.setattr(router, "PostCallData", track_postcall_data)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'PostCallData'</failure></testcase><testcase classname="tests.test_router" name="test_low_confidence_path_fallback_and_metrics" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'">tests/test_router.py:518: in test_low_confidence_path_fallback_and_metrics
    monkeypatch.setattr(router, "_check_vendor_health", lambda vendor: True)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_check_vendor_health'</failure></testcase><testcase classname="tests.test_router" name="test_cache_trace_vendor_and_cache_hit" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'cache_answer'">tests/test_router.py:561: in test_cache_trace_vendor_and_cache_hit
    monkeypatch.setattr(router, "cache_answer", lambda *args, **kwargs: None)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'cache_answer'</failure></testcase><testcase classname="tests.test_router_coverage" name="test_no_direct_endpoints_in_main" time="0.001" /><testcase classname="tests.test_router_coverage" name="test_no_app_decorators_in_main" time="0.001" /><testcase classname="tests.test_router_extras" name="test_llama_override" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_extras.py:25: in test_llama_override
    monkeypatch.setattr(router, "ask_llama", fake_llama)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_extras" name="test_cache_hit" time="0.002"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router_extras.py:41: in test_cache_hit
    monkeypatch.setattr(router, "ask_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router_extras" name="test_low_conf_rejection" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_extras.py:73: in test_low_conf_rejection
    monkeypatch.setattr(router, "ask_llama", low_conf)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_extras" name="test_ha_command" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'">tests/test_router_extras.py:90: in test_ha_command
    monkeypatch.setattr(router, "handle_command", fake_handle)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</failure></testcase><testcase classname="tests.test_router_helpers" name="test_call_gpt" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'">tests/test_router_helpers.py:23: in test_call_gpt
    monkeypatch.setattr(router, "ask_gpt", fake_ask_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_gpt'</failure></testcase><testcase classname="tests.test_router_helpers" name="test_call_llama_success" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_helpers.py:80: in test_call_llama_success
    monkeypatch.setattr(router, "ask_llama", fake_llama)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_helpers" name="test_call_llama_fallback" time="0.002"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_helpers.py:140: in test_call_llama_fallback
    monkeypatch.setattr(router, "ask_llama", fake_llama)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_llama_circuit_open_routes_to_gpt" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'">tests/test_router_llama_fallback.py:34: in test_llama_circuit_open_routes_to_gpt
    monkeypatch.setattr(router, "_call_gpt", fake_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_gpt_failure_falls_back_to_llama" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'">tests/test_router_llama_fallback.py:61: in test_gpt_failure_falls_back_to_llama
    monkeypatch.setattr(router, "_call_gpt", fail_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_gpt_failure_raises_when_llama_unhealthy" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'">tests/test_router_llama_fallback.py:82: in test_gpt_failure_raises_when_llama_unhealthy
    monkeypatch.setattr(router, "_call_gpt", fail_gpt)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_gpt_override_failure_falls_back_to_llama" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt_override'">tests/test_router_llama_fallback.py:105: in test_gpt_override_failure_falls_back_to_llama
    monkeypatch.setattr(router, "_call_gpt_override", fail_override)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_call_gpt_override'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_empty_llama_response_falls_back_to_gpt" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_llama_fallback.py:126: in test_empty_llama_response_falls_back_to_gpt
    monkeypatch.setattr(router, "ask_llama", fake_llama)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_llama_fallback" name="test_low_conf_llama_response_falls_back_to_gpt" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'">tests/test_router_llama_fallback.py:151: in test_low_conf_llama_response_falls_back_to_gpt
    monkeypatch.setattr(router, "ask_llama", fake_llama)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'ask_llama'</failure></testcase><testcase classname="tests.test_router_minimum_grid.TestOverrideAllowsOnlyAllowlistedModels" name="test_override_allows_only_allowlisted_models" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestDefaultPickRoutesByIntent" name="test_default_pick_routes_by_intent" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestLlamaErrorFallsBackToGpt" name="test_llama_error_falls_back_to_gpt_once" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestOpenAI4xxBubblesNoFallback" name="test_openai_4xx_bubbles_no_fallback" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestCacheShortCircuitHits" name="test_cache_short_circuit_hits" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestUserCircuitBreaker" name="test_user_cb_opens_and_cools_down" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestTimeoutsEnforcedPerVendor" name="test_timeouts_enforced_per_vendor" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_minimum_grid.TestGoldenTraceEmitsOnceWithFields" name="test_golden_trace_emits_once_with_fields" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_router_minimum_grid.py:88: in patch_memgpt_and_vector
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_router_provenance" name="test_annotate_provenance_triggers_embeddings" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_embed'">tests/test_router_provenance.py:154: in test_annotate_provenance_triggers_embeddings
    monkeypatch.setattr(router, "_embed", fake_embed)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute '_embed'</failure></testcase><testcase classname="tests.test_router_user_circuit" name="test_per_user_llama_circuit" time="0.002"><failure message="AttributeError: module 'app.router' has no attribute 'llama_integration'">tests/test_router_user_circuit.py:17: in test_per_user_llama_circuit
    monkeypatch.setattr(r.llama_integration, "LLAMA_HEALTHY", True)
                        ^^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.router' has no attribute 'llama_integration'</failure></testcase><testcase classname="tests.test_routes_extracted" name="test_main_contains_no_business_handlers" time="0.092"><failure message="AssertionError: assert '/v1/sessions/upload' in ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/album_art', '/google/oauth/callback']">tests/test_routes_extracted.py:19: in test_main_contains_no_business_handlers
    assert p in got
E   AssertionError: assert '/v1/sessions/upload' in ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/album_art', '/google/oauth/callback']</failure></testcase><testcase classname="tests.test_routes_unique" name="test_no_duplicate_google_oauth_login_route" time="0.002"><failure message="assert 0 == 1">tests/test_routes_unique.py:10: in test_no_duplicate_google_oauth_login_route
    assert c[("GET", "/v1/google/auth/login_url")] == 1
E   assert 0 == 1</failure></testcase><testcase classname="tests.test_routes_unique" name="test_no_duplicate_auth_routes_prefix" time="0.001" /><testcase classname="tests.test_routing_deterministic" name="test_flag_guard_legacy_router" time="0.001"><failure message="AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'pick_model'">tests/test_routing_deterministic.py:13: in test_flag_guard_legacy_router
    monkeypatch.setattr(r, "pick_model", lambda *a, **k: ("gpt", "gpt-4o"))
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'pick_model'</failure></testcase><testcase classname="tests.test_routing_deterministic" name="test_deterministic_router_path" time="0.002" /><testcase classname="tests.test_routing_matrix" name="test_branch_short_default" time="0.002" /><testcase classname="tests.test_routing_matrix" name="test_branch_long_context_docs" time="0.003" /><testcase classname="tests.test_routing_matrix" name="test_branch_attachments" time="0.001" /><testcase classname="tests.test_routing_matrix" name="test_branch_ops_simple" time="0.001" /><testcase classname="tests.test_routing_matrix" name="test_branch_ops_complex" time="0.001" /><testcase classname="tests.test_routing_matrix" name="test_branch_long_prompt" time="0.001" /><testcase classname="tests.test_routing_requirements.TestOverridePathRespectsAllowlistAndHealth" name="test_override_with_allowed_model_passes" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestOverridePathRespectsAllowlistAndHealth" name="test_override_with_disallowed_model_fails" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestOverridePathRespectsAllowlistAndHealth" name="test_override_with_unhealthy_vendor_fails" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestOverridePathRespectsAllowlistAndHealth" name="test_override_fallback_when_vendor_unhealthy" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestOverridePathRespectsAllowlistAndHealth" name="test_override_unknown_vendor_fails" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_heavy_word_count_routes_to_gpt" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_heavy_tokens_routes_to_gpt" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_keyword_routing_routes_to_gpt" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_heavy_intent_routes_to_gpt" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_light_task_routes_to_llama" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestDefaultPickerPathPicksExpectedVendorModel" name="test_unhealthy_llama_routes_to_gpt" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestLlamaFailureGptFallbackPath" name="test_llama_failure_triggers_gpt_fallback_once" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestLlamaFailureGptFallbackPath" name="test_llama_5xx_error_triggers_fallback" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestLlamaFailureGptFallbackPath" name="test_llama_4xx_error_no_fallback" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestGoldenTraceEmitsExactlyOnce" name="test_golden_trace_emits_once_per_request" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestGoldenTraceEmitsExactlyOnce" name="test_golden_trace_emits_once_with_fallback" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestGoldenTraceEmitsExactlyOnce" name="test_golden_trace_emits_once_with_override" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestGoldenTraceEmitsExactlyOnce" name="test_golden_trace_contains_required_fields" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestCircuitBreakerOpensAfterThreshold" name="test_user_cb_opens_after_threshold_failures" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestCircuitBreakerOpensAfterThreshold" name="test_user_cb_cools_down_after_timeout" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestCircuitBreakerOpensAfterThreshold" name="test_global_cb_opens_after_threshold_failures" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_routing_requirements.TestCircuitBreakerOpensAfterThreshold" name="test_cb_reset_after_success" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'&quot;">tests/test_routing_requirements.py:89: in patch_dependencies
    monkeypatch.setattr(
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'memgpt'</error></testcase><testcase classname="tests.test_runtime_config_and_pipeline" name="test_runtime_config_defaults_loaded" time="0.001" /><testcase classname="tests.test_runtime_config_and_pipeline" name="test_admin_config_endpoint" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_runtime_config_and_pipeline.py:29: in test_admin_config_endpoint
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_runtime_config_and_pipeline" name="test_status_vector_store_endpoint" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_runtime_config_and_pipeline.py:37: in test_status_vector_store_endpoint
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_runtime_config_and_pipeline" name="test_admin_retrieval_trace_endpoint" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_runtime_config_and_pipeline.py:56: in test_admin_retrieval_trace_endpoint
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_runtime_config_and_pipeline" name="test_prompt_builder_uses_pipeline_when_enabled" time="0.112" /><testcase classname="tests.test_runtime_config_and_pipeline" name="test_reranker_minilm_orders_overlap" time="0.001" /><testcase classname="tests.test_runtime_config_and_pipeline" name="test_memgpt_policy_injects_by_threshold" time="0.001" /><testcase classname="tests.test_safe_query_user_memories" name="test_safe_query_user_memories_coerces_k" time="0.001" /><testcase classname="tests.test_security" name="test_preflight_endpoint_available" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_security.py:20: in test_preflight_endpoint_available
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_security" name="test_rate_limit_key_scope_route_isolates" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_security.py:37: in test_rate_limit_key_scope_route_isolates
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_security" name="test_verify_token_cookie_and_header_paths" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_security.py:47: in test_verify_token_cookie_and_header_paths
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_security" name="test_rate_limit_blocks_and_retry_after" time="0.008"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/test_security.py:71: in test_rate_limit_blocks_and_retry_after
    assert r2.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.test_security" name="test_webhook_sign_verify_roundtrip" time="0.003"><failure message="fastapi.exceptions.HTTPException: 400: invalid_timestamp">app/security.py:1751: in verify_webhook
    ts_val = float(str(x_timestamp).strip())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: could not convert string to float: 'annotation=NoneType required=False default=None json_schema_extra={}'

During handling of the above exception, another exception occurred:
tests/test_security.py:107: in test_webhook_sign_verify_roundtrip
    asyncio.run(_run())
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
tests/test_security.py:104: in _run
    out = await verify_webhook(req, x_signature=sig)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/security.py:1753: in verify_webhook
    raise HTTPException(status_code=400, detail="invalid_timestamp")
E   fastapi.exceptions.HTTPException: 400: invalid_timestamp</failure></testcase><testcase classname="tests.test_security_and_middleware" name="test_rate_limit_long_and_burst" time="0.034"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/test_security_and_middleware.py:53: in test_rate_limit_long_and_burst
    assert r.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.test_security_and_middleware" name="test_response_has_security_headers" time="0.002"><failure message="ImportError: cannot import name 'trace_request' from 'app.middleware' (/Users/kingal/2025/GesahniV2/app/middleware/__init__.py)">tests/test_security_and_middleware.py:61: in test_response_has_security_headers
    from app.middleware import trace_request
E   ImportError: cannot import name 'trace_request' from 'app.middleware' (/Users/kingal/2025/GesahniV2/app/middleware/__init__.py)</failure></testcase><testcase classname="tests.test_security_and_middleware" name="test_nonce_required_and_reuse" time="0.014" /><testcase classname="tests.test_security_and_middleware" name="test_webhook_signing_and_rotation" time="0.009"><failure message="assert 400 == 200&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/test_security_and_middleware.py:109: in test_webhook_signing_and_rotation
    assert r.status_code == 200
E   assert 400 == 200
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.test_security_comprehensive.TestCookiePolicy" name="test_legacy_temp_cookie_attributes" time="0.002" /><testcase classname="tests.test_security_comprehensive.TestCookiePolicy" name="test_legacy_temp_cookie_secure_on_https" time="0.002" /><testcase classname="tests.test_security_comprehensive.TestCookiePolicy" name="test_failing_origin_validation_logic" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestCookiePolicy" name="test_allowed_origin_passes" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestRateLimit" name="test_11th_call_in_minute_yields_429" time="0.012"><failure message="Failed: Call 3 was unexpectedly rate limited: 429: {'error': 'rate_limited', 'retry_after': 0}">tests/test_security_comprehensive.py:170: in test_11th_call_in_minute_yields_429
    asyncio.run(rate_limit(mock_request))
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/security.py:1337: in rate_limit
    raise HTTPException(
E   fastapi.exceptions.HTTPException: 429: {'error': 'rate_limited', 'retry_after': 0}

During handling of the above exception, another exception occurred:
tests/test_security_comprehensive.py:172: in test_11th_call_in_minute_yields_429
    pytest.fail(f"Call {i+1} was unexpectedly rate limited: {e}")
E   Failed: Call 3 was unexpectedly rate limited: 429: {'error': 'rate_limited', 'retry_after': 0}</failure></testcase><testcase classname="tests.test_security_comprehensive.TestRateLimit" name="test_rate_limit_headers_present" time="0.008" /><testcase classname="tests.test_security_comprehensive.TestStateAndTX" name="test_expired_state_jwt_decode_fails" time="0.003" /><testcase classname="tests.test_security_comprehensive.TestStateAndTX" name="test_missing_tx_returns_none" time="0.002" /><testcase classname="tests.test_security_comprehensive.TestStateAndTX" name="test_user_mismatch_detected" time="0.003" /><testcase classname="tests.test_security_comprehensive.TestStateAndTX" name="test_consumed_tx_not_available" time="0.003" /><testcase classname="tests.test_security_comprehensive.TestNoURLLog" name="test_jwt_state_not_logged_in_logs" time="0.003" /><testcase classname="tests.test_security_comprehensive.TestNoURLLog" name="test_authorize_url_not_logged_in_logs" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestNoURLLog" name="test_sensitive_data_not_in_log_metadata" time="0.002" /><testcase classname="tests.test_security_comprehensive.TestOriginValidation" name="test_origin_validation_logic_disallowed_origin" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestOriginValidation" name="test_origin_validation_logic_allowed_origin" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestOriginValidation" name="test_origin_validation_empty_origin_allowed" time="0.001" /><testcase classname="tests.test_security_comprehensive.TestCookieSecurity" name="test_oauth_state_cookies_httponly" time="0.004" /><testcase classname="tests.test_security_comprehensive.TestCookieSecurity" name="test_temp_cookie_no_preview_in_logs" time="0.006" /><testcase classname="tests.test_security_comprehensive.TestRateLimitSecurity" name="test_rate_limit_bypass_requires_scope" time="0.003" /><testcase classname="tests.test_security_comprehensive.TestRateLimitSecurity" name="test_rate_limit_user_scoping" time="0.026" /><testcase classname="tests.test_security_jwt_decode" name="test_jwt_decode_respects_leeway" time="0.002"><failure message="jwt.exceptions.ExpiredSignatureError: Signature has expired">tests/test_security_jwt_decode.py:17: in test_jwt_decode_respects_leeway
    claims = jwt_decode(token, os.getenv("JWT_SECRET"), algorithms=["HS256"])
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/security.py:408: in jwt_decode
    return jwt.decode(token, key, algorithms=algorithms, options=opts, **kwargs)  # type: ignore[arg-type]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:222: in decode
    decoded = self.decode_complete(
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:167: in decode_complete
    self._validate_claims(
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:262: in _validate_claims
    self._validate_exp(payload, now, leeway)
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:363: in _validate_exp
    raise ExpiredSignatureError("Signature has expired")
E   jwt.exceptions.ExpiredSignatureError: Signature has expired</failure></testcase><testcase classname="tests.test_self_check_escalation" name="test_escalates_after_two_failures" time="0.003" /><testcase classname="tests.test_self_check_escalation" name="test_final_retry_o4_mini" time="0.002"><failure message="AssertionError: assert 'gpt-4o' in {'gpt-4.1-nano', 'o4-mini'}">tests/test_self_check_escalation.py:48: in test_final_retry_o4_mini
    assert model in {"gpt-4.1-nano", "o4-mini"}
E   AssertionError: assert 'gpt-4o' in {'gpt-4.1-nano', 'o4-mini'}</failure></testcase><testcase classname="tests.test_self_check_loop" name="test_exactly_one_final_retry" time="0.002"><failure message="KeyError: 'gpt-4o'">tests/test_self_check_loop.py:19: in test_exactly_one_final_retry
    text, final_model, reason, score, pt, ct, cost, escalated = asyncio.run(
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/model_router.py:391: in run_with_self_check
    text, pt, ct, cost = await _call(current_model)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^
app/model_router.py:346: in _call
    text, pt, ct, cost = await ask_func(
tests/test_self_check_loop.py:17: in ask_seq
    return seq[model]
           ^^^^^^^^^^
E   KeyError: 'gpt-4o'</failure></testcase><testcase classname="tests.test_semantic_cache" name="test_semantic_cache_hit_case_insensitive" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'&quot;">tests/test_semantic_cache.py:33: in setup_cache
    monkeypatch.setattr(router, "handle_command", no_ha)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</error></testcase><testcase classname="tests.test_semantic_cache" name="test_semantic_cache_hit_whitespace_insensitive" time="0.001"><error message="failed on setup with &quot;AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'&quot;">tests/test_semantic_cache.py:33: in setup_cache
    monkeypatch.setattr(router, "handle_command", no_ha)
E   AttributeError: &lt;module 'app.router' from '/Users/kingal/2025/GesahniV2/app/router/__init__.py'&gt; has no attribute 'handle_command'</error></testcase><testcase classname="tests.test_semantic_cache" name="test_record_feedback_preserves_metadata" time="0.002" /><testcase classname="tests.test_session_meta_logging" name="test_capture_save_sets_transcript_uri_when_sharing_enabled" time="0.028" /><testcase classname="tests.test_session_tags" name="test_save_session_tags" time="0.005" /><testcase classname="tests.test_sessions_api" name="test_capture_flow" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_sessions_api.py:52: in test_capture_flow
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_sessions_api" name="test_search_sort_and_pagination" time="0.009"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_sessions_api.py:130: in test_search_sort_and_pagination
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_sessions_api" name="test_search_by_tag" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_sessions_api.py:160: in test_search_by_tag
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_sessions_api" name="test_manual_pipeline" time="0.005"><failure message="KeyError: 'session_id'">tests/test_sessions_api.py:172: in test_manual_pipeline
    session_id = resp.json()["session_id"]
                 ^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'session_id'</failure></testcase><testcase classname="tests.test_skill_registry" name="test_all_skill_modules_have_handle" time="0.008"><failure message="AssertionError: contracts has no Skill subclass&#10;assert False">tests/test_skill_registry.py:30: in test_all_skill_modules_have_handle
    assert found, f"{info.name} has no Skill subclass"
E   AssertionError: contracts has no Skill subclass
E   assert False</failure></testcase><testcase classname="tests.test_skills.test_alarm_skill" name="test_alarm_set_list_cancel" time="0.005" /><testcase classname="tests.test_skills.test_calendar_skill" name="test_calendar_skill" time="0.005" /><testcase classname="tests.test_skills.test_climate_skill" name="test_set_temperature" time="0.003" /><testcase classname="tests.test_skills.test_clock_skill" name="test_clock_skill_match_and_run" time="0.002" /><testcase classname="tests.test_skills.test_color_skill" name="test_color_hex_to_rgb" time="0.003" /><testcase classname="tests.test_skills.test_color_skill" name="test_color_rgb_to_hex" time="0.002" /><testcase classname="tests.test_skills.test_cover_skill" name="test_cover_skill" time="0.002" /><testcase classname="tests.test_skills.test_currency_skill" name="test_currency_skill" time="0.002" /><testcase classname="tests.test_skills.test_datetime_skill" name="test_datetime_today" time="0.002" /><testcase classname="tests.test_skills.test_datetime_skill" name="test_datetime_relative" time="0.003" /><testcase classname="tests.test_skills.test_dictionary_skill" name="test_dictionary" time="0.002" /><testcase classname="tests.test_skills.test_dictionary_skill" name="test_synonyms_of_variant" time="0.002" /><testcase classname="tests.test_skills.test_dictionary_skill" name="test_what_does_mean_variant" time="0.002" /><testcase classname="tests.test_skills.test_dictionary_skill" name="test_dictionary_no_meanings" time="0.003" /><testcase classname="tests.test_skills.test_dictionary_skill" name="test_dictionary_service_unreachable" time="0.002" /><testcase classname="tests.test_skills.test_door_lock_skill" name="test_door_lock" time="0.005"><failure message="AssertionError: assert 'Lock' in 'Which door did you mean? I found multiple matches.'">tests/test_skills/test_door_lock_skill.py:28: in test_door_lock
    assert "Lock" in resp
E   AssertionError: assert 'Lock' in 'Which door did you mean? I found multiple matches.'</failure></testcase><testcase classname="tests.test_skills.test_fan_skill" name="test_fan_skill" time="0.002" /><testcase classname="tests.test_skills.test_forecast_skill" name="test_forecast_skill" time="0.009" /><testcase classname="tests.test_skills.test_forecast_skill" name="test_forecast_plain_phrase" time="0.002" /><testcase classname="tests.test_skills.test_forecast_skill" name="test_forecast_handles_no_data" time="0.002" /><testcase classname="tests.test_skills.test_joke_skill" name="test_joke" time="0.003" /><testcase classname="tests.test_skills.test_lights_skill" name="test_lights_turn_on" time="0.004"><failure message="AssertionError: assert 'Kitchen' in 'Which light did you mean? I found multiple matches.'">tests/test_skills/test_lights_skill.py:41: in test_lights_turn_on
    assert "Kitchen" in resp
E   AssertionError: assert 'Kitchen' in 'Which light did you mean? I found multiple matches.'</failure></testcase><testcase classname="tests.test_skills.test_lights_skill" name="test_lights_brightness_bounds" time="0.003"><failure message="NameError: name 'time' is not defined. Did you forget to import 'time'">tests/test_skills/test_lights_skill.py:63: in test_lights_brightness_bounds
    resp = asyncio.run(skill.run("set office lights to 150%", m))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/lights_skill.py:120: in run
    idemp = f"lights:{entity}:set:{level}:{int(time.time()//10)}"
                                               ^^^^
E   NameError: name 'time' is not defined. Did you forget to import 'time'</failure></testcase><testcase classname="tests.test_skills.test_lights_skill" name="test_lights_switch_synonym" time="0.003"><failure message="NameError: name 'time' is not defined. Did you forget to import 'time'">tests/test_skills/test_lights_skill.py:87: in test_lights_switch_synonym
    resp = asyncio.run(skill.run("switch off desk light", m))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/lights_skill.py:158: in run
    idemp = f"lights:{entity}:{service}:{int(time.time()//10)}"
                                             ^^^^
E   NameError: name 'time' is not defined. Did you forget to import 'time'</failure></testcase><testcase classname="tests.test_skills.test_lights_skill" name="test_lights_fuzzy_match" time="0.003"><failure message="KeyError: 'service'">tests/test_skills/test_lights_skill.py:112: in test_lights_fuzzy_match
    assert captured["service"] == "turn_on"
           ^^^^^^^^^^^^^^^^^^^
E   KeyError: 'service'</failure></testcase><testcase classname="tests.test_skills.test_lights_skill" name="test_lights_not_found" time="0.002"><failure message="AssertionError: assert 'Couldn’t find any light' in 'Which light did you mean? I found multiple matches.'">tests/test_skills/test_lights_skill.py:125: in test_lights_not_found
    assert "Couldn’t find any light" in resp
E   AssertionError: assert 'Couldn’t find any light' in 'Which light did you mean? I found multiple matches.'</failure></testcase><testcase classname="tests.test_skills.test_math_skill" name="test_math_basic" time="0.003"><failure message="AssertionError: assert '5 — Evaluated numeric: 5' == '5'&#10;  &#10;  - 5&#10;  + 5 — Evaluated numeric: 5">tests/test_skills/test_math_skill.py:14: in test_math_basic
    assert out == "5"
E   AssertionError: assert '5 — Evaluated numeric: 5' == '5'
E     
E     - 5
E     + 5 — Evaluated numeric: 5</failure></testcase><testcase classname="tests.test_skills.test_math_skill" name="test_percentage" time="0.003" /><testcase classname="tests.test_skills.test_math_skill" name="test_divide_by_zero" time="0.002"><failure message="ZeroDivisionError: division by zero">tests/test_skills/test_math_skill.py:27: in test_divide_by_zero
    out = asyncio.run(skill.run("5 / 0", m))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/math_skill.py:25: in run
    val, expl = evaluate_expr(expr)
                ^^^^^^^^^^^^^^^^^^^
app/skills/math_eval.py:174: in evaluate_expr
    val = _eval_node(node)
          ^^^^^^^^^^^^^^^^
app/skills/math_eval.py:19: in _eval_node
    return _eval_node(node.body)
           ^^^^^^^^^^^^^^^^^^^^^
app/skills/math_eval.py:34: in _eval_node
    return left / right
           ^^^^^^^^^^^^
E   ZeroDivisionError: division by zero</failure></testcase><testcase classname="tests.test_skills.test_music_skill" name="test_music_play" time="0.002"><failure message="TypeError: MusicOrchestrator.__init__() got an unexpected keyword argument 'provider'">tests/test_skills/test_music_skill.py:22: in test_music_play
    resp = asyncio.run(skill.run("play music", m))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/music_skill.py:46: in run
    orch = MusicOrchestrator(provider=provider)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: MusicOrchestrator.__init__() got an unexpected keyword argument 'provider'</failure></testcase><testcase classname="tests.test_skills.test_music_skill" name="test_music_artist" time="0.002" /><testcase classname="tests.test_skills.test_news_skill" name="test_news" time="0.006" /><testcase classname="tests.test_skills.test_notes_skill" name="test_notes" time="0.002"><failure message="NameError: name 'time' is not defined. Did you forget to import 'time'">tests/test_skills/test_notes_skill.py:25: in test_notes
    asyncio.run(skill.run("note hello", m1))
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/notes_skill.py:105: in run
    idemp = f"notes:add:{hash(text)}:{int(time.time()//10)}"
                                          ^^^^
E   NameError: name 'time' is not defined. Did you forget to import 'time'</failure></testcase><testcase classname="tests.test_skills.test_notify_skill" name="test_notify_skill" time="0.002" /><testcase classname="tests.test_skills.test_password_skill" name="test_password_default_length" time="0.003" /><testcase classname="tests.test_skills.test_password_skill" name="test_password_custom_length_bounds" time="0.003" /><testcase classname="tests.test_skills.test_recipe_skill" name="test_recipe" time="0.002" /><testcase classname="tests.test_skills.test_regex_skill" name="test_regex_explain_valid" time="0.002" /><testcase classname="tests.test_skills.test_regex_skill" name="test_regex_test_match" time="0.002" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_skill" time="0.011" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_recurring" time="0.008" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_minutes_variants" time="0.006" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_hours_variants" time="0.014" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_tomorrow_at_time" time="0.007" /><testcase classname="tests.test_skills.test_reminder_skill" name="test_reminder_weekday_cron" time="0.006" /><testcase classname="tests.test_skills.test_roku_skill" name="test_roku_launch" time="0.002" /><testcase classname="tests.test_skills.test_scene_skill" name="test_scene_skill" time="0.002" /><testcase classname="tests.test_skills.test_script_skill" name="test_script_skill" time="0.002" /><testcase classname="tests.test_skills.test_script_skill" name="test_script_skill_does_not_match_lebrun" time="0.001" /><testcase classname="tests.test_skills.test_search_skill" name="test_search" time="0.003" /><testcase classname="tests.test_skills.test_search_skill" name="test_search_was_are_variants" time="0.002" /><testcase classname="tests.test_skills.test_search_skill" name="test_search_related_topics_fallback" time="0.002" /><testcase classname="tests.test_skills.test_search_skill" name="test_search_service_unreachable" time="0.002" /><testcase classname="tests.test_skills.test_sports_skill" name="test_did_team_win" time="0.009" /><testcase classname="tests.test_skills.test_sports_skill" name="test_next_game" time="0.003" /><testcase classname="tests.test_skills.test_status_skill" name="test_status" time="0.003" /><testcase classname="tests.test_skills.test_stock_skill" name="test_stock_price" time="0.003" /><testcase classname="tests.test_skills.test_stock_skill" name="test_crypto_price_conversion" time="0.002" /><testcase classname="tests.test_skills.test_stock_skill" name="test_stock_price_error" time="0.003" /><testcase classname="tests.test_skills.test_teach_skill" name="test_teach_skill_missing_entity" time="0.002" /><testcase classname="tests.test_skills.test_text_utils_skill" name="test_slugify" time="0.002" /><testcase classname="tests.test_skills.test_text_utils_skill" name="test_word_count" time="0.002" /><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_skill" time="0.010" /><testcase classname="tests.test_skills.test_timer_skill" name="test_named_timer_cancel_query" time="0.013" /><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_begin_synonym" time="0.006" /><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_stop_synonym" time="0.012" /><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_mins_synonym" time="0.006" /><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_left_alt_phrase" time="0.013"><failure message="AssertionError: assert 'focus' in '1 seconds left on focu timer.'">tests/test_skills/test_timer_skill.py:108: in test_timer_left_alt_phrase
    assert "focus" in resp
E   AssertionError: assert 'focus' in '1 seconds left on focu timer.'</failure></testcase><testcase classname="tests.test_skills.test_timer_skill" name="test_timer_default_name" time="0.007" /><testcase classname="tests.test_skills.test_traffic_skill" name="test_traffic_ann_arbor" time="0.003" /><testcase classname="tests.test_skills.test_traffic_skill" name="test_drive_to_chicago" time="0.002" /><testcase classname="tests.test_skills.test_translate_skill" name="test_translate" time="0.003" /><testcase classname="tests.test_skills.test_translate_skill" name="test_detect" time="0.002" /><testcase classname="tests.test_skills.test_unit_conversion_skill" name="test_unit_conversion_skill" time="0.002" /><testcase classname="tests.test_skills.test_unit_conversion_skill" name="test_unit_conversion_litre_alias" time="0.002" /><testcase classname="tests.test_skills.test_unit_conversion_skill" name="test_unit_conversion_kilometre_alias" time="0.002" /><testcase classname="tests.test_skills.test_unit_conversion_skill" name="test_unit_conversion_plural_handling" time="0.003" /><testcase classname="tests.test_skills.test_unit_conversion_skill" name="test_unit_conversion_unsupported" time="0.002" /><testcase classname="tests.test_skills.test_url_title_skill" name="test_url_title" time="0.002" /><testcase classname="tests.test_skills.test_uuid_nanoid_skill" name="test_make_id_default" time="0.002" /><testcase classname="tests.test_skills.test_uuid_nanoid_skill" name="test_nanoid_custom_length" time="0.002" /><testcase classname="tests.test_skills.test_uuid_skill" name="test_uuid_v4_default" time="0.003" /><testcase classname="tests.test_skills.test_uuid_skill" name="test_uuid_v5" time="0.002" /><testcase classname="tests.test_skills.test_vacuum_skill" name="test_vacuum_start" time="0.004" /><testcase classname="tests.test_skills.test_weather_skill" name="test_weather_skill" time="0.003" /><testcase classname="tests.test_skills.test_weather_skill" name="test_weather_skill_zero_temp" time="0.002" /><testcase classname="tests.test_skills.test_weather_skill" name="test_weather_city_with_comma" time="0.003" /><testcase classname="tests.test_skills.test_world_clock_skill" name="test_world_clock_skill" time="0.005" /><testcase classname="tests.test_skills_base" name="test_check_builtin_skills_match" time="0.002"><failure message="ValueError: &quot;LogRecord&quot; object has no field &quot;candidates&quot;">tests/test_skills_base.py:25: in test_check_builtin_skills_match
    resp = asyncio.run(base.check_builtin_skills("hello there"))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/base.py:116: in check_builtin_skills
    rec.candidates = [(c.skill.__class__.__name__, c.score, c.reasons) for c in top3]
    ^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pydantic/main.py:997: in __setattr__
    elif (setattr_handler := self._setattr_handler(name, value)) is not None:
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pydantic/main.py:1044: in _setattr_handler
    raise ValueError(f'"{cls.__name__}" object has no field "{name}"')
E   ValueError: "LogRecord" object has no field "candidates"</failure></testcase><testcase classname="tests.test_skills_base" name="test_check_builtin_skills_none" time="0.003"><failure message="ValueError: &quot;LogRecord&quot; object has no field &quot;candidates&quot;">tests/test_skills_base.py:31: in test_check_builtin_skills_none
    resp = asyncio.run(base.check_builtin_skills("no match"))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/skills/base.py:116: in check_builtin_skills
    rec.candidates = [(c.skill.__class__.__name__, c.score, c.reasons) for c in top3]
    ^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pydantic/main.py:997: in __setattr__
    elif (setattr_handler := self._setattr_handler(name, value)) is not None:
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pydantic/main.py:1044: in _setattr_handler
    raise ValueError(f'"{cls.__name__}" object has no field "{name}"')
E   ValueError: "LogRecord" object has no field "candidates"</failure></testcase><testcase classname="tests.test_skills_direct" name="test_skills" time="0.003"><failure message="AttributeError: 'bool' object has no attribute 'groupdict'">tests/test_skills_direct.py:24: in test_skills
    result = await base.check_builtin_skills("hello")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/skills/base.py:93: in check_builtin_skills
    groups = m.groupdict()
             ^^^^^^^^^^^
E   AttributeError: 'bool' object has no attribute 'groupdict'</failure></testcase><testcase classname="tests.test_skills_init" name="test_skills_order_and_length" time="0.002"><failure message="AssertionError: assert 32 == 33&#10; +  where 32 = len([&lt;class 'app.skills.smalltalk_skill.SmalltalkSkill'&gt;, &lt;class 'app.skills.clock_skill.ClockSkill'&gt;, &lt;class 'app.skills....therSkill'&gt;, &lt;class 'app.skills.forecast_skill.ForecastSkill'&gt;, &lt;class 'app.skills.reminder_skill.ReminderSkill'&gt;, ...])&#10; +    where [&lt;class 'app.skills.smalltalk_skill.SmalltalkSkill'&gt;, &lt;class 'app.skills.clock_skill.ClockSkill'&gt;, &lt;class 'app.skills....therSkill'&gt;, &lt;class 'app.skills.forecast_skill.ForecastSkill'&gt;, &lt;class 'app.skills.reminder_skill.ReminderSkill'&gt;, ...] = skills.SKILL_CLASSES&#10; +  and   33 = len([&lt;tests.test_skills_base.Dummy object at 0x12061b4a0&gt;, &lt;app.skills.smalltalk_skill.SmalltalkSkill object at 0x112c6d52...eather_skill.WeatherSkill object at 0x114e0b5f0&gt;, &lt;app.skills.forecast_skill.ForecastSkill object at 0x114e0b620&gt;, ...])&#10; +    where [&lt;tests.test_skills_base.Dummy object at 0x12061b4a0&gt;, &lt;app.skills.smalltalk_skill.SmalltalkSkill object at 0x112c6d52...eather_skill.WeatherSkill object at 0x114e0b5f0&gt;, &lt;app.skills.forecast_skill.ForecastSkill object at 0x114e0b620&gt;, ...] = skills.SKILLS">tests/test_skills_init.py:78: in test_skills_order_and_length
    assert len(skills.SKILL_CLASSES) == len(skills.SKILLS)
E   AssertionError: assert 32 == 33
E    +  where 32 = len([&lt;class 'app.skills.smalltalk_skill.SmalltalkSkill'&gt;, &lt;class 'app.skills.clock_skill.ClockSkill'&gt;, &lt;class 'app.skills....therSkill'&gt;, &lt;class 'app.skills.forecast_skill.ForecastSkill'&gt;, &lt;class 'app.skills.reminder_skill.ReminderSkill'&gt;, ...])
E    +    where [&lt;class 'app.skills.smalltalk_skill.SmalltalkSkill'&gt;, &lt;class 'app.skills.clock_skill.ClockSkill'&gt;, &lt;class 'app.skills....therSkill'&gt;, &lt;class 'app.skills.forecast_skill.ForecastSkill'&gt;, &lt;class 'app.skills.reminder_skill.ReminderSkill'&gt;, ...] = skills.SKILL_CLASSES
E    +  and   33 = len([&lt;tests.test_skills_base.Dummy object at 0x12061b4a0&gt;, &lt;app.skills.smalltalk_skill.SmalltalkSkill object at 0x112c6d52...eather_skill.WeatherSkill object at 0x114e0b5f0&gt;, &lt;app.skills.forecast_skill.ForecastSkill object at 0x114e0b620&gt;, ...])
E    +    where [&lt;tests.test_skills_base.Dummy object at 0x12061b4a0&gt;, &lt;app.skills.smalltalk_skill.SmalltalkSkill object at 0x112c6d52...eather_skill.WeatherSkill object at 0x114e0b5f0&gt;, &lt;app.skills.forecast_skill.ForecastSkill object at 0x114e0b620&gt;, ...] = skills.SKILLS</failure></testcase><testcase classname="tests.test_smalltalk" name="test_is_greeting" time="0.002" /><testcase classname="tests.test_smalltalk" name="test_handle_returns_valid_format" time="0.009" /><testcase classname="tests.test_smalltalk" name="test_router_integration" time="0.002"><failure message="RuntimeError: Router has not been configured. Call set_router() first.">tests/test_smalltalk.py:37: in test_router_integration
    result = asyncio.run(router.route_prompt("hello", user_id="u"))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/router/entrypoint.py:23: in route_prompt
    router = get_router()
             ^^^^^^^^^^^^
app/router/registry.py:29: in get_router
    raise RuntimeError("Router has not been configured. Call set_router() first.")
E   RuntimeError: Router has not been configured. Call set_router() first.</failure></testcase><testcase classname="tests.test_smalltalk" name="test_cached_responses_are_deterministic" time="0.010" /><testcase classname="tests.test_smalltalk" name="test_router_uses_smalltalk_cache" time="0.002"><failure message="RuntimeError: Router has not been configured. Call set_router() first.">tests/test_smalltalk.py:49: in test_router_uses_smalltalk_cache
    first = asyncio.run(router.route_prompt("yo", user_id="u"))
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:194: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
app/router/entrypoint.py:23: in route_prompt
    router = get_router()
             ^^^^^^^^^^^^
app/router/registry.py:29: in get_router
    raise RuntimeError("Router has not been configured. Call set_router() first.")
E   RuntimeError: Router has not been configured. Call set_router() first.</failure></testcase><testcase classname="tests.test_smalltalk" name="test_time_provider_injection" time="0.008" /><testcase classname="tests.test_smalltalk" name="test_memory_hook_formatting" time="0.006" /><testcase classname="tests.test_spotify_401_refresh" name="test_me_refreshes_on_401" time="0.000"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.test_spotify_429_backoff" name="test_429_bubbles_retry_after" time="0.001"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.test_spotify_budget_timeout" name="test_spotify_budget_enforced" time="0.001"><error message="failed on setup with &quot;TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'&quot;">.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:686: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:149: in create_test_user
    token_data = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</error></testcase><testcase classname="tests.test_spotify_callback" name="test_callback_success_flow" time="0.005"><failure message="AssertionError: assert (False or '/settings?spotify=connected' in ((None or '')))&#10; +  where False = any(&lt;generator object test_callback_success_flow.&lt;locals&gt;.&lt;genexpr&gt; at 0x11fb02ea0&gt;)&#10; +  and   None = get('Location')&#10; +    where get = Headers({'x-error-code': 'not_found', 'content-length': '252', 'content-type': 'application/json'}).get&#10; +      where Headers({'x-error-code': 'not_found', 'content-length': '252', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers">tests/test_spotify_callback.py:50: in test_callback_success_flow
    assert any("/settings?spotify=connected" in (h.headers.get("Location") or "") for h in histories) or "/settings?spotify=connected" in (res.headers.get("Location") or "")
E   AssertionError: assert (False or '/settings?spotify=connected' in ((None or '')))
E    +  where False = any(&lt;generator object test_callback_success_flow.&lt;locals&gt;.&lt;genexpr&gt; at 0x11fb02ea0&gt;)
E    +  and   None = get('Location')
E    +    where get = Headers({'x-error-code': 'not_found', 'content-length': '252', 'content-type': 'application/json'}).get
E    +      where Headers({'x-error-code': 'not_found', 'content-length': '252', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers</failure></testcase><testcase classname="tests.test_spotify_callback" name="test_callback_no_cookie_redirects_no_session" time="0.004"><failure message="AssertionError: assert 'No valid session identifier' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d99d0&gt;.text">tests/test_spotify_callback.py:73: in test_callback_no_cookie_redirects_no_session
    assert "No valid session identifier" in caplog.text
E   AssertionError: assert 'No valid session identifier' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d99d0&gt;.text</failure></testcase><testcase classname="tests.test_spotify_callback" name="test_callback_missing_code_redirects_no_code" time="0.005"><failure message="AssertionError: assert 'Missing authorization code' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204db980&gt;.text">tests/test_spotify_callback.py:94: in test_callback_missing_code_redirects_no_code
    assert "Missing authorization code" in caplog.text
E   AssertionError: assert 'Missing authorization code' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204db980&gt;.text</failure></testcase><testcase classname="tests.test_spotify_callback_errors" name="test_callback_oauth_error_redirects" time="0.004"><failure message="AssertionError: assert 'spotify.callback:redirect' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d8470&gt;.text">tests/test_spotify_callback_errors.py:15: in test_callback_oauth_error_redirects
    assert "spotify.callback:redirect" in caplog.text
E   AssertionError: assert 'spotify.callback:redirect' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d8470&gt;.text</failure></testcase><testcase classname="tests.test_spotify_callback_errors" name="test_callback_invalid_pkce_redirects" time="0.006"><failure message="AssertionError: assert 'spotify.callback:redirect' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d9130&gt;.text">tests/test_spotify_callback_errors.py:35: in test_callback_invalid_pkce_redirects
    assert "spotify.callback:redirect" in caplog.text
E   AssertionError: assert 'spotify.callback:redirect' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1204d9130&gt;.text</failure></testcase><testcase classname="tests.test_spotify_callback_errors" name="test_callback_token_exchange_failure" time="0.005"><failure message="AssertionError: assert 'spotify.callback:redirect' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1205b3860&gt;.text">tests/test_spotify_callback_errors.py:61: in test_callback_token_exchange_failure
    assert "spotify.callback:redirect" in caplog.text
E   AssertionError: assert 'spotify.callback:redirect' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1205b3860&gt;.text</failure></testcase><testcase classname="tests.test_spotify_complete_flow" name="test_complete_spotify_oauth_flow_with_mocking" time="0.007"><failure message="AssertionError: Connect failed with body: {&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/v1/spotify/connect&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;-&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:15Z&quot;,&quot;error_id&quot;:&quot;01K46J8W02BH8R3WFXK88AJ6B7&quot;,&quot;env&quot;:&quot;dev&quot;}}&#10;assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_complete_flow.py:71: in test_complete_spotify_oauth_flow_with_mocking
    assert connect_response.status_code == 200, f"Connect failed with body: {connect_response.text}"
E   AssertionError: Connect failed with body: {"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/v1/spotify/connect","method":"GET","req_id":"-","timestamp":"2025-09-03T01:15:15Z","error_id":"01K46J8W02BH8R3WFXK88AJ6B7","env":"dev"}}
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_cookie_flow" name="test_connect_sets_temp_cookie" time="0.005"><failure message="AssertionError: assert 'spotify_oauth_jwt' in ''">tests/test_spotify_cookie_flow.py:20: in test_connect_sets_temp_cookie
    assert "spotify_oauth_jwt" in sc
E   AssertionError: assert 'spotify_oauth_jwt' in ''</failure></testcase><testcase classname="tests.test_spotify_cookie_flow" name="test_callback_clears_temp_cookie" time="0.004"><failure message="AssertionError: assert ('spotify_oauth_jwt' in '' or 404 in (302, 200))&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_cookie_flow.py:59: in test_callback_clears_temp_cookie
    assert "spotify_oauth_jwt" in joined or res.status_code in (302, 200)
E   AssertionError: assert ('spotify_oauth_jwt' in '' or 404 in (302, 200))
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_flow" name="test_spotify_flow" time="0.005" /><testcase classname="tests.test_spotify_flow_with_mocking_e2e" name="test_spotify_flow_with_mocking" time="0.004"><failure message="requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12044ffe0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))">.venv/lib/python3.12/site-packages/urllib3/connection.py:198: in _new_conn
    sock = connection.create_connection(
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:85: in create_connection
    raise err
.venv/lib/python3.12/site-packages/urllib3/util/connection.py:73: in create_connection
    sock.connect(sa)
E   ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:787: in urlopen
    response = self._make_request(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:493: in _make_request
    conn.request(
.venv/lib/python3.12/site-packages/urllib3/connection.py:494: in request
    self.endheaders()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1331: in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1091: in _send_output
    self.send(msg)
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py:1035: in send
    self.connect()
.venv/lib/python3.12/site-packages/urllib3/connection.py:325: in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/urllib3/connection.py:213: in _new_conn
    raise NewConnectionError(
E   urllib3.exceptions.NewConnectionError: &lt;urllib3.connection.HTTPConnection object at 0x12044ffe0&gt;: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:
.venv/lib/python3.12/site-packages/requests/adapters.py:644: in send
    resp = conn.urlopen(
.venv/lib/python3.12/site-packages/urllib3/connectionpool.py:841: in urlopen
    retries = retries.increment(
.venv/lib/python3.12/site-packages/urllib3/util/retry.py:519: in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12044ffe0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:
tests/test_spotify_flow_with_mocking_e2e.py:57: in test_spotify_flow_with_mocking
    login_response = requests.get(login_url, cookies=cookies)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:73: in get
    return request("get", url, params=params, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/api.py:59: in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/requests/adapters.py:677: in send
    raise ConnectionError(e, request=request)
E   requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=8000): Max retries exceeded with url: /v1/spotify/login?user_id=test_user (Caused by NewConnectionError('&lt;urllib3.connection.HTTPConnection object at 0x12044ffe0&gt;: Failed to establish a new connection: [Errno 61] Connection refused'))</failure></testcase><testcase classname="tests.test_spotify_integration" name="test_spotify_status_endpoint" time="0.007" /><testcase classname="tests.test_spotify_integration" name="test_spotify_auth_flow" time="0.008" /><testcase classname="tests.test_spotify_integration" name="test_spotify_debug_routes" time="0.027" /><testcase classname="tests.test_spotify_oauth_flow" name="test_complete_spotify_oauth_flow" time="0.005" /><testcase classname="tests.test_spotify_oauth_flow_with_mocks" name="test_complete_spotify_oauth_flow_with_mocking" time="0.006" /><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_successful_oauth_callback_storage" time="0.004"><failure message="AttributeError: &lt;module 'app.api.spotify' from '/Users/kingal/2025/GesahniV2/app/api/spotify.py'&gt; does not have the attribute 'get_spotify_oauth_token'">tests/test_spotify_oauth_robust.py:46: in test_successful_oauth_callback_storage
    patch('app.api.spotify.get_spotify_oauth_token') as mock_get_token, \
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.spotify' from '/Users/kingal/2025/GesahniV2/app/api/spotify.py'&gt; does not have the attribute 'get_spotify_oauth_token'</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_oauth_callback_missing_issuer_validation" time="0.005"><failure message="AttributeError: &lt;module 'app.api.spotify' from '/Users/kingal/2025/GesahniV2/app/api/spotify.py'&gt; does not have the attribute 'get_spotify_oauth_token'">tests/test_spotify_oauth_robust.py:83: in test_oauth_callback_missing_issuer_validation
    patch('app.api.spotify.get_spotify_oauth_token') as mock_get_token, \
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.spotify' from '/Users/kingal/2025/GesahniV2/app/api/spotify.py'&gt; does not have the attribute 'get_spotify_oauth_token'</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_connect_endpoint_authentication" time="0.006"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_oauth_robust.py:116: in test_spotify_connect_endpoint_authentication
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_status_endpoint_robust_error_handling" time="0.008"><failure message="AssertionError: assert 'connected' in {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8WEFCZPGX43Y9Q1HXEXP', 'method': 'GET', 'path': '/v1/spotify/status', ...}, 'message': 'Not Found'}">tests/test_spotify_oauth_robust.py:135: in test_spotify_status_endpoint_robust_error_handling
    assert 'connected' in data
E   AssertionError: assert 'connected' in {'code': 'not_found', 'detail': 'Not Found', 'details': {'env': 'dev', 'error_id': '01K46J8WEFCZPGX43Y9Q1HXEXP', 'method': 'GET', 'path': '/v1/spotify/status', ...}, 'message': 'Not Found'}</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_status_with_valid_token" time="0.021"><failure message="KeyError: 'connected'">tests/test_spotify_oauth_robust.py:171: in test_spotify_status_with_valid_token
    assert data['connected'] is True
           ^^^^^^^^^^^^^^^^^
E   KeyError: 'connected'</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_status_with_expired_token_auto_refresh" time="0.017"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_spotify_oauth_robust.py:195: in test_spotify_status_with_expired_token_auto_refresh
    patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_status_refresh_failure_handling" time="0.018"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_spotify_oauth_robust.py:239: in test_spotify_status_refresh_failure_handling
    patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_disconnect_functionality" time="0.021"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_oauth_robust.py:283: in test_spotify_disconnect_functionality
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_token_for_sdk_endpoint" time="0.021"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_oauth_robust.py:316: in test_spotify_token_for_sdk_endpoint
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_token_for_sdk_no_token" time="0.008" /><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_oauth_state_validation" time="0.006"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_oauth_robust.py:340: in test_spotify_oauth_state_validation
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_spotify_scope_validation" time="0.021"><failure message="assert None is not None">tests/test_spotify_oauth_robust.py:390: in test_spotify_scope_validation
    assert token is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_spotify_oauth_robust.TestSpotifyOAuthRobust" name="test_concurrent_oauth_callbacks" time="0.031"><failure message="assert None is not None">tests/test_spotify_oauth_robust.py:439: in test_concurrent_oauth_callbacks
    assert token is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_spotify_preserve_main_cookie" name="test_main_auth_cookie_preserved_through_callback" time="0.004" /><testcase classname="tests.test_spotify_scope_enforcement" name="test_spotify_devices_allows_music_control_scope" time="0.002"><failure message="TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'">tests/test_spotify_scope_enforcement.py:29: in test_spotify_devices_allows_music_control_scope
    token = make_access({"user_id": "u1", "scopes": ["music:control"]})
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: create_test_client.&lt;locals&gt;.&lt;lambda&gt;() missing 1 required positional argument: 'ttl_s'</failure></testcase><testcase classname="tests.test_spotify_status" name="test_spotify_status_not_connected_when_no_tokens" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_spotify_status.py:15: in test_spotify_status_not_connected_when_no_tokens
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_startup_vendor_pings" name="test_openai_startup_ping_gated" time="0.003" /><testcase classname="tests.test_startup_vendor_pings" name="test_openai_startup_ping_enabled_missing_key" time="0.002" /><testcase classname="tests.test_startup_vendor_pings" name="test_unknown_vendor" time="0.002" /><testcase classname="tests.test_stateless_oauth_flow" name="test_stateless_oauth_flow" time="0.006" /><testcase classname="tests.test_status" name="test_status_endpoint" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_status.py:42: in test_status_endpoint
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_status_admin_routes" name="test_status_routes_bound_and_json_stable" time="0.065" /><testcase classname="tests.test_stream_cancellation" name="test_stream_cancels_cleanly" time="0.002"><failure message="AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'">tests/test_stream_cancellation.py:29: in test_stream_cancels_cleanly
    monkeypatch.setattr(main_mod, "route_prompt", _fake_route)
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.test_stream_status" name="test_streaming_sets_status_code" time="0.003"><failure message="AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'">tests/test_stream_status.py:28: in test_streaming_sets_status_code
    monkeypatch.setattr(main, "route_prompt", fail)
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.test_tasks" name="test_enqueue_fallback" time="0.004" /><testcase classname="tests.test_telemetry" name="test_telemetry_logged" time="0.003"><failure message="AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'">tests/test_telemetry.py:39: in test_telemetry_logged
    client = setup_app(monkeypatch, str(hist))
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_telemetry.py:33: in setup_app
    monkeypatch.setattr(main, "route_prompt", fake_route)
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'route_prompt'</failure></testcase><testcase classname="tests.test_telemetry" name="test_latency_p95" time="0.004" /><testcase classname="tests.test_timer_selector" name="test_set_30_min_timer" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_timer_selector.py:12: in test_set_30_min_timer
    chosen, top = run_select("set a 30 minute timer")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_timer_selector.py:8: in run_select
    return asyncio.get_event_loop().run_until_complete(selector.select(prompt, top_n=3))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_timer_selector" name="test_create_timer_1_hour" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_timer_selector.py:18: in test_create_timer_1_hour
    chosen, top = run_select("create timer for 1 hour")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_timer_selector.py:8: in run_select
    return asyncio.get_event_loop().run_until_complete(selector.select(prompt, top_n=3))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_timer_selector" name="test_set_timer_named_pasta" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_timer_selector.py:24: in test_set_timer_named_pasta
    chosen, top = run_select("set a timer named pasta for 8 minutes")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_timer_selector.py:8: in run_select
    return asyncio.get_event_loop().run_until_complete(selector.select(prompt, top_n=3))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_timer_selector" name="test_pause_resume_stop_cname_cleaning" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/test_timer_selector.py:34: in test_pause_resume_stop_cname_cleaning
    chosen, top = run_select("pause my timer")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_timer_selector.py:8: in run_select
    return asyncio.get_event_loop().run_until_complete(selector.select(prompt, top_n=3))
           ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.test_token_concurrency" name="test_concurrent_upserts_union_scopes" time="0.022"><failure message="assert False&#10; +  where False = all([False, False, False])">tests/test_token_concurrency.py:44: in test_concurrent_upserts_union_scopes
    assert all(res)
E   assert False
E    +  where False = all([False, False, False])</failure></testcase><testcase classname="tests.test_token_dao" name="test_upsert_unions_scopes_and_invalidates_prev" time="0.014"><failure message="assert False">tests/test_token_dao.py:30: in test_upsert_unions_scopes_and_invalidates_prev
    assert ok
E   assert False</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_database_connection_failure_recovery" time="0.016"><failure message="assert False">tests/test_token_error_handling.py:55: in test_database_connection_failure_recovery
    assert stored
E   assert False</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_network_timeout_during_refresh" time="0.005"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_malformed_api_response_handling" time="0.004"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_concurrent_modification_conflict_resolution" time="0.063"><failure message="assert 0 &gt; 0">tests/test_token_error_handling.py:176: in test_concurrent_modification_conflict_resolution
    assert successful_updates &gt; 0
E   assert 0 &gt; 0</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_encryption_key_rotation_handling" time="0.018"><failure message="AttributeError: 'NoneType' object has no attribute 'access_token'">tests/test_token_error_handling.py:206: in test_encryption_key_rotation_handling
    assert retrieved.access_token == original_token
           ^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'access_token'</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_partial_token_data_corruption_recovery" time="0.017"><failure message="assert None is not None">tests/test_token_error_handling.py:255: in test_partial_token_data_corruption_recovery
    assert normal_token is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_rate_limit_exhaustion_handling" time="0.004"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_service_unavailable_handling" time="0.004"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_invalid_grant_error_recovery" time="0.004"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_memory_pressure_error_handling" time="3.567"><failure message="assert None is not None">tests/test_token_error_handling.py:400: in test_memory_pressure_error_handling
    assert token is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_disk_space_exhaustion_handling" time="0.005"><failure message="Exception: Disk full">tests/test_token_error_handling.py:423: in test_disk_space_exhaustion_handling
    result = await dao.upsert_token(token)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:2291: in _execute_mock_call
    raise effect
E   Exception: Disk full</failure></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_circuit_breaker_pattern" time="0.004"><error message="failed on setup with &quot;TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given&quot;">tests/test_token_error_handling.py:33: in refresh_service
    return TokenRefreshService(dao)
           ^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: TokenRefreshService.__init__() takes 1 positional argument but 2 were given</error></testcase><testcase classname="tests.test_token_error_handling.TestTokenErrorHandling" name="test_graceful_degradation_under_load" time="0.354" /><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_healthy_system_status" time="0.020"><failure message="assert 0 == 2">tests/test_token_health_monitoring.py:60: in test_healthy_system_status
    assert health['database']['total_tokens'] == 2
E   assert 0 == 2</failure></testcase><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_system_with_expired_tokens" time="0.023"><failure message="assert 0 == 3">tests/test_token_health_monitoring.py:123: in test_system_with_expired_tokens
    assert health['database']['total_tokens'] == 3
E   assert 0 == 3</failure></testcase><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_empty_database_health" time="0.005" /><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_corrupted_database_handling" time="0.005"><failure message="NameError: name 'Mock' is not defined">tests/test_token_health_monitoring.py:153: in test_corrupted_database_handling
    mock_dao = Mock()
               ^^^^
E   NameError: name 'Mock' is not defined</failure></testcase><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_refresh_service_health_metrics" time="0.006" /><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_health_timestamp_and_versioning" time="0.005" /><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_provider_distribution_tracking" time="0.029"><failure message="AssertionError: assert 'spotify' in {}">tests/test_token_health_monitoring.py:242: in test_provider_distribution_tracking
    assert provider in provider_stats
E   AssertionError: assert 'spotify' in {}</failure></testcase><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_health_performance_under_load" time="0.004"><failure message="UnboundLocalError: cannot access local variable 'time' where it is not associated with a value">tests/test_token_health_monitoring.py:252: in test_health_performance_under_load
    now = int(time.time())
              ^^^^
E   UnboundLocalError: cannot access local variable 'time' where it is not associated with a value</failure></testcase><testcase classname="tests.test_token_health_monitoring.TestTokenHealthMonitoring" name="test_health_error_resilience" time="0.004"><failure message="TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'">tests/test_token_health_monitoring.py:311: in test_health_error_resilience
    normal_token = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_issuer_validation_improvement" time="0.017"><failure message="AssertionError: ✅ Valid Spotify token should store successfully&#10;assert False">tests/test_token_improvements_demo.py:45: in test_issuer_validation_improvement
    assert stored, "✅ Valid Spotify token should store successfully"
E   AssertionError: ✅ Valid Spotify token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_provider_specific_validation" time="0.016"><failure message="AssertionError: ✅ spotify token should store successfully&#10;assert False">tests/test_token_improvements_demo.py:105: in test_provider_specific_validation
    assert stored, f"✅ {provider} token should store successfully"
E   AssertionError: ✅ spotify token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_token_scope_unioning_logic" time="0.019"><failure message="AssertionError: ✅ First token should store&#10;assert False">tests/test_token_improvements_demo.py:155: in test_token_scope_unioning_logic
    assert stored1, "✅ First token should store"
E   AssertionError: ✅ First token should store
E   assert False</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_user_isolation_improvement" time="0.017"><failure message="AssertionError: ✅ Token for alice should store successfully&#10;assert False">tests/test_token_improvements_demo.py:188: in test_user_isolation_improvement
    assert stored, f"✅ Token for {user} should store successfully"
E   AssertionError: ✅ Token for alice should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_comprehensive_validation_rules" time="0.004"><failure message="TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'">tests/test_token_improvements_demo.py:252: in test_comprehensive_validation_rules
    token = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_refresh_integration_concept" time="0.016"><failure message="AssertionError: ✅ Expired token should store successfully&#10;assert False">tests/test_token_improvements_demo.py:307: in test_refresh_integration_concept
    assert stored, "✅ Expired token should store successfully"
E   AssertionError: ✅ Expired token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_improvements_demo.TestTokenImprovementsDemo" name="test_health_monitoring_concept" time="0.005" /><testcase classname="tests.test_token_improvements_demo" name="test_token_system_improvements_integration" time="0.015"><failure message="AssertionError: OAuth token should store&#10;assert False">tests/test_token_improvements_demo.py:387: in test_token_system_improvements_integration
    assert stored, "OAuth token should store"
E   AssertionError: OAuth token should store
E   assert False</failure></testcase><testcase classname="tests.test_token_migration" name="test_migration_applies_and_upserts" time="0.018"><failure message="assert False is True">tests/test_token_migration.py:53: in test_migration_applies_and_upserts
    assert ok is True
E   assert False is True</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_successful_token_refresh_spotify" time="0.017"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:58: in test_successful_token_refresh_spotify
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_refresh_retry_on_failure" time="0.018"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:101: in test_refresh_retry_on_failure
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_refresh_exhaustion_gives_up" time="0.019"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:147: in test_refresh_exhaustion_gives_up
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_concurrent_refresh_protection" time="0.020"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:196: in test_concurrent_refresh_protection
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_force_refresh_bypasses_cache" time="0.016"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:240: in test_force_refresh_bypasses_cache
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_google_token_refresh" time="0.016"><failure message="AttributeError: module 'app.integrations.google' has no attribute 'client'">tests/test_token_refresh_service.py:290: in test_google_token_refresh
    with patch('app.integrations.google.client.GoogleClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:528: in resolve_name
    result = getattr(result, p)
             ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.integrations.google' has no attribute 'client'</failure></testcase><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_no_token_found_handling" time="0.009" /><testcase classname="tests.test_token_refresh_service.TestTokenRefreshService" name="test_invalid_refresh_token_handling" time="0.017"><failure message="AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'">tests/test_token_refresh_service.py:341: in test_invalid_refresh_token_handling
    with patch('app.integrations.spotify.client.SpotifyClient._refresh_access_token',
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;class 'app.integrations.spotify.client.SpotifyClient'&gt; does not have the attribute '_refresh_access_token'</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_spotify_oauth_issuer_validation" time="0.017"><failure message="AssertionError: Valid Spotify token should store successfully&#10;assert False">tests/test_token_system_verification.py:43: in test_spotify_oauth_issuer_validation
    assert stored, "Valid Spotify token should store successfully"
E   AssertionError: Valid Spotify token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_token_encryption_working" time="0.015"><failure message="AssertionError: Token should store successfully&#10;assert False">tests/test_token_system_verification.py:89: in test_token_encryption_working
    assert stored, "Token should store successfully"
E   AssertionError: Token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_token_health_monitoring" time="0.017"><failure message="AssertionError: Token for user1 should store successfully&#10;assert False">tests/test_token_system_verification.py:141: in test_token_health_monitoring
    assert stored, f"Token for {token.user_id} should store successfully"
E   AssertionError: Token for user1 should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_provider_specific_validation" time="0.017"><failure message="AssertionError: spotify token should store successfully&#10;assert False">tests/test_token_system_verification.py:187: in test_provider_specific_validation
    assert stored, f"{provider} token should store successfully"
E   AssertionError: spotify token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_user_isolation" time="0.018"><failure message="AssertionError: Token for alice should store successfully&#10;assert False">tests/test_token_system_verification.py:213: in test_user_isolation
    assert stored, f"Token for {user} should store successfully"
E   AssertionError: Token for alice should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_token_scope_unioning" time="0.021"><failure message="AssertionError: Should retrieve the token&#10;assert None is not None">tests/test_token_system_verification.py:261: in test_token_scope_unioning
    assert final_token is not None, "Should retrieve the token"
E   AssertionError: Should retrieve the token
E   assert None is not None</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_database_error_recovery" time="0.019"><failure message="AssertionError: Token should store successfully initially&#10;assert False">tests/test_token_system_verification.py:290: in test_database_error_recovery
    assert stored, "Token should store successfully initially"
E   AssertionError: Token should store successfully initially
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_token_refresh_integration" time="0.019"><failure message="AssertionError: Expired token should store successfully&#10;assert False">tests/test_token_system_verification.py:324: in test_token_refresh_integration
    assert stored, "Expired token should store successfully"
E   AssertionError: Expired token should store successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_system_verification.TestTokenSystemVerification" name="test_comprehensive_validation_rules" time="0.004"><failure message="TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'">tests/test_token_system_verification.py:407: in test_comprehensive_validation_rules
    token = ThirdPartyToken(
E   TypeError: ThirdPartyToken.__init__() got an unexpected keyword argument 'scope'</failure></testcase><testcase classname="tests.test_token_system_verification" name="test_full_token_system_integration" time="0.015"><failure message="AssertionError: Should store Spotify token successfully&#10;assert False">tests/test_token_system_verification.py:458: in test_full_token_system_integration
    assert stored, "Should store Spotify token successfully"
E   AssertionError: Should store Spotify token successfully
E   assert False</failure></testcase><testcase classname="tests.test_token_upsert_comprehensive" name="test_upsert_happy_path" time="0.018" /><testcase classname="tests.test_token_upsert_comprehensive" name="test_upsert_conflict_update" time="0.041" /><testcase classname="tests.test_token_upsert_comprehensive" name="test_fk_violation" time="0.014" /><testcase classname="tests.test_token_upsert_comprehensive" name="test_notnull_violation" time="0.019" /><testcase classname="tests.test_token_upsert_comprehensive" name="test_concurrent_upserts" time="0.032" /><testcase classname="tests.test_token_upsert_comprehensive" name="test_spotify_contract_validation_integration" time="0.035" /><testcase classname="tests.test_token_utils" name="test_count_tokens_uses_tiktoken" time="0.003" /><testcase classname="tests.test_token_utils" name="test_count_tokens_fallback" time="0.004" /><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_valid_spotify_token_structure" time="0.023"><failure message="assert False">tests/test_token_validation.py:43: in test_valid_spotify_token_structure
    assert stored
E   assert False</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_invalid_spotify_token_missing_issuer" time="0.016" /><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_invalid_spotify_token_wrong_issuer" time="0.019" /><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_expired_token_handling" time="0.004"><failure message="TypeError: object bool can't be used in 'await' expression">tests/test_token_validation.py:120: in test_expired_token_handling
    is_valid = await dao._validate_token_for_storage(expired_token)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object bool can't be used in 'await' expression</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_token_scope_validation" time="0.022"><failure message="assert None is not None">tests/test_token_validation.py:169: in test_token_scope_validation
    assert retrieved is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_google_token_validation" time="0.016"><failure message="assert False">tests/test_token_validation.py:198: in test_google_token_validation
    assert stored
E   assert False</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_malformed_token_rejection" time="0.005" /><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_token_encryption_validation" time="0.018"><failure message="assert False">tests/test_token_validation.py:242: in test_token_encryption_validation
    assert stored
E   assert False</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_multiple_users_isolation" time="0.020"><failure message="assert None is not None">tests/test_token_validation.py:294: in test_multiple_users_isolation
    assert retrieved_user1 is not None
E   assert None is not None</failure></testcase><testcase classname="tests.test_token_validation.TestTokenValidation" name="test_provider_specific_validation" time="0.004"><failure message="TypeError: object bool can't be used in 'await' expression">tests/test_token_validation.py:324: in test_provider_specific_validation
    is_valid = await dao._validate_token_for_storage(invalid_token)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object bool can't be used in 'await' expression</failure></testcase><testcase classname="tests.test_transcribe" name="test_transcribe_post_and_file_created" time="0.004"><failure message="AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'transcribe_file'">tests/test_transcribe.py:28: in test_transcribe_post_and_file_created
    main = setup_app(monkeypatch, tmp_path, fake_transcribe)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_transcribe.py:20: in setup_app
    monkeypatch.setattr(main, "transcribe_file", transcribe_func)
E   AttributeError: &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt; has no attribute 'transcribe_file'</failure></testcase><testcase classname="tests.test_transcribe" name="test_transcribe_get" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_transcribe.py:44: in test_transcribe_get
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_transcribe_unit_extra" name="test_model_resolution_precedence" time="0.005" /><testcase classname="tests.test_transcribe_unit_extra" name="test_max_audio_bytes_guard" time="0.004" /><testcase classname="tests.test_transcribe_unit_extra" name="test_has_speech_python_fallback" time="0.002" /><testcase classname="tests.test_transcribe_unit_extra" name="test_missing_api_key_raises" time="0.002" /><testcase classname="tests.test_transcribe_unit_extra" name="test_missing_openai_package_raises" time="0.003" /><testcase classname="tests.test_transcribe_unit_extra" name="test_client_cached_and_close" time="0.002" /><testcase classname="tests.test_transcribe_unit_extra" name="test_legacy_whisper_model_env" time="0.003" /><testcase classname="tests.test_transcription_errors" name="test_transcription_errors[missing-HTTPException-file_not_found]" time="0.005" /><testcase classname="tests.test_transcription_errors" name="test_transcription_errors[empty-ValueError-empty_transcription]" time="0.007" /><testcase classname="tests.test_transcription_errors" name="test_close_whisper_client_double" time="0.055" /><testcase classname="tests.test_transcription_flow_extended" name="test_initial_state_event" time="0.004" /><testcase classname="tests.test_transcription_flow_extended" name="test_final_punctuation_preserved" time="0.002" /><testcase classname="tests.test_transcription_flow_extended" name="test_error_emits_network_shaky" time="0.002" /><testcase classname="tests.test_transcription_flow_extended" name="test_events_order_state_then_partial_then_final" time="0.002" /><testcase classname="tests.test_transcription_flow_extended" name="test_voice_enabled_default_true" time="0.003" /><testcase classname="tests.test_transcription_flow_extended" name="test_wake_mode_any_accepts_either" time="0.004" /><testcase classname="tests.test_transcription_flow_extended" name="test_wake_mode_both_requires_both" time="0.002" /><testcase classname="tests.test_transcription_flow_extended" name="test_unknown_control_ignored" time="0.003" /><testcase classname="tests.test_transcription_flow_extended" name="test_has_speech_monkeypatch" time="0.003" /><testcase classname="tests.test_transcription_stream" name="test_ws_transcribe_emits_partial_final" time="0.005" /><testcase classname="tests.test_transcription_stream_extra" name="test_final_uses_last_partial" time="0.002" /><testcase classname="tests.test_transcription_stream_extra" name="test_final_when_no_partials" time="0.002" /><testcase classname="tests.test_transcription_unit" name="test_transcribe_file_success" time="0.005" /><testcase classname="tests.test_transcription_unit" name="test_transcribe_file_error" time="0.006" /><testcase classname="tests.test_tts_orchestrator" name="test_privacy_forces_piper" time="0.003" /><testcase classname="tests.test_tts_orchestrator" name="test_budget_blocks_openai" time="0.003" /><testcase classname="tests.test_tv_config" name="test_tv_config_defaults_then_save_and_get" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_tv_config.py:12: in test_tv_config_defaults_then_save_and_get
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_tv_config" name="test_tv_config_validation_rail_and_hhmm" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_tv_config.py:38: in test_tv_config_validation_rail_and_hhmm
    assert res.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_tv_config" name="test_tv_config_is_per_resident_isolated" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_tv_config.py:62: in test_tv_config_is_per_resident_isolated
    assert res.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_upload" name="test_upload_saves_file" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_upload.py:29: in test_upload_saves_file
    assert resp.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.test_user_hash" name="test_anon_user_id_length_and_stability" time="0.002" /><testcase classname="tests.test_user_hash" name="test_anon_user_id_without_auth_returns_local" time="0.001" /><testcase classname="tests.test_user_id_by_ip" name="test_unauthenticated_requests_are_rate_limited_per_ip" time="0.011"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/test_user_id_by_ip.py:34: in test_unauthenticated_requests_are_rate_limited_per_ip
    assert r2.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.test_user_model" name="test_user_crud_cycle" time="0.002" /><testcase classname="tests.test_user_stats" name="test_login_and_me" time="0.047"><failure message="AssertionError: assert 'token' in {'detail': {'code': 'invalid_credentials', 'detail': 'invalid credentials', 'details': {'env': 'dev', 'error_id': '01K46J93GQGX42SPPYTV4FWKAV', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'check username and password', ...}}">tests/test_user_stats.py:68: in test_login_and_me
    assert "token" in data1
E   AssertionError: assert 'token' in {'detail': {'code': 'invalid_credentials', 'detail': 'invalid credentials', 'details': {'env': 'dev', 'error_id': '01K46J93GQGX42SPPYTV4FWKAV', 'req_id': '-', 'status_code': 401, ...}, 'hint': 'check username and password', ...}}</failure></testcase><testcase classname="tests.test_vad" name="test_vad_none_backend" time="0.002" /><testcase classname="tests.test_vad" name="test_vad_webrtc_backend_no_crash" time="0.003" /><testcase classname="tests.test_vector_store_dual_fallback_behavior" name="test_dual_read_fallbacks_to_chroma_when_primary_empty" time="0.005"><failure message="AssertionError: assert [] == ['hello world']&#10;  &#10;  Right contains one more item: 'hello world'&#10;  Use -v to get more diff">tests/test_vector_store_dual_fallback_behavior.py:51: in test_dual_read_fallbacks_to_chroma_when_primary_empty
    assert res == ["hello world"]
E   AssertionError: assert [] == ['hello world']
E     
E     Right contains one more item: 'hello world'
E     Use -v to get more diff</failure></testcase><testcase classname="tests.test_vector_store_fallback" name="test_get_store_falls_back_to_memory" time="0.004" /><testcase classname="tests.test_vector_store_invalidate" name="test_invalidate_cache_clears_entry" time="0.004" /><testcase classname="tests.test_vector_store_logging" name="test_memory_store_logs" time="0.003" /><testcase classname="tests.test_vector_store_logging" name="test_chroma_store_logs" time="0.005" /><testcase classname="tests.test_vector_store_persistence" name="test_vector_store_ttl_eviction" time="0.013" /><testcase classname="tests.test_vector_store_persistence" name="test_vector_store_user_namespace" time="0.003" /><testcase classname="tests.test_vector_store_relevance" name="test_unrelated_query_returns_empty[MemoryVectorStore]" time="0.006" /><testcase classname="tests.test_vector_store_relevance" name="test_unrelated_query_returns_empty[ChromaVectorStore]" time="0.004" /><testcase classname="tests.test_vector_store_selection_and_strict_mode" name="test_unknown_vector_store_defaults_to_chroma_and_records_fallback" time="0.005"><failure message="AssertionError: assert 'NoneType' == 'ChromaVectorStore'&#10;  &#10;  - ChromaVectorStore&#10;  + NoneType">tests/test_vector_store_selection_and_strict_mode.py:26: in test_unknown_vector_store_defaults_to_chroma_and_records_fallback
    assert type(mem_api._store).__name__ == "ChromaVectorStore"
E   AssertionError: assert 'NoneType' == 'ChromaVectorStore'
E     
E     - ChromaVectorStore
E     + NoneType</failure></testcase><testcase classname="tests.test_vector_store_selection_and_strict_mode" name="test_qdrant_missing_dep_falls_back_nonprod" time="0.003"><failure message="AssertionError: assert 'NoneType' == 'MemoryVectorStore'&#10;  &#10;  - MemoryVectorStore&#10;  + NoneType">tests/test_vector_store_selection_and_strict_mode.py:39: in test_qdrant_missing_dep_falls_back_nonprod
    assert type(mem_api._store).__name__ == "MemoryVectorStore"
E   AssertionError: assert 'NoneType' == 'MemoryVectorStore'
E     
E     - MemoryVectorStore
E     + NoneType</failure></testcase><testcase classname="tests.test_vector_store_selection_and_strict_mode" name="test_strict_mode_raises_on_init_error" time="0.004"><failure message="Failed: DID NOT RAISE &lt;class 'Exception'&gt;">tests/test_vector_store_selection_and_strict_mode.py:50: in test_strict_mode_raises_on_init_error
    with pytest.raises(Exception):
         ^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE &lt;class 'Exception'&gt;</failure></testcase><testcase classname="tests.test_vector_store_selection_and_strict_mode" name="test_reload_store_applies_env_changes" time="0.003"><failure message="AssertionError: assert 'NoneType' == 'MemoryVectorStore'&#10;  &#10;  - MemoryVectorStore&#10;  + NoneType">tests/test_vector_store_selection_and_strict_mode.py:59: in test_reload_store_applies_env_changes
    assert type(mem_api._store).__name__ == "MemoryVectorStore"
E   AssertionError: assert 'NoneType' == 'MemoryVectorStore'
E     
E     - MemoryVectorStore
E     + NoneType</failure></testcase><testcase classname="tests.test_vector_store_selection_and_strict_mode" name="test_preflight_accepts_dual_and_cloud" time="0.003" /><testcase classname="tests.test_vector_store_strict_mode" name="test_strict_vector_store_enforced" time="0.008" /><testcase classname="tests.test_vector_store_threshold" name="test_cache_miss_high_threshold" time="0.004" /><testcase classname="tests.test_vector_store_threshold" name="test_cache_hit_low_threshold" time="0.002" /><testcase classname="tests.test_vector_store_threshold" name="test_threshold_out_of_range" time="0.002" /><testcase classname="tests.test_vision_quota_concurrency" name="test_vision_quota_concurrency" time="0.003" /><testcase classname="tests.test_voice_ws_gating" name="test_voice_disabled" time="0.002" /><testcase classname="tests.test_voice_ws_gating" name="test_ptt_gating" time="0.002" /><testcase classname="tests.test_voice_ws_gating" name="test_wake_gating" time="0.002" /><testcase classname="tests.test_voice_ws_gating" name="test_llm_token_and_final_punctuation" time="0.002" /><testcase classname="tests.test_worker_dedup" name="test_worker_dedup" time="0.211" /><testcase classname="tests.test_ws_auth" name="test_websocket_auth" time="0.040" /><testcase classname="tests.test_ws_stack_is_clean" name="test_ws_health_ok" time="0.096"><failure message="starlette.websockets.WebSocketDisconnect">tests/test_ws_stack_is_clean.py:52: in test_ws_health_ok
    with c.websocket_connect(f"/v1/ws/health?token={_tok()}") as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.test_ws_stack_is_clean" name="test_ws_health_rejects_invalid_token" time="0.097" /><testcase classname="tests.test_ws_stack_is_clean" name="test_ws_health_rejects_expired_token" time="0.096" /><testcase classname="tests.test_ws_stack_is_clean" name="test_ws_dependency_uses_class_based_approach" time="0.002" /><testcase classname="tests.test_ws_stack_is_clean" name="test_ws_state_properly_attached" time="0.002" /><testcase classname="tests.test_ws_topic_acl_and_broadcast_backpressure" name="test_ws_topic_acl_resident_me" time="0.005"><failure message="starlette.websockets.WebSocketDisconnect">tests/test_ws_topic_acl_and_broadcast_backpressure.py:25: in test_ws_topic_acl_resident_me
    with c.websocket_connect(url) as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.test_ws_topic_acl_and_broadcast_backpressure" name="test_ws_broadcast_backpressure_survives_many_clients" time="0.011"><failure message="assert 404 in (200, 401, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/test_ws_topic_acl_and_broadcast_backpressure.py:55: in test_ws_broadcast_backpressure_survives_many_clients
    assert r2.status_code in (200, 401, 403)
E   assert 404 in (200, 401, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_admin_docs_tvconfig_examples_unit" name="test_admin_tv_config_examples_and_scopes_present_in_docs" time="0.005"><failure message="AssertionError: assert '/v1/admin/tv/config' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...onses': {'200': {'content': {'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': 'Whoami'}}}">tests/unit/test_admin_docs_tvconfig_examples_unit.py:10: in test_admin_tv_config_examples_and_scopes_present_in_docs
    assert "/v1/admin/tv/config" in paths
E   AssertionError: assert '/v1/admin/tv/config' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...onses': {'200': {'content': {'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': 'Whoami'}}}</failure></testcase><testcase classname="tests.unit.test_argon2_unit" name="test_argon2_register_and_login" time="0.010"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_argon2_unit.py:19: in test_argon2_register_and_login
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestWhoamiLockedContract" name="test_whoami_returns_401_when_not_authenticated" time="0.004"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:23: in test_whoami_returns_401_when_not_authenticated
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestWhoamiLockedContract" name="test_whoami_with_valid_jwt_token" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:58: in test_whoami_with_valid_jwt_token
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_always_returns_204" time="0.006"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:80: in test_auth_finish_always_returns_204
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_idempotent_first_call" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:91: in test_auth_finish_idempotent_first_call
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_idempotent_second_call" time="0.006"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:112: in test_auth_finish_idempotent_second_call
    assert response1.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_idempotent_with_invalid_existing_cookies" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:151: in test_auth_finish_idempotent_with_invalid_existing_cookies
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_idempotent_with_different_user_cookies" time="0.006"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:185: in test_auth_finish_idempotent_with_different_user_cookies
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishLockedContract" name="test_auth_finish_get_returns_302" time="0.000"><skipped type="pytest.skip" message="GET route has dependency issues in test environment">/Users/kingal/2025/GesahniV2/tests/unit/test_auth_contract_locked.py:196: GET route has dependency issues in test environment</skipped></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishErrorHandling" name="test_auth_finish_with_csrf_enabled" time="0.006"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:226: in test_auth_finish_with_csrf_enabled
    assert response.status_code == 403  # CSRF error
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_contract_locked.TestAuthFinishErrorHandling" name="test_auth_finish_with_cross_site_intent_required" time="0.005"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_contract_locked.py:240: in test_auth_finish_with_cross_site_intent_required
    assert response.status_code == 401  # Missing intent header
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_endpoints_unit.TestWhoamiEndpoint" name="test_whoami_with_good_access_cookie" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestWhoamiEndpoint" name="test_whoami_with_bad_access_cookie" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestWhoamiEndpoint" name="test_whoami_with_bearer_header" time="0.002" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestWhoamiEndpoint" name="test_whoami_with_no_tokens" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestWhoamiEndpoint" name="test_whoami_with_mixed_auth_sources" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestRefreshEndpoint" name="test_refresh_with_valid_refresh_token" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestRefreshEndpoint" name="test_refresh_with_reused_jti_returns_401" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestRefreshEndpoint" name="test_refresh_concurrent_grace_period" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestRefreshEndpoint" name="test_refresh_with_expired_token" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestRefreshEndpoint" name="test_refresh_token_family_replacement" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestFinishIdempotent" name="test_finish_post_with_valid_cookie_returns_204_no_reset" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestFinishIdempotent" name="test_finish_post_without_valid_cookie" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestFinishIdempotent" name="test_finish_post_idempotent_multiple_calls" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestFinishIdempotent" name="test_finish_post_with_expired_cookie" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestAuthEndpointIntegration" name="test_complete_auth_flow_unit_test" time="0.001" /><testcase classname="tests.unit.test_auth_endpoints_unit.TestAuthEndpointIntegration" name="test_token_lifecycle_edge_cases" time="0.001" /><testcase classname="tests.unit.test_auth_migration" name="test_startup_requires_strong_secret" time="0.001"><failure message="Failed: DID NOT RAISE &lt;class 'RuntimeError'&gt;">tests/unit/test_auth_migration.py:16: in test_startup_requires_strong_secret
    with pytest.raises(RuntimeError) as exc:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE &lt;class 'RuntimeError'&gt;</failure></testcase><testcase classname="tests.unit.test_auth_migration" name="test_cookie_names_canonical_only" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_migration.py:34: in test_cookie_names_canonical_only
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_migration" name="test_jwt_leeway_60s" time="0.001" /><testcase classname="tests.unit.test_auth_more_unit" name="test_login_unknown_hash_returns_401" time="0.029"><failure message="sqlite3.OperationalError: no such table: auth_users">tests/unit/test_auth_more_unit.py:32: in test_login_unknown_hash_returns_401
    db.execute(
E   sqlite3.OperationalError: no such table: auth_users</failure></testcase><testcase classname="tests.unit.test_auth_more_unit" name="test_password_strength_enforced_when_env_set" time="0.024"><failure message="assert 409 == 400&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/unit/test_auth_more_unit.py:56: in test_password_strength_enforced_when_env_set
    assert r.status_code == 400
E   assert 409 == 400
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_more_unit" name="test_refresh_uses_cookie_when_body_missing" time="0.032"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/unit/test_auth_more_unit.py:62: in test_refresh_uses_cookie_when_body_missing
    assert r.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_more_unit" name="test_register_username_taken" time="0.036"><failure message="assert 409 == 400&#10; +  where 409 = &lt;Response [409 Conflict]&gt;.status_code">tests/unit/test_auth_more_unit.py:71: in test_register_username_taken
    assert r.status_code == 400
E   assert 409 == 400
E    +  where 409 = &lt;Response [409 Conflict]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_more_unit" name="test_logout_invalid_token_returns_204" time="0.030" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_record_attempt_success" time="0.002" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_record_attempt_failure" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_throttled_window_expiry" time="0.001"><failure message="KeyError: 'test_user'">tests/unit/test_auth_rate_limiting.py:73: in test_throttled_window_expiry
    count, ts = app.auth._attempts[key]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'test_user'</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_throttled_minimum_wait_time" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_get_throttle_status" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_should_apply_backoff" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_should_hard_lockout" time="0.002" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_clear_rate_limit_data" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingHelpers" name="test_get_rate_limit_stats" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_rate_limiting_user_and_ip" time="0.007"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rate_limiting.py:190: in test_login_rate_limiting_user_and_ip
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_rate_limiting_ip_bypass_prevention" time="0.007"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rate_limiting.py:220: in test_login_rate_limiting_ip_bypass_prevention
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_exponential_backoff" time="0.009"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rate_limiting.py:245: in test_login_exponential_backoff
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_hard_lockout" time="0.006"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rate_limiting.py:277: in test_login_hard_lockout
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_success_clears_rate_limits" time="0.006"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rate_limiting.py:306: in test_login_success_clears_rate_limits
    assert response.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingIntegration" name="test_login_most_restrictive_throttling" time="0.003"><failure message="KeyError: 'user:test_user'">tests/unit/test_auth_rate_limiting.py:339: in test_login_most_restrictive_throttling
    count, ts = app.auth._attempts[user_key]
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'user:test_user'</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingEdgeCases" name="test_concurrent_attempts" time="0.001" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingEdgeCases" name="test_window_boundary_conditions" time="0.001"><failure message="KeyError: 'test_user'">tests/unit/test_auth_rate_limiting.py:385: in test_window_boundary_conditions
    count, ts = app.auth._attempts[key]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'test_user'</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingEdgeCases" name="test_zero_remaining_time_handling" time="0.002"><failure message="KeyError: 'test_user'">tests/unit/test_auth_rate_limiting.py:412: in test_zero_remaining_time_handling
    count, ts = app.auth._attempts[key]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'test_user'</failure></testcase><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingEdgeCases" name="test_malformed_attempt_data" time="0.002" /><testcase classname="tests.unit.test_auth_rate_limiting.TestRateLimitingEdgeCases" name="test_large_attempt_counts" time="0.001"><failure message="AssertionError: assert None is not None&#10; +  where None = _throttled('test_user')">tests/unit/test_auth_rate_limiting.py:443: in test_large_attempt_counts
    assert _throttled(key) is not None
E   AssertionError: assert None is not None
E    +  where None = _throttled('test_user')</failure></testcase><testcase classname="tests.unit.test_auth_refresh_options_unit" name="test_options_refresh_without_cors_headers" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_auth_refresh_options_unit.py:8: in test_options_refresh_without_cors_headers
    response = client.options("/v1/auth/refresh")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_auth_refresh_options_unit" name="test_options_refresh_with_cors_headers" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_auth_refresh_options_unit.py:21: in test_options_refresh_with_cors_headers
    response = client.options("/v1/auth/refresh", headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_auth_refresh_options_unit" name="test_options_refresh_cors_credentials" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_auth_refresh_options_unit.py:40: in test_options_refresh_cors_credentials
    response = client.options("/v1/auth/refresh", headers=headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_auth_rotation_unit" name="test_refresh_rotation_and_reuse_detection" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_rotation_unit.py:21: in test_refresh_rotation_and_reuse_detection
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_token_endpoint_returns_bearer_token" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:18: in test_token_endpoint_returns_bearer_token
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_token_endpoint_accepts_scopes" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:34: in test_token_endpoint_accepts_scopes
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_token_endpoint_can_be_disabled" time="0.003"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:45: in test_token_endpoint_can_be_disabled
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_examples_endpoint_lists_scopes_and_redacted_jwt" time="0.003"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:52: in test_examples_endpoint_lists_scopes_and_redacted_jwt
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_openapi_contains_password_flow" time="0.004"><failure message="AssertionError: assert 'OAuth2' in {}">tests/unit/test_auth_token_endpoint_unit.py:63: in test_openapi_contains_password_flow
    assert "OAuth2" in comps
E   AssertionError: assert 'OAuth2' in {}</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_authorize_docs_lists_defined_scopes" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_auth_token_endpoint_unit.py:71: in test_authorize_docs_lists_defined_scopes
    scopes = schema["components"]["securitySchemes"]["OAuth2"]["flows"]["password"][
             ^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_admin_routes_show_locks_in_docs" time="0.004" /><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_missing_jwt_secret_raises_error" time="0.004"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:96: in test_missing_jwt_secret_raises_error
    assert r.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_auth_token_endpoint_unit" name="test_insecure_jwt_secret_raises_error" time="0.004"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_auth_token_endpoint_unit.py:104: in test_insecure_jwt_secret_raises_error
    assert r.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_bearer_token_verification_and_user_mapping" time="0.007"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/unit/test_bearer_auth_integration.py:72: in test_bearer_token_verification_and_user_mapping
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_csrf_bypass_with_authorization_header" time="0.006"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/unit/test_bearer_auth_integration.py:95: in test_csrf_bypass_with_authorization_header
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_csrf_required_without_authorization_header" time="0.004"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_bearer_auth_integration.py", line 112, in test_csrf_required_without_authorization_header
    |     response = client.post("/test")
    |                ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_bearer_auth_integration.py", line 112, in test_csrf_required_without_authorization_header
    response = client.post("/test")
               ^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_bearer_auth_integration.py:112: in test_csrf_required_without_authorization_header
    response = client.post("/test")
               ^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_cors_authorization_header_allowed" time="0.005" /><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_scope_enforcement_with_jwt_payload" time="0.008"><failure message="assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/unit/test_bearer_auth_integration.py:169: in test_scope_enforcement_with_jwt_payload
    assert response.status_code == 200
E   assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_invalid_bearer_token_rejected" time="0.007" /><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_missing_authorization_header_anonymous" time="0.006" /><testcase classname="tests.unit.test_bearer_auth_integration.TestBearerAuthIntegration" name="test_clerk_token_support" time="0.008" /><testcase classname="tests.unit.test_calendar_docs_examples_unit" name="test_calendar_examples_present_in_openapi" time="0.004"><failure message="AssertionError: assert '/v1/calendar/today' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...onses': {'200': {'content': {'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': 'Whoami'}}}">tests/unit/test_calendar_docs_examples_unit.py:10: in test_calendar_examples_present_in_openapi
    assert "/v1/calendar/today" in paths
E   AssertionError: assert '/v1/calendar/today' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...onses': {'200': {'content': {'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': 'Whoami'}}}</failure></testcase><testcase classname="tests.unit.test_calendar_fake_unit" name="test_provider_basic_local_and_utc_mapping" time="0.002" /><testcase classname="tests.unit.test_calendar_fake_unit" name="test_dst_spring_forward_gap" time="0.001" /><testcase classname="tests.unit.test_calendar_fake_unit" name="test_dst_fall_back_ambiguous_hour" time="0.001" /><testcase classname="tests.unit.test_calendar_fake_unit" name="test_api_calendar_next_uses_fake_provider" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_calendar_fake_unit.py:56: in test_api_calendar_next_uses_fake_provider
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_calendar_fake_unit" name="test_build_event_outputs_expected_keys" time="0.002" /><testcase classname="tests.unit.test_calendar_fake_unit" name="test_ics_parser_local_and_utc" time="0.004" /><testcase classname="tests.unit.test_calendar_fake_unit" name="test_list_next_sorts_by_utc" time="0.002" /><testcase classname="tests.unit.test_clerk_whoami" name="test_whoami_with_clerk_cookie" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_clerk_whoami.py:32: in test_whoami_with_clerk_cookie
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_clerk_whoami" name="test_whoami_with_clerk_header" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_clerk_whoami.py:50: in test_whoami_with_clerk_header
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_clerk_whoami" name="test_whoami_with_invalid_clerk_token" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_clerk_whoami.py:71: in test_whoami_with_invalid_clerk_token
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_clerk_whoami" name="test_whoami_fallback_to_clerk_when_jwt_fails" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_clerk_whoami.py:93: in test_whoami_fallback_to_clerk_when_jwt_fails
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_clerk_whoami" name="test_get_current_user_id_with_clerk" time="0.005"><failure message="AssertionError: assert 'anon' == 'user_clerk_123'&#10;  &#10;  - user_clerk_123&#10;  + anon">tests/unit/test_clerk_whoami.py:136: in test_get_current_user_id_with_clerk
    assert user_id == "user_clerk_123"
E   AssertionError: assert 'anon' == 'user_clerk_123'
E     
E     - user_clerk_123
E     + anon</failure></testcase><testcase classname="tests.unit.test_client_crypto_policy" name="test_crypto_policy_advertised" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_client_crypto_policy.py:9: in test_crypto_policy_advertised
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_config_runtime_unit" name="test_get_config_pytest_flag" time="0.001" /><testcase classname="tests.unit.test_config_runtime_values_unit" name="test_config_parsing_types" time="0.002" /><testcase classname="tests.unit.test_cookie_clear" name="test_clear_csrf_cookie_sets_max_age_zero_and_same_path" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_cookie_config_defaults" time="0.002"><failure message="assert True is False">tests/unit/test_cookie_config.py:37: in test_get_cookie_config_defaults
    assert config["secure"] is False
E   assert True is False</failure></testcase><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_cookie_config_dev_http" time="0.003" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_cookie_config_samesite_none" time="0.004" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_cookie_config_custom_secure" time="0.003" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_cookie_config_custom_samesite" time="0.003" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_is_dev_environment_pytest" time="0.003" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_is_dev_environment_localhost" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_is_dev_environment_127_0_0_1" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_is_dev_environment_production" time="0.004" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_scheme_https" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_scheme_http" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_scheme_fallback" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_token_ttls_defaults" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_get_token_ttls_custom" time="0.005" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_basic" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_auth_cookies" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_refresh_cookie" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_with_domain" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_not_httponly" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_not_secure" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_samesite_none" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_samesite_strict" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfig" name="test_format_cookie_header_custom_path" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfigMatrix" name="test_dev_prod_secure_samesite_matrix" time="0.009"><failure message="AssertionError: Env=PROD, SECURE=0, SAMESITE=lax: expected secure=False, got True&#10;assert True == False">tests/unit/test_cookie_config.py:376: in test_dev_prod_secure_samesite_matrix
    assert config["secure"] == expected_secure, (
E   AssertionError: Env=PROD, SECURE=0, SAMESITE=lax: expected secure=False, got True
E   assert True == False</failure></testcase><testcase classname="tests.unit.test_cookie_config.TestCookieConfigMatrix" name="test_format_cookie_header_domain_behavior" time="0.001" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfigMatrix" name="test_ttl_mapping_for_cookies" time="0.004" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfigIntegration" name="test_cookie_config_consistency" time="0.006" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfigIntegration" name="test_token_ttl_consistency" time="0.002" /><testcase classname="tests.unit.test_cookie_config.TestCookieConfigIntegration" name="test_cookie_header_format_consistency" time="0.001" /><testcase classname="tests.unit.test_cookie_guard" name="test_no_raw_set_cookie_outside_cookies_module" time="0.078"><failure message="Failed: Found 2 raw .set_cookie( calls outside allowed files:&#10;Allowed files: app/cookie_config.py, tests/unit/test_cookie_guard.py, app/cookies.py&#10;&#10;Violations:&#10;app/csrf.py:74: response.set_cookie(&#10;app/integrations/google/routes.py:158: http_response.set_cookie(&#10;&#10;All Set-Cookie operations must go through app/cookies.py facade.">tests/unit/test_cookie_guard.py:61: in test_no_raw_set_cookie_outside_cookies_module
    pytest.fail(
E   Failed: Found 2 raw .set_cookie( calls outside allowed files:
E   Allowed files: app/cookie_config.py, tests/unit/test_cookie_guard.py, app/cookies.py
E   
E   Violations:
E   app/csrf.py:74: response.set_cookie(
E   app/integrations/google/routes.py:158: http_response.set_cookie(
E   
E   All Set-Cookie operations must go through app/cookies.py facade.</failure></testcase><testcase classname="tests.unit.test_cookie_guard" name="test_no_raw_set_cookie_in_test_files" time="0.040" /><testcase classname="tests.unit.test_cookie_guard" name="test_cookies_module_exists" time="0.002" /><testcase classname="tests.unit.test_cookie_guard" name="test_test_helpers_exist" time="0.001" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_no_unauthorized_set_cookie_calls" time="0.039"><failure message="AssertionError: Found unauthorized set_cookie() calls:&#10;  Direct set_cookie() call in app/csrf.py:74:                response.set_cookie(&#10;  Direct set_cookie() call in app/integrations/google/routes.py:158:    http_response.set_cookie(&#10;assert 2 == 0&#10; +  where 2 = len(['Direct set_cookie() call in app/csrf.py:74:                response.set_cookie(', 'Direct set_cookie() call in app/integrations/google/routes.py:158:    http_response.set_cookie('])">tests/unit/test_cookie_jwt_compliance_unit.py:90: in test_no_unauthorized_set_cookie_calls
    assert (
E   AssertionError: Found unauthorized set_cookie() calls:
E     Direct set_cookie() call in app/csrf.py:74:                response.set_cookie(
E     Direct set_cookie() call in app/integrations/google/routes.py:158:    http_response.set_cookie(
E   assert 2 == 0
E    +  where 2 = len(['Direct set_cookie() call in app/csrf.py:74:                response.set_cookie(', 'Direct set_cookie() call in app/integrations/google/routes.py:158:    http_response.set_cookie('])</failure></testcase><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_no_unauthorized_set_cookie_headers" time="0.039" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_no_unauthorized_jwt_encode_calls" time="0.041" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_app_token_minting_goes_through_tokens_py" time="0.042" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_idp_token_signing_only_in_allowed_locations" time="0.045" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_auth_py_uses_centralized_functions" time="0.003" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_cookies_py_centralized_facade_exists" time="0.001" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_tokens_py_centralized_facade_exists" time="0.002" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_cookie_config_centralized_configuration_exists" time="0.001" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_no_direct_cookie_manipulation_in_application_code" time="0.228"><failure message="AssertionError: Found unauthorized cookie manipulation:&#10;  Direct cookie manipulation in app/csrf.py:74:                response.set_cookie(&#10;  Direct cookie manipulation in app/integrations/google/routes.py:158:    http_response.set_cookie(&#10;assert 2 == 0&#10; +  where 2 = len(['Direct cookie manipulation in app/csrf.py:74:                response.set_cookie(', 'Direct cookie manipulation in app/integrations/google/routes.py:158:    http_response.set_cookie('])">tests/unit/test_cookie_jwt_compliance_unit.py:277: in test_no_direct_cookie_manipulation_in_application_code
    assert (
E   AssertionError: Found unauthorized cookie manipulation:
E     Direct cookie manipulation in app/csrf.py:74:                response.set_cookie(
E     Direct cookie manipulation in app/integrations/google/routes.py:158:    http_response.set_cookie(
E   assert 2 == 0
E    +  where 2 = len(['Direct cookie manipulation in app/csrf.py:74:                response.set_cookie(', 'Direct cookie manipulation in app/integrations/google/routes.py:158:    http_response.set_cookie('])</failure></testcase><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTCompliance" name="test_proper_separation_of_token_types" time="0.078" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTComplianceIntegration" name="test_compliance_script_runs_successfully" time="0.001" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTComplianceIntegration" name="test_centralized_functions_are_importable" time="0.001" /><testcase classname="tests.unit.test_cookie_jwt_compliance_unit.TestCookieJWTComplianceIntegration" name="test_cookie_config_provides_consistent_settings" time="0.001" /><testcase classname="tests.unit.test_cookies_unit.TestAuthCookies" name="test_set_auth_cookies_basic" time="0.003"><failure message="AssertionError: assert 6 == 3&#10; +  where 6 = &lt;Mock name='mock.headers.append' id='4838442960'&gt;.call_count&#10; +    where &lt;Mock name='mock.headers.append' id='4838442960'&gt; = &lt;Mock name='mock.headers' id='4838445744'&gt;.append&#10; +      where &lt;Mock name='mock.headers' id='4838445744'&gt; = &lt;Mock id='4838452944'&gt;.headers">tests/unit/test_cookies_unit.py:61: in test_set_auth_cookies_basic
    assert response.headers.append.call_count == 3  # access, refresh, session
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: assert 6 == 3
E    +  where 6 = &lt;Mock name='mock.headers.append' id='4838442960'&gt;.call_count
E    +    where &lt;Mock name='mock.headers.append' id='4838442960'&gt; = &lt;Mock name='mock.headers' id='4838445744'&gt;.append
E    +      where &lt;Mock name='mock.headers' id='4838445744'&gt; = &lt;Mock id='4838452944'&gt;.headers</failure></testcase><testcase classname="tests.unit.test_cookies_unit.TestAuthCookies" name="test_set_auth_cookies_no_refresh" time="0.002"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;Mock name='mock.headers.append' id='4835922320'&gt;.call_count&#10; +    where &lt;Mock name='mock.headers.append' id='4835922320'&gt; = &lt;Mock name='mock.headers' id='4835927600'&gt;.append&#10; +      where &lt;Mock name='mock.headers' id='4835927600'&gt; = &lt;Mock id='4835927360'&gt;.headers">tests/unit/test_cookies_unit.py:115: in test_set_auth_cookies_no_refresh
    assert response.headers.append.call_count == 2
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;Mock name='mock.headers.append' id='4835922320'&gt;.call_count
E    +    where &lt;Mock name='mock.headers.append' id='4835922320'&gt; = &lt;Mock name='mock.headers' id='4835927600'&gt;.append
E    +      where &lt;Mock name='mock.headers' id='4835927600'&gt; = &lt;Mock id='4835927360'&gt;.headers</failure></testcase><testcase classname="tests.unit.test_cookies_unit.TestAuthCookies" name="test_set_auth_cookies_no_session" time="0.002"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;Mock name='mock.headers.append' id='4838639664'&gt;.call_count&#10; +    where &lt;Mock name='mock.headers.append' id='4838639664'&gt; = &lt;Mock name='mock.headers' id='4838641248'&gt;.append&#10; +      where &lt;Mock name='mock.headers' id='4838641248'&gt; = &lt;Mock id='4838640144'&gt;.headers">tests/unit/test_cookies_unit.py:150: in test_set_auth_cookies_no_session
    assert response.headers.append.call_count == 2
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;Mock name='mock.headers.append' id='4838639664'&gt;.call_count
E    +    where &lt;Mock name='mock.headers.append' id='4838639664'&gt; = &lt;Mock name='mock.headers' id='4838641248'&gt;.append
E    +      where &lt;Mock name='mock.headers' id='4838641248'&gt; = &lt;Mock id='4838640144'&gt;.headers</failure></testcase><testcase classname="tests.unit.test_cookies_unit.TestAuthCookies" name="test_clear_auth_cookies" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestOAuthStateCookies" name="test_set_oauth_state_cookies" time="0.003" /><testcase classname="tests.unit.test_cookies_unit.TestOAuthStateCookies" name="test_clear_oauth_state_cookies" time="0.002"><failure message="NameError: name 'session_cookie_name' is not defined">tests/unit/test_cookies_unit.py:266: in test_clear_oauth_state_cookies
    clear_oauth_state_cookies(response, request, provider="g")
app/cookies.py:482: in clear_oauth_state_cookies
    httponly=cookie_name in [state_cookie_name, session_cookie_name],
                                                ^^^^^^^^^^^^^^^^^^^
E   NameError: name 'session_cookie_name' is not defined</failure></testcase><testcase classname="tests.unit.test_cookies_unit.TestCSRFCookies" name="test_set_csrf_cookie" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestCSRFCookies" name="test_set_csrf_cookie_samesite_none" time="0.001" /><testcase classname="tests.unit.test_cookies_unit.TestCSRFCookies" name="test_clear_csrf_cookie" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestDeviceCookies" name="test_set_device_cookie" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestDeviceCookies" name="test_clear_device_cookie" time="0.001" /><testcase classname="tests.unit.test_cookies_unit.TestNamedCookies" name="test_set_named_cookie_basic" time="0.001" /><testcase classname="tests.unit.test_cookies_unit.TestNamedCookies" name="test_set_named_cookie_with_overrides" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestNamedCookies" name="test_clear_named_cookie" time="0.003" /><testcase classname="tests.unit.test_cookies_unit.TestCookieSecurityAttributes" name="test_dev_http_cookies_not_secure" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestCookieSecurityAttributes" name="test_prod_https_cookies_secure" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestCookieNegativeScenarios" name="test_missing_config_defaults_gracefully" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestCookieNegativeScenarios" name="test_invalid_cookie_values" time="0.002" /><testcase classname="tests.unit.test_cookies_unit.TestCookieNegativeScenarios" name="test_empty_cookie_values_on_clear" time="0.002" /><testcase classname="tests.unit.test_cors_boot_line" name="test_cors_logs_once" time="0.095"><failure message="AssertionError: assert None == ['http://localhost:3000']&#10; +  where None = getattr(&lt;starlette.datastructures.State object at 0x1205a9f40&gt;, 'allowed_origins', None)&#10; +    where &lt;starlette.datastructures.State object at 0x1205a9f40&gt; = &lt;fastapi.applications.FastAPI object at 0x120898ec0&gt;.state&#10; +      where &lt;fastapi.applications.FastAPI object at 0x120898ec0&gt; = &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt;.app">tests/unit/test_cors_boot_line.py:23: in test_cors_logs_once
    assert getattr(main.app.state, "allowed_origins", None) == ["http://localhost:3000"]
E   AssertionError: assert None == ['http://localhost:3000']
E    +  where None = getattr(&lt;starlette.datastructures.State object at 0x1205a9f40&gt;, 'allowed_origins', None)
E    +    where &lt;starlette.datastructures.State object at 0x1205a9f40&gt; = &lt;fastapi.applications.FastAPI object at 0x120898ec0&gt;.state
E    +      where &lt;fastapi.applications.FastAPI object at 0x120898ec0&gt; = &lt;module 'app.main' from '/Users/kingal/2025/GesahniV2/app/main.py'&gt;.app</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_allowlist_exactly_localhost_3000" time="0.006"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_configuration_unit.py:21: in test_cors_allowlist_exactly_localhost_3000
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_allow_credentials_yes" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_configuration_unit.py:52: in test_cors_allow_credentials_yes
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_expose_headers_only_required" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_configuration_unit.py:78: in test_cors_expose_headers_only_required
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_preflight_short_circuits" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_configuration_unit.py:100: in test_cors_preflight_short_circuits
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_actual_requests_get_middleware_headers" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_configuration_unit.py:133: in test_cors_actual_requests_get_middleware_headers
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_malicious_origin_rejected" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_configuration_unit.py:148: in test_cors_malicious_origin_rejected
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_multiple_origins_handled" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_configuration_unit.py:166: in test_cors_multiple_origins_handled
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_configuration_unit" name="test_cors_headers_consistency" time="0.008" /><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_preflight_skips_csrf" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_csrf_integration_unit.py:21: in test_cors_csrf_preflight_skips_csrf
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_actual_request_without_csrf_fails" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_csrf_integration_unit.py:54: in test_cors_csrf_actual_request_without_csrf_fails
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_actual_request_with_csrf_succeeds" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_csrf_integration_unit.py:67: in test_cors_csrf_actual_request_with_csrf_succeeds
    assert csrf_response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_credentials_handling" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_csrf_integration_unit.py:91: in test_cors_csrf_credentials_handling
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_expose_headers_only_required" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_csrf_integration_unit.py:117: in test_cors_csrf_expose_headers_only_required
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_disallowed_origin_rejected" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_csrf_integration_unit.py:132: in test_cors_csrf_disallowed_origin_rejected
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_csrf_integration_unit" name="test_cors_csrf_middleware_order" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_csrf_integration_unit.py:163: in test_cors_csrf_middleware_order
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_error_headers_unit" name="test_401_response_has_cors_headers" time="0.004"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_error_headers_unit.py:11: in test_401_response_has_cors_headers
    assert response.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_error_headers_unit" name="test_429_response_has_cors_headers" time="0.002"><skipped type="pytest.skip" message="Rate limiting test requires more complex setup">/Users/kingal/2025/GesahniV2/tests/unit/test_cors_error_headers_unit.py:23: Rate limiting test requires more complex setup</skipped></testcase><testcase classname="tests.unit.test_cors_error_headers_unit" name="test_403_response_has_cors_headers" time="0.004"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_error_headers_unit.py:30: in test_403_response_has_cors_headers
    assert response.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_error_headers_unit" name="test_error_response_without_origin_no_cors_headers" time="0.004"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_error_headers_unit.py:41: in test_error_response_without_origin_no_cors_headers
    assert response.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_error_headers_unit" name="test_error_response_with_disallowed_origin_no_cors_headers" time="0.005"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_error_headers_unit.py:53: in test_error_response_with_disallowed_origin_no_cors_headers
    assert response.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_is_outermost_middleware" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:27: in test_cors_is_outermost_middleware
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_options_requests_bypass_custom_middleware" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:61: in test_options_requests_bypass_custom_middleware
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_non_options_requests_get_rate_limit_headers" time="0.003"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_middleware_unit.py:93: in test_non_options_requests_get_rate_limit_headers
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_headers_are_present_for_all_origins" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:112: in test_cors_headers_are_present_for_all_origins
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_rejects_127_0_0_1_origin" time="0.004"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:130: in test_cors_rejects_127_0_0_1_origin
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_exposes_only_required_headers" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_middleware_unit.py:150: in test_cors_exposes_only_required_headers
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_handles_preflight_requests_correctly" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:168: in test_cors_handles_preflight_requests_correctly
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_middleware_order_is_correct" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:192: in test_middleware_order_is_correct
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_x_request_id_header_is_present" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:215: in test_x_request_id_header_is_present
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_credentials_are_handled_correctly" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:237: in test_cors_credentials_are_handled_correctly
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_credentials_are_enabled_by_default" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_cors_middleware_unit.py:257: in test_cors_credentials_are_enabled_by_default
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_cors_middleware_unit" name="test_cors_max_age_is_set" time="0.003"><failure message="AssertionError: TestClient did not receive any response.">tests/unit/test_cors_middleware_unit.py:267: in test_cors_max_age_is_set
    response = client.options(
.venv/lib/python3.12/site-packages/starlette/testclient.py:502: in options
    return super().options(
.venv/lib/python3.12/site-packages/httpx/_client.py:1082: in options
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:357: in handle_request
    assert response_started, "TestClient did not receive any response."
           ^^^^^^^^^^^^^^^^
E   AssertionError: TestClient did not receive any response.</failure></testcase><testcase classname="tests.unit.test_csrf_bypass_and_cors" name="test_webhook_with_signature_bypasses_csrf" time="0.006" /><testcase classname="tests.unit.test_csrf_bypass_and_cors" name="test_bearer_token_bypasses_csrf" time="0.006" /><testcase classname="tests.unit.test_csrf_bypass_and_cors" name="test_cors_headers_on_404_include_acao" time="0.004"><failure message="AssertionError: assert None == 'http://localhost:3000'&#10; +  where None = get('access-control-allow-origin')&#10; +    where get = Headers({'x-error-code': 'not_found', 'content-length': '244', 'content-type': 'application/json'}).get&#10; +      where Headers({'x-error-code': 'not_found', 'content-length': '244', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers">tests/unit/test_csrf_bypass_and_cors.py:50: in test_cors_headers_on_404_include_acao
    assert r.headers.get("access-control-allow-origin") == "http://localhost:3000"
E   AssertionError: assert None == 'http://localhost:3000'
E    +  where None = get('access-control-allow-origin')
E    +    where get = Headers({'x-error-code': 'not_found', 'content-length': '244', 'content-type': 'application/json'}).get
E    +      where Headers({'x-error-code': 'not_found', 'content-length': '244', 'content-type': 'application/json'}) = &lt;Response [404 Not Found]&gt;.headers</failure></testcase><testcase classname="tests.unit.test_csrf_enforcement" name="test_post_without_cookie_or_header_returns_403" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_enforcement.py", line 23, in test_post_without_cookie_or_header_returns_403
    |     r = c.post("/change")
    |         ^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_enforcement.py", line 23, in test_post_without_cookie_or_header_returns_403
    r = c.post("/change")
        ^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_enforcement.py:23: in test_post_without_cookie_or_header_returns_403
    r = c.post("/change")
        ^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_enforcement" name="test_post_with_cookie_but_missing_header_returns_403" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_enforcement.py", line 30, in test_post_with_cookie_but_missing_header_returns_403
    |     r = c.post("/change")
    |         ^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_enforcement.py", line 30, in test_post_with_cookie_but_missing_header_returns_403
    r = c.post("/change")
        ^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_enforcement.py:30: in test_post_with_cookie_but_missing_header_returns_403
    r = c.post("/change")
        ^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_enforcement" name="test_post_with_matching_cookie_and_header_passes" time="0.004" /><testcase classname="tests.unit.test_csrf_flags_and_enforcement" name="test_get_csrf_sets_cookie_and_returns_token" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_csrf_flags_and_enforcement.py:12: in test_get_csrf_sets_cookie_and_returns_token
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_csrf_flags_and_enforcement" name="test_csrf_cookie_flags_respect_env" time="0.016"><failure message="AssertionError: assert ('SameSite=Lax' in '' or 'SameSite=lax' in '')">tests/unit/test_csrf_flags_and_enforcement.py:26: in test_csrf_cookie_flags_respect_env
    assert "SameSite=Lax" in sc or "SameSite=lax" in sc
E   AssertionError: assert ('SameSite=Lax' in '' or 'SameSite=lax' in '')</failure></testcase><testcase classname="tests.unit.test_csrf_middleware_enforcement" name="test_csrf_enabled_blocks_without_header" time="0.003"><failure message="assert 404 in (400, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_csrf_middleware_enforcement.py:12: in test_csrf_enabled_blocks_without_header
    assert r.status_code in (400, 403)
E   assert 404 in (400, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_csrf_middleware_enforcement" name="test_csrf_allows_with_header_and_cookie" time="0.004"><failure message="assert 404 in (200, 204, 401)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_csrf_middleware_enforcement.py:23: in test_csrf_allows_with_header_and_cookie
    assert r.status_code in (200, 204, 401)  # 204 is correct for successful logout
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in (200, 204, 401)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_exempts_get_requests" time="0.006" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_exempts_head_requests" time="0.006" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_exempts_options_requests" time="0.006" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_blocks_post_without_token" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 88, in test_csrf_blocks_post_without_token
    |     r = c.post("/post")
    |         ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 88, in test_csrf_blocks_post_without_token
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:88: in test_csrf_blocks_post_without_token
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_blocks_put_without_token" time="0.007"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 95, in test_csrf_blocks_put_without_token
    |     r = c.put("/put")
    |         ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1181, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 95, in test_csrf_blocks_put_without_token
    r = c.put("/put")
        ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1181, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:95: in test_csrf_blocks_put_without_token
    r = c.put("/put")
        ^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.12/site-packages/httpx/_client.py:1181: in put
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_blocks_patch_without_token" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 101, in test_csrf_blocks_patch_without_token
    |     r = c.patch("/patch")
    |         ^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1218, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 101, in test_csrf_blocks_patch_without_token
    r = c.patch("/patch")
        ^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1218, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:101: in test_csrf_blocks_patch_without_token
    r = c.patch("/patch")
        ^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.12/site-packages/httpx/_client.py:1218: in patch
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_blocks_delete_without_token" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 107, in test_csrf_blocks_delete_without_token
    |     r = c.delete("/delete")
    |         ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1251, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 107, in test_csrf_blocks_delete_without_token
    r = c.delete("/delete")
        ^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1251, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:107: in test_csrf_blocks_delete_without_token
    r = c.delete("/delete")
        ^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.12/site-packages/httpx/_client.py:1251: in delete
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_token_roundtrip_matching" time="0.005" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_token_mismatch" time="0.006"><failure message="fastapi.exceptions.HTTPException: 400: csrf.invalid">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 124, in test_csrf_token_mismatch
    |     r = c.post("/post", headers={"X-CSRF-Token": "header_token"})
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 204, in dispatch
    |     raise HTTPException(400, detail="csrf.invalid")
    | fastapi.exceptions.HTTPException: 400: csrf.invalid
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 124, in test_csrf_token_mismatch
    r = c.post("/post", headers={"X-CSRF-Token": "header_token"})
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 204, in dispatch
    raise HTTPException(400, detail="csrf.invalid")
fastapi.exceptions.HTTPException: 400: csrf.invalid

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:124: in test_csrf_token_mismatch
    r = c.post("/post", headers={"X-CSRF-Token": "header_token"})
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:204: in dispatch
    raise HTTPException(400, detail="csrf.invalid")
E   fastapi.exceptions.HTTPException: 400: csrf.invalid</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_missing_header_with_cookie" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 132, in test_csrf_missing_header_with_cookie
    |     r = c.post("/post")  # No header
    |         ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 132, in test_csrf_missing_header_with_cookie
    r = c.post("/post")  # No header
        ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:132: in test_csrf_missing_header_with_cookie
    r = c.post("/post")  # No header
        ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_missing_cookie_with_header" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 139, in test_csrf_missing_cookie_with_header
    |     r = c.post("/post", headers={"X-CSRF-Token": "some_token"})  # No cookie
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 139, in test_csrf_missing_cookie_with_header
    r = c.post("/post", headers={"X-CSRF-Token": "some_token"})  # No cookie
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:139: in test_csrf_missing_cookie_with_header
    r = c.post("/post", headers={"X-CSRF-Token": "some_token"})  # No cookie
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_legacy_header_allowed" time="0.008" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_legacy_header_disabled" time="0.006"><failure message="fastapi.exceptions.HTTPException: 400: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 158, in test_csrf_legacy_header_disabled
    |     r = c.post("/post", headers={"X-CSRF": "some_token"})  # Legacy header
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 189, in dispatch
    |     raise HTTPException(400, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 400: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 158, in test_csrf_legacy_header_disabled
    r = c.post("/post", headers={"X-CSRF": "some_token"})  # Legacy header
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 189, in dispatch
    raise HTTPException(400, detail="csrf.missing")
fastapi.exceptions.HTTPException: 400: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:158: in test_csrf_legacy_header_disabled
    r = c.post("/post", headers={"X-CSRF": "some_token"})  # Legacy header
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:189: in dispatch
    raise HTTPException(400, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 400: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_cross_site_validation" time="0.008"><failure message="fastapi.exceptions.HTTPException: 400: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 170, in test_csrf_cross_site_validation
    |     r = c.post("/post")
    |         ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 163, in dispatch
    |     raise HTTPException(400, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 400: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 170, in test_csrf_cross_site_validation
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 163, in dispatch
    raise HTTPException(400, detail="csrf.missing")
fastapi.exceptions.HTTPException: 400: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:170: in test_csrf_cross_site_validation
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:163: in dispatch
    raise HTTPException(400, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 400: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_same_site_validation" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 190, in test_csrf_same_site_validation
    |     r = c.post("/post")
    |         ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 190, in test_csrf_same_site_validation
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:190: in test_csrf_same_site_validation
    r = c.post("/post")
        ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_bypass_oauth_callback" time="0.006" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_bypass_bearer_token" time="0.006" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_disabled_globally" time="0.005" /><testcase classname="tests.unit.test_csrf_unit" name="test_get_csrf_token" time="0.002" /><testcase classname="tests.unit.test_csrf_unit" name="test_extract_csrf_header_prefers_new_header" time="0.003" /><testcase classname="tests.unit.test_csrf_unit" name="test_extract_csrf_header_fallback_to_legacy" time="0.002" /><testcase classname="tests.unit.test_csrf_unit" name="test_extract_csrf_header_no_token" time="0.001" /><testcase classname="tests.unit.test_csrf_unit" name="test_extract_csrf_header_legacy_disabled" time="0.001" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_concurrent_requests" time="0.034" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_malformed_header" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 335, in test_csrf_malformed_header
    |     r = c.post("/post", headers={"X-CSRF-Token": ""})
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 335, in test_csrf_malformed_header
    r = c.post("/post", headers={"X-CSRF-Token": ""})
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:335: in test_csrf_malformed_header
    r = c.post("/post", headers={"X-CSRF-Token": ""})
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[GET-/ping]" time="0.007" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[HEAD-/head]" time="0.007" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[OPTIONS-/options]" time="0.007" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[POST-/post]" time="0.008" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[PUT-/put]" time="0.008" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[PATCH-/patch]" time="0.008" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_with_token[DELETE-/delete]" time="0.007" /><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_without_token[POST-/post]" time="0.007"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    |     response = getattr(c, method.lower())(endpoint)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:393: in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_without_token[PUT-/put]" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    |     response = getattr(c, method.lower())(endpoint)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 583, in put
    |     return super().put(
    |            ^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1181, in put
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 583, in put
    return super().put(
           ^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1181, in put
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:393: in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:583: in put
    return super().put(
.venv/lib/python3.12/site-packages/httpx/_client.py:1181: in put
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_without_token[PATCH-/patch]" time="0.005"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    |     response = getattr(c, method.lower())(endpoint)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 614, in patch
    |     return super().patch(
    |            ^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1218, in patch
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 614, in patch
    return super().patch(
           ^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1218, in patch
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:393: in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:614: in patch
    return super().patch(
.venv/lib/python3.12/site-packages/httpx/_client.py:1218: in patch
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_csrf_unit" name="test_csrf_all_methods_without_token[DELETE-/delete]" time="0.006"><failure message="fastapi.exceptions.HTTPException: 403: csrf.missing">+ Exception Group Traceback (most recent call last):
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    |     response = getattr(c, method.lower())(endpoint)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 641, in delete
    |     return super().delete(
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1251, in delete
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    |     raise HTTPException(403, detail="csrf.missing")
    | fastapi.exceptions.HTTPException: 403: csrf.missing
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/kingal/2025/GesahniV2/tests/unit/test_csrf_unit.py", line 393, in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 641, in delete
    return super().delete(
           ^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1251, in delete
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 291, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 222, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/kingal/2025/GesahniV2/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kingal/2025/GesahniV2/app/csrf.py", line 197, in dispatch
    raise HTTPException(403, detail="csrf.missing")
fastapi.exceptions.HTTPException: 403: csrf.missing

During handling of the above exception, another exception occurred:
tests/unit/test_csrf_unit.py:393: in test_csrf_all_methods_without_token
    response = getattr(c, method.lower())(endpoint)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:641: in delete
    return super().delete(
.venv/lib/python3.12/site-packages/httpx/_client.py:1251: in delete
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/csrf.py:197: in dispatch
    raise HTTPException(403, detail="csrf.missing")
E   fastapi.exceptions.HTTPException: 403: csrf.missing</failure></testcase><testcase classname="tests.unit.test_dependencies_options_unit" name="test_rate_limit_dependency_handles_options" time="0.011" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_verify_token_dependency_handles_options" time="0.008" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_verify_token_strict_dependency_handles_options" time="0.009" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_rate_limit_with_dependency_handles_options" time="0.009" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_scope_rate_limit_dependency_handles_options" time="0.008" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_rate_limit_problem_dependency_handles_options" time="0.010" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_require_nonce_dependency_handles_options" time="0.008" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_require_roles_dependency_handles_options" time="0.010" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_require_user_dependency_handles_options" time="0.010" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_require_scope_dependency_handles_options" time="0.009" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_require_any_scope_dependency_handles_options" time="0.010" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_optional_require_scope_dependency_handles_options" time="0.009" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_optional_require_any_scope_dependency_handles_options" time="0.012" /><testcase classname="tests.unit.test_dependencies_options_unit" name="test_all_dependencies_handle_options_without_headers" time="0.038" /><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_openapi_includes_oauth2_security_scheme" time="0.005" /><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_require_any_scope_allows_when_present" time="0.005"><failure message="AssertionError: assert 401 == 200&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code&#10; +    where &lt;Response [401 Unauthorized]&gt; = get('/any', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidTEiLCJzY29wZSI6ImIifQ.de3t3Z3q1OBivjSXRKwjmEAebitxNNKjxFDYC97OOgw'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x1207e4890&gt;.get">tests/unit/test_deps_scopes_oauth_unit.py:57: in test_require_any_scope_allows_when_present
    assert c.get("/any", headers=h).status_code == 200
E   AssertionError: assert 401 == 200
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code
E    +    where &lt;Response [401 Unauthorized]&gt; = get('/any', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidTEiLCJzY29wZSI6ImIifQ.de3t3Z3q1OBivjSXRKwjmEAebitxNNKjxFDYC97OOgw'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x1207e4890&gt;.get</failure></testcase><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_require_any_scope_blocks_when_missing" time="0.006"><failure message="AssertionError: assert 401 == 403&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code&#10; +    where &lt;Response [401 Unauthorized]&gt; = get('/any', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidTEiLCJzY29wZSI6ImMifQ.yDkKdXj3Doj8ybt_Sdp6_j6oOMZziz7xjg83Nfj5KJM'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x1207e9cd0&gt;.get">tests/unit/test_deps_scopes_oauth_unit.py:70: in test_require_any_scope_blocks_when_missing
    assert c.get("/any", headers=h).status_code == 403
E   AssertionError: assert 401 == 403
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code
E    +    where &lt;Response [401 Unauthorized]&gt; = get('/any', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidTEiLCJzY29wZSI6ImMifQ.yDkKdXj3Doj8ybt_Sdp6_j6oOMZziz7xjg83Nfj5KJM'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x1207e9cd0&gt;.get</failure></testcase><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_optional_require_any_scope_noop_when_env_not_set" time="0.005" /><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_optional_require_scope_enforces_when_enabled" time="0.005"><failure message="assert 200 in (401, 403)&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/unit/test_deps_scopes_oauth_unit.py:99: in test_optional_require_scope_enforces_when_enabled
    assert r0.status_code in (401, 403)
E   assert 200 in (401, 403)
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_docs_security_with_runtime_noop" time="0.005" /><testcase classname="tests.unit.test_deps_scopes_oauth_unit" name="test_oauth2_scopes_mapping_contains_expected_keys" time="0.002" /><testcase classname="tests.unit.test_device_bound_refresh_unit" name="test_refresh_single_use_revokes" time="0.014"><failure message="assert 400 == 200&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/unit/test_device_bound_refresh_unit.py:24: in test_refresh_single_use_revokes
    c, t = _client(monkeypatch)
           ^^^^^^^^^^^^^^^^^^^^
tests/unit/test_device_bound_refresh_unit.py:18: in _client
    assert r.status_code == 200
E   assert 400 == 200
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_docs_visibility_unit" name="test_docs_hidden_in_prod" time="0.101" /><testcase classname="tests.unit.test_docs_visibility_unit" name="test_docs_visible_in_dev_and_persist_auth_and_filter" time="0.100"><failure message="AssertionError: assert 'GesahniV2 API' == 'Granny Mode API'&#10;  &#10;  - Granny Mode API&#10;  + GesahniV2 API">tests/unit/test_docs_visibility_unit.py:63: in test_docs_visible_in_dev_and_persist_auth_and_filter
    assert data.get("info", {}).get("title") == "Granny Mode API"
E   AssertionError: assert 'GesahniV2 API' == 'Granny Mode API'
E     
E     - Granny Mode API
E     + GesahniV2 API</failure></testcase><testcase classname="tests.unit.test_docs_visibility_unit" name="test_openapi_title_and_version_from_app_version_env" time="0.039"><failure message="AssertionError: assert 'GesahniV2 API' == 'Granny Mode API'&#10;  &#10;  - Granny Mode API&#10;  + GesahniV2 API">tests/unit/test_docs_visibility_unit.py:75: in test_openapi_title_and_version_from_app_version_env
    assert data.get("info", {}).get("title") == "Granny Mode API"
E   AssertionError: assert 'GesahniV2 API' == 'Granny Mode API'
E     
E     - Granny Mode API
E     + GesahniV2 API</failure></testcase><testcase classname="tests.unit.test_docs_visibility_unit" name="test_openapi_servers_override_env" time="0.100"><failure message="AssertionError: assert [] == ['http://a.lo...b.local:9001']&#10;  &#10;  Right contains 2 more items, first extra item: 'http://a.local:9000'&#10;  Use -v to get more diff">tests/unit/test_docs_visibility_unit.py:87: in test_openapi_servers_override_env
    assert urls == ["http://a.local:9000", "http://b.local:9001"]
E   AssertionError: assert [] == ['http://a.lo...b.local:9001']
E     
E     Right contains 2 more items, first extra item: 'http://a.local:9000'
E     Use -v to get more diff</failure></testcase><testcase classname="tests.unit.test_docs_visibility_unit" name="test_oauth2_security_scheme_present_with_scopes" time="0.100"><failure message="AssertionError: assert 'OAuth2' in {}">tests/unit/test_docs_visibility_unit.py:97: in test_oauth2_security_scheme_present_with_scopes
    assert "OAuth2" in comps
E   AssertionError: assert 'OAuth2' in {}</failure></testcase><testcase classname="tests.unit.test_docs_visibility_unit" name="test_docs_hidden_in_staging_env" time="0.104" /><testcase classname="tests.unit.test_docs_visibility_unit" name="test_docs_visible_with_env_case_and_whitespace" time="0.106" /><testcase classname="tests.unit.test_docs_visibility_unit" name="test_openapi_tags_present" time="0.101" /><testcase classname="tests.unit.test_embeddings_async_stub_unit" name="test_embed_async_stub_when_pytest_flag" time="0.002" /><testcase classname="tests.unit.test_embeddings_stub_unit" name="test_embed_sync_stub_for_memory_store" time="0.001" /><testcase classname="tests.unit.test_embeddings_stub_unit" name="test_benchmark_stub" time="0.002" /><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_env_dev_loading" time="0.032"><failure message="AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'&#10;  &#10;  - http://localhost:3000&#10;  ?                  ^&#10;  + http://localhost:8000&#10;  ?                  ^">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:92: in test_env_dev_loading
    assert os.environ["APP_URL"] == "http://localhost:3000"
E   AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'
E     
E     - http://localhost:3000
E     ?                  ^
E     + http://localhost:8000
E     ?                  ^</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_env_staging_loading" time="0.030"><failure message="AssertionError: assert 'http://localhost:8000' == 'https://staging.gesahni.com'&#10;  &#10;  - https://staging.gesahni.com&#10;  + http://localhost:8000">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:110: in test_env_staging_loading
    assert os.environ["APP_URL"] == "https://staging.gesahni.com"
E   AssertionError: assert 'http://localhost:8000' == 'https://staging.gesahni.com'
E     
E     - https://staging.gesahni.com
E     + http://localhost:8000</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_env_prod_loading" time="0.031"><failure message="AssertionError: assert 'http://localhost:8000' == 'https://app.gesahni.com'&#10;  &#10;  - https://app.gesahni.com&#10;  + http://localhost:8000">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:128: in test_env_prod_loading
    assert os.environ["APP_URL"] == "https://app.gesahni.com"
E   AssertionError: assert 'http://localhost:8000' == 'https://app.gesahni.com'
E     
E     - https://app.gesahni.com
E     + http://localhost:8000</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_env_precedence" time="0.029"><failure message="AssertionError: assert 'http://localhost:8000' == 'http://custom.localhost:3000'&#10;  &#10;  - http://custom.localhost:3000&#10;  ?        -------          ^&#10;  + http://localhost:8000&#10;  ?                  ^">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:153: in test_env_precedence
    assert os.environ["APP_URL"] == "http://custom.localhost:3000"
E   AssertionError: assert 'http://localhost:8000' == 'http://custom.localhost:3000'
E     
E     - http://custom.localhost:3000
E     ?        -------          ^
E     + http://localhost:8000
E     ?                  ^</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_missing_env_files" time="0.029"><failure message="AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'&#10;  &#10;  - http://localhost:3000&#10;  ?                  ^&#10;  + http://localhost:8000&#10;  ?                  ^">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:176: in test_missing_env_files
    assert os.environ["APP_URL"] == "http://localhost:3000"
E   AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'
E     
E     - http://localhost:3000
E     ?                  ^
E     + http://localhost:8000
E     ?                  ^</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_environment_specific_security_settings" time="0.051"><failure message="AssertionError: assert '0' == '1'&#10;  &#10;  - 1&#10;  + 0">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:190: in test_environment_specific_security_settings
    assert os.environ["COOKIE_SECURE"] == "1"
E   AssertionError: assert '0' == '1'
E     
E     - 1
E     + 0</failure></testcase><testcase classname="tests.unit.test_env_configuration.TestEnvironmentConfiguration" name="test_url_configuration_per_environment" time="0.030"><failure message="AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'&#10;  &#10;  - http://localhost:3000&#10;  ?                  ^&#10;  + http://localhost:8000&#10;  ?                  ^">/Users/kingal/2025/GesahniV2/tests/unit/test_env_configuration.py:206: in test_url_configuration_per_environment
    assert os.environ["APP_URL"] == "http://localhost:3000"
E   AssertionError: assert 'http://localhost:8000' == 'http://localhost:3000'
E     
E     - http://localhost:3000
E     ?                  ^
E     + http://localhost:8000
E     ?                  ^</failure></testcase><testcase classname="tests.unit.test_env_utils_alt_example_unit" name="test_load_env_alt_example" time="0.005" /><testcase classname="tests.unit.test_env_utils_no_reload_when_unchanged_unit" name="test_load_env_no_reload_when_unchanged" time="0.006" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_basic_functionality" time="0.005" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_with_example_file" time="0.007" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_precedence" time="0.006"><failure message="AssertionError: assert 'test_value' == 'env_value'&#10;  &#10;  - env_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_simple_unit.py:106: in test_load_env_precedence
    assert os.getenv("TEST_VAR") == "env_value"
E   AssertionError: assert 'test_value' == 'env_value'
E     
E     - env_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_force_reload" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_simple_unit.py:136: in test_load_env_force_reload
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_test_mode" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_simple_unit.py:172: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_caching" time="0.004"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_simple_unit.py:209: in test_load_env_caching
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_missing_files" time="0.003" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_with_comments" time="0.004" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_with_quoted_values" time="0.006"><failure message="AssertionError: assert 'test_value' == 'quoted value'&#10;  &#10;  - quoted value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_simple_unit.py:313: in test_load_env_with_quoted_values
    assert os.getenv("TEST_VAR") == "quoted value"
E   AssertionError: assert 'test_value' == 'quoted value'
E     
E     - quoted value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_environment_specific" time="0.005" /><testcase classname="tests.unit.test_env_utils_simple_unit.TestLoadEnvBasic" name="test_load_env_logging" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files0-existing_env0-expected_values0]" time="0.006"><failure message="AssertionError: Expected FOO=env_value, got existing_value&#10;assert 'existing_value' == 'env_value'&#10;  &#10;  - env_value&#10;  + existing_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected FOO=env_value, got existing_value
E   assert 'existing_value' == 'env_value'
E     
E     - env_value
E     + existing_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files1-existing_env1-expected_values1]" time="0.006"><failure message="AssertionError: Expected BAR=example_value, got env_value&#10;assert 'env_value' == 'example_value'&#10;  &#10;  - example_value&#10;  + env_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected BAR=example_value, got env_value
E   assert 'env_value' == 'example_value'
E     
E     - example_value
E     + env_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files2-existing_env2-expected_values2]" time="0.006"><failure message="AssertionError: Expected BAR=example_value, got env_value&#10;assert 'env_value' == 'example_value'&#10;  &#10;  - example_value&#10;  + env_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected BAR=example_value, got env_value
E   assert 'env_value' == 'example_value'
E     
E     - example_value
E     + env_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files3-existing_env3-expected_values3]" time="0.009" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files4-existing_env4-expected_values4]" time="0.008"><failure message="AssertionError: Expected FOO=env_value, got existing_value&#10;assert 'existing_value' == 'env_value'&#10;  &#10;  - env_value&#10;  + existing_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected FOO=env_value, got existing_value
E   assert 'existing_value' == 'env_value'
E     
E     - env_value
E     + existing_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files5-existing_env5-expected_values5]" time="0.006"><failure message="AssertionError: Expected FOO=, got 1&#10;assert '1' == ''&#10;  &#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected FOO=, got 1
E   assert '1' == ''
E     
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvPrecedence" name="test_load_env_precedence[env_files6-existing_env6-expected_values6]" time="0.006"><failure message="AssertionError: Expected FOO=value, got 1&#10;assert '1' == 'value'&#10;  &#10;  - value&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:129: in test_load_env_precedence
    assert (
E   AssertionError: Expected FOO=value, got 1
E   assert '1' == 'value'
E     
E     - value
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[True-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[False-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[1-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[0-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[true-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[false-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[yes-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[no-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[on-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[off-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[TRUE-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvForceReload" name="test_load_env_force_values[FALSE-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:175: in test_load_env_force_values
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars0-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars1-True]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars2-True]" time="0.007"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars3-False]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars4-False]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars5-True]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars6-True]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars7-True]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars8-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars9-False]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars10-True]" time="0.006"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvTestMode" name="test_load_env_test_mode[test_env_vars11-True]" time="0.005"><failure message="AssertionError: assert 'test_value' == 'initial_value'&#10;  &#10;  - initial_value&#10;  + test_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:241: in test_load_env_test_mode
    assert os.getenv("TEST_VAR") == "initial_value"
E   AssertionError: assert 'test_value' == 'initial_value'
E     
E     - initial_value
E     + test_value</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios0-no_files]" time="0.003" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios1-example_only]" time="0.005"><failure message="AssertionError: assert '1' == 'value'&#10;  &#10;  - value&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:314: in test_load_env_file_scenarios
    assert os.getenv("FOO") == "value"
E   AssertionError: assert '1' == 'value'
E     
E     - value
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios2-env_only]" time="0.004"><failure message="AssertionError: assert '1' == 'value'&#10;  &#10;  - value&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:316: in test_load_env_file_scenarios
    assert os.getenv("FOO") == "value"
E   AssertionError: assert '1' == 'value'
E     
E     - value
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios3-empty_file]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios4-empty_example]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios5-comments_only]" time="0.005" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios6-example_comments_only]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios7-mixed_content]" time="0.005"><failure message="AssertionError: assert '1' == 'value'&#10;  &#10;  - value&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:324: in test_load_env_file_scenarios
    assert os.getenv("FOO") == "value"
E   AssertionError: assert '1' == 'value'
E     
E     - value
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios8-invalid_lines]" time="0.005" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios9-quoted_values]" time="0.006"><failure message="AssertionError: assert '1' == 'quoted value'&#10;  &#10;  - quoted value&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:327: in test_load_env_file_scenarios
    assert os.getenv("FOO") == "quoted value"
E   AssertionError: assert '1' == 'quoted value'
E     
E     - quoted value
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvFileHandling" name="test_load_env_file_scenarios[file_scenarios10-escaped_chars]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes0-False]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes1-True]" time="0.008"><failure message="AssertionError: assert '1' != '1'&#10; +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')&#10; +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:398: in test_load_env_caching
    assert os.getenv("FOO") != initial_foo
E   AssertionError: assert '1' != '1'
E    +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')
E    +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes2-True]" time="0.008"><failure message="AssertionError: assert 'env_value' != 'env_value'&#10; +  where 'env_value' = &lt;function getenv at 0x10f25df80&gt;('BAR')&#10; +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:400: in test_load_env_caching
    assert os.getenv("BAR") != initial_bar
E   AssertionError: assert 'env_value' != 'env_value'
E    +  where 'env_value' = &lt;function getenv at 0x10f25df80&gt;('BAR')
E    +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes3-True]" time="0.007"><failure message="AssertionError: assert '1' != '1'&#10; +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')&#10; +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:398: in test_load_env_caching
    assert os.getenv("FOO") != initial_foo
E   AssertionError: assert '1' != '1'
E    +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')
E    +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes4-True]" time="0.006"><failure message="AssertionError: assert '1' != '1'&#10; +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')&#10; +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:398: in test_load_env_caching
    assert os.getenv("FOO") != initial_foo
E   AssertionError: assert '1' != '1'
E    +  where '1' = &lt;function getenv at 0x10f25df80&gt;('FOO')
E    +    where &lt;function getenv at 0x10f25df80&gt; = os.getenv</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvCaching" name="test_load_env_caching[file_changes5-True]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvErrorHandling" name="test_load_env_error_handling[permission_denied-skip_file]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvErrorHandling" name="test_load_env_error_handling[encoding_error-skip_file]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvErrorHandling" name="test_load_env_error_handling[corrupted_content-skip_file]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvErrorHandling" name="test_load_env_error_handling[invalid_format-skip_file]" time="0.004"><failure message="Failed: DID NOT RAISE any of (&lt;class 'PermissionError'&gt;, &lt;class 'UnicodeDecodeError'&gt;, &lt;class 'ValueError'&gt;, &lt;class 'OSError'&gt;)">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:456: in test_load_env_error_handling
    with pytest.raises(
E   Failed: DID NOT RAISE any of (&lt;class 'PermissionError'&gt;, &lt;class 'UnicodeDecodeError'&gt;, &lt;class 'ValueError'&gt;, &lt;class 'OSError'&gt;)</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvErrorHandling" name="test_load_env_error_handling[filesystem_error-skip_file]" time="0.004" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvLogging" name="test_load_env_logging[first_load-1]" time="0.006"><failure message="AssertionError: assert 2 == 1&#10; +  where 2 = &lt;MagicMock name='mock.info' id='4840117728'&gt;.call_count&#10; +    where &lt;MagicMock name='mock.info' id='4840117728'&gt; = &lt;MagicMock id='4840126560'&gt;.info">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:518: in test_load_env_logging
    assert mock_logger.info.call_count == expected_log_calls
E   AssertionError: assert 2 == 1
E    +  where 2 = &lt;MagicMock name='mock.info' id='4840117728'&gt;.call_count
E    +    where &lt;MagicMock name='mock.info' id='4840117728'&gt; = &lt;MagicMock id='4840126560'&gt;.info</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvLogging" name="test_load_env_logging[reload_with_changes-2]" time="0.008"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;MagicMock name='mock.info' id='4837772464'&gt;.call_count&#10; +    where &lt;MagicMock name='mock.info' id='4837772464'&gt; = &lt;MagicMock id='4840124736'&gt;.info">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:518: in test_load_env_logging
    assert mock_logger.info.call_count == expected_log_calls
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;MagicMock name='mock.info' id='4837772464'&gt;.call_count
E    +    where &lt;MagicMock name='mock.info' id='4837772464'&gt; = &lt;MagicMock id='4840124736'&gt;.info</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvLogging" name="test_load_env_logging[reload_no_changes-2]" time="0.006"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;MagicMock name='mock.info' id='4839347488'&gt;.call_count&#10; +    where &lt;MagicMock name='mock.info' id='4839347488'&gt; = &lt;MagicMock id='4838763952'&gt;.info">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:518: in test_load_env_logging
    assert mock_logger.info.call_count == expected_log_calls
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;MagicMock name='mock.info' id='4839347488'&gt;.call_count
E    +    where &lt;MagicMock name='mock.info' id='4839347488'&gt; = &lt;MagicMock id='4838763952'&gt;.info</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvLogging" name="test_load_env_logging[force_reload-2]" time="0.006"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;MagicMock name='mock.info' id='4839228096'&gt;.call_count&#10; +    where &lt;MagicMock name='mock.info' id='4839228096'&gt; = &lt;MagicMock id='4839525168'&gt;.info">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:518: in test_load_env_logging
    assert mock_logger.info.call_count == expected_log_calls
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;MagicMock name='mock.info' id='4839228096'&gt;.call_count
E    +    where &lt;MagicMock name='mock.info' id='4839228096'&gt; = &lt;MagicMock id='4839525168'&gt;.info</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvLogging" name="test_load_env_logging[test_mode_reload-2]" time="0.006"><failure message="AssertionError: assert 4 == 2&#10; +  where 4 = &lt;MagicMock name='mock.info' id='4839542272'&gt;.call_count&#10; +    where &lt;MagicMock name='mock.info' id='4839542272'&gt; = &lt;MagicMock id='4839351472'&gt;.info">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_table_driven_unit.py:518: in test_load_env_logging
    assert mock_logger.info.call_count == expected_log_calls
E   AssertionError: assert 4 == 2
E    +  where 4 = &lt;MagicMock name='mock.info' id='4839542272'&gt;.call_count
E    +    where &lt;MagicMock name='mock.info' id='4839542272'&gt; = &lt;MagicMock id='4839351472'&gt;.info</failure></testcase><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvBackCompat" name="test_load_env_back_compat[None-invalidate_new_cache0]" time="0.005" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvBackCompat" name="test_load_env_back_compat[123.456-preserve_new_cache]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvBackCompat" name="test_load_env_back_compat[None-invalidate_new_cache1]" time="0.005" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files0-expected_vars0]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files1-expected_vars1]" time="0.007" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files2-expected_vars2]" time="0.006" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files3-expected_vars3]" time="0.007" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files4-expected_vars4]" time="0.008" /><testcase classname="tests.unit.test_env_utils_table_driven_unit.TestLoadEnvEnvironmentSpecific" name="test_load_env_environment_specific[env_files5-expected_vars5]" time="0.007" /><testcase classname="tests.unit.test_env_utils_unit" name="test_load_env_prefers_real_env" time="0.006"><failure message="AssertionError: assert '1' == 'real'&#10;  &#10;  - real&#10;  + 1">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_unit.py:24: in test_load_env_prefers_real_env
    assert env_utils.os.getenv("FOO") == "real"
E   AssertionError: assert '1' == 'real'
E     
E     - real
E     + 1</failure></testcase><testcase classname="tests.unit.test_env_utils_unit" name="test_load_env_uses_example_when_missing" time="0.006"><failure message="AssertionError: assert 'alt_value' == 'example'&#10;  &#10;  - example&#10;  + alt_value">/Users/kingal/2025/GesahniV2/tests/unit/test_env_utils_unit.py:41: in test_load_env_uses_example_when_missing
    assert env_utils.os.getenv("BAZ") == "example"
E   AssertionError: assert 'alt_value' == 'example'
E     
E     - example
E     + alt_value</failure></testcase><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_routing_decision_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_pick_model_with_policy_override" time="0.002" /><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_pick_model_with_policy_automatic" time="0.002" /><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_validate_model_allowlist" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_should_fallback" time="0.002" /><testcase classname="tests.unit.test_extracted_modules.TestRouterPolicy" name="test_get_fallback_decision" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestAdapters" name="test_llm_request_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestAdapters" name="test_llm_response_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestAdapters" name="test_llm_error_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestAdapters" name="test_call_llm_openai" time="0.003" /><testcase classname="tests.unit.test_extracted_modules.TestAdapters" name="test_call_llm_ollama" time="0.004" /><testcase classname="tests.unit.test_extracted_modules.TestPostCall" name="test_postcall_data_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestPostCall" name="test_postcall_result_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestPostCall" name="test_process_postcall" time="0.004" /><testcase classname="tests.unit.test_extracted_modules.TestPostCall" name="test_process_openai_response" time="0.003" /><testcase classname="tests.unit.test_extracted_modules.TestHealth" name="test_health_check_result_creation" time="0.001" /><testcase classname="tests.unit.test_extracted_modules.TestHealth" name="test_health_check_cache" time="0.003" /><testcase classname="tests.unit.test_extracted_modules.TestHealth" name="test_check_system_health" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestFlag" name="test_flag_creation" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestFlag" name="test_flag_creation_with_type" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestFlag" name="test_flag_env_key_property" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestRegister" name="test_register_flag" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestRegister" name="test_register_flag_default_type" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestRegister" name="test_register_overwrites_existing" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_bool_true_values" time="0.002" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_bool_false_values" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_int" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_float" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_str" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestCoerce" name="test_coerce_unknown_type" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGetValue" name="test_get_value_with_override" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGetValue" name="test_get_value_registered_flag_with_env" time="0.004" /><testcase classname="tests.unit.test_feature_flags.TestGetValue" name="test_get_value_registered_flag_without_env" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestGetValue" name="test_get_value_unregistered_flag" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestGetValue" name="test_get_value_unregistered_flag_no_env" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_registered_flag_bool" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_registered_flag_int" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_registered_flag_float" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_registered_flag_str" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_unregistered_flag" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestGet" name="test_get_unregistered_flag_no_env" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestSetValue" name="test_set_value" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestSetValue" name="test_set_value_overwrites_existing" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestClearValue" name="test_clear_value_existing" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestClearValue" name="test_clear_value_nonexistent" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestListFlags" name="test_list_flags_empty" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestListFlags" name="test_list_flags_with_registered_flags" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestListFlags" name="test_list_flags_with_overrides" time="0.001" /><testcase classname="tests.unit.test_feature_flags.TestListFlags" name="test_list_flags_with_env_values" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestListFlags" name="test_list_flags_sorted_keys" time="0.002" /><testcase classname="tests.unit.test_feature_flags.TestIntegration" name="test_flag_lifecycle" time="0.003" /><testcase classname="tests.unit.test_feature_flags.TestIntegration" name="test_multiple_flags" time="0.002" /><testcase classname="tests.unit.test_feature_flags.TestIntegration" name="test_flag_gates_combination" time="0.001" /><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_success" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:26: in test_google_login_url_success
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_missing_env_vars" time="0.006"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:47: in test_google_login_url_missing_env_vars
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_with_optional_params" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:68: in test_google_login_url_with_optional_params
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_default_next_param" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:85: in test_google_login_url_default_next_param
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_custom_next_param" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:101: in test_google_login_url_custom_next_param
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_login_url.TestGoogleOAuthLoginURL" name="test_google_login_url_state_signature" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_login_url.py:117: in test_google_login_url_state_signature
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_login_url_success" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:49: in test_login_url_success
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_login_url_missing_config" time="0.007"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:78: in test_login_url_missing_config
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_login_url_with_optional_params" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:96: in test_login_url_with_optional_params
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_login_url_with_next_param" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:105: in test_login_url_with_next_param
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_signed_state_generation" time="0.004"><failure message="AssertionError: assert 4 == 3&#10; +  where 4 = len(['1756862137', 'fDOPZJ0c8yH8auuY', 'Od98PMFMiUc', 'e45ea5c7aa41'])">tests/unit/test_google_oauth_unit.py:116: in test_signed_state_generation
    assert len(parts) == 3
E   AssertionError: assert 4 == 3
E    +  where 4 = len(['1756862137', 'fDOPZJ0c8yH8auuY', 'Od98PMFMiUc', 'e45ea5c7aa41'])</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_cookie_configuration" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:140: in test_cookie_configuration
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_google_oauth_unit.TestGoogleOAuthLoginUrl" name="test_logging_on_endpoint_hit" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_google_oauth_unit.py:157: in test_logging_on_endpoint_hit
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_ha_scope_and_limiter_unit" name="test_ha_entities_401_without_token" time="0.075"><failure message="assert 404 == 401&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_ha_scope_and_limiter_unit.py:32: in test_ha_entities_401_without_token
    assert r.status_code == 401
E   assert 404 == 401
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_ha_scope_and_limiter_unit" name="test_ha_entities_403_without_scope" time="0.093"><failure message="assert 404 == 403&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_ha_scope_and_limiter_unit.py:38: in test_ha_entities_403_without_scope
    assert r.status_code == 403
E   assert 404 == 403
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_ha_scope_and_limiter_unit" name="test_ha_entities_429_after_first_call" time="0.075"><failure message="assert 404 in {200, 400, 500}&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_ha_scope_and_limiter_unit.py:45: in test_ha_entities_429_after_first_call
    assert r1.status_code in {200, 400, 500}
E   assert 404 in {200, 400, 500}
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_http_utils_decorator_unit" name="test_log_exceptions_decorator_propagates" time="0.002" /><testcase classname="tests.unit.test_http_utils_fallback_request_method_unit" name="test_json_request_fallback_method" time="0.002" /><testcase classname="tests.unit.test_http_utils_llama_hook_unit" name="test_json_request_uses_llama_httpx" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_success" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_json_decode_error" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_http_errors" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_500_retries_then_success" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_network_error" time="0.004" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_unknown_error" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_import_fallback" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_timeout_default" time="0.003"><failure message="assert 2.0 == 10.0">tests/unit/test_http_utils_unit.py:273: in test_json_request_timeout_default
    assert captured_timeout == 10.0
E   assert 2.0 == 10.0</failure></testcase><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_custom_timeout" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_asyncclient_typeerror_fallback" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_all_retries_exhausted" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_network_error_all_retries_exhausted" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_non_retryable_http_error_all_attempts" time="0.003" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_final_return_statement" time="0.002" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_custom_exception_type" time="0.004" /><testcase classname="tests.unit.test_http_utils_unit" name="test_json_request_context_manager_exception" time="0.002" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_basic[hello there-smalltalk]" time="0.001" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_basic[turn on the lights-control]" time="0.001" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_basic[what did i say yesterday?-recall_story]" time="0.002" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_basic[asdfgh-unknown]" time="0.001" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_thresholding[tell me a joke-0.9]" time="0.001" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_thresholding[do you know a random fact?-0.8]" time="0.002" /><testcase classname="tests.unit.test_intent_detector_unit" name="test_detect_intent_thresholding[say something interesting-0.6]" time="0.001" /><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_missing_jwt_secret_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:19: in test_missing_jwt_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_insecure_jwt_secret_change_me_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:28: in test_insecure_jwt_secret_change_me_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_insecure_jwt_secret_default_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:37: in test_insecure_jwt_secret_default_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_insecure_jwt_secret_placeholder_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:46: in test_insecure_jwt_secret_placeholder_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_insecure_jwt_secret_secret_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:55: in test_insecure_jwt_secret_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_insecure_jwt_secret_key_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:64: in test_insecure_jwt_secret_key_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_secure_jwt_secret_works" time="0.007"><failure message="assert 404 in [200, 401]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:77: in test_secure_jwt_secret_works
    assert response.status_code in [200, 401]
E   assert 404 in [200, 401]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_empty_jwt_secret_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:85: in test_empty_jwt_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_whitespace_jwt_secret_raises_error" time="0.005"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:94: in test_whitespace_jwt_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestJWTSecretSecurity" name="test_case_insensitive_insecure_detection" time="0.007"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:123: in test_case_insensitive_insecure_detection
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestCaregiverAuthSecurity" name="test_missing_care_secret_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:134: in test_missing_care_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestCaregiverAuthSecurity" name="test_insecure_care_secret_raises_error" time="0.006"><failure message="assert 404 == 500&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:141: in test_insecure_care_secret_raises_error
    assert response.status_code == 500
E   assert 404 == 500
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestCaregiverAuthSecurity" name="test_secure_care_secret_works" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:152: in test_secure_care_secret_works
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestHealthCheckSecurity" name="test_health_check_missing_jwt_secret_returns_error" time="0.006"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:164: in test_health_check_missing_jwt_secret_returns_error
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestHealthCheckSecurity" name="test_health_check_insecure_jwt_secret_returns_error" time="0.006"><failure message="assert 404 == 503&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:173: in test_health_check_insecure_jwt_secret_returns_error
    assert response.status_code == 503
E   assert 404 == 503
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_jwt_secret_security.TestHealthCheckSecurity" name="test_health_check_secure_jwt_secret_returns_ok" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_jwt_secret_security.py:183: in test_health_check_secure_jwt_secret_returns_ok
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logging_config_unit" name="test_configure_logging_and_error_buffer" time="0.003" /><testcase classname="tests.unit.test_logging_filters_unit.TestCORSConfigFilter" name="test_cors_config_filter_mutes_in_info_mode" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestCORSConfigFilter" name="test_cors_config_filter_allows_in_debug_mode" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestCORSConfigFilter" name="test_cors_config_filter_allows_other_messages" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestVectorStoreWarningFilter" name="test_vector_store_warning_filter_shows_once" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestVectorStoreWarningFilter" name="test_vector_store_warning_filter_allows_other_warnings" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestVectorStoreWarningFilter" name="test_vector_store_warning_filter_allows_info_level" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestOllamaHealthFilter" name="test_ollama_health_filter_mutes_health_checks" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestOllamaHealthFilter" name="test_ollama_health_filter_allows_other_messages" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestOllamaHealthFilter" name="test_ollama_health_filter_allows_error_level" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestCookieTTLFilter" name="test_cookie_ttl_filter_simplifies_ttl_messages" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestCookieTTLFilter" name="test_cookie_ttl_filter_removes_emojis" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestSecretCheckFilter" name="test_secret_check_filter_condenses_repeated_checks" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestSecretCheckFilter" name="test_secret_check_filter_allows_different_messages" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestHealthCheckFilter" name="test_health_check_filter_mutes_health_paths" time="0.001" /><testcase classname="tests.unit.test_logging_filters_unit.TestHealthCheckFilter" name="test_health_check_filter_allows_other_paths" time="0.001" /><testcase classname="tests.unit.test_logging_formatter_unit" name="test_json_formatter_and_request_id_filter" time="0.001" /><testcase classname="tests.unit.test_logging_formatter_unserializable_meta_unit" name="test_json_formatter_unserializable_meta_fallback" time="0.002" /><testcase classname="tests.unit.test_logging_request_id_filter_integration_unit" name="test_request_id_filter_uses_context_var" time="0.001" /><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_clears_cookies_with_consistent_attributes" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:46: in test_logout_clears_cookies_with_consistent_attributes
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_clears_cookies_in_secure_environment" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:86: in test_logout_clears_cookies_in_secure_environment
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_clears_cookies_in_development_environment" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:113: in test_logout_clears_cookies_in_development_environment
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_handles_cookie_config_failure_gracefully" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:139: in test_logout_handles_cookie_config_failure_gracefully
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_handles_delete_cookie_failure_gracefully" time="0.004"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:160: in test_logout_handles_delete_cookie_failure_gracefully
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_revokes_refresh_tokens_with_session_id" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:178: in test_logout_revokes_refresh_tokens_with_session_id
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_revokes_refresh_tokens_with_authorization_header" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:200: in test_logout_revokes_refresh_tokens_with_authorization_header
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_falls_back_to_anon_when_no_session_id_found" time="0.004"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:216: in test_logout_falls_back_to_anon_when_no_session_id_found
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_handles_token_revocation_failure_gracefully" time="0.004"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:234: in test_logout_handles_token_revocation_failure_gracefully
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_clears_both_access_and_refresh_tokens" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:256: in test_logout_clears_both_access_and_refresh_tokens
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_cookie_clearing.TestLogoutCookieClearing" name="test_logout_uses_custom_refresh_ttl_from_environment" time="0.007"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_cookie_clearing.py:283: in test_logout_uses_custom_refresh_ttl_from_environment
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_returns_204_no_content" time="0.004"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_requirements.py:10: in test_logout_returns_204_no_content
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_deletes_all_three_cookies" time="0.003"><failure message="AssertionError: Missing Set-Cookie header for access_token&#10;assert None is not None">tests/unit/test_logout_requirements.py:38: in test_logout_deletes_all_three_cookies
    assert cookie_header is not None, f"Missing Set-Cookie header for {cookie_name}"
E   AssertionError: Missing Set-Cookie header for access_token
E   assert None is not None</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_uses_same_attributes_as_login" time="0.004"><failure message="AssertionError: assert 'Path=/' in ''">tests/unit/test_logout_requirements.py:61: in test_logout_uses_same_attributes_as_login
    assert "Path=/" in header
E   AssertionError: assert 'Path=/' in ''</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_has_proper_deletion_semantics" time="0.004"><failure message="AssertionError: All cookies should have Max-Age=0 for immediate deletion&#10;assert 'Max-Age=0' in ''">tests/unit/test_logout_requirements.py:87: in test_logout_has_proper_deletion_semantics
    assert (
E   AssertionError: All cookies should have Max-Age=0 for immediate deletion
E   assert 'Max-Age=0' in ''</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_response_is_unambiguous" time="0.004"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_requirements.py:98: in test_logout_response_is_unambiguous
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_logout_requirements" name="test_logout_works_with_existing_cookies" time="0.003"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_logout_requirements.py:130: in test_logout_works_with_existing_cookies
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_short_response" time="0.011" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_long_response" time="0.002" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_low_confidence_indicators" time="0.003" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_acknowledgments" time="0.003" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_punctuation_only" time="0.003" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_profile_short_response" time="0.002" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_profile_long_response" time="0.002" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_profile_low_confidence_indicators" time="0.003" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_memory_with_confidence_score" time="0.003" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_should_write_profile_with_confidence_score" time="0.002" /><testcase classname="tests.unit.test_memory_write_policy.TestMemoryWritePolicy" name="test_empty_response_blocked" time="0.002" /><testcase classname="tests.unit.test_metrics_cache_rate_zero_unit" name="test_cache_hit_rate_zero_division_safe" time="0.001" /><testcase classname="tests.unit.test_metrics_samples_trim_unit" name="test_latency_samples_trim" time="0.002" /><testcase classname="tests.unit.test_metrics_unit" name="test_record_and_snapshot" time="0.002" /><testcase classname="tests.unit.test_metrics_unit" name="test_latency_stats_and_top_skills" time="0.002" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_with_origin_header" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_with_referer_header" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_from_request_url" time="0.002" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_fallback_to_env" time="0.007" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_invalid_path" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestOriginAwareURLs" name="test_build_origin_aware_url_with_query_params" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_valid_path" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_absolute_urls" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_protocol_relative_urls" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_invalid_paths" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_normalize_slashes" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSanitizeRedirectPath" name="test_sanitize_custom_fallback" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSecurityFeatures" name="test_no_hardcoded_localhost_in_urls" time="0.001"><failure message="AssertionError: assert 'localhost' in 'https://app.example.com/login'">tests/unit/test_middleware_redirects.py:117: in test_no_hardcoded_localhost_in_urls
    assert "localhost" in result
E   AssertionError: assert 'localhost' in 'https://app.example.com/login'</failure></testcase><testcase classname="tests.unit.test_middleware_redirects.TestSecurityFeatures" name="test_open_redirect_prevention" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestSecurityFeatures" name="test_relative_path_acceptance" time="0.001" /><testcase classname="tests.unit.test_middleware_redirects.TestEnvironmentConfiguration" name="test_app_url_fallback" time="0.005" /><testcase classname="tests.unit.test_middleware_redirects.TestEnvironmentConfiguration" name="test_environment_variable_priority" time="0.006" /><testcase classname="tests.unit.test_middleware_redirects.TestEnvironmentConfiguration" name="test_origin_header_priority_over_env" time="0.003" /><testcase classname="tests.unit.test_model_params_env_list_unit" name="test_env_list_parsing" time="0.001" /><testcase classname="tests.unit.test_model_params_stop_normalization_unit" name="test_stop_normalization_iterables" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars0-expected0]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars1-expected1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars2-expected2]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars3-expected3]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars4-expected4]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars5-expected5]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars6-expected6]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars7-expected7]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars8-expected8]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars9-expected9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars10-expected10]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars11-expected11]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars12-expected12]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars13-expected13]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars14-expected14]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars15-expected15]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars16-expected16]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars17-expected17]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars18-expected18]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_env_variations[env_vars19-expected19]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_invalid_values[GEN_TEMPERATURE-not_a_number-0.1]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_invalid_values[GEN_TEMPERATURE--0.1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_invalid_values[GEN_TOP_P-invalid-0.9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_invalid_values[GEN_MAX_TOKENS-abc-None]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestBaseDefaults" name="test_base_defaults_invalid_values[GEN_MAX_COMPLETION_TOKENS-xyz-None]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[None-expected_changes0]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides1-expected_changes1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides2-expected_changes2]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides3-expected_changes3]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides4-expected_changes4]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides5-expected_changes5]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides6-expected_changes6]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides7-expected_changes7]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides8-expected_changes8]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides9-expected_changes9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides10-expected_changes10]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides11-expected_changes11]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides12-expected_changes12]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides13-expected_changes13]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides14-expected_changes14]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides15-expected_changes15]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_variations[overrides16-expected_changes16]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[END-expected_output0]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[a,b,c-expected_output1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[a, b , c-expected_output2]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[-expected_output3]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[   -expected_output4]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input5-expected_output5]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input6-expected_output6]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input7-expected_output7]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input8-expected_output8]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input9-expected_output9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input10-expected_output10]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[stop_input11-expected_output11]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[123-None]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[None-None]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestMergeParams" name="test_merge_params_stop_normalization[True-None]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[None-expected_openai_args0]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides1-expected_openai_args1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides2-expected_openai_args2]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides3-expected_openai_args3]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides4-expected_openai_args4]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides5-expected_openai_args5]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides6-expected_openai_args6]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides7-expected_openai_args7]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides8-expected_openai_args8]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides9-expected_openai_args9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides10-expected_openai_args10]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides11-expected_openai_args11]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides12-expected_openai_args12]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides13-expected_openai_args13]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_mapping[overrides14-expected_openai_args14]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOpenAI" name="test_for_openai_never_includes_max_tokens" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[None-expected_ollama_args0]" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides1-expected_ollama_args1]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides2-expected_ollama_args2]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides3-expected_ollama_args3]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides4-expected_ollama_args4]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides5-expected_ollama_args5]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides6-expected_ollama_args6]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides7-expected_ollama_args7]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides8-expected_ollama_args8]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides9-expected_ollama_args9]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides10-expected_ollama_args10]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides11-expected_ollama_args11]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides12-expected_ollama_args12]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides13-expected_ollama_args13]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides14-expected_ollama_args14]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_mapping[overrides15-expected_ollama_args15]" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestForOllama" name="test_for_ollama_preserves_additional_options" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestEdgeCases" name="test_env_float_edge_cases" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestEdgeCases" name="test_env_int_edge_cases" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestEdgeCases" name="test_env_list_edge_cases" time="0.002" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestEdgeCases" name="test_merge_params_with_empty_iterables" time="0.001" /><testcase classname="tests.unit.test_model_params_table_driven_unit.TestEdgeCases" name="test_provider_mapping_with_none_values" time="0.001" /><testcase classname="tests.unit.test_model_params_unit" name="test_merge_and_maps" time="0.001" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_paths[do heavy research on climate change words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words-analysis-50-gpt]" time="0.005" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_paths[please explain-chat-2000-gpt]" time="0.005" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_paths[write code sample-chat-10-gpt]" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_llama_path" time="0.003" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_reasons[do heavy research on climate change words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words words-analysis-50-heavy_length]" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_reasons[please explain-chat-2000-heavy_tokens]" time="0.006" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_reasons[write code sample-chat-10-keyword]" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_gpt_reasons[analyze this data-analysis-10-keyword]" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_llama_unhealthy_fallback" time="0.006" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_circuit_breaker_fallback" time="0.003" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_no_llama_model_configured" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_empty_llama_model_configured" time="0.006" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_environment_ollama_model" time="0.004" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_keyword_detection_case_insensitive" time="0.006" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_heavy_intents" time="0.007" /><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_light_task_default_path" time="0.004"><failure message="AssertionError: assert 'llama3' == 'llama3:latest'&#10;  &#10;  - llama3:latest&#10;  + llama3">tests/unit/test_model_picker_unit.py:192: in test_pick_model_light_task_default_path
    assert model == "llama3:latest"
E   AssertionError: assert 'llama3' == 'llama3:latest'
E     
E     - llama3:latest
E     + llama3</failure></testcase><testcase classname="tests.unit.test_model_picker_unit" name="test_pick_model_environment_variables_override" time="0.009" /><testcase classname="tests.unit.test_music_cache_unit" name="test_recommendations_cache_respects_limit" time="0.006"><failure message="KeyError: 'recommendations'">tests/unit/test_music_cache_unit.py:47: in test_recommendations_cache_respects_limit
    assert len(out1["recommendations"]) == 10
               ^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'recommendations'</failure></testcase><testcase classname="tests.unit.test_music_devices_unit" name="test_devices_returns_empty_on_auth_error" time="0.004"><failure message="KeyError: 'devices'">tests/unit/test_music_devices_unit.py:29: in test_devices_returns_empty_on_auth_error
    assert out["devices"] == []
           ^^^^^^^^^^^^^^
E   KeyError: 'devices'</failure></testcase><testcase classname="tests.unit.test_music_state_defaults_unit" name="test_music_state_default_values" time="0.001" /><testcase classname="tests.unit.test_oauth_logging.TestOAuthLogging" name="test_oauth_login_url_logging" time="0.007"><failure message="AssertionError: Expected 'info' to have been called.">tests/unit/test_oauth_logging.py:29: in test_oauth_login_url_logging
    mock_logger.info.assert_called()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:918: in assert_called
    raise AssertionError(msg)
E   AssertionError: Expected 'info' to have been called.</failure></testcase><testcase classname="tests.unit.test_oauth_logging.TestOAuthLogging" name="test_oauth_callback_success_logging" time="0.002"><failure message="AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'">tests/unit/test_oauth_logging.py:52: in test_oauth_callback_success_logging
    with patch("app.api.google_oauth._verify_signed_state", return_value=True):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'</failure></testcase><testcase classname="tests.unit.test_oauth_logging.TestOAuthLogging" name="test_oauth_callback_failure_logging" time="0.001"><failure message="AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'">tests/unit/test_oauth_logging.py:99: in test_oauth_callback_failure_logging
    with patch("app.api.google_oauth._verify_signed_state", return_value=True):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'</failure></testcase><testcase classname="tests.unit.test_oauth_logging.TestOAuthLogging" name="test_whoami_logging" time="0.005"><failure message="AssertionError: Expected 'info' to have been called.">tests/unit/test_oauth_logging.py:143: in test_whoami_logging
    mock_logger.info.assert_called()
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:918: in assert_called
    raise AssertionError(msg)
E   AssertionError: Expected 'info' to have been called.</failure></testcase><testcase classname="tests.unit.test_oauth_logging.TestOAuthLogging" name="test_http_out_logging" time="0.003"><failure message="AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'">tests/unit/test_oauth_logging.py:165: in test_http_out_logging
    with patch("app.api.google_oauth._verify_signed_state", return_value=True):
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1437: in get_original
    raise AttributeError(
E   AttributeError: &lt;module 'app.api.google_oauth' from '/Users/kingal/2025/GesahniV2/app/api/google_oauth.py'&gt; does not have the attribute '_verify_signed_state'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_reload_env_response_model_present" time="0.004"><failure message="KeyError: '/v1/admin/reload_env'">tests/unit/test_openapi_admin_examples_unit.py:12: in test_admin_reload_env_response_model_present
    op = spec["paths"]["/v1/admin/reload_env"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/admin/reload_env'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_bootstrap_response_model_present" time="0.004"><failure message="KeyError: '/v1/admin/vector_store/bootstrap'">tests/unit/test_openapi_admin_examples_unit.py:22: in test_admin_bootstrap_response_model_present
    op = spec["paths"]["/v1/admin/vector_store/bootstrap"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/admin/vector_store/bootstrap'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_migrate_response_model_present" time="0.003"><failure message="KeyError: '/v1/admin/vector_store/migrate'">tests/unit/test_openapi_admin_examples_unit.py:32: in test_admin_migrate_response_model_present
    op = spec["paths"]["/v1/admin/vector_store/migrate"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/admin/vector_store/migrate'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_flags_response_model_present" time="0.004"><failure message="KeyError: '/v1/admin/flags'">tests/unit/test_openapi_admin_examples_unit.py:42: in test_admin_flags_response_model_present
    op = spec["paths"]["/v1/admin/flags"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/admin/flags'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_components_response_schemas_exist" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_admin_examples_unit.py:52: in test_admin_components_response_schemas_exist
    schemas = spec["components"]["schemas"]
              ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_tags_present" time="0.004" /><testcase classname="tests.unit.test_openapi_admin_examples_unit" name="test_admin_paths_nonempty" time="0.003"><failure message="assert False&#10; +  where False = any(&lt;generator object test_admin_paths_nonempty.&lt;locals&gt;.&lt;genexpr&gt; at 0x118b1cba0&gt;)">tests/unit/test_openapi_admin_examples_unit.py:69: in test_admin_paths_nonempty
    assert any(p.startswith("/v1/admin/") for p in spec["paths"].keys())
E   assert False
E    +  where False = any(&lt;generator object test_admin_paths_nonempty.&lt;locals&gt;.&lt;genexpr&gt; at 0x118b1cba0&gt;)</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_alerts_post_has_example_and_response_model" time="0.004"><failure message="KeyError: '/v1/care/alerts'">tests/unit/test_openapi_care_examples_unit.py:12: in test_care_alerts_post_has_example_and_response_model
    op = spec["paths"]["/v1/care/alerts"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/alerts'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_ack_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/care/alerts/{alert_id}/ack'">tests/unit/test_openapi_care_examples_unit.py:26: in test_care_ack_post_response_model_present
    op = spec["paths"]["/v1/care/alerts/{alert_id}/ack"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/alerts/{alert_id}/ack'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_resolve_post_response_model_present" time="0.003"><failure message="KeyError: '/v1/care/alerts/{alert_id}/resolve'">tests/unit/test_openapi_care_examples_unit.py:36: in test_care_resolve_post_response_model_present
    op = spec["paths"]["/v1/care/alerts/{alert_id}/resolve"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/alerts/{alert_id}/resolve'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_heartbeat_request_example_present" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_care_examples_unit.py:46: in test_care_heartbeat_request_example_present
    comp = spec["components"]["schemas"]["Heartbeat"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_sessions_post_request_example_present" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_care_examples_unit.py:52: in test_care_sessions_post_request_example_present
    comp = spec["components"]["schemas"]["SessionBody"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_sessions_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/care/sessions'">tests/unit/test_openapi_care_examples_unit.py:58: in test_care_sessions_post_response_model_present
    op = spec["paths"]["/v1/care/sessions"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/sessions'</failure></testcase><testcase classname="tests.unit.test_openapi_care_examples_unit" name="test_care_components_alertrecord_exists" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_care_examples_unit.py:68: in test_care_components_alertrecord_exists
    schemas = spec["components"]["schemas"]
              ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_post_request_example_present" time="0.004"><failure message="KeyError: '/v1/care/contacts'">tests/unit/test_openapi_contacts_examples_unit.py:15: in test_contacts_post_request_example_present
    op = spec["paths"]["/v1/care/contacts"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/contacts'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_post_response_model_present" time="0.003"><failure message="KeyError: '/v1/care/contacts'">tests/unit/test_openapi_contacts_examples_unit.py:26: in test_contacts_post_response_model_present
    op = spec["paths"]["/v1/care/contacts"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/contacts'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_patch_response_model_present" time="0.004"><failure message="KeyError: '/v1/care/contacts/{contact_id}'">tests/unit/test_openapi_contacts_examples_unit.py:36: in test_contacts_patch_response_model_present
    op = spec["paths"]["/v1/care/contacts/{contact_id}"]["patch"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/contacts/{contact_id}'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_delete_response_model_present" time="0.003"><failure message="KeyError: '/v1/care/contacts/{contact_id}'">tests/unit/test_openapi_contacts_examples_unit.py:46: in test_contacts_delete_response_model_present
    op = spec["paths"]["/v1/care/contacts/{contact_id}"]["delete"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/care/contacts/{contact_id}'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_tv_call_response_model_present" time="0.004"><failure message="KeyError: '/v1/tv/contacts/call'">tests/unit/test_openapi_contacts_examples_unit.py:56: in test_contacts_tv_call_response_model_present
    op = spec["paths"]["/v1/tv/contacts/call"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/contacts/call'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_request_example_has_quiet_hours_field" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_contacts_examples_unit.py:66: in test_contacts_request_example_has_quiet_hours_field
    comp = spec["components"]["schemas"]["ContactBody"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_contacts_examples_unit" name="test_contacts_response_component_exists" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_contacts_examples_unit.py:73: in test_contacts_response_component_exists
    comps = spec["components"]["schemas"]
            ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_examples_unit" name="test_examples_present_for_post_endpoints" time="0.004"><failure message="AssertionError: Missing examples/models: [('/v1/care/alerts', 'post', 'no op'), ('/v1/music', 'post', 'no op'), ('/v1/vibe', 'post', 'no op'), ('/v1/reminders', 'post', 'no op'), ('/v1/admin/reload_env', 'post', 'no op'), ('/v1/care/contacts', 'post', 'no op')]&#10;assert not [('/v1/care/alerts', 'post', 'no op'), ('/v1/music', 'post', 'no op'), ('/v1/vibe', 'post', 'no op'), ('/v1/reminders', 'post', 'no op'), ('/v1/admin/reload_env', 'post', 'no op'), ('/v1/care/contacts', 'post', 'no op')]">tests/unit/test_openapi_examples_unit.py:59: in test_examples_present_for_post_endpoints
    assert not missing, f"Missing examples/models: {missing}"
E   AssertionError: Missing examples/models: [('/v1/care/alerts', 'post', 'no op'), ('/v1/music', 'post', 'no op'), ('/v1/vibe', 'post', 'no op'), ('/v1/reminders', 'post', 'no op'), ('/v1/admin/reload_env', 'post', 'no op'), ('/v1/care/contacts', 'post', 'no op')]
E   assert not [('/v1/care/alerts', 'post', 'no op'), ('/v1/music', 'post', 'no op'), ('/v1/vibe', 'post', 'no op'), ('/v1/reminders', 'post', 'no op'), ('/v1/admin/reload_env', 'post', 'no op'), ('/v1/care/contacts', 'post', 'no op')]</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_music_post_request_example_present" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_music_examples_unit.py:12: in test_music_post_request_example_present
    comp = spec["components"]["schemas"]["MusicCommand"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_music_post_response_model_present" time="0.003"><failure message="KeyError: '/v1/music'">tests/unit/test_openapi_music_examples_unit.py:18: in test_music_post_response_model_present
    op = spec["paths"]["/v1/music"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/music'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_vibe_post_request_example_present" time="0.005"><failure message="KeyError: 'components'">tests/unit/test_openapi_music_examples_unit.py:28: in test_vibe_post_request_example_present
    comp = spec["components"]["schemas"]["VibeBody"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_vibe_post_response_model_present" time="0.003"><failure message="KeyError: '/v1/vibe'">tests/unit/test_openapi_music_examples_unit.py:34: in test_vibe_post_response_model_present
    op = spec["paths"]["/v1/vibe"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/vibe'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_restore_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/music/restore'">tests/unit/test_openapi_music_examples_unit.py:44: in test_restore_post_response_model_present
    op = spec["paths"]["/v1/music/restore"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/music/restore'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_device_post_request_example_present" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_music_examples_unit.py:54: in test_device_post_request_example_present
    comp = spec["components"]["schemas"]["DeviceBody"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_music_examples_unit" name="test_device_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/music/device'">tests/unit/test_openapi_music_examples_unit.py:60: in test_device_post_response_model_present
    op = spec["paths"]["/v1/music/device"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/music/device'</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_post_request_example_present" time="0.005"><failure message="KeyError: 'components'">tests/unit/test_openapi_reminders_examples_unit.py:12: in test_reminders_post_request_example_present
    comp = spec["components"]["schemas"]["ReminderCreate"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_post_response_model_present" time="0.003"><failure message="KeyError: '/v1/reminders'">tests/unit/test_openapi_reminders_examples_unit.py:18: in test_reminders_post_response_model_present
    op = spec["paths"]["/v1/reminders"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/reminders'</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_accepts_query_or_json_docstring" time="0.004"><failure message="KeyError: '/v1/reminders'">tests/unit/test_openapi_reminders_examples_unit.py:28: in test_reminders_accepts_query_or_json_docstring
    op = spec["paths"]["/v1/reminders"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/reminders'</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_components_okresponse_exists" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_reminders_examples_unit.py:37: in test_reminders_components_okresponse_exists
    assert "OkResponse" in spec["components"]["schemas"]
                           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_get_exists" time="0.004"><failure message="AssertionError: assert '/v1/reminders' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...{'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': ' Legacy Google Oauth Callback Root'}}}">tests/unit/test_openapi_reminders_examples_unit.py:42: in test_reminders_get_exists
    assert "/v1/reminders" in spec["paths"]
E   AssertionError: assert '/v1/reminders' in {'/google/oauth/callback': {'get': {'operationId': '_legacy_google_oauth_callback_root_google_oauth_callback_get', 're...{'application/json': {...}}, 'description': 'Successful Response'}}, 'summary': ' Legacy Google Oauth Callback Root'}}}</failure></testcase><testcase classname="tests.unit.test_openapi_reminders_examples_unit" name="test_reminders_delete_exists" time="0.003"><failure message="KeyError: '/v1/reminders'">tests/unit/test_openapi_reminders_examples_unit.py:48: in test_reminders_delete_exists
    assert "delete" in spec["paths"]["/v1/reminders"]
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/reminders'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_tts_request_example_present" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_tts_ha_examples_unit.py:12: in test_tts_request_example_present
    comp = spec["components"]["schemas"]["TTSRequest"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_tts_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/tts/speak'">tests/unit/test_openapi_tts_ha_examples_unit.py:18: in test_tts_post_response_model_present
    op = spec["paths"]["/v1/tts/speak"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tts/speak'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_ha_service_post_response_model_present" time="0.004"><failure message="KeyError: '/v1/ha/service'">tests/unit/test_openapi_tts_ha_examples_unit.py:28: in test_ha_service_post_response_model_present
    op = spec["paths"]["/v1/ha/service"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/ha/service'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_ha_webhook_post_response_model_present" time="0.005"><failure message="KeyError: '/v1/ha/webhook'">tests/unit/test_openapi_tts_ha_examples_unit.py:38: in test_ha_webhook_post_response_model_present
    op = spec["paths"]["/v1/ha/webhook"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/ha/webhook'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_core_ask_request_example_present" time="0.003"><failure message="KeyError: 'components'">tests/unit/test_openapi_tts_ha_examples_unit.py:48: in test_core_ask_request_example_present
    comp = spec["components"]["schemas"]["AskRequest"]
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_components_ok_and_ack_exist" time="0.004"><failure message="KeyError: 'components'">tests/unit/test_openapi_tts_ha_examples_unit.py:54: in test_components_ok_and_ack_exist
    schemas = spec["components"]["schemas"]
              ^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_openapi_tts_ha_examples_unit" name="test_paths_include_tts_and_ha" time="0.003"><failure message="AssertionError: assert ('/v1/tts/speak' in dict_keys(['/google/oauth/callback']))">tests/unit/test_openapi_tts_ha_examples_unit.py:61: in test_paths_include_tts_and_ha
    assert "/v1/tts/speak" in p and "/v1/ha/service" in p and "/v1/ha/webhook" in p
E   AssertionError: assert ('/v1/tts/speak' in dict_keys(['/google/oauth/callback']))</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_photos_favorite_response_model_present" time="0.003"><failure message="KeyError: '/v1/tv/photos/favorite'">tests/unit/test_openapi_tv_examples_unit.py:12: in test_tv_photos_favorite_response_model_present
    op = spec["paths"]["/v1/tv/photos/favorite"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/photos/favorite'</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_alert_response_model_present" time="0.003"><failure message="KeyError: '/v1/tv/alert'">tests/unit/test_openapi_tv_examples_unit.py:22: in test_tv_alert_response_model_present
    op = spec["paths"]["/v1/tv/alert"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/alert'</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_music_play_response_model_present" time="0.003"><failure message="KeyError: '/v1/tv/music/play'">tests/unit/test_openapi_tv_examples_unit.py:32: in test_tv_music_play_response_model_present
    op = spec["paths"]["/v1/tv/music/play"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/music/play'</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_prefs_response_model_present" time="0.003"><failure message="KeyError: '/v1/tv/prefs'">tests/unit/test_openapi_tv_examples_unit.py:42: in test_tv_prefs_response_model_present
    op = spec["paths"]["/v1/tv/prefs"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/prefs'</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_stage2_response_model_present" time="0.004"><failure message="KeyError: '/v1/tv/stage2'">tests/unit/test_openapi_tv_examples_unit.py:52: in test_tv_stage2_response_model_present
    op = spec["paths"]["/v1/tv/stage2"]["post"]
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: '/v1/tv/stage2'</failure></testcase><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_tags_present" time="0.003" /><testcase classname="tests.unit.test_openapi_tv_examples_unit" name="test_tv_paths_nonempty" time="0.003"><failure message="assert False&#10; +  where False = any(&lt;generator object test_tv_paths_nonempty.&lt;locals&gt;.&lt;genexpr&gt; at 0x118c152f0&gt;)">tests/unit/test_openapi_tv_examples_unit.py:67: in test_tv_paths_nonempty
    assert any(p.startswith("/v1/tv/") for p in spec["paths"].keys())
E   assert False
E    +  where False = any(&lt;generator object test_tv_paths_nonempty.&lt;locals&gt;.&lt;genexpr&gt; at 0x118c152f0&gt;)</failure></testcase><testcase classname="tests.unit.test_ops_rate_limit_problem_unit" name="test_rate_limit_problem_returns_problem_json" time="0.008"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/unit/test_ops_rate_limit_problem_unit.py:21: in test_rate_limit_problem_returns_problem_json
    assert r2.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_otel_disabled_unit" name="test_otel_disabled_env" time="0.001" /><testcase classname="tests.unit.test_otel_exemplar_unit" name="test_observe_with_exemplar_fallbacks" time="0.001" /><testcase classname="tests.unit.test_otel_set_error_unit" name="test_set_error_on_span_stub" time="0.001" /><testcase classname="tests.unit.test_otel_shutdown_unit" name="test_shutdown_tracing_no_sdk" time="0.002" /><testcase classname="tests.unit.test_otel_shutdown_unit" name="test_shutdown_tracing_calls_provider_and_processor" time="0.001" /><testcase classname="tests.unit.test_otel_utils_unit" name="test_start_span_noop_without_otel" time="0.001" /><testcase classname="tests.unit.test_pat_complete.TestPATComplete" name="test_pat_creation_and_hashing" time="0.012" /><testcase classname="tests.unit.test_pat_complete.TestPATComplete" name="test_verify_pat_async" time="0.019" /><testcase classname="tests.unit.test_pat_complete.TestPATComplete" name="test_list_pats_for_user" time="0.018" /><testcase classname="tests.unit.test_pat_complete.TestPATComplete" name="test_revoke_pat" time="0.019" /><testcase classname="tests.unit.test_pat_complete.TestPATComplete" name="test_complete_pat_workflow" time="0.023" /><testcase classname="tests.unit.test_pat_complete" name="test_pat_endpoints_integration" time="0.001" /><testcase classname="tests.unit.test_pat_unit" name="test_pat_verify_scope_and_revoked" time="0.003"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/unit/test_pat_unit.py:34: in test_pat_verify_scope_and_revoked
    token = asyncio.get_event_loop().run_until_complete(_setup())
            ^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_sanitize_collection_name" time="0.001" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_ensure_collection_stub_drops_and_creates" time="0.001" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_ensure_collection_non_stub_get_then_recreate" time="0.001" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_ingest_uses_detected_vector_dim_and_uuid_ids" time="0.004" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_dedup_skips_second_ingest" time="0.005" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_ingest_stub_backend_skips_and_returns_headings" time="0.001" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_dedup_fallback_without_filter_calls_scroll_without_filter" time="0.003" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_ensure_collection_creates_payload_indexes" time="0.001" /><testcase classname="tests.unit.test_qdrant_ingest_unit" name="test_split_markdown_enforces_token_budget" time="0.001" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_success" time="0.004" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_already_used" time="0.005" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_lock_timeout" time="0.606" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_redis_fallback" time="0.006" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_redis_exception" time="0.006" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_concurrent_simulation" time="0.004" /><testcase classname="tests.unit.test_race_condition_fix_unit" name="test_claim_refresh_jti_with_retry_same_jti_concurrent" time="0.004" /><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_whoami_rate_limit_anonymous" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:68: in test_whoami_rate_limit_anonymous
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_refresh_rate_limit_anonymous" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:85: in test_refresh_rate_limit_anonymous
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_window_reset" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:100: in test_rate_limit_window_reset
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_different_ips" time="0.007" /><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_different_paths" time="0.005"><failure message="assert 404 in [200, 401]&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:145: in test_rate_limit_different_paths
    assert response.status_code in [200, 401]  # 401 for auth endpoints without tokens
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 in [200, 401]
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_metrics_recording" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:153: in test_rate_limit_metrics_recording
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_bypass_scopes" time="0.015" /><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_options_preflight" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:188: in test_rate_limit_options_preflight
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_health_metrics_exempt" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:204: in test_rate_limit_health_metrics_exempt
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_retry_after_header" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:220: in test_rate_limit_retry_after_header
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_user_vs_anonymous" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:246: in test_rate_limit_user_vs_anonymous
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_concurrent_requests" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:258: in test_rate_limit_concurrent_requests
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_recovery_after_window" time="0.006"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:280: in test_rate_limit_recovery_after_window
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_pytest_bypass" time="0.008"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:302: in test_rate_limit_pytest_bypass
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthRateLimiting" name="test_rate_limit_configuration_validation" time="0.007"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:311: in test_rate_limit_configuration_validation
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthEndpointRateLimitingIntegration" name="test_login_refresh_rate_limit_sequence" time="0.003"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:339: in test_login_refresh_rate_limit_sequence
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthEndpointRateLimitingIntegration" name="test_rate_limit_with_auth_headers" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:361: in test_rate_limit_with_auth_headers
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_auth.TestAuthEndpointRateLimitingIntegration" name="test_rate_limit_metrics_detailed" time="0.005"><failure message="assert 404 == 429&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_auth.py:387: in test_rate_limit_metrics_detailed
    assert response.status_code == 429
E   assert 404 == 429
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_bypass_and_daily_unit" name="test_bypass_scopes_allows" time="0.017"><failure message="AssertionError: assert 429 == 200&#10; +  where 429 = &lt;Response [429 Too Many Requests]&gt;.status_code&#10; +    where &lt;Response [429 Too Many Requests]&gt; = get('/rl', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidSIsInNjb3BlIjoiYWRtaW4ifQ.aDbqWoetB5JBElyJd6V_Vv420aQmbEJH0_SEU-BAjCE'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x120e42ab0&gt;.get">tests/unit/test_rate_limit_bypass_and_daily_unit.py:32: in test_bypass_scopes_allows
    assert client.get("/rl", headers=h).status_code == 200
E   AssertionError: assert 429 == 200
E    +  where 429 = &lt;Response [429 Too Many Requests]&gt;.status_code
E    +    where &lt;Response [429 Too Many Requests]&gt; = get('/rl', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidSIsInNjb3BlIjoiYWRtaW4ifQ.aDbqWoetB5JBElyJd6V_Vv420aQmbEJH0_SEU-BAjCE'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x120e42ab0&gt;.get</failure></testcase><testcase classname="tests.unit.test_rate_limit_bypass_and_daily_unit" name="test_daily_cap_blocks" time="0.012" /><testcase classname="tests.unit.test_rate_limit_metrics_unit" name="test_metrics_allow_and_block_counters" time="0.009" /><testcase classname="tests.unit.test_rate_limit_overrides_unit" name="test_burst_override_blocks_on_4th" time="0.009"><failure message="AssertionError: assert 429 == 200&#10; +  where 429 = &lt;Response [429 Too Many Requests]&gt;.status_code&#10; +    where &lt;Response [429 Too Many Requests]&gt; = get('/burst3', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidSJ9.NEZwwfytVy0_FzmoHlgM5bpIBIBf08hkUUZCKdkTImQ'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x120fd0b90&gt;.get">tests/unit/test_rate_limit_overrides_unit.py:39: in test_burst_override_blocks_on_4th
    assert client.get("/burst3", headers=h).status_code == 200
E   AssertionError: assert 429 == 200
E    +  where 429 = &lt;Response [429 Too Many Requests]&gt;.status_code
E    +    where &lt;Response [429 Too Many Requests]&gt; = get('/burst3', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidSJ9.NEZwwfytVy0_FzmoHlgM5bpIBIBf08hkUUZCKdkTImQ'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x120fd0b90&gt;.get</failure></testcase><testcase classname="tests.unit.test_rate_limit_overrides_unit" name="test_scope_override_applies_only_with_scope" time="0.017" /><testcase classname="tests.unit.test_rate_limit_snapshot_unit" name="test_rate_limit_snapshot_headers_present" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_snapshot_unit.py:9: in test_rate_limit_snapshot_headers_present
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_rate_limit_status_endpoint_unit" name="test_rate_limit_status_endpoint_defaults" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_rate_limit_status_endpoint_unit.py:9: in test_rate_limit_status_endpoint_defaults
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_redaction_invalid_json_unit" name="test_get_redaction_map_invalid_json" time="0.005" /><testcase classname="tests.unit.test_redaction_sanitize_unit" name="test_sanitize_and_map_path" time="0.004" /><testcase classname="tests.unit.test_redaction_unit" name="test_redact_pii_and_store" time="0.005" /><testcase classname="tests.unit.test_refresh_delegation_unit" name="test_legacy_refresh_delegates_to_canonical" time="0.028"><failure message="assert 400 == 401&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/unit/test_refresh_delegation_unit.py:25: in test_legacy_refresh_delegates_to_canonical
    assert response1.status_code == 401
E   assert 400 == 401
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_refresh_delegation_unit" name="test_legacy_refresh_logs_deprecation" time="0.014"><failure message="AssertionError: expected call not found.&#10;Expected: print('deprecate route=/v1/refresh')&#10;  Actual: print('  File &quot;/Users/kingal/2025/GesahniV2/app/api/auth.py&quot;, line 2041, in refresh\n    logger.info(&quot;refresh_flow: csrf_failed=true, reason=invalid_csrf&quot;)\n', file=&lt;_io.TextIOWrapper name=&quot;&lt;_io.FileIO name=8 mode='rb+' closefd=True&gt;&quot; mode='r+' encoding='utf-8'&gt;, end='')">tests/unit/test_refresh_delegation_unit.py:50: in test_legacy_refresh_logs_deprecation
    mock_print.assert_called_with("deprecate route=/v1/refresh")
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:949: in assert_called_with
    raise AssertionError(_error_message()) from cause
E   AssertionError: expected call not found.
E   Expected: print('deprecate route=/v1/refresh')
E     Actual: print('  File "/Users/kingal/2025/GesahniV2/app/api/auth.py", line 2041, in refresh\n    logger.info("refresh_flow: csrf_failed=true, reason=invalid_csrf")\n', file=&lt;_io.TextIOWrapper name="&lt;_io.FileIO name=8 mode='rb+' closefd=True&gt;" mode='r+' encoding='utf-8'&gt;, end='')</failure></testcase><testcase classname="tests.unit.test_refresh_delegation_unit" name="test_canonical_refresh_is_primary" time="0.015"><failure message="assert 400 == 401&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/unit/test_refresh_delegation_unit.py:63: in test_canonical_refresh_is_primary
    assert response.status_code == 401  # Expected for invalid token
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 400 == 401
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_refresh_delegation_unit" name="test_legacy_refresh_maintains_compatibility" time="0.016"><failure message="assert 400 == 401&#10; +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code">tests/unit/test_refresh_delegation_unit.py:83: in test_legacy_refresh_maintains_compatibility
    assert response1.status_code == 401
E   assert 400 == 401
E    +  where 400 = &lt;Response [400 Bad Request]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_refresh_logout_flow" name="test_refresh_requires_intent_in_cross_site" time="0.047"><failure message="assert 404 in (400, 401)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_refresh_logout_flow.py:14: in test_refresh_requires_intent_in_cross_site
    assert r.status_code in (400, 401)
E   assert 404 in (400, 401)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_refresh_logout_flow" name="test_logout_clears_cookies" time="0.042"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_refresh_logout_flow.py:28: in test_logout_clears_cookies
    assert r.status_code == 204  # 204 No Content is correct for logout
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_router_import_contract" name="test_router_contracts_import" time="0.003" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_registry_import" time="0.001" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_registry_functionality" time="0.002" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_entrypoint_import" time="0.001" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_entrypoint_without_router" time="0.002" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_entrypoint_with_mock_router" time="0.006" /><testcase classname="tests.unit.test_router_import_contract" name="test_router_init_empty" time="0.001"><failure message="AssertionError: assert 'set_router' not in ['ALLOWED_GPT_MODELS', 'ALLOWED_LLAMA_MODELS', 'ALLOWED_MODELS', 'LLAMA_HEALTHY', 'LLAMA_USER_CB_COOLDOWN', 'LLAMA_USER_CB_THRESHOLD', ...]">tests/unit/test_router_import_contract.py:116: in test_router_init_empty
    assert 'set_router' not in router_attrs
E   AssertionError: assert 'set_router' not in ['ALLOWED_GPT_MODELS', 'ALLOWED_LLAMA_MODELS', 'ALLOWED_MODELS', 'LLAMA_HEALTHY', 'LLAMA_USER_CB_COOLDOWN', 'LLAMA_USER_CB_THRESHOLD', ...]</failure></testcase><testcase classname="tests.unit.test_router_import_contract" name="test_no_circular_imports" time="0.003" /><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_music_routes_gate_by_scope" time="0.009"><failure message="assert 404 in (200, 400)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_router_scope_gates_unit.py:29: in test_music_routes_gate_by_scope
    assert r1.status_code in (200, 400)
E   assert 404 in (200, 400)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_admin_routes_gate_by_scope" time="0.005"><failure message="assert 404 in (401, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_router_scope_gates_unit.py:38: in test_admin_routes_gate_by_scope
    assert r_forbidden.status_code in (401, 403)
E   assert 404 in (401, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_ha_routes_gate_by_care_scopes" time="0.004"><failure message="assert 404 in (401, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_router_scope_gates_unit.py:50: in test_ha_routes_gate_by_care_scopes
    assert r_no.status_code in (401, 403)
E   assert 404 in (401, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_caregiver_router_requires_caregiver_scope" time="0.007" /><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_docs_shows_locks_for_music_and_admin" time="0.004"><failure message="assert False">tests/unit/test_router_scope_gates_unit.py:82: in test_docs_shows_locks_for_music_and_admin
    assert found_admin
E   assert False</failure></testcase><testcase classname="tests.unit.test_router_scope_gates_unit" name="test_docs_schemes_include_all_scopes" time="0.005"><failure message="KeyError: 'components'">tests/unit/test_router_scope_gates_unit.py:90: in test_docs_schemes_include_all_scopes
    scopes = schema["components"]["securitySchemes"]["OAuth2"]["flows"]["password"][
             ^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'components'</failure></testcase><testcase classname="tests.unit.test_routes_no_duplicates" name="test_no_duplicate_core_routes" time="0.001"><failure message="AssertionError: duplicate handler for ('GET',) /v1/whoami: []&#10;assert 0 == 1&#10; +  where 0 = len([])">tests/unit/test_routes_no_duplicates.py:26: in test_no_duplicate_core_routes
    assert len(matches) == 1, f"duplicate handler for {methods} {path}: {matches}"
E   AssertionError: duplicate handler for ('GET',) /v1/whoami: []
E   assert 0 == 1
E    +  where 0 = len([])</failure></testcase><testcase classname="tests.unit.test_scope_default_deny_openapi" name="test_privileged_routes_require_scopes_in_openapi" time="0.001" /><testcase classname="tests.unit.test_scope_guards_unit" name="test_scope_guard_denies_without_scope" time="0.011"><failure message="assert 401 == 403&#10; +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code">tests/unit/test_scope_guards_unit.py:35: in test_scope_guard_denies_without_scope
    assert r.status_code == 403
E   assert 401 == 403
E    +  where 401 = &lt;Response [401 Unauthorized]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_all_set" time="0.004"><failure message="KeyError: 'JWT_SECRET'">tests/unit/test_secret_verification_unit.py:33: in test_verify_secrets_on_boot_all_set
    assert results["JWT_SECRET"]["status"] == "SET_SECURE"
           ^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'JWT_SECRET'</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_missing_required" time="0.006" /><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_insecure_defaults" time="0.003"><failure message="KeyError: 'JWT_SECRET'">tests/unit/test_secret_verification_unit.py:67: in test_verify_secrets_on_boot_insecure_defaults
    assert results["JWT_SECRET"]["status"] == "INSECURE_DEFAULT"
           ^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'JWT_SECRET'</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_weak_jwt_secret" time="0.002"><failure message="KeyError: 'JWT_SECRET'">tests/unit/test_secret_verification_unit.py:79: in test_verify_secrets_on_boot_weak_jwt_secret
    assert results["JWT_SECRET"]["status"] == "WEAK_SECRET"
           ^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'JWT_SECRET'</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_invalid_openai_format" time="0.003"><failure message="KeyError: 'JWT_SECRET'">tests/unit/test_secret_verification_unit.py:93: in test_verify_secrets_on_boot_invalid_openai_format
    assert results["JWT_SECRET"]["status"] == "SET_SECURE"
           ^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'JWT_SECRET'</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_get_missing_required_secrets" time="0.006" /><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_get_insecure_secrets" time="0.003"><failure message="AssertionError: assert 'JWT_SECRET' in []">tests/unit/test_secret_verification_unit.py:125: in test_get_insecure_secrets
    assert "JWT_SECRET" in insecure
E   AssertionError: assert 'JWT_SECRET' in []</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_log_secret_summary_all_good" time="0.003"><failure message="AssertionError: assert 'All critical secrets are properly configured' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1211e12b0&gt;.text">tests/unit/test_secret_verification_unit.py:140: in test_log_secret_summary_all_good
    assert "All critical secrets are properly configured" in caplog.text
E   AssertionError: assert 'All critical secrets are properly configured' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x1211e12b0&gt;.text</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_log_secret_summary_missing_required" time="0.012"><failure message="RuntimeError: JWT_SECRET too weak (need &gt;=32 bytes)">tests/unit/test_secret_verification_unit.py:147: in test_log_secret_summary_missing_required
    log_secret_summary()
app/secret_verification.py:289: in log_secret_summary
    raise RuntimeError("JWT_SECRET too weak (need &gt;=32 bytes)")
E   RuntimeError: JWT_SECRET too weak (need &gt;=32 bytes)</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_log_secret_summary_insecure_secrets" time="0.003"><failure message="AssertionError: assert 'Secrets with security issues' in ''&#10; +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x120788fe0&gt;.text">tests/unit/test_secret_verification_unit.py:161: in test_log_secret_summary_insecure_secrets
    assert "Secrets with security issues" in caplog.text
E   AssertionError: assert 'Secrets with security issues' in ''
E    +  where '' = &lt;_pytest.logging.LogCaptureFixture object at 0x120788fe0&gt;.text</failure></testcase><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_critical_secrets_configuration" time="0.001" /><testcase classname="tests.unit.test_secret_verification_unit.TestSecretVerification" name="test_verify_secrets_on_boot_optional_secrets_not_set" time="0.006" /><testcase classname="tests.unit.test_security_additional_unit" name="test_get_rate_limit_defaults_keys" time="0.001" /><testcase classname="tests.unit.test_security_additional_unit" name="test_bucket_rate_limit_counts_and_limit" time="0.001" /><testcase classname="tests.unit.test_security_additional_unit" name="test_bucket_retry_after_non_negative" time="0.001" /><testcase classname="tests.unit.test_security_additional_unit" name="test_get_request_payload_from_header" time="0.001"><failure message="assert (False)&#10; +  where False = isinstance(None, dict)">tests/unit/test_security_additional_unit.py:61: in test_get_request_payload_from_header
    assert isinstance(p, dict) and (p.get("user_id") == "u1")
E   assert (False)
E    +  where False = isinstance(None, dict)</failure></testcase><testcase classname="tests.unit.test_security_additional_unit" name="test_bypass_scopes_env_parsing" time="0.002" /><testcase classname="tests.unit.test_security_additional_unit" name="test_daily_incr_local_counter" time="0.002" /><testcase classname="tests.unit.test_security_additional_unit" name="test_rl_key_format" time="0.001" /><testcase classname="tests.unit.test_security_additional_unit" name="test_require_nonce_disabled_passes" time="0.002" /><testcase classname="tests.unit.test_security_additional_unit" name="test_verify_webhook_missing_secret" time="0.002" /><testcase classname="tests.unit.test_security_additional_unit" name="test_rotate_webhook_secret_writes_file" time="0.003" /><testcase classname="tests.unit.test_security_additional_unit" name="test_middleware_sets_rate_limit_headers_on_healthz" time="0.005"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_security_additional_unit.py:136: in test_middleware_sets_rate_limit_headers_on_healthz
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_security_additional_unit" name="test_rate_limit_backend_status_helper" time="0.002" /><testcase classname="tests.unit.test_security_additional_unit" name="test_rate_limit_http_burst_block_when_limit_one" time="0.008"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/unit/test_security_additional_unit.py:175: in test_rate_limit_http_burst_block_when_limit_one
    assert r2.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_security_additional_unit" name="test_rate_limit_http_long_block_when_limit_one" time="0.008"><failure message="AssertionError: assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code&#10; +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidV9sb25nIn0._RrAW4_2PgrrZqdSKVa6st4d9w_PiKYAfsVG6WQ7gFk'})&#10; +      where get = &lt;starlette.testclient.TestClient object at 0x120e10fe0&gt;.get">tests/unit/test_security_additional_unit.py:188: in test_rate_limit_http_long_block_when_limit_one
    assert c.get("/ping", headers=h).status_code == 429
E   AssertionError: assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code
E    +    where &lt;Response [200 OK]&gt; = get('/ping', headers={'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidV9sb25nIn0._RrAW4_2PgrrZqdSKVa6st4d9w_PiKYAfsVG6WQ7gFk'})
E    +      where get = &lt;starlette.testclient.TestClient object at 0x120e10fe0&gt;.get</failure></testcase><testcase classname="tests.unit.test_security_additional_unit" name="test_scope_rate_limit_no_scope_delegates_to_default" time="0.010" /><testcase classname="tests.unit.test_security_buckets_unit" name="test_bucket_rate_limit_and_retry_after" time="0.001" /><testcase classname="tests.unit.test_security_bypass_and_daily_more_unit" name="test_bypass_scope_global_env" time="0.004" /><testcase classname="tests.unit.test_security_bypass_and_daily_more_unit" name="test_daily_cap_blocks" time="0.013"><failure message="assert 200 == 429&#10; +  where 200 = &lt;Response [200 OK]&gt;.status_code">tests/unit/test_security_bypass_and_daily_more_unit.py:49: in test_daily_cap_blocks
    assert r3.status_code == 429
E   assert 200 == 429
E    +  where 200 = &lt;Response [200 OK]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_security_current_key_unit" name="test_current_key_variants" time="0.001"><failure message="AttributeError: 'NoneType' object has no attribute 'state'">tests/unit/test_security_current_key_unit.py:7: in test_current_key_variants
    assert _current_key(None) == "anon"
           ^^^^^^^^^^^^^^^^^^
app/security.py:772: in _current_key
    uid = getattr(request.state, "user_id", None)
                  ^^^^^^^^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'state'</failure></testcase><testcase classname="tests.unit.test_security_get_request_payload_unit" name="test_get_request_payload_without_secret_decodes_without_verify" time="0.001" /><testcase classname="tests.unit.test_security_headers_unit" name="test_healthz_includes_retry_after_when_limited" time="0.003"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_security_headers_unit.py:12: in test_healthz_includes_retry_after_when_limited
    assert r1.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_security_legacy_apply_rate_limit_unit" name="test_apply_rate_limit_and_pruning" time="0.002"><failure message="assert False">tests/unit/test_security_legacy_apply_rate_limit_unit.py:13: in test_apply_rate_limit_and_pruning
    assert await sec._apply_rate_limit("ip")
E   assert False</failure></testcase><testcase classname="tests.unit.test_security_nonce_unit" name="test_require_nonce_enforced" time="0.002" /><testcase classname="tests.unit.test_security_scope_override_unit" name="test_scope_override_blocks_on_third" time="0.010" /><testcase classname="tests.unit.test_security_unit" name="test_get_rate_limit_snapshot_and_current_key" time="0.001" /><testcase classname="tests.unit.test_security_unit" name="test_verify_token_missing_secret" time="0.002" /><testcase classname="tests.unit.test_security_unit" name="test_verify_token_success" time="0.002" /><testcase classname="tests.unit.test_security_unit" name="test_rate_limit_paths" time="0.002" /><testcase classname="tests.unit.test_security_unit" name="test_require_nonce" time="0.002" /><testcase classname="tests.unit.test_security_webhook_missing_secret_unit" name="test_verify_webhook_missing_secret" time="0.003" /><testcase classname="tests.unit.test_security_ws_unit" name="test_verify_ws_header_and_query" time="0.005"><failure message="AttributeError: 'DummyWS' object has no attribute 'close'">app/security.py:1437: in verify_ws
    payload = jwt_decode(token, jwt_secret, algorithms=["HS256"])
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app/security.py:408: in jwt_decode
    return jwt.decode(token, key, algorithms=algorithms, options=opts, **kwargs)  # type: ignore[arg-type]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:222: in decode
    decoded = self.decode_complete(
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:167: in decode_complete
    self._validate_claims(
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:251: in _validate_claims
    self._validate_required_claims(payload, options)
.venv/lib/python3.12/site-packages/jwt/api_jwt.py:285: in _validate_required_claims
    raise MissingRequiredClaimError(claim)
E   jwt.exceptions.MissingRequiredClaimError: Token is missing the "exp" claim

During handling of the above exception, another exception occurred:
tests/unit/test_security_ws_unit.py:24: in test_verify_ws_header_and_query
    await sec.verify_ws(ws)
app/security.py:1445: in verify_ws
    await websocket.close(
          ^^^^^^^^^^^^^^^
E   AttributeError: 'DummyWS' object has no attribute 'close'</failure></testcase><testcase classname="tests.unit.test_security_ws_unit" name="test_rate_limit_ws" time="0.003"><failure message="fastapi.exceptions.WebSocketException: 1013:">tests/unit/test_security_ws_unit.py:54: in test_rate_limit_ws
    await sec.rate_limit_ws(ws)
app/security.py:1559: in rate_limit_ws
    raise WebSocketException(code=1013)
E   fastapi.exceptions.WebSocketException: 1013:</failure></testcase><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_session_cookie_priority" time="0.004" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_session_cookie_opaque_validation" time="0.005" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_session_cookie_legacy_name" time="0.003" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_x_session_id_header_secondary_priority" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_sid_cookie_fallback" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_user_id_fallback" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_anon_fallback" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_anon_user_id_ignored" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_websocket_session_cookie_priority" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_websocket_session_cookie_opaque_validation" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_websocket_query_param_fallback" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_websocket_priority_over_user_id" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_request_priority_over_websocket" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_exception_handling_session_cookie" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_exception_handling_header" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_exception_handling_cookie" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_exception_handling_websocket" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_none_request_and_websocket" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestResolveSessionId" name="test_empty_string_values" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestGetCurrentSessionDevice" name="test_session_id_uses_centralized_resolution" time="0.003" /><testcase classname="tests.unit.test_session_id_resolution.TestGetCurrentSessionDevice" name="test_device_id_fallback_order" time="0.002" /><testcase classname="tests.unit.test_session_id_resolution.TestGetCurrentSessionDevice" name="test_websocket_device_id" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestGetCurrentSessionDevice" name="test_no_device_id" time="0.001" /><testcase classname="tests.unit.test_session_id_resolution.TestGetCurrentSessionDevice" name="test_exception_handling" time="0.003" /><testcase classname="tests.unit.test_session_id_resolution.TestIntegrationWithAuthEndpoints" name="test_logout_endpoint_uses_centralized_resolution" time="0.005"><failure message="assert 404 == 204&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_session_id_resolution.py:298: in test_logout_endpoint_uses_centralized_resolution
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_init_memory_backend" time="0.005" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_init_redis_backend_available" time="0.007"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:43: in test_init_redis_backend_available
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_init_redis_backend_unavailable" time="0.006"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:52: in test_init_redis_backend_unavailable
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_create_session_memory_backend" time="0.005" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_create_session_redis_backend" time="0.006"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:78: in test_create_session_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_get_session_valid_memory_backend" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_get_session_valid_redis_backend" time="0.006"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:119: in test_get_session_valid_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_get_session_expired_memory_backend" time="0.005" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_get_session_expired_redis_backend" time="0.005"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:151: in test_get_session_expired_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_get_session_nonexistent" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_delete_session_memory_backend" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_delete_session_redis_backend" time="0.007"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:186: in test_delete_session_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_delete_session_nonexistent" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_cleanup_expired_memory_backend" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_cleanup_expired_redis_backend" time="0.006"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:228: in test_cleanup_expired_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_cleanup_expired_standalone_function" time="0.001" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_concurrent_upserts_memory_backend" time="0.006" /><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_concurrent_upserts_redis_backend" time="0.005"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:273: in test_concurrent_upserts_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_corrupt_token_handling_redis_backend" time="0.005"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:303: in test_corrupt_token_handling_redis_backend
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_corrupt_token_handling_redis_exception" time="0.005"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:320: in test_corrupt_token_handling_redis_exception
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionCookieStore" name="test_corrupt_token_handling_redis_delete_exception" time="0.006"><failure message="ModuleNotFoundError: No module named 'redis'">tests/unit/test_session_store_unit.py:335: in test_corrupt_token_handling_redis_delete_exception
    with patch("redis.Redis") as mock_redis_class:
         ^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;frozen importlib._bootstrap&gt;:1387: in _gcd_import
    ???
&lt;frozen importlib._bootstrap&gt;:1360: in _find_and_load
    ???
&lt;frozen importlib._bootstrap&gt;:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'redis'</failure></testcase><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_create_session_metadata" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_update_session" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_update_status" time="0.003" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_append_error" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_get_session" time="0.003" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_get_session_nonexistent" time="0.003" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_list_sessions_all" time="0.004" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_list_sessions_by_status" time="0.005" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_list_sessions_sorted_by_creation" time="1.109" /><testcase classname="tests.unit.test_session_store_unit.TestSessionMetadataStore" name="test_concurrent_session_operations" time="0.029" /><testcase classname="tests.unit.test_session_store_unit.TestGlobalSessionStore" name="test_get_session_store_returns_instance" time="0.001" /><testcase classname="tests.unit.test_session_store_unit.TestGlobalSessionStore" name="test_get_session_store_returns_same_instance" time="0.001" /><testcase classname="tests.unit.test_sessions_shapes_strict" name="test_sessions_shapes_array_only" time="0.046"><failure message="assert 404 in (200, 401)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_sessions_shapes_strict.py:12: in test_sessions_shapes_array_only
    assert r.status_code in (200, 401)
E   assert 404 in (200, 401)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_sessions_shapes_strict" name="test_sessions_paginated_shape" time="0.044"><failure message="assert 404 in (200, 401)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_sessions_shapes_strict.py:24: in test_sessions_paginated_shape
    assert r.status_code in (200, 401)
E   assert 404 in (200, 401)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_non_v1_paths" time="0.003" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_logout_paths_ends_with_logout" time="0.002" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_logout_paths_contains_auth_logout" time="0.004" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_x_logout_header" time="0.003" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_auth_cookie_deletion_access_token" time="0.003" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_auth_cookie_deletion_refresh_token" time="0.003" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_auth_cookie_deletion_session" time="0.003" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_skip_204_status_code" time="0.004" /><testcase classname="tests.unit.test_silent_refresh_skip_conditions" name="test_do_not_skip_normal_v1_path" time="0.003"><failure message="AttributeError: module 'app.middleware' has no attribute 'jwt'">tests/unit/test_silent_refresh_skip_conditions.py:139: in test_do_not_skip_normal_v1_path
    with patch("app.middleware.jwt.decode") as mock_jwt_decode:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:1451: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/pkgutil.py:528: in resolve_name
    result = getattr(result, p)
             ^^^^^^^^^^^^^^^^^^
E   AttributeError: module 'app.middleware' has no attribute 'jwt'</failure></testcase><testcase classname="tests.unit.test_status_config_unit" name="test_config_endpoint_includes_env_defaults" time="0.005"><failure message="assert 404 in (200, 403)&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_status_config_unit.py:9: in test_config_endpoint_includes_env_defaults
    assert r.status_code in (200, 403)
E   assert 404 in (200, 403)
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_status_rate_limit_endpoint_more_unit" name="test_rate_limit_status_contains_prefix_and_windows" time="0.004"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_status_rate_limit_endpoint_more_unit.py:9: in test_rate_limit_status_contains_prefix_and_windows
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_none" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_string" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_bytes" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_integer" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_empty_string" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_special_characters" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestHashUserId" name="test_hash_user_id_unicode" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestUtcNow" name="test_utc_now_returns_datetime" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestUtcNow" name="test_utc_now_has_timezone" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestUtcNow" name="test_utc_now_is_recent" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestUtcNow" name="test_utc_now_is_deterministic_within_test" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestLogRecord" name="test_log_record_creation" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestLogRecord" name="test_log_record_with_all_fields" time="0.002" /><testcase classname="tests.unit.test_telemetry.TestLogRecord" name="test_log_record_optional_fields" time="0.001" /><testcase classname="tests.unit.test_telemetry.TestLogRecordVar" name="test_log_record_var_default" time="0.001"><failure message="AssertionError: assert LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) is None&#10; +  where LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) = &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt;()&#10; +    where &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt; = &lt;ContextVar name='log_record' default=None at 0x112c85b70&gt;.get">tests/unit/test_telemetry.py:276: in test_log_record_var_default
    assert log_record_var.get() is None
E   AssertionError: assert LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) is None
E    +  where LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) = &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt;()
E    +    where &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt; = &lt;ContextVar name='log_record' default=None at 0x112c85b70&gt;.get</failure></testcase><testcase classname="tests.unit.test_telemetry.TestLogRecordVar" name="test_log_record_var_set_get" time="0.001"><failure message="AssertionError: assert LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) is None&#10; +  where LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) = &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt;()&#10; +    where &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt; = &lt;ContextVar name='log_record' default=None at 0x112c85b70&gt;.get">tests/unit/test_telemetry.py:284: in test_log_record_var_set_get
    assert log_record_var.get() is None
E   AssertionError: assert LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) is None
E    +  where LogRecord(req_id='t1', prompt=None, engine_used='tts:piper:piper', response=None, timestamp='2025-09-03T01:15:41.01109...132}, 'explain': {'items': []}}}], tts_engine=None, tts_tier=None, tts_chars=None, tts_minutes=None, tts_cost_usd=None) = &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt;()
E    +    where &lt;built-in method get of _contextvars.ContextVar object at 0x112c85b70&gt; = &lt;ContextVar name='log_record' default=None at 0x112c85b70&gt;.get</failure></testcase><testcase classname="tests.unit.test_token_store_admin_endpoint_unit.TestTokenStoreAdminEndpoint" name="test_admin_token_store_stats_function_direct" time="0.001" /><testcase classname="tests.unit.test_token_store_admin_endpoint_unit.TestTokenStoreAdminEndpoint" name="test_admin_token_store_stats_function_with_mock" time="0.002" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_set_get" time="0.001" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_ttl_expiration" time="1.102" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_exists" time="1.104" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_delete" time="0.001" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_cleanup" time="1.102" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestLocalStorage" name="test_local_storage_thread_safety" time="0.004" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_has_redis_with_redis_available" time="0.009" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_has_redis_with_redis_unavailable" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_has_redis_with_redis_connection_error" time="0.007" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_allow_refresh_redis_fallback" time="0.009" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_is_refresh_allowed_redis_fallback" time="0.010" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_claim_refresh_jti_redis_fallback" time="0.011" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_claim_refresh_jti_with_retry_redis_fallback" time="0.012" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_set_get_last_used_jti_redis_fallback" time="0.012" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_revoke_refresh_family_redis_fallback" time="0.010" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_revoke_access_redis_fallback" time="0.011" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_incr_login_counter_redis_fallback" time="0.011" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreRedisFallback" name="test_record_pat_last_used_redis_fallback" time="0.009" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestCleanupTask" name="test_start_stop_cleanup_task" time="0.005" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestCleanupTask" name="test_cleanup_task_multiple_starts" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestCleanupTask" name="test_get_storage_stats" time="0.002" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestCleanupTask" name="test_clear_local_storage" time="0.003" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreIntegration" name="test_refresh_token_rotation_flow" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreIntegration" name="test_token_revocation_flow" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreIntegration" name="test_rate_limiting_flow" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreIntegration" name="test_pat_last_used_tracking" time="0.006" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreErrorHandling" name="test_redis_connection_failure_handling" time="0.002" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreErrorHandling" name="test_redis_operation_failure_handling" time="0.014" /><testcase classname="tests.unit.test_token_store_improvements_unit.TestTokenStoreErrorHandling" name="test_cleanup_task_error_handling" time="0.106" /><testcase classname="tests.unit.test_token_utils_unit" name="test_count_tokens_handles_spaces_and_nospaces" time="0.001" /><testcase classname="tests.unit.test_ttl_helper" name="test_refresh_ttl_seconds_env_seconds" time="0.002" /><testcase classname="tests.unit.test_ttl_helper" name="test_refresh_ttl_minutes_fallback" time="0.001" /><testcase classname="tests.unit.test_ttl_helper" name="test_refresh_ttl_default" time="0.001" /><testcase classname="tests.unit.test_tts_orchestrator_unit" name="test_tts_cache_hit" time="0.003"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/unit/test_tts_orchestrator_unit.py:15: in test_tts_cache_hit
    .get_event_loop()
     ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.unit.test_tts_orchestrator_unit" name="test_tts_daily_cap_autodegrade" time="0.002"><failure message="RuntimeError: There is no current event loop in thread 'MainThread'.">tests/unit/test_tts_orchestrator_unit.py:37: in test_tts_daily_cap_autodegrade
    .get_event_loop()
     ^^^^^^^^^^^^^^^^
/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/events.py:702: in get_event_loop
    raise RuntimeError('There is no current event loop in thread %r.'
E   RuntimeError: There is no current event loop in thread 'MainThread'.</failure></testcase><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_with_explicit_app_url" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_with_explicit_app_url_trailing_slash" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_default_values" time="0.005" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_custom_host_port" time="0.004" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_force_https" time="0.005" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_force_https_various_values" time="0.022" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_force_https_disabled" time="0.018" /><testcase classname="tests.unit.test_url_helpers.TestGetAppUrl" name="test_get_app_url_logging_warning" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetFrontendUrl" name="test_get_frontend_url_default" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetFrontendUrl" name="test_get_frontend_url_single_origin" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestGetFrontendUrl" name="test_get_frontend_url_multiple_origins" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetFrontendUrl" name="test_get_frontend_url_with_spaces" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestGetFrontendUrl" name="test_get_frontend_url_with_trailing_spaces" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_http_to_ws" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_https_to_wss" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_with_base_url_none" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_with_existing_path" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_with_complex_base_url" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildWsUrl" name="test_build_ws_url_with_query_params" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildApiUrl" name="test_build_api_url_simple" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildApiUrl" name="test_build_api_url_with_base_url_none" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildApiUrl" name="test_build_api_url_with_existing_path" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildApiUrl" name="test_build_api_url_with_query_params" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildApiUrl" name="test_build_api_url_with_fragment" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_pytest" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_flask_dev" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_env_dev" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_node_dev" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_production" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_mixed" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestIsDevEnvironment" name="test_is_dev_environment_multiple_true" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_with_origin_header" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_with_referer_header" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_from_request_url" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_fallback_to_env" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_invalid_path" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_with_query_params" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_request_url_parsing_exception" time="0.004" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_invalid_url_scheme" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestBuildOriginAwareUrl" name="test_build_origin_aware_url_no_fallback_env" time="0.003" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_valid_paths" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_absolute_urls" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_protocol_relative_urls" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_invalid_inputs" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_normalize_slashes" time="0.002" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_custom_fallback" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_trailing_slash_preservation" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_query_params" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_fragments" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_complex_paths" time="0.001" /><testcase classname="tests.unit.test_url_helpers.TestSanitizeRedirectPath" name="test_sanitize_redirect_path_edge_cases" time="0.001" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_validate_websocket_origin_valid" time="0.001" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_validate_websocket_origin_invalid" time="0.002" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_validate_websocket_origin_missing" time="0.002" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_validate_websocket_origin_none" time="0.001" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_verify_ws_origin_validation" time="0.006" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_verify_ws_valid_origin" time="0.005" /><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_websocket_http_handler_error_codes" time="0.004"><failure message="assert 404 == 400&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_websocket_origin_validation_unit.py:111: in test_websocket_http_handler_error_codes
    assert response.status_code == 400
E   assert 404 == 400
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_websocket_origin_validation_unit" name="test_cors_origins_restricted" time="0.001"><failure message="AssertionError: CORS middleware should be configured&#10;assert None is not None">tests/unit/test_websocket_origin_validation_unit.py:136: in test_cors_origins_restricted
    assert cors_middleware is not None, "CORS middleware should be configured"
E   AssertionError: CORS middleware should be configured
E   assert None is not None</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_available_in_dev" time="0.083"><failure message="assert 404 == 200&#10; +  where 404 = &lt;Response [404 Not Found]&gt;.status_code">tests/unit/test_ws_helper_unit.py:26: in test_ws_helper_available_in_dev
    assert r.status_code == 200
E   assert 404 == 200
E    +  where 404 = &lt;Response [404 Not Found]&gt;.status_code</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_hidden_in_prod" time="0.075" /><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_contains_inputs_and_buttons" time="0.077"><failure message="assert 'id=&quot;url&quot;' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/do...thod&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:48Z&quot;,&quot;error_id&quot;:&quot;01K46J9VXASM3BMGQNSXSG42PD&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/unit/test_ws_helper_unit.py:52: in test_ws_helper_contains_inputs_and_buttons
    assert needle in html
E   assert 'id="url"' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/do...thod":"GET","req_id":"abc123","timestamp":"2025-09-03T01:15:48Z","error_id":"01K46J9VXASM3BMGQNSXSG42PD","env":"dev"}}'</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_default_url_points_to_ws_care" time="0.074"><failure message="assert '/v1/ws/care' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/do...thod&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:48Z&quot;,&quot;error_id&quot;:&quot;01K46J9VZS9MWNF062VBANKP6P&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/unit/test_ws_helper_unit.py:59: in test_ws_helper_default_url_points_to_ws_care
    assert "/v1/ws/care" in html
E   assert '/v1/ws/care' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/do...thod":"GET","req_id":"abc123","timestamp":"2025-09-03T01:15:48Z","error_id":"01K46J9VZS9MWNF062VBANKP6P","env":"dev"}}'</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_shows_subscribe_payload_hint" time="0.075"><failure message="assert '{\\&quot;action\\&quot;:\\&quot;subscribe\\&quot;,\\&quot;topic\\&quot;:\\&quot;resident:{id}\\&quot;}' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/do...thod&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:48Z&quot;,&quot;error_id&quot;:&quot;01K46J9W2BA8RC57MBX3FJVPJE&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/unit/test_ws_helper_unit.py:66: in test_ws_helper_shows_subscribe_payload_hint
    assert '{\\"action\\":\\"subscribe\\",\\"topic\\":\\"resident:{id}\\"}' in html
E   assert '{\\"action\\":\\"subscribe\\",\\"topic\\":\\"resident:{id}\\"}' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/do...thod":"GET","req_id":"abc123","timestamp":"2025-09-03T01:15:48Z","error_id":"01K46J9W2BA8RC57MBX3FJVPJE","env":"dev"}}'</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_title_and_styles_present" time="0.076"><failure message="assert '&lt;title&gt;WS Helper • Granny Mode API&lt;/title&gt;' in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/do...thod&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:48Z&quot;,&quot;error_id&quot;:&quot;01K46J9W4X8ZRR0BWGRREVEDJH&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/unit/test_ws_helper_unit.py:73: in test_ws_helper_title_and_styles_present
    assert "&lt;title&gt;WS Helper • Granny Mode API&lt;/title&gt;" in html
E   assert '&lt;title&gt;WS Helper • Granny Mode API&lt;/title&gt;' in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/do...thod":"GET","req_id":"abc123","timestamp":"2025-09-03T01:15:48Z","error_id":"01K46J9W4X8ZRR0BWGRREVEDJH","env":"dev"}}'</failure></testcase><testcase classname="tests.unit.test_ws_helper_unit" name="test_ws_helper_includes_token_query_logic" time="0.074"><failure message="assert &quot;token=' + encodeURIComponent(t)&quot; in '{&quot;code&quot;:&quot;not_found&quot;,&quot;message&quot;:&quot;Not Found&quot;,&quot;detail&quot;:&quot;Not Found&quot;,&quot;details&quot;:{&quot;status_code&quot;:404,&quot;trace_id&quot;:&quot;&quot;,&quot;path&quot;:&quot;/do...thod&quot;:&quot;GET&quot;,&quot;req_id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:&quot;2025-09-03T01:15:48Z&quot;,&quot;error_id&quot;:&quot;01K46J9W7DH3XNDDR2DDFS6F5W&quot;,&quot;env&quot;:&quot;dev&quot;}}'">tests/unit/test_ws_helper_unit.py:82: in test_ws_helper_includes_token_query_logic
    assert "token=' + encodeURIComponent(t)" in html
E   assert "token=' + encodeURIComponent(t)" in '{"code":"not_found","message":"Not Found","detail":"Not Found","details":{"status_code":404,"trace_id":"","path":"/do...thod":"GET","req_id":"abc123","timestamp":"2025-09-03T01:15:48Z","error_id":"01K46J9W7DH3XNDDR2DDFS6F5W","env":"dev"}}'</failure></testcase><testcase classname="tests.unit.test_ws_origin_check" name="test_ws_origin_policy[http://localhost:3000-True]" time="0.008"><failure message="starlette.websockets.WebSocketDisconnect">tests/unit/test_ws_origin_check.py:21: in test_ws_origin_policy
    with c.websocket_connect("/v1/ws/health", headers={"Origin": origin}) as ws:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:121: in __enter__
    self._raise_on_close(message)
.venv/lib/python3.12/site-packages/starlette/testclient.py:150: in _raise_on_close
    raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E   starlette.websockets.WebSocketDisconnect</failure></testcase><testcase classname="tests.unit.test_ws_origin_check" name="test_ws_origin_policy[https://evil.example-False]" time="0.021" /></testsuite></testsuites>