import importlib
import os
import pytest
from fastapi.testclient import TestClient


def _reload_app():
    if "app.main" in importlib.sys.modules:
        del importlib.sys.modules["app.main"]
    # Importing here to let import-time behaviour run
    import app.main as main
    return main


def test_dev_weak_secret_allows(monkeypatch):
    monkeypatch.setenv("ENV", "dev")
    monkeypatch.setenv("DEV_MODE", "1")
    monkeypatch.setenv("JWT_SECRET", "short")
    main = _reload_app()
    with TestClient(main.app) as c:
        r = c.get("/")
        assert r.status_code in (200, 404, 405)


def test_prod_weak_secret_rejects(monkeypatch):
    monkeypatch.setenv("ENV", "prod")
    monkeypatch.setenv("DEV_MODE", "0")
    monkeypatch.setenv("JWT_SECRET", "short")
    # Reloading should raise due to weak JWT in production
    with pytest.raises(RuntimeError):
        _reload_app()


