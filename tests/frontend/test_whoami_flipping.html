<!DOCTYPE html>
<html>

<head>
    <title>WhoamiOk State Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .warning {
            color: orange;
        }

        .state {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>WhoamiOk State Test</h1>
    <div id="log"></div>

    <script>
        const log = document.getElementById('log');
        let whoamiOkChanges = 0;
        let lastWhoamiOkState = null;
        let lastChangeTime = 0;

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(div);
        }

        // Monitor whoamiOk state changes
        function monitorWhoamiOk() {
            // This would need to be integrated with the actual React app
            // For now, we'll simulate the monitoring
            addLog('Monitoring whoamiOk state changes...', 'info');

            // Simulate the auth flow
            setTimeout(() => {
                addLog('Auth finish started', 'warning');
                setTimeout(() => {
                    addLog('Auth finish completed - whoamiOk should be true', 'success');
                    setTimeout(() => {
                        addLog('Checking for rapid state changes...', 'info');
                        if (whoamiOkChanges > 2) {
                            addLog(`❌ Too many whoamiOk changes: ${whoamiOkChanges}`, 'error');
                        } else {
                            addLog(`✅ Stable whoamiOk state: ${whoamiOkChanges} changes`, 'success');
                        }
                    }, 2000);
                }, 1000);
            }, 500);
        }

        // Start monitoring
        monitorWhoamiOk();

        // Instructions for manual testing
        addLog('To test manually:', 'info');
        addLog('1. Open the app in another tab', 'info');
        addLog('2. Sign in with Clerk', 'info');
        addLog('3. Watch for whoamiOk state changes in console', 'info');
        addLog('4. Should see: signedIn=false cookie=true whoamiOk=unknown → finisher → whoamiOk=true (stable)', 'info');
    </script>
</body>

</html>
